patch.z80(253): error: Duplicate label: COLOUR
# file opened: build.z80
   1  0000              ;
   2  0000              ; Title:	BBC Basic for BSX - Main build file
   3  0000              ; Author:	Dean Belfield
   4  0000              ; Created:	16/05/2020
   5  0000              ; Last Updated:	08/10/2020
   6  0000              ;
   7  0000              ; Modinfo:
   8  0000              ;
   9  0000              ; 08/10/2020:	Minor mods to support UART
  10  0000
  11  0000              ROM_START		EQU 	0x0000
  12  0000              RAM_START		EQU 	0x8000
  13  0000
  14  0000              PORT_STM_FILE		EQU	0x01			; The IO port for the SD card filing system
  15  0000
  16  0000              BUILD_ROM		EQU 	0			; Set to 1 to build for ROM, or 0 to build for RAM
  17  0000
  18  0000              			MODULE BUILD
  19  0000
  20  0000              			IF BUILD_ROM == 0
  21  0000              			ORG RAM_START
  22  8000              			ELSE
  23  8000 ~            			ORG ROM_START+0x4000
  24  8000              			ENDIF
  25  8000
  26  8000 CD 4E 8C     			CALL    TELL
  27  8003 42 53 58 20  			DEFM	"BSX Breadboard Computer 0.1\n\r"
  27  8007 42 72 65 61
  27  800B 64 62 6F 61
  27  800F 72 64 20 43
  27  8013 6F 6D 70 75
  27  8017 74 65 72 20
  27  801B 30 2E 31 0A
  27  801F 0D
  28  8020 0A 0D        			DEFM	"\n\r"
  29  8022 00           			DEFB    0
  30  8023
  31  8023              			include "main.z80"
# file opened: main.z80
   1+ 8023              ;
   2+ 8023              ;BBC BASIC INTERPRETER - Z80 VERSION
   3+ 8023              ;COMMAND, ERROR AND LEXICAL ANALYSIS MODULE - "MAIN"
   4+ 8023              ;(C) COPYRIGHT  R.T.RUSSELL  1984
   5+ 8023              ;VERSION 2.3, 07-05-1984
   6+ 8023              ;VERSION 3.0, 01-03-1987
   7+ 8023              ;
   8+ 8023              			MODULE MAIN
   9+ 8023              ;
  10+ 8023              TERROR:			EQU     85H
  11+ 8023              LINE:			EQU     86H
  12+ 8023              ELSE:			EQU     8BH
  13+ 8023              THEN:			EQU     8CH
  14+ 8023              LINO:			EQU     8DH
  15+ 8023              FN:			EQU     0A4H
  16+ 8023              TO:			EQU     0B8H
  17+ 8023              REN:			EQU     0CCH
  18+ 8023              DATA:			EQU     0DCH
  19+ 8023              DIM:			EQU     0DEH
  20+ 8023              FOR:			EQU     0E3H
  21+ 8023              GOSUB:			EQU     0E4H
  22+ 8023              GOTO:			EQU     0E5H
  23+ 8023              TIF:			EQU     0E7H
  24+ 8023              LOCAL:			EQU     0EAH
  25+ 8023              NEXT:			EQU     0EDH
  26+ 8023              ON:			EQU     0EEH
  27+ 8023              PROC:			EQU     0F2H
  28+ 8023              REM:			EQU     0F4H
  29+ 8023              REPEAT:			EQU     0F5H
  30+ 8023              RESTOR:			EQU     0F7H
  31+ 8023              TRACE:			EQU     0FCH
  32+ 8023              UNTIL:			EQU     0FDH
  33+ 8023              ;
  34+ 8023              TOKLO:			EQU     8FH
  35+ 8023              TOKHI:			EQU     93H
  36+ 8023              OFFSET:			EQU     0CFH-TOKLO
  37+ 8023
  38+ 8023              ;START:			JP      COLD
  39+ 8023              ;			JP      WARM
  40+ 8023              ;			JP      ESCAPE
  41+ 8023              ;			JP      EXTERR
  42+ 8023              ;			JP      TELL
  43+ 8023              ;			JP      TEXT
  44+ 8023              ;			JP      SETTOP
  45+ 8023              ;			JP      CLEAR
  46+ 8023              ;			JP      RUN0
  47+ 8023              ;			JP      OSCLI
  48+ 8023              ;			JP      OSBGET
  49+ 8023              ;			JP      OSBPUT
  50+ 8023              ;			JP      OSSTAT
  51+ 8023              ;			JP      OSSHUT
  52+ 8023
  53+ 8023 21 00 B5     COLD:			LD      HL,STAVAR       ;COLD START
  54+ 8026 F9           			LD      SP,HL
  55+ 8027 36 0A        			LD      (HL),10
  56+ 8029 2C           			INC     L
  57+ 802A 36 09        			LD      (HL),9
  58+ 802C 2C           			INC     L
  59+ 802D AF           			XOR     A
  60+ 802E 77           PURGE:			LD      (HL),A          ;CLEAR SCRATCHPAD
  61+ 802F 2C           			INC     L
  62+ 8030 20 FC        			JR      NZ,PURGE
  63+ 8032 3E 37        			LD      A,37H           ;V3.0
  64+ 8034 32 FE B5     			LD      (LISTON),A
  65+ 8037 21 6E 80     			LD      HL,NOTICE
  66+ 803A 22 EE B5     			LD      (ERRTXT),HL
  67+ 803D CD 12 B1     			CALL    OSINIT
  68+ 8040 ED 53 E4 B5  			LD      (HIMEM),DE
  69+ 8044 22 DC B5     			LD      (PAGE),HL
  70+ 8047 CD E7 87     			CALL    NEWIT
  71+ 804A C2 D3 8C     			JP      NZ,CHAIN0       ;AUTO-RUN
  72+ 804D CD 4E 8C     			CALL    TELL
  73+ 8050 42 42 43 20  			DEFM    "BBC BASIC (Z80) Version 3.00\n\r"
  73+ 8054 42 41 53 49
  73+ 8058 43 20 28 5A
  73+ 805C 38 30 29 20
  73+ 8060 56 65 72 73
  73+ 8064 69 6F 6E 20
  73+ 8068 33 2E 30 30
  73+ 806C 0A 0D
  74+ 806E 28 43 29 20  NOTICE:			DEFM    "(C) Copyright R.T.Russell 1987\n\r"
  74+ 8072 43 6F 70 79
  74+ 8076 72 69 67 68
  74+ 807A 74 20 52 2E
  74+ 807E 54 2E 52 75
  74+ 8082 73 73 65 6C
  74+ 8086 6C 20 31 39
  74+ 808A 38 37 0A 0D
  75+ 808E 0A 0D        			DEFM	"\n\r"
  76+ 8090 00           			DEFB    0
  77+ 8091 F6           @WARM:			DEFB    0F6H
  78+ 8092 37           @CLOOP:			SCF
  79+ 8093 ED 7B E4 B5  			LD      SP,(HIMEM)
  80+ 8097 CD E0 B0     			CALL    PROMPT          ;PROMPT USER
  81+ 809A 21 FE B5     			LD      HL,LISTON
  82+ 809D 7E           			LD      A,(HL)
  83+ 809E E6 0F        			AND     0FH             ;LISTO
  84+ 80A0 F6 30        			OR      30H             ;OPT 3
  85+ 80A2 77           			LD      (HL),A
  86+ 80A3 ED 62        			SBC     HL,HL           ;HL <- 0 (V3.0)
  87+ 80A5 22 EC B5     			LD      (ERRTRP),HL
  88+ 80A8 22 F4 B5     			LD      (ERRLIN),HL
  89+ 80AB 2A EA B5     			LD      HL,(AUTONO)
  90+ 80AE 22 E6 B5     			LD      (LINENO),HL
  91+ 80B1 7C           			LD      A,H
  92+ 80B2 B5           			OR      L
  93+ 80B3 28 17        			JR      Z,NOAUTO
  94+ 80B5 E5           			PUSH    HL
  95+ 80B6 CD 28 89     			CALL    PBCD            ;AUTO NUMBER
  96+ 80B9 E1           			POP     HL
  97+ 80BA ED 4B FF B5  			LD      BC,(INCREM)
  98+ 80BE 06 00        			LD      B,0
  99+ 80C0 09           			ADD     HL,BC
 100+ 80C1 DA 09 8B     			JP      C,TOOBIG
 101+ 80C4 22 EA B5     			LD      (AUTONO),HL
 102+ 80C7 3E 20        			LD      A,' '
 103+ 80C9 CD 97 88     			CALL    OUTCHR
 104+ 80CC 21 00 B3     NOAUTO:			LD      HL,ACCS
 105+ 80CF CD 1E B1     			CALL    OSLINE          ;GET CONSOLE INPUT
 106+ 80D2 AF           			XOR     A
 107+ 80D3 32 FB B5     			LD      (COUNT),A
 108+ 80D6 FD 21 00 B3  			LD      IY,ACCS
 109+ 80DA CD E4 8A     			CALL    LINNUM
 110+ 80DD CD 99 A4     			CALL    NXT
 111+ 80E0 7C           			LD      A,H
 112+ 80E1 B5           			OR      L
 113+ 80E2 28 03        			JR      Z,LNZERO        ;FOR AUTO (NON-MAPPED)
 114+ 80E4 22 E6 B5     			LD      (LINENO),HL
 115+ 80E7 11 00 B4     LNZERO:			LD      DE,BUFFER
 116+ 80EA 0E 01        			LD      C,1             ;LEFT MODE
 117+ 80EC CD 78 8B     			CALL    LEXAN2          ;LEXICAL ANALYSIS
 118+ 80EF 12           			LD      (DE),A          ;TERMINATOR
 119+ 80F0 AF           			XOR     A
 120+ 80F1 47           			LD      B,A
 121+ 80F2 4B           			LD      C,E             ;BC=LINE LENGTH
 122+ 80F3 13           			INC     DE
 123+ 80F4 12           			LD      (DE),A          ;ZERO NEXT
 124+ 80F5 2A E6 B5     			LD      HL,(LINENO)
 125+ 80F8 7C           			LD      A,H
 126+ 80F9 B5           			OR      L
 127+ 80FA FD 21 00 B4  			LD      IY,BUFFER       ;FOR XEQ
 128+ 80FE CA 0B 8D     			JP      Z,XEQ           ;DIRECT MODE
 129+ 8101 C5           			PUSH    BC
 130+ 8102 E5           			PUSH    HL
 131+ 8103 CD CB 87     			CALL    SETTOP          ;SET TOP
 132+ 8106 E1           			POP     HL
 133+ 8107 CD CE 88     			CALL    FINDL
 134+ 810A CC 8B 87     			CALL    Z,DEL
 135+ 810D C1           			POP     BC
 136+ 810E 79           			LD      A,C
 137+ 810F B7           			OR      A
 138+ 8110 CA 92 80     			JP      Z,CLOOP         ;DELETE LINE ONLY
 139+ 8113 C6 04        			ADD     A,4
 140+ 8115 4F           			LD      C,A             ;LENGTH INCLUSIVE
 141+ 8116 D5           			PUSH    DE              ;LINE NUMBER
 142+ 8117 C5           			PUSH    BC              ;SAVE LINE LENGTH
 143+ 8118 EB           			EX      DE,HL
 144+ 8119 2A DE B5     			LD      HL,(TOP)
 145+ 811C E5           			PUSH    HL
 146+ 811D 09           			ADD     HL,BC
 147+ 811E E5           			PUSH    HL
 148+ 811F 24           			INC     H
 149+ 8120 AF           			XOR     A
 150+ 8121 ED 72        			SBC     HL,SP
 151+ 8123 E1           			POP     HL
 152+ 8124 D2 FE 86     			JP      NC,ERROR        ;"No room"
 153+ 8127 22 DE B5     			LD      (TOP),HL
 154+ 812A E3           			EX      (SP),HL
 155+ 812B E5           			PUSH    HL
 156+ 812C 23           			INC     HL
 157+ 812D B7           			OR      A
 158+ 812E ED 52        			SBC     HL,DE
 159+ 8130 44           			LD      B,H             ;BC=AMOUNT TO MOVE
 160+ 8131 4D           			LD      C,L
 161+ 8132 E1           			POP     HL
 162+ 8133 D1           			POP     DE
 163+ 8134 28 02        			JR      Z,ATEND
 164+ 8136 ED B8        			LDDR                    ;MAKE SPACE
 165+ 8138 C1           ATEND:			POP     BC              ;LINE LENGTH
 166+ 8139 D1           			POP     DE              ;LINE NUMBER
 167+ 813A 23           			INC     HL
 168+ 813B 71           			LD      (HL),C          ;STORE LENGTH
 169+ 813C 23           			INC     HL
 170+ 813D 73           			LD      (HL),E          ;STORE LINE NUMBER
 171+ 813E 23           			INC     HL
 172+ 813F 72           			LD      (HL),D
 173+ 8140 23           			INC     HL
 174+ 8141 11 00 B4     			LD      DE,BUFFER
 175+ 8144 EB           			EX      DE,HL
 176+ 8145 0D           			DEC     C
 177+ 8146 0D           			DEC     C
 178+ 8147 0D           			DEC     C
 179+ 8148 ED B0        			LDIR                    ;ADD LINE
 180+ 814A CD C0 87     			CALL    CLEAN
 181+ 814D C3 92 80     			JP      CLOOP
 182+ 8150              ;
 183+ 8150              ;LIST OF TOKENS AND KEYWORDS.
 184+ 8150              ;IF A KEYWORD IS FOLLOWED BY NUL THEN IT WILL
 185+ 8150              ; ONLY MATCH WITH THE WORD FOLLOWED IMMEDIATELY
 186+ 8150              ; BY A DELIMITER.
 187+ 8150              ;
 188+ 8150 80           KEYWDS:			DEFB    80H
 189+ 8151 41 4E 44     			DEFM    'AND'
 190+ 8154 94           			DEFB    94H
 191+ 8155 41 42 53     			DEFM    'ABS'
 192+ 8158 95           			DEFB    95H
 193+ 8159 41 43 53     			DEFM    'ACS'
 194+ 815C 96           			DEFB    96H
 195+ 815D 41 44 56 41  			DEFM    'ADVAL'
 195+ 8161 4C
 196+ 8162 97           			DEFB    97H
 197+ 8163 41 53 43     			DEFM    'ASC'
 198+ 8166 98           			DEFB    98H
 199+ 8167 41 53 4E     			DEFM    'ASN'
 200+ 816A 99           			DEFB    99H
 201+ 816B 41 54 4E     			DEFM    'ATN'
 202+ 816E C6           			DEFB    0C6H
 203+ 816F 41 55 54 4F  			DEFM    'AUTO'
 204+ 8173 9A           			DEFB    9AH
 205+ 8174 42 47 45 54  			DEFM    'BGET'
 206+ 8178 00           			DEFB    0
 207+ 8179 D5           			DEFB    0D5H
 208+ 817A 42 50 55 54  			DEFM    'BPUT'
 209+ 817E 00           			DEFB    0
 210+ 817F FB           			DEFB    0FBH
 211+ 8180 43 4F 4C 4F  			DEFM    'COLOUR'
 211+ 8184 55 52
 212+ 8186 FB           			DEFB    0FBH
 213+ 8187 43 4F 4C 4F  			DEFM    'COLOR'
 213+ 818B 52
 214+ 818C D6           			DEFB    0D6H
 215+ 818D 43 41 4C 4C  			DEFM    'CALL'
 216+ 8191 D7           			DEFB    0D7H
 217+ 8192 43 48 41 49  			DEFM    'CHAIN'
 217+ 8196 4E
 218+ 8197 BD           			DEFB    0BDH
 219+ 8198 43 48 52 24  			DEFM    'CHR$'
 220+ 819C D8           			DEFB    0D8H
 221+ 819D 43 4C 45 41  			DEFM    'CLEAR'
 221+ 81A1 52
 222+ 81A2 00           			DEFB    0
 223+ 81A3 D9           			DEFB    0D9H
 224+ 81A4 43 4C 4F 53  			DEFM    'CLOSE'
 224+ 81A8 45
 225+ 81A9 00           			DEFB    0
 226+ 81AA DA           			DEFB    0DAH
 227+ 81AB 43 4C 47     			DEFM    'CLG'
 228+ 81AE 00           			DEFB    0
 229+ 81AF DB           			DEFB    0DBH
 230+ 81B0 43 4C 53     			DEFM    'CLS'
 231+ 81B3 00           			DEFB    0
 232+ 81B4 9B           			DEFB    9BH
 233+ 81B5 43 4F 53     			DEFM    'COS'
 234+ 81B8 9C           			DEFB    9CH
 235+ 81B9 43 4F 55 4E  			DEFM    'COUNT'
 235+ 81BD 54
 236+ 81BE 00           			DEFB    0
 237+ 81BF DC           			DEFB    0DCH
 238+ 81C0 44 41 54 41  			DEFM    'DATA'
 239+ 81C4 9D           			DEFB    9DH
 240+ 81C5 44 45 47     			DEFM    'DEG'
 241+ 81C8 DD           			DEFB    0DDH
 242+ 81C9 44 45 46     			DEFM    'DEF'
 243+ 81CC C7           			DEFB    0C7H
 244+ 81CD 44 45 4C 45  			DEFM    'DELETE'
 244+ 81D1 54 45
 245+ 81D3 81           			DEFB    81H
 246+ 81D4 44 49 56     			DEFM    'DIV'
 247+ 81D7 DE           			DEFB    0DEH
 248+ 81D8 44 49 4D     			DEFM    'DIM'
 249+ 81DB DF           			DEFB    0DFH
 250+ 81DC 44 52 41 57  			DEFM    'DRAW'
 251+ 81E0 E1           			DEFB    0E1H
 252+ 81E1 45 4E 44 50  			DEFM    'ENDPROC'
 252+ 81E5 52 4F 43
 253+ 81E8 00           			DEFB    0
 254+ 81E9 E0           			DEFB    0E0H
 255+ 81EA 45 4E 44     			DEFM    'END'
 256+ 81ED 00           			DEFB    0
 257+ 81EE E2           			DEFB    0E2H
 258+ 81EF 45 4E 56 45  			DEFM    'ENVELOPE'
 258+ 81F3 4C 4F 50 45
 259+ 81F7 8B           			DEFB    8BH
 260+ 81F8 45 4C 53 45  			DEFM    'ELSE'
 261+ 81FC A0           			DEFB    0A0H
 262+ 81FD 45 56 41 4C  			DEFM    'EVAL'
 263+ 8201 9E           			DEFB    9EH
 264+ 8202 45 52 4C     			DEFM    'ERL'
 265+ 8205 00           			DEFB    0
 266+ 8206 85           			DEFB    85H
 267+ 8207 45 52 52 4F  			DEFM    'ERROR'
 267+ 820B 52
 268+ 820C C5           			DEFB    0C5H
 269+ 820D 45 4F 46     			DEFM    'EOF'
 270+ 8210 00           			DEFB    0
 271+ 8211 82           			DEFB    82H
 272+ 8212 45 4F 52     			DEFM    'EOR'
 273+ 8215 9F           			DEFB    9FH
 274+ 8216 45 52 52     			DEFM    'ERR'
 275+ 8219 00           			DEFB    0
 276+ 821A A1           			DEFB    0A1H
 277+ 821B 45 58 50     			DEFM    'EXP'
 278+ 821E A2           			DEFB    0A2H
 279+ 821F 45 58 54     			DEFM    'EXT'
 280+ 8222 00           			DEFB    0
 281+ 8223 E3           			DEFB    0E3H
 282+ 8224 46 4F 52     			DEFM    'FOR'
 283+ 8227 A3           			DEFB    0A3H
 284+ 8228 46 41 4C 53  			DEFM    'FALSE'
 284+ 822C 45
 285+ 822D 00           			DEFB    0
 286+ 822E A4           			DEFB    0A4H
 287+ 822F 46 4E        			DEFM    'FN'
 288+ 8231 E5           			DEFB    0E5H
 289+ 8232 47 4F 54 4F  			DEFM    'GOTO'
 290+ 8236 BE           			DEFB    0BEH
 291+ 8237 47 45 54 24  			DEFM    'GET$'
 292+ 823B A5           			DEFB    0A5H
 293+ 823C 47 45 54     			DEFM    'GET'
 294+ 823F E4           			DEFB    0E4H
 295+ 8240 47 4F 53 55  			DEFM    'GOSUB'
 295+ 8244 42
 296+ 8245 E6           			DEFB    0E6H
 297+ 8246 47 43 4F 4C  			DEFM    'GCOL'
 298+ 824A 93           			DEFB    93H
 299+ 824B 48 49 4D 45  			DEFM    'HIMEM'
 299+ 824F 4D
 300+ 8250 00           			DEFB    0
 301+ 8251 E8           			DEFB    0E8H
 302+ 8252 49 4E 50 55  			DEFM    'INPUT'
 302+ 8256 54
 303+ 8257 E7           			DEFB    0E7H
 304+ 8258 49 46        			DEFM    'IF'
 305+ 825A BF           			DEFB    0BFH
 306+ 825B 49 4E 4B 45  			DEFM    'INKEY$'
 306+ 825F 59 24
 307+ 8261 A6           			DEFB    0A6H
 308+ 8262 49 4E 4B 45  			DEFM    'INKEY'
 308+ 8266 59
 309+ 8267 A8           			DEFB    0A8H
 310+ 8268 49 4E 54     			DEFM    'INT'
 311+ 826B A7           			DEFB    0A7H
 312+ 826C 49 4E 53 54  			DEFM    'INSTR('
 312+ 8270 52 28
 313+ 8272 C9           			DEFB    0C9H
 314+ 8273 4C 49 53 54  			DEFM    'LIST'
 315+ 8277 86           			DEFB    86H
 316+ 8278 4C 49 4E 45  			DEFM    'LINE'
 317+ 827C C8           			DEFB    0C8H
 318+ 827D 4C 4F 41 44  			DEFM    'LOAD'
 319+ 8281 92           			DEFB    92H
 320+ 8282 4C 4F 4D 45  			DEFM    'LOMEM'
 320+ 8286 4D
 321+ 8287 00           			DEFB    0
 322+ 8288 EA           			DEFB    0EAH
 323+ 8289 4C 4F 43 41  			DEFM    'LOCAL'
 323+ 828D 4C
 324+ 828E C0           			DEFB    0C0H
 325+ 828F 4C 45 46 54  			DEFM    'LEFT$('
 325+ 8293 24 28
 326+ 8295 A9           			DEFB    0A9H
 327+ 8296 4C 45 4E     			DEFM    'LEN'
 328+ 8299 E9           			DEFB    0E9H
 329+ 829A 4C 45 54     			DEFM    'LET'
 330+ 829D AB           			DEFB    0ABH
 331+ 829E 4C 4F 47     			DEFM    'LOG'
 332+ 82A1 AA           			DEFB    0AAH
 333+ 82A2 4C 4E        			DEFM    'LN'
 334+ 82A4 C1           			DEFB    0C1H
 335+ 82A5 4D 49 44 24  			DEFM    'MID$('
 335+ 82A9 28
 336+ 82AA EB           			DEFB    0EBH
 337+ 82AB 4D 4F 44 45  			DEFM    'MODE'
 338+ 82AF 83           			DEFB    83H
 339+ 82B0 4D 4F 44     			DEFM    'MOD'
 340+ 82B3 EC           			DEFB    0ECH
 341+ 82B4 4D 4F 56 45  			DEFM    'MOVE'
 342+ 82B8 ED           			DEFB    0EDH
 343+ 82B9 4E 45 58 54  			DEFM    'NEXT'
 344+ 82BD CA           			DEFB    0CAH
 345+ 82BE 4E 45 57     			DEFM    'NEW'
 346+ 82C1 00           			DEFB    0
 347+ 82C2 AC           			DEFB    0ACH
 348+ 82C3 4E 4F 54     			DEFM    'NOT'
 349+ 82C6 CB           			DEFB    0CBH
 350+ 82C7 4F 4C 44     			DEFM    'OLD'
 351+ 82CA 00           			DEFB    0
 352+ 82CB EE           			DEFB    0EEH
 353+ 82CC 4F 4E        			DEFM    'ON'
 354+ 82CE 87           			DEFB    87H
 355+ 82CF 4F 46 46     			DEFM    'OFF'
 356+ 82D2 84           			DEFB    84H
 357+ 82D3 4F 52        			DEFM    'OR'
 358+ 82D5 8E           			DEFB    8EH
 359+ 82D6 4F 50 45 4E  			DEFM    'OPENIN'
 359+ 82DA 49 4E
 360+ 82DC AE           			DEFB    0AEH
 361+ 82DD 4F 50 45 4E  			DEFM    'OPENOUT'
 361+ 82E1 4F 55 54
 362+ 82E4 AD           			DEFB    0ADH
 363+ 82E5 4F 50 45 4E  			DEFM    'OPENUP'
 363+ 82E9 55 50
 364+ 82EB FF           			DEFB    0FFH
 365+ 82EC 4F 53 43 4C  			DEFM    'OSCLI'
 365+ 82F0 49
 366+ 82F1 F1           			DEFB    0F1H
 367+ 82F2 50 52 49 4E  			DEFM    'PRINT'
 367+ 82F6 54
 368+ 82F7 90           			DEFB    90H
 369+ 82F8 50 41 47 45  			DEFM    'PAGE'
 370+ 82FC 00           			DEFB    0
 371+ 82FD 8F           			DEFB    8FH
 372+ 82FE 50 54 52     			DEFM    'PTR'
 373+ 8301 00           			DEFB    0
 374+ 8302 AF           			DEFB    0AFH
 375+ 8303 50 49        			DEFM    'PI'
 376+ 8305 00           			DEFB    0
 377+ 8306 F0           			DEFB    0F0H
 378+ 8307 50 4C 4F 54  			DEFM    'PLOT'
 379+ 830B B0           			DEFB    0B0H
 380+ 830C 50 4F 49 4E  			DEFM    'POINT('
 380+ 8310 54 28
 381+ 8312 F2           			DEFB    0F2H
 382+ 8313 50 52 4F 43  			DEFM    'PROC'
 383+ 8317 B1           			DEFB    0B1H
 384+ 8318 50 4F 53     			DEFM    'POS'
 385+ 831B 00           			DEFB    0
 386+ 831C CE           			DEFB    0CEH
 387+ 831D 50 55 54     			DEFM    'PUT'
 388+ 8320 F8           			DEFB    0F8H
 389+ 8321 52 45 54 55  			DEFM    'RETURN'
 389+ 8325 52 4E
 390+ 8327 00           			DEFB    0
 391+ 8328 F5           			DEFB    0F5H
 392+ 8329 52 45 50 45  			DEFM    'REPEAT'
 392+ 832D 41 54
 393+ 832F F6           			DEFB    0F6H
 394+ 8330 52 45 50 4F  			DEFM    'REPORT'
 394+ 8334 52 54
 395+ 8336 00           			DEFB    0
 396+ 8337 F3           			DEFB    0F3H
 397+ 8338 52 45 41 44  			DEFM    'READ'
 398+ 833C F4           			DEFB    0F4H
 399+ 833D 52 45 4D     			DEFM    'REM'
 400+ 8340 F9           			DEFB    0F9H
 401+ 8341 52 55 4E     			DEFM    'RUN'
 402+ 8344 00           			DEFB    0
 403+ 8345 B2           			DEFB    0B2H
 404+ 8346 52 41 44     			DEFM    'RAD'
 405+ 8349 F7           			DEFB    0F7H
 406+ 834A 52 45 53 54  			DEFM    'RESTORE'
 406+ 834E 4F 52 45
 407+ 8351 C2           			DEFB    0C2H
 408+ 8352 52 49 47 48  			DEFM    'RIGHT$('
 408+ 8356 54 24 28
 409+ 8359 B3           			DEFB    0B3H
 410+ 835A 52 4E 44     			DEFM    'RND'
 411+ 835D 00           			DEFB    0
 412+ 835E CC           			DEFB    0CCH
 413+ 835F 52 45 4E 55  			DEFM    'RENUMBER'
 413+ 8363 4D 42 45 52
 414+ 8367 88           			DEFB    88H
 415+ 8368 53 54 45 50  			DEFM    'STEP'
 416+ 836C CD           			DEFB    0CDH
 417+ 836D 53 41 56 45  			DEFM    'SAVE'
 418+ 8371 B4           			DEFB    0B4H
 419+ 8372 53 47 4E     			DEFM    'SGN'
 420+ 8375 B5           			DEFB    0B5H
 421+ 8376 53 49 4E     			DEFM    'SIN'
 422+ 8379 B6           			DEFB    0B6H
 423+ 837A 53 51 52     			DEFM    'SQR'
 424+ 837D 89           			DEFB    89H
 425+ 837E 53 50 43     			DEFM    'SPC'
 426+ 8381 C3           			DEFB    0C3H
 427+ 8382 53 54 52 24  			DEFM    'STR$'
 428+ 8386 C4           			DEFB    0C4H
 429+ 8387 53 54 52 49  			DEFM    'STRING$('
 429+ 838B 4E 47 24 28
 430+ 838F D4           			DEFB    0D4H
 431+ 8390 53 4F 55 4E  			DEFM    'SOUND'
 431+ 8394 44
 432+ 8395 FA           			DEFB    0FAH
 433+ 8396 53 54 4F 50  			DEFM    'STOP'
 434+ 839A 00           			DEFB    0
 435+ 839B B7           			DEFB    0B7H
 436+ 839C 54 41 4E     			DEFM    'TAN'
 437+ 839F 8C           			DEFB    8CH
 438+ 83A0 54 48 45 4E  			DEFM    'THEN'
 439+ 83A4 B8           			DEFB    0B8H
 440+ 83A5 54 4F        			DEFM    'TO'
 441+ 83A7 8A           			DEFB    8AH
 442+ 83A8 54 41 42 28  			DEFM    'TAB('
 443+ 83AC FC           			DEFB    0FCH
 444+ 83AD 54 52 41 43  			DEFM    'TRACE'
 444+ 83B1 45
 445+ 83B2 91           			DEFB    91H
 446+ 83B3 54 49 4D 45  			DEFM    'TIME'
 447+ 83B7 00           			DEFB    0
 448+ 83B8 B9           			DEFB    0B9H
 449+ 83B9 54 52 55 45  			DEFM    'TRUE'
 450+ 83BD 00           			DEFB    0
 451+ 83BE FD           			DEFB    0FDH
 452+ 83BF 55 4E 54 49  			DEFM    'UNTIL'
 452+ 83C3 4C
 453+ 83C4 BA           			DEFB    0BAH
 454+ 83C5 55 53 52     			DEFM    'USR'
 455+ 83C8 EF           			DEFB    0EFH
 456+ 83C9 56 44 55     			DEFM    'VDU'
 457+ 83CC BB           			DEFB    0BBH
 458+ 83CD 56 41 4C     			DEFM    'VAL'
 459+ 83D0 BC           			DEFB    0BCH
 460+ 83D1 56 50 4F 53  			DEFM    'VPOS'
 461+ 83D5 00           			DEFB    0
 462+ 83D6 FE           			DEFB    0FEH
 463+ 83D7 57 49 44 54  			DEFM    'WIDTH'
 463+ 83DB 48
 464+ 83DC D3           			DEFB    0D3H
 465+ 83DD 48 49 4D 45  			DEFM    'HIMEM'
 465+ 83E1 4D
 466+ 83E2 D2           			DEFB    0D2H
 467+ 83E3 4C 4F 4D 45  			DEFM    'LOMEM'
 467+ 83E7 4D
 468+ 83E8 D0           			DEFB    0D0H
 469+ 83E9 50 41 47 45  			DEFM    'PAGE'
 470+ 83ED CF           			DEFB    0CFH
 471+ 83EE 50 54 52     			DEFM    'PTR'
 472+ 83F1 D1           			DEFB    0D1H
 473+ 83F2 54 49 4D 45  			DEFM    'TIME'
 474+ 83F6 01           			DEFB    1
 475+ 83F7 4D 69 73 73  			DEFM    'Missing '
 475+ 83FB 69 6E 67 20
 476+ 83FF 02           			DEFB    2
 477+ 8400 4E 6F 20 73  			DEFM    'No such '
 477+ 8404 75 63 68 20
 478+ 8408 03           			DEFB    3
 479+ 8409 42 61 64 20  			DEFM    'Bad '
 480+ 840D 04           			DEFB    4
 481+ 840E 20 72 61 6E  			DEFM    ' range'
 481+ 8412 67 65
 482+ 8414 05           			DEFB    5
 483+ 8415 76 61 72 69  			DEFM    'variable'
 483+ 8419 61 62 6C 65
 484+ 841D 06           			DEFB    6
 485+ 841E 4F 75 74 20  			DEFM    'Out of'
 485+ 8422 6F 66
 486+ 8424 07           			DEFB    7
 487+ 8425 4E 6F 20     			DEFM    'No '
 488+ 8428 08           			DEFB    8
 489+ 8429 20 73 70 61  			DEFM    ' space'
 489+ 842D 63 65
 490+ 842F              KEYWDL:			EQU     $-KEYWDS
 491+ 842F FF FF        			DEFW    -1
 492+ 8431              ;
 493+ 8431              ;ERROR MESSAGES:
 494+ 8431              ;
 495+ 8431 07           ERRWDS:			DEFB    7
 496+ 8432 72 6F 6F 6D  			DEFM    'room'
 497+ 8436 00           			DEFB    0
 498+ 8437 06           			DEFB    6
 499+ 8438 04           			DEFB    4
 500+ 8439 00           			DEFB    0
 501+ 843A 00 00        			DEFW    0
 502+ 843C 4D 69 73 74  			DEFM    'Mistake'
 502+ 8440 61 6B 65
 503+ 8443 00           			DEFB    0
 504+ 8444 01           			DEFB    1
 505+ 8445 2C           			DEFM    ','
 506+ 8446 00           			DEFB    0
 507+ 8447 54 79 70 65  			DEFM    'Type mismatch'
 507+ 844B 20 6D 69 73
 507+ 844F 6D 61 74 63
 507+ 8453 68
 508+ 8454 00           			DEFB    0
 509+ 8455 07           			DEFB    7
 510+ 8456 A4           			DEFB    FN
 511+ 8457 00 00        			DEFW    0
 512+ 8459 01           			DEFB    1
 513+ 845A 22           			DEFM    34		;ASCII ""
 514+ 845B 00           			DEFB    0
 515+ 845C 03           			DEFB    3
 516+ 845D DE           			DEFB    DIM
 517+ 845E 00           			DEFB    0
 518+ 845F DE           			DEFB    DIM
 519+ 8460 08           			DEFB    8
 520+ 8461 00           			DEFB    0
 521+ 8462 4E 6F 74 20  			DEFM    'Not '
 522+ 8466 EA           			DEFB    LOCAL
 523+ 8467 00           			DEFB    0
 524+ 8468 07           			DEFB    7
 525+ 8469 F2           			DEFB    PROC
 526+ 846A 00           			DEFB    0
 527+ 846B 41 72 72 61  			DEFM    'Array'
 527+ 846F 79
 528+ 8470 00           			DEFB    0
 529+ 8471 53 75 62 73  			DEFM    'Subscript'
 529+ 8475 63 72 69 70
 529+ 8479 74
 530+ 847A 00           			DEFB    0
 531+ 847B 53 79 6E 74  			DEFM    'Syntax error'
 531+ 847F 61 78 20 65
 531+ 8483 72 72 6F 72
 532+ 8487 00           			DEFB    0
 533+ 8488 45 73 63 61  			DEFM    'Escape'
 533+ 848C 70 65
 534+ 848E 00           			DEFB    0
 535+ 848F 44 69 76 69  			DEFM    'Division by zero'
 535+ 8493 73 69 6F 6E
 535+ 8497 20 62 79 20
 535+ 849B 7A 65 72 6F
 536+ 849F 00           			DEFB    0
 537+ 84A0 53 74 72 69  			DEFM    'String too long'
 537+ 84A4 6E 67 20 74
 537+ 84A8 6F 6F 20 6C
 537+ 84AC 6F 6E 67
 538+ 84AF 00           			DEFB    0
 539+ 84B0 54 6F 6F 20  			DEFM    'Too big'
 539+ 84B4 62 69 67
 540+ 84B7 00           			DEFB    0
 541+ 84B8 2D 76 65 20  			DEFM    '-ve root'
 541+ 84BC 72 6F 6F 74
 542+ 84C0 00           			DEFB    0
 543+ 84C1 4C 6F 67     			DEFM    'Log'
 544+ 84C4 04           			DEFB    4
 545+ 84C5 00           			DEFB    0
 546+ 84C6 41 63 63 75  			DEFM    'Accuracy lost'
 546+ 84CA 72 61 63 79
 546+ 84CE 20 6C 6F 73
 546+ 84D2 74
 547+ 84D3 00           			DEFB    0
 548+ 84D4 45 78 70     			DEFM    'Exp'
 549+ 84D7 04           			DEFB    4
 550+ 84D8 00 00        			DEFW    0
 551+ 84DA 02           			DEFB    2
 552+ 84DB 05           			DEFB    5
 553+ 84DC 00           			DEFB    0
 554+ 84DD 01           			DEFB    1
 555+ 84DE 29           			DEFM    ')'
 556+ 84DF 00           			DEFB    0
 557+ 84E0 03           			DEFB    3
 558+ 84E1 48 45 58     			DEFM    'HEX'
 559+ 84E4 00           			DEFB    0
 560+ 84E5 02           			DEFB    2
 561+ 84E6 A4           			DEFB    FN
 562+ 84E7 2F           			DEFM    '/'
 563+ 84E8 F2           			DEFB    PROC
 564+ 84E9 00           			DEFB    0
 565+ 84EA 03           			DEFB    3
 566+ 84EB 63 61 6C 6C  			DEFM    'call'
 567+ 84EF 00           			DEFB    0
 568+ 84F0 41 72 67 75  			DEFM    'Arguments'
 568+ 84F4 6D 65 6E 74
 568+ 84F8 73
 569+ 84F9 00           			DEFB    0
 570+ 84FA 07           			DEFB    7
 571+ 84FB E3           			DEFB    FOR
 572+ 84FC 00           			DEFB    0
 573+ 84FD 43 61 6E 27  			DEFM    'Can''t match '
 573+ 8501 74 20 6D 61
 573+ 8505 74 63 68 20
 574+ 8509 E3           			DEFB    FOR
 575+ 850A 00           			DEFB    0
 576+ 850B E3           			DEFB    FOR
 577+ 850C 20           			DEFM    ' '
 578+ 850D 05           			DEFB    5
 579+ 850E 00 00        			DEFW    0
 580+ 8510 07           			DEFB    7
 581+ 8511 B8           			DEFB    TO
 582+ 8512 00 00        			DEFW    0
 583+ 8514 07           			DEFB    7
 584+ 8515 E4           			DEFB    GOSUB
 585+ 8516 00           			DEFB    0
 586+ 8517 EE           			DEFB    ON
 587+ 8518 20 73 79 6E  			DEFM    ' syntax'
 587+ 851C 74 61 78
 588+ 851F 00           			DEFB    0
 589+ 8520 EE           			DEFB    ON
 590+ 8521 04           			DEFB    4
 591+ 8522 00           			DEFB    0
 592+ 8523 02           			DEFB    2
 593+ 8524 6C 69 6E 65  			DEFM    'line'
 594+ 8528 00           			DEFB    0
 595+ 8529 06           			DEFB    6
 596+ 852A 20           			DEFM    ' '
 597+ 852B DC           			DEFB    DATA
 598+ 852C 00           			DEFB    0
 599+ 852D 07           			DEFB    7
 600+ 852E F5           			DEFB    REPEAT
 601+ 852F 00 00        			DEFW    0
 602+ 8531 01           			DEFB    1
 603+ 8532 23           			DEFM    '#'
 604+ 8533 00           			DEFB    0
 605+ 8534              ;
 606+ 8534              ;COMMANDS:
 607+ 8534              ;
 608+ 8534              ;DELETE line,line
 609+ 8534              ;
 610+ 8534 CD CB 87     @DELETE:		CALL    SETTOP          ;SET TOP
 611+ 8537 CD 31 8B     			CALL    DLPAIR
 612+ 853A 7E           DELET1:			LD      A,(HL)
 613+ 853B B7           			OR      A
 614+ 853C 28 71        			JR      Z,WARMNC
 615+ 853E 23           			INC     HL
 616+ 853F 5E           			LD      E,(HL)
 617+ 8540 23           			INC     HL
 618+ 8541 56           			LD      D,(HL)
 619+ 8542 7A           			LD      A,D
 620+ 8543 B3           			OR      E
 621+ 8544 28 1A        			JR      Z,CLOOP1        ;LINE NUMBER ZERO
 622+ 8546 2B           			DEC     HL
 623+ 8547 2B           			DEC     HL
 624+ 8548 EB           			EX      DE,HL
 625+ 8549 37           			SCF
 626+ 854A ED 42        			SBC     HL,BC
 627+ 854C EB           			EX      DE,HL
 628+ 854D 30 60        			JR      NC,WARMNC
 629+ 854F C5           			PUSH    BC
 630+ 8550 CD 8B 87     			CALL    DEL
 631+ 8553 C1           			POP     BC
 632+ 8554 18 E4        			JR      DELET1
 633+ 8556              ;
 634+ 8556              ;LISTO expr
 635+ 8556              ;
 636+ 8556 FD 23        LISTO:			INC     IY              ;SKIP "O"
 637+ 8558 CD B5 9E     			CALL    EXPRI
 638+ 855B D9           			EXX
 639+ 855C 7D           			LD      A,L
 640+ 855D 32 FE B5     			LD      (LISTON),A
 641+ 8560 C3 92 80     CLOOP1:			JP      CLOOP
 642+ 8563              ;
 643+ 8563              ;LIST
 644+ 8563              ;LIST line
 645+ 8563              ;LIST line,line [IF string]
 646+ 8563              ;LIST ,line
 647+ 8563              ;LIST line,
 648+ 8563              ;
 649+ 8563 FE 4F        @LIST:			CP      'O'
 650+ 8565 28 EF        			JR      Z,LISTO
 651+ 8567 CD 31 8B     			CALL    DLPAIR
 652+ 856A CD 99 A4     			CALL    NXT
 653+ 856D FE E7        			CP      TIF             ;IF CLAUSE ?
 654+ 856F 3E 00        			LD      A,0             ;INIT IF-CLAUSE LENGTH
 655+ 8571 20 15        			JR      NZ,LISTB
 656+ 8573 FD 23        			INC     IY              ;SKIP IF
 657+ 8575 CD 99 A4     			CALL    NXT             ;SKIP SPACES (IF ANY)
 658+ 8578 EB           			EX      DE,HL
 659+ 8579 FD E5        			PUSH    IY
 660+ 857B E1           			POP     HL              ;HL ADDRESSES IF CLAUSE
 661+ 857C 3E 0D        			LD      A,CR
 662+ 857E C5           			PUSH    BC
 663+ 857F 01 00 01     			LD      BC,256
 664+ 8582 ED B1        			CPIR                    ;LOCATE CR
 665+ 8584 79           			LD      A,C
 666+ 8585 2F           			CPL                     ;A = SUBSTRING LENGTH
 667+ 8586 C1           			POP     BC
 668+ 8587 EB           			EX      DE,HL
 669+ 8588 5F           LISTB:			LD      E,A             ;IF-CLAUSE LENGTH
 670+ 8589 78           			LD      A,B
 671+ 858A B1           			OR      C
 672+ 858B 20 01        			JR      NZ,LISTA
 673+ 858D 0B           			DEC     BC
 674+ 858E D9           LISTA:			EXX
 675+ 858F DD 21 FE B5  			LD      IX,LISTON
 676+ 8593 01 00 00     			LD      BC,0            ;INDENTATION COUNT
 677+ 8596 D9           			EXX
 678+ 8597 3E 14        			LD      A,20
 679+ 8599              ;
 680+ 8599 C5           LISTC:			PUSH    BC              ;SAVE HIGH LINE NUMBER
 681+ 859A D5           			PUSH    DE              ;SAVE IF-CLAUSE LENGTH
 682+ 859B E5           			PUSH    HL              ;SAVE PROGRAM POINTER
 683+ 859C 08           			EX      AF,AF'
 684+ 859D 7E           			LD      A,(HL)
 685+ 859E B7           			OR      A
 686+ 859F 28 0E        			JR      Z,WARMNC
 687+ 85A1              ;
 688+ 85A1              ;CHECK IF PAST TERMINATING LINE NUMBER:
 689+ 85A1              ;
 690+ 85A1 7B           			LD      A,E             ;A = IF-CLAUSE LENGTH
 691+ 85A2 23           			INC     HL
 692+ 85A3 5E           			LD      E,(HL)
 693+ 85A4 23           			INC     HL
 694+ 85A5 56           			LD      D,(HL)          ;DE = LINE NUMBER
 695+ 85A6 2B           			DEC     HL
 696+ 85A7 2B           			DEC     HL
 697+ 85A8 D5           			PUSH    DE              ;SAVE LINE NUMBER
 698+ 85A9 EB           			EX      DE,HL
 699+ 85AA 37           			SCF
 700+ 85AB ED 42        			SBC     HL,BC
 701+ 85AD EB           			EX      DE,HL
 702+ 85AE D1           			POP     DE              ;RESTORE LINE NUMBER
 703+ 85AF D2 91 80     WARMNC:			JP      NC,WARM
 704+ 85B2 4E           			LD      C,(HL)          ;C = LINE LENGTH + 4
 705+ 85B3 47           			LD      B,A             ;B = IF-CLAUSE LENGTH
 706+ 85B4              ;
 707+ 85B4              ;CHECK IF "UNLISTABLE":
 708+ 85B4              ;
 709+ 85B4 7A           			LD      A,D
 710+ 85B5 B3           			OR      E
 711+ 85B6 CA 92 80     			JP      Z,CLOOP
 712+ 85B9              ;
 713+ 85B9              ;CHECK FOR IF CLAUSE:
 714+ 85B9              ;
 715+ 85B9 23           			INC     HL
 716+ 85BA 23           			INC     HL
 717+ 85BB 23           			INC     HL              ;HL ADDRESSES LINE TEXT
 718+ 85BC 0D           			DEC     C
 719+ 85BD 0D           			DEC     C
 720+ 85BE 0D           			DEC     C
 721+ 85BF 0D           			DEC     C               ;C = LINE LENGTH
 722+ 85C0 D5           			PUSH    DE              ;SAVE LINE NUMBER
 723+ 85C1 E5           			PUSH    HL              ;SAVE LINE ADDRESS
 724+ 85C2 AF           			XOR     A               ;A <- 0
 725+ 85C3 B8           			CP      B               ;WAS THERE AN IF-CLAUSE
 726+ 85C4 FD E5        			PUSH    IY
 727+ 85C6 D1           			POP     DE              ;DE ADDRESSES IF-CLAUSE
 728+ 85C7 C4 54 A2     			CALL    NZ,SEARCH       ;SEARCH FOR IF CLAUSE
 729+ 85CA E1           			POP     HL              ;RESTORE LINE ADDRESS
 730+ 85CB D1           			POP     DE              ;RESTORE LINE NUMBER
 731+ 85CC FD E5        			PUSH    IY
 732+ 85CE CC 07 88     			CALL    Z,LISTIT        ;LIST IF MATCH
 733+ 85D1 FD E1        			POP     IY
 734+ 85D3              ;
 735+ 85D3 08           			EX      AF,AF'
 736+ 85D4 3D           			DEC     A
 737+ 85D5 CD 05 B1     			CALL    LTRAP
 738+ 85D8 E1           			POP     HL              ;RESTORE POINTER
 739+ 85D9 5E           			LD      E,(HL)
 740+ 85DA 16 00        			LD      D,0
 741+ 85DC 19           			ADD     HL,DE           ;ADDRESS NEXT LINE
 742+ 85DD D1           			POP     DE              ;RESTORE IF-CLAUSE LEN
 743+ 85DE C1           			POP     BC              ;RESTORE HI LINE NUMBER
 744+ 85DF 18 B8        			JR      LISTC
 745+ 85E1              ;
 746+ 85E1              ;RENUMBER
 747+ 85E1              ;RENUMBER start
 748+ 85E1              ;RENUMBER start,increment
 749+ 85E1              ;RENUMBER ,increment
 750+ 85E1              ;
 751+ 85E1 CD EF 87     @RENUM:			CALL    CLEAR           ;USES DYNAMIC AREA
 752+ 85E4 CD 0E 8B     			CALL    PAIR            ;LOAD HL,BC
 753+ 85E7 D9           			EXX
 754+ 85E8 2A DC B5     			LD      HL,(PAGE)
 755+ 85EB ED 5B E0 B5  			LD      DE,(LOMEM)
 756+ 85EF 7E           RENUM1:			LD      A,(HL)          ;BUILD TABLE
 757+ 85F0 B7           			OR      A
 758+ 85F1 28 30        			JR      Z,RENUM2
 759+ 85F3 23           			INC     HL
 760+ 85F4 4E           			LD      C,(HL)          ;OLD LINE NUMBER
 761+ 85F5 23           			INC     HL
 762+ 85F6 46           			LD      B,(HL)
 763+ 85F7 78           			LD      A,B
 764+ 85F8 B1           			OR      C
 765+ 85F9 CA 92 80     			JP      Z,CLOOP         ;LINE NUMBER ZERO
 766+ 85FC EB           			EX      DE,HL
 767+ 85FD 71           			LD      (HL),C
 768+ 85FE 23           			INC     HL
 769+ 85FF 70           			LD      (HL),B
 770+ 8600 23           			INC     HL
 771+ 8601 D9           			EXX
 772+ 8602 E5           			PUSH    HL
 773+ 8603 09           			ADD     HL,BC           ;ADD INCREMENT
 774+ 8604 DA 09 8B     			JP      C,TOOBIG        ;"Too big"
 775+ 8607 D9           			EXX
 776+ 8608 C1           			POP     BC
 777+ 8609 71           			LD      (HL),C
 778+ 860A 23           			INC     HL
 779+ 860B 70           			LD      (HL),B
 780+ 860C 23           			INC     HL
 781+ 860D EB           			EX      DE,HL
 782+ 860E 2B           			DEC     HL
 783+ 860F 2B           			DEC     HL
 784+ 8610 AF           			XOR     A
 785+ 8611 47           			LD      B,A
 786+ 8612 4E           			LD      C,(HL)
 787+ 8613 09           			ADD     HL,BC           ;NEXT LINE
 788+ 8614 EB           			EX      DE,HL
 789+ 8615 E5           			PUSH    HL
 790+ 8616 24           			INC     H
 791+ 8617 ED 72        			SBC     HL,SP
 792+ 8619 E1           			POP     HL
 793+ 861A EB           			EX      DE,HL
 794+ 861B 38 D2        			JR      C,RENUM1        ;CONTINUE
 795+ 861D CD 13 87     			CALL    EXTERR          ;"RENUMBER space'
 796+ 8620 CC           			DEFB    REN
 797+ 8621 08           			DEFB    8
 798+ 8622 00           			DEFB    0
 799+ 8623              ;
 800+ 8623 EB           RENUM2:			EX      DE,HL
 801+ 8624 36 FF        			LD      (HL),-1
 802+ 8626 23           			INC     HL
 803+ 8627 36 FF        			LD      (HL),-1
 804+ 8629 ED 5B E0 B5  			LD      DE,(LOMEM)
 805+ 862D D9           			EXX
 806+ 862E 2A DC B5     			LD      HL,(PAGE)
 807+ 8631 4E           RENUM3:			LD      C,(HL)
 808+ 8632 79           			LD      A,C
 809+ 8633 B7           			OR      A
 810+ 8634 CA 91 80     			JP      Z,WARM
 811+ 8637 D9           			EXX
 812+ 8638 EB           			EX      DE,HL
 813+ 8639 23           			INC     HL
 814+ 863A 23           			INC     HL
 815+ 863B 5E           			LD      E,(HL)
 816+ 863C 23           			INC     HL
 817+ 863D 56           			LD      D,(HL)
 818+ 863E 23           			INC     HL
 819+ 863F D5           			PUSH    DE
 820+ 8640 EB           			EX      DE,HL
 821+ 8641 22 E6 B5     			LD      (LINENO),HL
 822+ 8644 D9           			EXX
 823+ 8645 D1           			POP     DE
 824+ 8646 23           			INC     HL
 825+ 8647 73           			LD      (HL),E          ;NEW LINE NUMBER
 826+ 8648 23           			INC     HL
 827+ 8649 72           			LD      (HL),D
 828+ 864A 23           			INC     HL
 829+ 864B 0D           			DEC     C
 830+ 864C 0D           			DEC     C
 831+ 864D 0D           			DEC     C
 832+ 864E 06 00        			LD      B,0
 833+ 8650 3E 8D        RENUM7:			LD      A,LINO
 834+ 8652 ED B1        			CPIR                    ;SEARCH FOR LINE NUMBER
 835+ 8654 20 DB        			JR      NZ,RENUM3
 836+ 8656 C5           			PUSH    BC
 837+ 8657 E5           			PUSH    HL
 838+ 8658 E5           			PUSH    HL
 839+ 8659 FD E1        			POP     IY
 840+ 865B D9           			EXX
 841+ 865C CD 47 A3     			CALL    DECODE          ;DECODE LINE NUMBER
 842+ 865F D9           			EXX
 843+ 8660 44           			LD      B,H
 844+ 8661 4D           			LD      C,L
 845+ 8662 2A E0 B5     			LD      HL,(LOMEM)
 846+ 8665 5E           RENUM4:			LD      E,(HL)          ;CROSS-REFERENCE TABLE
 847+ 8666 23           			INC     HL
 848+ 8667 56           			LD      D,(HL)
 849+ 8668 23           			INC     HL
 850+ 8669 EB           			EX      DE,HL
 851+ 866A B7           			OR      A               ;CLEAR CARRY
 852+ 866B ED 42        			SBC     HL,BC
 853+ 866D EB           			EX      DE,HL
 854+ 866E 5E           			LD      E,(HL)          ;NEW NUMBER
 855+ 866F 23           			INC     HL
 856+ 8670 56           			LD      D,(HL)
 857+ 8671 23           			INC     HL
 858+ 8672 38 F1        			JR      C,RENUM4
 859+ 8674 EB           			EX      DE,HL
 860+ 8675 28 19        			JR      Z,RENUM5        ;FOUND
 861+ 8677 CD 4E 8C     			CALL    TELL
 862+ 867A 46 61 69 6C  			DEFM    'Failed at '
 862+ 867E 65 64 20 61
 862+ 8682 74 20
 863+ 8684 00           			DEFB    0
 864+ 8685 2A E6 B5     			LD      HL,(LINENO)
 865+ 8688 CD 24 89     			CALL    PBCDL
 866+ 868B CD 90 88     			CALL    CRLF
 867+ 868E 18 06        			JR      RENUM6
 868+ 8690 D1           RENUM5:			POP     DE
 869+ 8691 D5           			PUSH    DE
 870+ 8692 1B           			DEC     DE
 871+ 8693 CD 1C 8C     			CALL    ENCODE          ;RE-WRITE NUMBER
 872+ 8696 E1           RENUM6:			POP     HL
 873+ 8697 C1           			POP     BC
 874+ 8698 18 B6        			JR      RENUM7
 875+ 869A              ;
 876+ 869A              ;AUTO
 877+ 869A              ;AUTO start,increment
 878+ 869A              ;AUTO start
 879+ 869A              ;AUTO ,increment
 880+ 869A              ;
 881+ 869A CD 0E 8B     @AUTO:			CALL    PAIR
 882+ 869D 22 EA B5     			LD      (AUTONO),HL
 883+ 86A0 79           			LD      A,C
 884+ 86A1 32 FF B5     			LD      (INCREM),A
 885+ 86A4 18 29        			JR      CLOOP0
 886+ 86A6              ;
 887+ 86A6              ;BAD
 888+ 86A6              ;NEW
 889+ 86A6              ;
 890+ 86A6 CD 4E 8C     BAD:			CALL    TELL            ;"Bad program'
 891+ 86A9 03           			DEFB    3
 892+ 86AA 70 72 6F 67  			DEFM    'program'
 892+ 86AE 72 61 6D
 893+ 86B1 0D           			DEFB    CR
 894+ 86B2 0A           			DEFB    LF
 895+ 86B3 00           			DEFB    0
 896+ 86B4 CD E7 87     @NEW:			CALL    NEWIT
 897+ 86B7 18 16        			JR      CLOOP0
 898+ 86B9              ;
 899+ 86B9              ;OLD
 900+ 86B9              ;
 901+ 86B9 2A DC B5     @OLD:			LD      HL,(PAGE)
 902+ 86BC E5           			PUSH    HL
 903+ 86BD 23           			INC     HL
 904+ 86BE 23           			INC     HL
 905+ 86BF 23           			INC     HL
 906+ 86C0 01 FC 00     			LD      BC,252
 907+ 86C3 3E 0D        			LD      A,CR
 908+ 86C5 ED B1        			CPIR
 909+ 86C7 20 DD        			JR      NZ,BAD
 910+ 86C9 7D           			LD      A,L
 911+ 86CA E1           			POP     HL
 912+ 86CB 77           			LD      (HL),A
 913+ 86CC CD C0 87     			CALL    CLEAN
 914+ 86CF C3 92 80     CLOOP0:			JP      CLOOP
 915+ 86D2              ;
 916+ 86D2              ;LOAD filename
 917+ 86D2              ;
 918+ 86D2 CD BE 9E     @LOAD:			CALL    EXPRS           ;GET FILENAME
 919+ 86D5 3E 0D        			LD      A,CR
 920+ 86D7 12           			LD      (DE),A
 921+ 86D8 CD A6 87     			CALL    LOAD0
 922+ 86DB CD EF 87     			CALL    CLEAR
 923+ 86DE 18 1B        			JR      WARM0
 924+ 86E0              ;
 925+ 86E0              ;SAVE filename
 926+ 86E0              ;
 927+ 86E0 CD CB 87     @SAVE:			CALL    SETTOP          ;SET TOP
 928+ 86E3 CD BE 9E     			CALL    EXPRS           ;FILENAME
 929+ 86E6 3E 0D        			LD      A,CR
 930+ 86E8 12           			LD      (DE),A
 931+ 86E9 ED 5B DC B5  			LD      DE,(PAGE)
 932+ 86ED 2A DE B5     			LD      HL,(TOP)
 933+ 86F0 B7           			OR      A
 934+ 86F1 ED 52        			SBC     HL,DE
 935+ 86F3 44           			LD      B,H             ;LENGTH OF PROGRAM
 936+ 86F4 4D           			LD      C,L
 937+ 86F5 21 00 B3     			LD      HL,ACCS
 938+ 86F8 CD 02 B2     			CALL    OSSAVE
 939+ 86FB C3 91 80     WARM0:			JP      WARM
 940+ 86FE              ;
 941+ 86FE              ;ERROR
 942+ 86FE              ;
 943+ 86FE ED 7B E4 B5  @ERROR:			LD      SP,(HIMEM)
 944+ 8702 21 31 84     			LD      HL,ERRWDS
 945+ 8705 B7           			OR      A
 946+ 8706 28 0A        			JR      Z,ERROR1
 947+ 8708 47           			LD      B,A             ;ERROR NUMBER
 948+ 8709 08           			EX      AF,AF'
 949+ 870A AF           			XOR     A
 950+ 870B BE           ERROR0:			CP      (HL)
 951+ 870C 23           			INC     HL
 952+ 870D 20 FC        			JR      NZ,ERROR0
 953+ 870F 10 FA        			DJNZ    ERROR0
 954+ 8711 08           			EX      AF,AF'
 955+ 8712 E5           ERROR1:			PUSH    HL
 956+ 8713 E1           @EXTERR:		POP     HL
 957+ 8714 22 EE B5     			LD      (ERRTXT),HL
 958+ 8717 ED 7B E4 B5  			LD      SP,(HIMEM)
 959+ 871B 32 FD B5     			LD      (ERR),A
 960+ 871E CD E7 88     			CALL    SETLIN
 961+ 8721 22 F2 B5     			LD      (ERL),HL
 962+ 8724 B7           			OR      A
 963+ 8725 28 0B        			JR      Z,ERROR2
 964+ 8727 2A EC B5     			LD      HL,(ERRTRP)
 965+ 872A 7C           			LD      A,H
 966+ 872B B5           			OR      L
 967+ 872C E5           			PUSH    HL
 968+ 872D FD E1        			POP     IY
 969+ 872F C2 0B 8D     			JP      NZ,XEQ          ;ERROR TRAPPED
 970+ 8732 21 00 00     ERROR2:			LD      HL,0
 971+ 8735 22 EA B5     			LD      (AUTONO),HL
 972+ 8738 22 E8 B5     			LD      (TRACEN),HL     ;CANCEL TRACE
 973+ 873B CD 02 B2     			CALL    RESET           ;RESET OPSYS
 974+ 873E CD 90 88     			CALL    CRLF
 975+ 8741 CD 42 8C     			CALL    REPORT          ;MESSAGE
 976+ 8744 CD 11 89     			CALL    SAYLN
 977+ 8747 1E 00        			LD      E,0
 978+ 8749 DC 02 B2     			CALL    C,OSSHUT        ;CLOSE ALL FILES
 979+ 874C CD 90 88     			CALL    CRLF
 980+ 874F C3 92 80     			JP      CLOOP
 981+ 8752              ;
 982+ 8752              ;SUBROUTINES:
 983+ 8752              ;
 984+ 8752              ;
 985+ 8752              ;LEX - SEARCH FOR KEYWORDS
 986+ 8752              ;   Inputs: HL = start of keyword table
 987+ 8752              ;           IY = start of match text
 988+ 8752              ;  Outputs: If found, Z-flag set, A=token.
 989+ 8752              ;           If not found, Z-flag reset, A=(IY).
 990+ 8752              ;           IY updated (if NZ, IY unchanged).
 991+ 8752              ; Destroys: A,B,H,L,IY,F
 992+ 8752              ;
 993+ 8752 21 50 81     LEX:			LD      HL,KEYWDS
 994+ 8755 FD 7E 00     LEX0:			LD      A,(IY)
 995+ 8758 46           			LD      B,(HL)
 996+ 8759 23           			INC     HL
 997+ 875A BE           			CP      (HL)
 998+ 875B 28 08        			JR      Z,LEX2
 999+ 875D D8           			RET     C               ;FAIL EXIT
1000+ 875E 23           LEX1:			INC     HL
1001+ 875F CB 7E        			BIT     7,(HL)
1002+ 8761 28 FB        			JR      Z,LEX1
1003+ 8763 18 F0        			JR      LEX0
1004+ 8765 FD E5        LEX2:			PUSH    IY              ;SAVE POINTER
1005+ 8767 23           LEX3:			INC     HL
1006+ 8768 CB 7E        			BIT     7,(HL)
1007+ 876A 20 1B        			JR      NZ,LEX6         ;FOUND
1008+ 876C FD 23        			INC     IY
1009+ 876E FD 7E 00     			LD      A,(IY)
1010+ 8771 FE 2E        			CP      '.'
1011+ 8773 28 12        			JR      Z,LEX6          ;FOUND (ABBREV.)
1012+ 8775 BE           			CP      (HL)
1013+ 8776 28 EF        			JR      Z,LEX3
1014+ 8778 CD 55 8B     			CALL    RANGE1
1015+ 877B 38 04        			JR      C,LEX5
1016+ 877D FD E1        LEX4:			POP     IY              ;RESTORE POINTER
1017+ 877F 18 DD        			JR      LEX1
1018+ 8781 7E           LEX5:			LD      A,(HL)
1019+ 8782 B7           			OR      A
1020+ 8783 20 F8        			JR      NZ,LEX4
1021+ 8785 FD 2B        			DEC     IY
1022+ 8787 F1           LEX6:			POP     AF
1023+ 8788 AF           			XOR     A
1024+ 8789 78           			LD      A,B
1025+ 878A C9           			RET
1026+ 878B              ;
1027+ 878B              ;DEL - DELETE A PROGRAM LINE.
1028+ 878B              ;   Inputs: HL addresses program line.
1029+ 878B              ; Destroys: B,C,F
1030+ 878B              ;
1031+ 878B D5           DEL:			PUSH    DE
1032+ 878C E5           			PUSH    HL
1033+ 878D E5           			PUSH    HL
1034+ 878E 06 00        			LD      B,0
1035+ 8790 4E           			LD      C,(HL)
1036+ 8791 09           			ADD     HL,BC
1037+ 8792 E5           			PUSH    HL
1038+ 8793 EB           			EX      DE,HL
1039+ 8794 2A DE B5     			LD      HL,(TOP)
1040+ 8797 ED 52        			SBC     HL,DE
1041+ 8799 44           			LD      B,H
1042+ 879A 4D           			LD      C,L
1043+ 879B E1           			POP     HL
1044+ 879C D1           			POP     DE
1045+ 879D ED B0        			LDIR                    ;DELETE LINE
1046+ 879F ED 53 DE B5  			LD      (TOP),DE
1047+ 87A3 E1           			POP     HL
1048+ 87A4 D1           			POP     DE
1049+ 87A5 C9           			RET
1050+ 87A6              ;
1051+ 87A6              ;LOAD0 - LOAD A DISK FILE THEN CLEAN.
1052+ 87A6              ;   Inputs: Filename in ACCS (term CR)
1053+ 87A6              ; Destroys: A,B,C,D,E,H,L,F
1054+ 87A6              ;
1055+ 87A6              ;CLEAN - CHECK FOR BAD PROGRAM, FIND END OF TEXT
1056+ 87A6              ; AND WRITE FF FF, THEN LOAD (TOP).
1057+ 87A6              ; Destroys: A,B,C,H,L,F
1058+ 87A6              ;
1059+ 87A6 ED 5B DC B5  @LOAD0: 		LD      DE,(PAGE)
1060+ 87AA 21 00 FF     			LD      HL,-256
1061+ 87AD 39           			ADD     HL,SP
1062+ 87AE ED 52        			SBC     HL,DE           ;FIND AVAILABLE SPACE
1063+ 87B0 44           			LD      B,H
1064+ 87B1 4D           			LD      C,L
1065+ 87B2 21 00 B3     			LD      HL,ACCS
1066+ 87B5 CD 02 B2     			CALL    OSLOAD          ;LOAD
1067+ 87B8 D4 E7 87     			CALL    NC,NEWIT
1068+ 87BB 3E 00        			LD      A,0
1069+ 87BD D2 FE 86     			JP      NC,ERROR        ;"No room"
1070+ 87C0 CD CB 87     CLEAN:			CALL    SETTOP
1071+ 87C3 2B           			DEC     HL
1072+ 87C4 36 FF        			LD      (HL),-1         ;WRITE &FFFF
1073+ 87C6 2B           			DEC     HL
1074+ 87C7 36 FF        			LD      (HL),-1
1075+ 87C9 18 24        			JR      CLEAR
1076+ 87CB              ;
1077+ 87CB 2A DC B5     SETTOP:			LD      HL,(PAGE)
1078+ 87CE 06 00        			LD      B,0
1079+ 87D0 3E 0D        			LD      A,CR
1080+ 87D2 4E           SETOP1:			LD      C,(HL)
1081+ 87D3 0C           			INC     C
1082+ 87D4 0D           			DEC     C
1083+ 87D5 28 09        			JR      Z,SETOP2
1084+ 87D7 09           			ADD     HL,BC
1085+ 87D8 2B           			DEC     HL
1086+ 87D9 BE           			CP      (HL)
1087+ 87DA 23           			INC     HL
1088+ 87DB 28 F5        			JR      Z,SETOP1
1089+ 87DD C3 A6 86     			JP      BAD
1090+ 87E0 23           SETOP2:			INC     HL              ;N.B. CALLED FROM NEWIT
1091+ 87E1 23           			INC     HL
1092+ 87E2 23           			INC     HL
1093+ 87E3 22 DE B5     			LD      (TOP),HL
1094+ 87E6 C9           			RET
1095+ 87E7              ;
1096+ 87E7              ;NEWIT - NEW PROGRAM THEN CLEAR
1097+ 87E7              ;   Destroys: H,L
1098+ 87E7              ;
1099+ 87E7              ;CLEAR - CLEAR ALL DYNAMIC VARIABLES INCLUDING
1100+ 87E7              ; FUNCTION AND PROCEDURE POINTERS.
1101+ 87E7              ;   Destroys: Nothing
1102+ 87E7              ;
1103+ 87E7 2A DC B5     NEWIT:			LD      HL,(PAGE)
1104+ 87EA 36 00        			LD      (HL),0
1105+ 87EC CD E0 87     			CALL    SETOP2
1106+ 87EF E5           @CLEAR:			PUSH    HL
1107+ 87F0 2A DE B5     			LD      HL,(TOP)
1108+ 87F3 22 E0 B5     			LD      (LOMEM),HL
1109+ 87F6 22 E2 B5     			LD      (FREE),HL
1110+ 87F9 21 6C B5     			LD      HL,DYNVAR
1111+ 87FC C5           			PUSH    BC
1112+ 87FD 06 70        			LD      B,2*(54+2)
1113+ 87FF 36 00        CLEAR1:			LD      (HL),0
1114+ 8801 23           			INC     HL
1115+ 8802 10 FB        			DJNZ    CLEAR1
1116+ 8804 C1           			POP     BC
1117+ 8805 E1           			POP     HL
1118+ 8806 C9           			RET
1119+ 8807              ;
1120+ 8807              ;LISTIT - LIST A PROGRAM LINE.
1121+ 8807              ;    Inputs: HL addresses line
1122+ 8807              ;            DE = line number (binary)
1123+ 8807              ;            IX addresses LISTON
1124+ 8807              ;  Destroys: A,D,E,B',C',D',E',H',L',IY,F
1125+ 8807              ;
1126+ 8807 E5           LISTIT:			PUSH    HL
1127+ 8808 EB           			EX      DE,HL
1128+ 8809 C5           			PUSH    BC
1129+ 880A CD 28 89     			CALL    PBCD
1130+ 880D C1           			POP     BC
1131+ 880E E1           			POP     HL
1132+ 880F 7E           			LD      A,(HL)
1133+ 8810 FE ED        			CP      NEXT
1134+ 8812 CC 73 88     			CALL    Z,INDENT
1135+ 8815 FE FD        			CP      UNTIL
1136+ 8817 CC 73 88     			CALL    Z,INDENT
1137+ 881A D9           			EXX
1138+ 881B 3E 20        			LD      A,' '
1139+ 881D DD CB 00 46  			BIT     0,(IX)
1140+ 8821 C4 97 88     			CALL    NZ,OUTCHR
1141+ 8824 78           			LD      A,B
1142+ 8825 87           			ADD     A,A
1143+ 8826 DD CB 00 4E  			BIT     1,(IX)
1144+ 882A C4 4D 97     			CALL    NZ,FILL
1145+ 882D 79           			LD      A,C
1146+ 882E 87           			ADD     A,A
1147+ 882F DD CB 00 56  			BIT     2,(IX)
1148+ 8833 C4 4D 97     			CALL    NZ,FILL
1149+ 8836 D9           			EXX
1150+ 8837 7E           			LD      A,(HL)
1151+ 8838 FE E3        			CP      FOR
1152+ 883A CC 73 88     			CALL    Z,INDENT
1153+ 883D FE F5        			CP      REPEAT
1154+ 883F CC 73 88     			CALL    Z,INDENT
1155+ 8842 1E 00        			LD      E,0
1156+ 8844 7E           LIST8:			LD      A,(HL)
1157+ 8845 23           			INC     HL
1158+ 8846 FE 0D        			CP      CR
1159+ 8848 28 46        			JR      Z,CRLF
1160+ 884A FE 22        			CP      34		;ASCII ""
1161+ 884C 20 01        			JR      NZ,LIST7
1162+ 884E 1C           			INC     E
1163+ 884F CD 67 88     LIST7:			CALL    LOUT
1164+ 8852 18 F0        			JR      LIST8
1165+ 8854              ;
1166+ 8854 E5           PRLINO:			PUSH    HL
1167+ 8855 FD E1        			POP     IY
1168+ 8857 C5           			PUSH    BC
1169+ 8858 CD 47 A3     			CALL    DECODE
1170+ 885B C1           			POP     BC
1171+ 885C D9           			EXX
1172+ 885D C5           			PUSH    BC
1173+ 885E CD 24 89     			CALL    PBCDL
1174+ 8861 C1           			POP     BC
1175+ 8862 D9           			EXX
1176+ 8863 FD E5        			PUSH    IY
1177+ 8865 E1           			POP     HL
1178+ 8866 C9           			RET
1179+ 8867              ;
1180+ 8867 CB 43        LOUT:			BIT     0,E
1181+ 8869 20 2C        			JR      NZ,OUTCHR
1182+ 886B FE 8D        			CP      LINO
1183+ 886D 28 E5        			JR      Z,PRLINO
1184+ 886F CD B0 88     			CALL    OUT
1185+ 8872 7E           			LD      A,(HL)
1186+ 8873 D9           INDENT:			EXX
1187+ 8874 FE E3        			CP      FOR
1188+ 8876 28 08        			JR      Z,IND1
1189+ 8878 FE ED        			CP      NEXT
1190+ 887A 20 05        			JR      NZ,IND2
1191+ 887C 05           			DEC     B
1192+ 887D F2 81 88     			JP      P,IND2
1193+ 8880 04           IND1:			INC     B
1194+ 8881 FE F5        IND2:			CP      REPEAT
1195+ 8883 28 08        			JR      Z,IND3
1196+ 8885 FE FD        			CP      UNTIL
1197+ 8887 20 05        			JR      NZ,IND4
1198+ 8889 0D           			DEC     C
1199+ 888A F2 8E 88     			JP      P,IND4
1200+ 888D 0C           IND3:			INC     C
1201+ 888E D9           IND4:			EXX
1202+ 888F C9           			RET
1203+ 8890              ;
1204+ 8890              ;CRLF - SEND CARRIAGE RETURN, LINE FEED.
1205+ 8890              ;  Destroys: A,F
1206+ 8890              ;OUTCHR - OUTPUT A CHARACTER TO CONSOLE.
1207+ 8890              ;    Inputs: A = character
1208+ 8890              ;  Destroys: A,F
1209+ 8890              ;
1210+ 8890 3E 0D        @CRLF:			LD      A,CR
1211+ 8892 CD 97 88     			CALL    OUTCHR
1212+ 8895 3E 0A        			LD      A,LF
1213+ 8897 CD E2 B0     @OUTCHR:		CALL    OSWRCH
1214+ 889A D6 0D        			SUB     CR
1215+ 889C 28 05        			JR      Z,CARRET
1216+ 889E D8           			RET     C               ;NON-PRINTING
1217+ 889F 3A FB B5     			LD      A,(COUNT)
1218+ 88A2 3C           			INC     A
1219+ 88A3 32 FB B5     CARRET:			LD      (COUNT),A
1220+ 88A6 C8           			RET     Z
1221+ 88A7 E5           			PUSH    HL
1222+ 88A8 2A FC B5     			LD      HL,(WIDTH)
1223+ 88AB BD           			CP      L
1224+ 88AC E1           			POP     HL
1225+ 88AD C0           			RET     NZ
1226+ 88AE 18 E0        			JR      CRLF
1227+ 88B0              ;
1228+ 88B0              ;OUT - SEND CHARACTER OR KEYWORD
1229+ 88B0              ;   Inputs: A = character (>=10, <128)
1230+ 88B0              ;           A = Token (<10, >=128)
1231+ 88B0              ;  Destroys: A,F
1232+ 88B0              ;
1233+ 88B0 FE 8A        @OUT:			CP      138
1234+ 88B2 EA 97 88     			JP      PE,OUTCHR
1235+ 88B5 C5           			PUSH    BC
1236+ 88B6 E5           			PUSH    HL
1237+ 88B7 21 50 81     			LD      HL,KEYWDS
1238+ 88BA 01 DF 02     			LD      BC,KEYWDL
1239+ 88BD ED B1        			CPIR
1240+ 88BF 7E           TOKEN1:			LD      A,(HL)
1241+ 88C0 23           			INC     HL
1242+ 88C1 FE 8A        			CP      138
1243+ 88C3 F5           			PUSH    AF
1244+ 88C4 EC 97 88     			CALL    PE,OUTCHR
1245+ 88C7 F1           			POP     AF
1246+ 88C8 EA BF 88     			JP      PE,TOKEN1
1247+ 88CB E1           			POP     HL
1248+ 88CC C1           			POP     BC
1249+ 88CD C9           			RET
1250+ 88CE              ;
1251+ 88CE              ;FINDL - FIND PROGRAM LINE.
1252+ 88CE              ;   Inputs: HL = line number (binary)
1253+ 88CE              ;  Outputs: HL addresses line (if found)
1254+ 88CE              ;           DE = line number
1255+ 88CE              ;           Z-flag set if found.
1256+ 88CE              ; Destroys: A,B,C,D,E,H,L,F
1257+ 88CE              ;
1258+ 88CE EB           @FINDL:			EX      DE,HL
1259+ 88CF 2A DC B5     			LD      HL,(PAGE)
1260+ 88D2 AF           			XOR     A               ;A=0
1261+ 88D3 BE           			CP      (HL)
1262+ 88D4 3C           			INC     A
1263+ 88D5 D0           			RET     NC
1264+ 88D6 AF           			XOR     A               ;CLEAR CARRY
1265+ 88D7 47           			LD      B,A
1266+ 88D8 4E           FINDL1:			LD      C,(HL)
1267+ 88D9 E5           			PUSH    HL
1268+ 88DA 23           			INC     HL
1269+ 88DB 7E           			LD      A,(HL)
1270+ 88DC 23           			INC     HL
1271+ 88DD 66           			LD      H,(HL)
1272+ 88DE 6F           			LD      L,A
1273+ 88DF ED 52        			SBC     HL,DE
1274+ 88E1 E1           			POP     HL
1275+ 88E2 D0           			RET     NC              ;FOUND OR PAST
1276+ 88E3 09           			ADD     HL,BC
1277+ 88E4 C3 D8 88     			JP      FINDL1
1278+ 88E7              ;
1279+ 88E7              ;SETLIN - Search program for line containing address.
1280+ 88E7              ;         Update (LINENO).
1281+ 88E7              ;   Inputs: Address in (ERRLIN)
1282+ 88E7              ;  Outputs: Line number in HL and (LINENO)
1283+ 88E7              ; Destroys: B,C,D,E,H,L,F
1284+ 88E7              ;
1285+ 88E7 06 00        @SETLIN:		LD      B,0
1286+ 88E9 ED 5B F4 B5  			LD      DE,(ERRLIN)
1287+ 88ED 2A DC B5     			LD      HL,(PAGE)
1288+ 88F0 B7           			OR      A
1289+ 88F1 ED 52        			SBC     HL,DE
1290+ 88F3 19           			ADD     HL,DE
1291+ 88F4 30 16        			JR      NC,SET3
1292+ 88F6 4E           SET1:			LD      C,(HL)
1293+ 88F7 0C           			INC     C
1294+ 88F8 0D           			DEC     C
1295+ 88F9 28 11        			JR      Z,SET3
1296+ 88FB 09           			ADD     HL,BC
1297+ 88FC ED 52        			SBC     HL,DE
1298+ 88FE 19           			ADD     HL,DE
1299+ 88FF 38 F5        			JR      C,SET1
1300+ 8901 ED 42        			SBC     HL,BC
1301+ 8903 23           			INC     HL
1302+ 8904 5E           			LD      E,(HL)          ;LINE NUMBER
1303+ 8905 23           			INC     HL
1304+ 8906 56           			LD      D,(HL)
1305+ 8907 EB           			EX      DE,HL
1306+ 8908 22 E6 B5     SET2:			LD      (LINENO),HL
1307+ 890B C9           			RET
1308+ 890C 21 00 00     SET3:			LD      HL,0
1309+ 890F 18 F7        			JR      SET2
1310+ 8911              ;
1311+ 8911              ;SAYLN - PRINT " at line nnnn" MESSAGE.
1312+ 8911              ;  Outputs: Carry=0 if line number is zero.
1313+ 8911              ;           Carry=1 if line number is non-zero.
1314+ 8911              ; Destroys: A,B,C,D,E,H,L,F
1315+ 8911              ;
1316+ 8911 2A E6 B5     @SAYLN:			LD      HL,(LINENO)
1317+ 8914 7C           			LD      A,H
1318+ 8915 B5           			OR      L
1319+ 8916 C8           			RET     Z
1320+ 8917 CD 4E 8C     			CALL    TELL
1321+ 891A 20 61 74 20  			DEFM    ' at line '
1321+ 891E 6C 69 6E 65
1321+ 8922 20
1322+ 8923 00           			DEFB    0
1323+ 8924 0E 00        @PBCDL:			LD      C,0
1324+ 8926 18 02        			JR      PBCD0
1325+ 8928              ;
1326+ 8928              ;PBCD - PRINT NUMBER AS DECIMAL INTEGER.
1327+ 8928              ;   Inputs: HL = number (binary).
1328+ 8928              ;  Outputs: Carry = 1
1329+ 8928              ; Destroys: A,B,C,D,E,H,L,F
1330+ 8928              ;
1331+ 8928 0E 20        PBCD:			LD      C,' '
1332+ 892A 06 05        PBCD0:			LD      B,5
1333+ 892C 11 10 27     			LD      DE,10000
1334+ 892F AF           PBCD1:			XOR     A
1335+ 8930 ED 52        PBCD2:			SBC     HL,DE
1336+ 8932 3C           			INC     A
1337+ 8933 30 FB        			JR      NC,PBCD2
1338+ 8935 19           			ADD     HL,DE
1339+ 8936 3D           			DEC     A
1340+ 8937 28 04        			JR      Z,PBCD3
1341+ 8939 CB E1        			SET     4,C
1342+ 893B CB E9        			SET     5,C
1343+ 893D B1           PBCD3:			OR      C
1344+ 893E C4 97 88     			CALL    NZ,OUTCHR
1345+ 8941 78           			LD      A,B
1346+ 8942 FE 05        			CP      5
1347+ 8944 28 06        			JR      Z,PBCD4
1348+ 8946 29           			ADD     HL,HL
1349+ 8947 54           			LD      D,H
1350+ 8948 5D           			LD      E,L
1351+ 8949 29           			ADD     HL,HL
1352+ 894A 29           			ADD     HL,HL
1353+ 894B 19           			ADD     HL,DE
1354+ 894C 11 E8 03     PBCD4:			LD      DE,1000
1355+ 894F 10 DE        			DJNZ    PBCD1
1356+ 8951 37           			SCF
1357+ 8952 C9           			RET
1358+ 8953              ;
1359+ 8953              ;PUTVAR - CREATE VARIABLE AND INITIALISE TO ZERO.
1360+ 8953              ;   Inputs: HL, IY as returned from GETVAR (NZ).
1361+ 8953              ;  Outputs: As GETVAR.
1362+ 8953              ; Destroys: everything
1363+ 8953              ;
1364+ 8953 CD A0 8A     @PUTVAR:		CALL    CREATE
1365+ 8956 FD 7E 00     			LD      A,(IY)
1366+ 8959 FE 28        			CP      '('
1367+ 895B 20 68        			JR      NZ,GETVZ        ;SET EXIT CONDITIONS
1368+ 895D 3E 0E        ARRAY:			LD      A,14            ;'Array'
1369+ 895F C3 FE 86     ERROR3:			JP      ERROR
1370+ 8962              ;
1371+ 8962              ;GETVAR - GET LOCATION OF VARIABLE, RETURN IN HL & IX
1372+ 8962              ;   Inputs: IY addresses first character.
1373+ 8962              ;  Outputs: Carry set and NZ if illegal character.
1374+ 8962              ;           Z-flag set if variable found, then:
1375+ 8962              ;            A = variable type (0,4,5,128 or 129)
1376+ 8962              ;            HL = IX = variable pointer.
1377+ 8962              ;            IY updated
1378+ 8962              ;           If Z-flag & carry reset, then:
1379+ 8962              ;            HL, IY set for subsequent PUTVAR call.
1380+ 8962              ; Destroys: everything
1381+ 8962              ;
1382+ 8962 FD 7E 00     @GETVAR:		LD      A,(IY)
1383+ 8965 FE 24        			CP      '$'
1384+ 8967 28 62        			JR      Z,GETV4
1385+ 8969 FE 21        			CP      '!'
1386+ 896B 28 62        			JR      Z,GETV5
1387+ 896D FE 3F        			CP      '?'
1388+ 896F 28 62        			JR      Z,GETV6
1389+ 8971 CD 18 8A     			CALL    LOCATE
1390+ 8974 C0           			RET     NZ
1391+ 8975 FD 7E 00     			LD      A,(IY)
1392+ 8978 FE 28        			CP      '('             ;ARRAY?
1393+ 897A 20 41        			JR      NZ,GETVX        ;EXIT
1394+ 897C D5           			PUSH    DE              ;SAVE TYPE
1395+ 897D 7E           			LD      A,(HL)          ;NO. OF DIMENSIONS
1396+ 897E B7           			OR      A
1397+ 897F 28 DC        			JR      Z,ARRAY
1398+ 8981 23           			INC     HL
1399+ 8982 11 00 00     			LD      DE,0            ;ACCUMULATOR
1400+ 8985 F5           			PUSH    AF
1401+ 8986 FD 23        			INC     IY              ;SKIP (
1402+ 8988 18 04        			JR      GETV3
1403+ 898A F5           GETV2:			PUSH    AF
1404+ 898B CD 51 A4     			CALL    COMMA
1405+ 898E E5           GETV3:			PUSH    HL
1406+ 898F D5           			PUSH    DE
1407+ 8990 CD B5 9E     			CALL    EXPRI           ;SUBSCRIPT
1408+ 8993 D9           			EXX
1409+ 8994 D1           			POP     DE
1410+ 8995 E3           			EX      (SP),HL
1411+ 8996 4E           			LD      C,(HL)
1412+ 8997 23           			INC     HL
1413+ 8998 46           			LD      B,(HL)
1414+ 8999 23           			INC     HL
1415+ 899A E3           			EX      (SP),HL
1416+ 899B EB           			EX      DE,HL
1417+ 899C D5           			PUSH    DE
1418+ 899D CD C6 97     			CALL    MUL16           ;HL=HL*BC
1419+ 89A0 D1           			POP     DE
1420+ 89A1 19           			ADD     HL,DE
1421+ 89A2 EB           			EX      DE,HL
1422+ 89A3 B7           			OR      A
1423+ 89A4 ED 42        			SBC     HL,BC
1424+ 89A6 3E 0F        			LD      A,15
1425+ 89A8 30 B5        			JR      NC,ERROR3       ;"Subscript"
1426+ 89AA E1           			POP     HL
1427+ 89AB F1           			POP     AF
1428+ 89AC 3D           			DEC     A               ;DIMENSION COUNTER
1429+ 89AD 20 DB        			JR      NZ,GETV2
1430+ 89AF CD 5D A4     			CALL    BRAKET          ;CLOSING BRACKET
1431+ 89B2 F1           			POP     AF              ;RESTORE TYPE
1432+ 89B3 E5           			PUSH    HL
1433+ 89B4 CD B9 97     			CALL    X4OR5           ;DE=DE*n
1434+ 89B7 E1           			POP     HL
1435+ 89B8 19           			ADD     HL,DE
1436+ 89B9 57           			LD      D,A             ;TYPE
1437+ 89BA FD 7E 00     			LD      A,(IY)
1438+ 89BD FE 3F        GETVX:			CP      '?'
1439+ 89BF 28 1D        			JR      Z,GETV9
1440+ 89C1 FE 21        			CP      '!'
1441+ 89C3 28 15        			JR      Z,GETV8
1442+ 89C5 E5           GETVZ:			PUSH    HL              ;SET EXIT CONDITIONS
1443+ 89C6 DD E1        			POP     IX
1444+ 89C8 7A           			LD      A,D
1445+ 89C9 BF           			CP      A
1446+ 89CA C9           			RET
1447+ 89CB              ;
1448+ 89CB              ;PROCESS UNARY & BINARY INDIRECTION:
1449+ 89CB              ;
1450+ 89CB 3E 80        GETV4:			LD      A,128           ;STATIC STRING
1451+ 89CD 18 05        			JR      GETV7
1452+ 89CF 3E 04        GETV5:			LD      A,4             ;UNARY 32-BIT INDIRN.
1453+ 89D1 18 01        			JR      GETV7
1454+ 89D3 AF           GETV6:			XOR     A               ;UNARY 8-BIT INDIRECTION
1455+ 89D4 21 00 00     GETV7:			LD      HL,0
1456+ 89D7 F5           			PUSH    AF
1457+ 89D8 18 15        			JR      GETV0
1458+ 89DA              ;
1459+ 89DA 06 04        GETV8:			LD      B,4             ;32-BIT BINARY INDIRN.
1460+ 89DC 18 02        			JR      GETVA
1461+ 89DE 06 00        GETV9:			LD      B,0             ;8-BIT BINARY INDIRN.
1462+ 89E0 E5           GETVA:			PUSH    HL
1463+ 89E1 DD E1        			POP     IX
1464+ 89E3 7A           			LD      A,D             ;TYPE
1465+ 89E4 FE 81        			CP      129
1466+ 89E6 C8           			RET     Z               ;STRING!
1467+ 89E7 C5           			PUSH    BC
1468+ 89E8 CD 6E 9F     			CALL    LOADN           ;LEFT OPERAND
1469+ 89EB CD 5C A1     			CALL    SFIX
1470+ 89EE D9           			EXX
1471+ 89EF E5           GETV0:			PUSH    HL
1472+ 89F0 FD 23        			INC     IY
1473+ 89F2 CD CC 9E     			CALL    ITEMI
1474+ 89F5 D9           			EXX
1475+ 89F6 D1           			POP     DE
1476+ 89F7 F1           			POP     AF
1477+ 89F8 19           			ADD     HL,DE
1478+ 89F9 E5           			PUSH    HL
1479+ 89FA DD E1        			POP     IX
1480+ 89FC BF           			CP      A
1481+ 89FD C9           			RET
1482+ 89FE              ;
1483+ 89FE              ;GETDEF - Find entry for FN or PROC in dynamic area.
1484+ 89FE              ;   Inputs: IY addresses byte following "DEF" token.
1485+ 89FE              ;  Outputs: Z flag set if found
1486+ 89FE              ;           Carry set if neither FN or PROC first.
1487+ 89FE              ;           If Z: HL points to entry
1488+ 89FE              ;                 IY addresses delimiter
1489+ 89FE              ; Destroys: A,D,E,H,L,IY,F
1490+ 89FE              ;
1491+ 89FE FD 7E 01     @GETDEF:		LD      A,(IY+1)
1492+ 8A01 CD 55 8B     			CALL    RANGE1
1493+ 8A04 D8           			RET     C
1494+ 8A05 FD 7E 00     			LD      A,(IY)
1495+ 8A08 21 D8 B5     			LD      HL,FNPTR
1496+ 8A0B FE A4        			CP      FN
1497+ 8A0D 28 43        			JR      Z,LOC2
1498+ 8A0F 21 DA B5     			LD      HL,PROPTR
1499+ 8A12 FE F2        			CP      PROC
1500+ 8A14 28 3C        			JR      Z,LOC2
1501+ 8A16 37           			SCF
1502+ 8A17 C9           			RET
1503+ 8A18              ;
1504+ 8A18              ;LOCATE - Try to locate variable name in static or
1505+ 8A18              ;dynamic variables.  If illegal first character return
1506+ 8A18              ;carry, non-zero.  If found, return no-carry, zero.
1507+ 8A18              ;If not found, return no-carry, non-zero.
1508+ 8A18              ;   Inputs: IY addresses first character of name.
1509+ 8A18              ;           A=(IY)
1510+ 8A18              ;  Outputs: Z-flag set if found, then:
1511+ 8A18              ;            IY addresses terminator
1512+ 8A18              ;            HL addresses location of variable
1513+ 8A18              ;            D=type of variable:  4 = integer
1514+ 8A18              ;                                 5 = floating point
1515+ 8A18              ;                               129 = string
1516+ 8A18              ; Destroys: A,D,E,H,L,IY,F
1517+ 8A18              ;
1518+ 8A18 D6 40        LOCATE:			SUB     '@'
1519+ 8A1A D8           			RET     C
1520+ 8A1B 26 00        			LD      H,0
1521+ 8A1D FE 1B        			CP      'Z'-'@'+1
1522+ 8A1F 30 1D        			JR      NC,LOC0         ;NOT STATIC
1523+ 8A21 87           			ADD     A,A
1524+ 8A22 6F           			LD      L,A
1525+ 8A23 FD 7E 01     			LD      A,(IY+1)        ;2nd CHARACTER
1526+ 8A26 FE 25        			CP      '%'
1527+ 8A28 20 20        			JR      NZ,LOC1         ;NOT STATIC
1528+ 8A2A FD 7E 02     			LD      A,(IY+2)
1529+ 8A2D FE 28        			CP      '('
1530+ 8A2F 28 19        			JR      Z,LOC1          ;NOT STATIC
1531+ 8A31 29           			ADD     HL,HL
1532+ 8A32 11 00 B5     			LD      DE,STAVAR       ;STATIC VARIABLES
1533+ 8A35 19           			ADD     HL,DE
1534+ 8A36 FD 23        			INC     IY
1535+ 8A38 FD 23        			INC     IY
1536+ 8A3A 16 04        			LD      D,4             ;INTEGER TYPE
1537+ 8A3C AF           			XOR     A
1538+ 8A3D C9           			RET
1539+ 8A3E              ;
1540+ 8A3E FE 1F        LOC0:			CP      '_'-'@'
1541+ 8A40 D8           			RET     C
1542+ 8A41 FE 3B        			CP      'z'-'@'+1
1543+ 8A43 3F           			CCF
1544+ 8A44 3D           			DEC     A               ;SET NZ
1545+ 8A45 D8           			RET     C
1546+ 8A46 D6 03        			SUB     3
1547+ 8A48 87           			ADD     A,A
1548+ 8A49 6F           			LD      L,A
1549+ 8A4A 11 6C B5     LOC1:			LD      DE,DYNVAR       ;DYNAMIC VARIABLES
1550+ 8A4D 2D           			DEC     L
1551+ 8A4E 2D           			DEC     L
1552+ 8A4F 37           			SCF
1553+ 8A50 F8           			RET     M
1554+ 8A51 19           			ADD     HL,DE
1555+ 8A52 5E           LOC2:			LD      E,(HL)
1556+ 8A53 23           			INC     HL
1557+ 8A54 56           			LD      D,(HL)
1558+ 8A55 7A           			LD      A,D
1559+ 8A56 B3           			OR      E
1560+ 8A57 28 45        			JR      Z,LOC6          ;UNDEFINED VARIABLE
1561+ 8A59 62           			LD      H,D
1562+ 8A5A 6B           			LD      L,E
1563+ 8A5B 23           			INC     HL              ;SKIP LINK
1564+ 8A5C 23           			INC     HL
1565+ 8A5D FD E5        			PUSH    IY
1566+ 8A5F 7E           LOC3:			LD      A,(HL)          ;COMPARE
1567+ 8A60 23           			INC     HL
1568+ 8A61 FD 23        			INC     IY
1569+ 8A63 FD BE 00     			CP      (IY)
1570+ 8A66 28 F7        			JR      Z,LOC3
1571+ 8A68 B7           			OR      A               ;0=TERMINATOR
1572+ 8A69 28 06        			JR      Z,LOC5          ;FOUND (MAYBE)
1573+ 8A6B FD E1        LOC4:			POP     IY
1574+ 8A6D EB           			EX      DE,HL
1575+ 8A6E C3 52 8A     			JP      LOC2            ;TRY NEXT ENTRY
1576+ 8A71              ;
1577+ 8A71 FD 2B        LOC5:			DEC     IY
1578+ 8A73 FD 7E 00     			LD      A,(IY)
1579+ 8A76 FE 28        			CP      '('
1580+ 8A78 28 13        			JR      Z,LOC5A         ;FOUND
1581+ 8A7A FD 23        			INC     IY
1582+ 8A7C CD 49 8B     			CALL    RANGE
1583+ 8A7F 38 0C        			JR      C,LOC5A         ;FOUND
1584+ 8A81 FE 28        			CP      '('
1585+ 8A83 28 E6        			JR      Z,LOC4          ;KEEP LOOKING
1586+ 8A85 FD 7E FF     			LD      A,(IY-1)
1587+ 8A88 CD 55 8B     			CALL    RANGE1
1588+ 8A8B 30 DE        			JR      NC,LOC4         ;KEEP LOOKING
1589+ 8A8D D1           LOC5A:			POP     DE
1590+ 8A8E FD 7E FF     TYPE:			LD      A,(IY-1)
1591+ 8A91 FE 24        			CP      '$'
1592+ 8A93 16 81        			LD      D,129
1593+ 8A95 C8           			RET     Z               ;STRING
1594+ 8A96 FE 25        			CP      '%'
1595+ 8A98 16 04        			LD      D,4
1596+ 8A9A C8           			RET     Z               ;INTEGER
1597+ 8A9B 14           			INC     D
1598+ 8A9C BF           			CP      A
1599+ 8A9D C9           			RET
1600+ 8A9E              ;
1601+ 8A9E 3C           LOC6:			INC     A               ;SET NZ
1602+ 8A9F C9           			RET
1603+ 8AA0              ;
1604+ 8AA0              ;CREATE - CREATE NEW ENTRY, INITIALISE TO ZERO.
1605+ 8AA0              ;   Inputs: HL, IY as returned from LOCATE (NZ).
1606+ 8AA0              ;  Outputs: As LOCATE, GETDEF.
1607+ 8AA0              ; Destroys: As LOCATE, GETDEF.
1608+ 8AA0              ;
1609+ 8AA0 AF           @CREATE:		XOR     A
1610+ 8AA1 ED 5B E2 B5  			LD      DE,(FREE)
1611+ 8AA5 72           			LD      (HL),D
1612+ 8AA6 2B           			DEC     HL
1613+ 8AA7 73           			LD      (HL),E
1614+ 8AA8 EB           			EX      DE,HL
1615+ 8AA9 77           			LD      (HL),A
1616+ 8AAA 23           			INC     HL
1617+ 8AAB 77           			LD      (HL),A
1618+ 8AAC 23           			INC     HL
1619+ 8AAD FD 23        LOC7:			INC     IY
1620+ 8AAF CD 49 8B     			CALL    RANGE           ;END OF VARIABLE?
1621+ 8AB2 38 14        			JR      C,LOC8
1622+ 8AB4 77           			LD      (HL),A
1623+ 8AB5 23           			INC     HL
1624+ 8AB6 CD 55 8B     			CALL    RANGE1
1625+ 8AB9 30 F2        			JR      NC,LOC7
1626+ 8ABB FE 28        			CP      '('
1627+ 8ABD 28 09        			JR      Z,LOC8
1628+ 8ABF FD 7E 01     			LD      A,(IY+1)
1629+ 8AC2 FE 28        			CP      '('
1630+ 8AC4 28 E7        			JR      Z,LOC7
1631+ 8AC6 FD 23        			INC     IY
1632+ 8AC8 36 00        LOC8:			LD      (HL),0          ;TERMINATOR
1633+ 8ACA 23           			INC     HL
1634+ 8ACB E5           			PUSH    HL
1635+ 8ACC CD 8E 8A     			CALL    TYPE
1636+ 8ACF 3E 05        			LD      A,5
1637+ 8AD1 BA           			CP      D
1638+ 8AD2 28 01        			JR      Z,LOC9
1639+ 8AD4 3D           			DEC     A
1640+ 8AD5 36 00        LOC9:			LD      (HL),0          ;INITIALISE TO ZERO
1641+ 8AD7 23           			INC     HL
1642+ 8AD8 3D           			DEC     A
1643+ 8AD9 20 FA        			JR      NZ,LOC9
1644+ 8ADB 22 E2 B5     			LD      (FREE),HL
1645+ 8ADE CD E2 95     			CALL    CHECK
1646+ 8AE1 E1           			POP     HL
1647+ 8AE2 AF           			XOR     A
1648+ 8AE3 C9           			RET
1649+ 8AE4              ;
1650+ 8AE4              ;LINNUM - GET LINE NUMBER FROM TEXT STRING
1651+ 8AE4              ;   Inputs: IY = Text Pointer
1652+ 8AE4              ;  Outputs: HL = Line number (zero if none)
1653+ 8AE4              ;           IY updated
1654+ 8AE4              ; Destroys: A,D,E,H,L,IY,F
1655+ 8AE4              ;
1656+ 8AE4 CD 99 A4     LINNUM:			CALL    NXT
1657+ 8AE7 21 00 00     			LD      HL,0
1658+ 8AEA FD 7E 00     LINNM1:			LD      A,(IY)
1659+ 8AED D6 30        			SUB     '0'
1660+ 8AEF D8           			RET     C
1661+ 8AF0 FE 0A        			CP      10
1662+ 8AF2 D0           			RET     NC
1663+ 8AF3 FD 23        			INC     IY
1664+ 8AF5 54           			LD      D,H
1665+ 8AF6 5D           			LD      E,L
1666+ 8AF7 29           			ADD     HL,HL           ;*2
1667+ 8AF8 38 0F        			JR      C,TOOBIG
1668+ 8AFA 29           			ADD     HL,HL           ;*4
1669+ 8AFB 38 0C        			JR      C,TOOBIG
1670+ 8AFD 19           			ADD     HL,DE           ;*5
1671+ 8AFE 38 09        			JR      C,TOOBIG
1672+ 8B00 29           			ADD     HL,HL           ;*10
1673+ 8B01 38 06        			JR      C,TOOBIG
1674+ 8B03 5F           			LD      E,A
1675+ 8B04 16 00        			LD      D,0
1676+ 8B06 19           			ADD     HL,DE           ;ADD IN DIGIT
1677+ 8B07 30 E1        			JR      NC,LINNM1
1678+ 8B09 3E 14        TOOBIG:			LD      A,20
1679+ 8B0B C3 FE 86     			JP      ERROR           ;"Too big"
1680+ 8B0E              ;
1681+ 8B0E              ;PAIR - GET PAIR OF LINE NUMBERS FOR RENUMBER/AUTO.
1682+ 8B0E              ;   Inputs: IY = text pointer
1683+ 8B0E              ;  Outputs: HL = first number (10 by default)
1684+ 8B0E              ;           BC = second number (10 by default)
1685+ 8B0E              ; Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IY,F
1686+ 8B0E              ;
1687+ 8B0E CD E4 8A     PAIR:			CALL    LINNUM          ;FIRST
1688+ 8B11 7C           			LD      A,H
1689+ 8B12 B5           			OR      L
1690+ 8B13 20 02        			JR      NZ,PAIR1
1691+ 8B15 2E 0A        			LD      L,10
1692+ 8B17 CD E5 96     PAIR1:			CALL    TERM?
1693+ 8B1A FD 23        			INC     IY
1694+ 8B1C E5           			PUSH    HL
1695+ 8B1D 21 0A 00     			LD      HL,10
1696+ 8B20 C4 E4 8A     			CALL    NZ,LINNUM       ;SECOND
1697+ 8B23 E3           			EX      (SP),HL
1698+ 8B24 C1           			POP     BC
1699+ 8B25 78           			LD      A,B
1700+ 8B26 B1           			OR      C
1701+ 8B27 C0           			RET     NZ
1702+ 8B28 CD 13 87     			CALL    EXTERR
1703+ 8B2B 53 69 6C 6C  			DEFM    'Silly'
1703+ 8B2F 79
1704+ 8B30 00           			DEFB    0
1705+ 8B31              ;
1706+ 8B31              ;DLPAIR - GET PAIR OF LINE NUMBERS FOR DELETE/LIST.
1707+ 8B31              ;   Inputs: IY = text pointer
1708+ 8B31              ;  Outputs: HL = points to program text
1709+ 8B31              ;           BC = second number (0 by default)
1710+ 8B31              ; Destroys: A,B,C,D,E,H,L,IY,F
1711+ 8B31              ;
1712+ 8B31 CD E4 8A     DLPAIR:			CALL    LINNUM
1713+ 8B34 E5           			PUSH    HL
1714+ 8B35 CD E5 96     			CALL    TERM?
1715+ 8B38 28 09        			JR      Z,DLP1
1716+ 8B3A FE E7        			CP      TIF
1717+ 8B3C 28 05        			JR      Z,DLP1
1718+ 8B3E FD 23        			INC     IY
1719+ 8B40 CD E4 8A     			CALL    LINNUM
1720+ 8B43 E3           DLP1:			EX      (SP),HL
1721+ 8B44 CD CE 88     			CALL    FINDL
1722+ 8B47 C1           			POP     BC
1723+ 8B48 C9           			RET
1724+ 8B49              ;
1725+ 8B49              ;TEST FOR VALID CHARACTER IN VARIABLE NAME:
1726+ 8B49              ;   Inputs: IY addresses character
1727+ 8B49              ;  Outputs: Carry set if out-of-range.
1728+ 8B49              ; Destroys: A,F
1729+ 8B49              ;
1730+ 8B49 FD 7E 00     @RANGE:			LD      A,(IY)
1731+ 8B4C FE 24        			CP      '$'
1732+ 8B4E C8           			RET     Z
1733+ 8B4F FE 25        			CP      '%'
1734+ 8B51 C8           			RET     Z
1735+ 8B52 FE 28        			CP      '('
1736+ 8B54 C8           			RET     Z
1737+ 8B55 FE 30        RANGE1:			CP      '0'
1738+ 8B57 D8           			RET     C
1739+ 8B58 FE 3A        			CP      '9'+1
1740+ 8B5A 3F           			CCF
1741+ 8B5B D0           			RET     NC
1742+ 8B5C FE 40        			CP      '@'             ;V2.4
1743+ 8B5E C8           			RET     Z
1744+ 8B5F FE 41        RANGE2:			CP      'A'
1745+ 8B61 D8           			RET     C
1746+ 8B62 FE 5B        			CP      'Z'+1
1747+ 8B64 3F           			CCF
1748+ 8B65 D0           			RET     NC
1749+ 8B66 FE 5F        			CP      '_'
1750+ 8B68 D8           			RET     C
1751+ 8B69 FE 7B        			CP      'z'+1
1752+ 8B6B 3F           			CCF
1753+ 8B6C C9           			RET
1754+ 8B6D              ;
1755+ 8B6D AF           SPACE: 			XOR     A
1756+ 8B6E CD 13 87     			CALL    EXTERR          ;"LINE space"
1757+ 8B71 86           			DEFB    LINE
1758+ 8B72 08           			DEFB    8
1759+ 8B73 00           			DEFB    0
1760+ 8B74              ;
1761+ 8B74              ;LEXAN - LEXICAL ANALYSIS.
1762+ 8B74              ;  Bit 0,C: 1=left, 0=right
1763+ 8B74              ;  Bit 3,C: 1=in HEX
1764+ 8B74              ;  Bit 4,C: 1=accept line number
1765+ 8B74              ;  Bit 5,C: 1=in variable, FN, PROC
1766+ 8B74              ;  Bit 6,C: 1=in REM, DATA, *
1767+ 8B74              ;  Bit 7,C: 1=in quotes
1768+ 8B74              ;   Inputs: IY addresses source string
1769+ 8B74              ;           DE addresses destination string
1770+ 8B74              ;           (must be page boundary)
1771+ 8B74              ;           C  sets initial mode
1772+ 8B74              ;  Outputs: DE, IY updated
1773+ 8B74              ;           A holds carriage return
1774+ 8B74              ;
1775+ 8B74 12           LEXAN1:			LD      (DE),A          ;TRANSFER TO BUFFER
1776+ 8B75 13           			INC     DE              ;INCREMENT POINTERS
1777+ 8B76 FD 23        			INC     IY
1778+ 8B78 7B           @LEXAN2:		LD      A,E             ;MAIN ENTRY
1779+ 8B79 FE FC        			CP      252             ;TEST LENGTH
1780+ 8B7B 30 F0        			JR      NC,SPACE        ;LINE TOO LONG
1781+ 8B7D FD 7E 00     			LD      A,(IY)
1782+ 8B80 FE 0D        			CP      CR
1783+ 8B82 C8           			RET     Z               ;END OF LINE
1784+ 8B83 CD 55 8B     			CALL    RANGE1
1785+ 8B86 30 04        			JR      NC,LEXAN3
1786+ 8B88 CB A9        			RES     5,C             ;NOT IN VARIABLE
1787+ 8B8A CB 99        			RES     3,C             ;NOT IN HEX
1788+ 8B8C FE 20        LEXAN3:			CP      ' '
1789+ 8B8E 28 E4        			JR      Z,LEXAN1        ;PASS SPACES
1790+ 8B90 FE 2C        			CP      ','
1791+ 8B92 28 E0        			JR      Z,LEXAN1        ;PASS COMMAS
1792+ 8B94 FE 47        			CP      'G'
1793+ 8B96 38 02        			JR      C,LEXAN4
1794+ 8B98 CB 99        			RES     3,C             ;NOT IN HEX
1795+ 8B9A FE 22        LEXAN4:			CP      34		;ASCII ""
1796+ 8B9C 20 05        			JR      NZ,LEXAN5
1797+ 8B9E CB 11        			RL      C
1798+ 8BA0 3F           			CCF                     ;TOGGLE C7
1799+ 8BA1 CB 19        			RR      C
1800+ 8BA3 CB 61        LEXAN5:			BIT     4,C
1801+ 8BA5 28 10        			JR      Z,LEXAN6
1802+ 8BA7 CB A1        			RES     4,C
1803+ 8BA9 C5           			PUSH    BC
1804+ 8BAA D5           			PUSH    DE
1805+ 8BAB CD E4 8A     			CALL    LINNUM          ;GET LINE NUMBER
1806+ 8BAE D1           			POP     DE
1807+ 8BAF C1           			POP     BC
1808+ 8BB0 7C           			LD      A,H
1809+ 8BB1 B5           			OR      L
1810+ 8BB2 C4 1C 8C     			CALL    NZ,ENCODE       ;ENCODE LINE NUMBER
1811+ 8BB5 18 C1        			JR      LEXAN2          ;CONTINUE
1812+ 8BB7              ;
1813+ 8BB7 0D           LEXAN6:			DEC     C
1814+ 8BB8 28 09        			JR      Z,LEXAN7        ;C=1 (LEFT)
1815+ 8BBA 0C           			INC     C
1816+ 8BBB 20 B7        			JR      NZ,LEXAN1
1817+ 8BBD B7           			OR      A
1818+ 8BBE F4 52 87     			CALL    P,LEX           ;TOKENISE IF POSS.
1819+ 8BC1 18 12        			JR      LEXAN8
1820+ 8BC3              ;
1821+ 8BC3 FE 2A        LEXAN7:			CP      '*'
1822+ 8BC5 28 16        			JR      Z,LEXAN9
1823+ 8BC7 B7           			OR      A
1824+ 8BC8 F4 52 87     			CALL    P,LEX           ;TOKENISE IF POSS.
1825+ 8BCB FE 8F        			CP      TOKLO
1826+ 8BCD 38 06        			JR      C,LEXAN8
1827+ 8BCF FE 94        			CP      TOKHI+1
1828+ 8BD1 30 02        			JR      NC,LEXAN8
1829+ 8BD3 C6 40        			ADD     A,OFFSET        ;LEFT VERSION
1830+ 8BD5 FE F4        LEXAN8:			CP      REM
1831+ 8BD7 28 04        			JR      Z,LEXAN9
1832+ 8BD9 FE DC        			CP      DATA
1833+ 8BDB 20 02        			JR      NZ,LEXANA
1834+ 8BDD CB F1        LEXAN9:			SET     6,C             ;QUIT TOKENISING
1835+ 8BDF FE A4        LEXANA:			CP      FN
1836+ 8BE1 28 09        			JR      Z,LEXANB
1837+ 8BE3 FE F2        			CP      PROC
1838+ 8BE5 28 05        			JR      Z,LEXANB
1839+ 8BE7 CD 5F 8B     			CALL    RANGE2
1840+ 8BEA 38 02        			JR      C,LEXANC
1841+ 8BEC CB E9        LEXANB:			SET     5,C             ;IN VARIABLE/FN/PROC
1842+ 8BEE FE 26        LEXANC:			CP      '&'
1843+ 8BF0 20 02        			JR      NZ,LEXAND
1844+ 8BF2 CB D9        			SET     3,C             ;IN HEX
1845+ 8BF4 21 13 8C     LEXAND:			LD      HL,LIST1
1846+ 8BF7 C5           			PUSH    BC
1847+ 8BF8 01 06 00     			LD      BC,LIST1L
1848+ 8BFB ED B1        			CPIR
1849+ 8BFD C1           			POP     BC
1850+ 8BFE 20 02        			JR      NZ,LEXANE
1851+ 8C00 CB E1        			SET     4,C             ;ACCEPT LINE NUMBER
1852+ 8C02 21 17 8C     LEXANE:			LD      HL,LIST2
1853+ 8C05 C5           			PUSH    BC
1854+ 8C06 01 05 00     			LD      BC,LIST2L
1855+ 8C09 ED B1        			CPIR
1856+ 8C0B C1           			POP     BC
1857+ 8C0C 20 02        			JR      NZ,LEXANF
1858+ 8C0E CB C1        			SET     0,C             ;ENTER LEFT MODE
1859+ 8C10 C3 74 8B     LEXANF:			JP      LEXAN1
1860+ 8C13              ;
1861+ 8C13 E5           LIST1:			DEFB    GOTO
1862+ 8C14 E4           			DEFB    GOSUB
1863+ 8C15 F7           			DEFB    RESTOR
1864+ 8C16 FC           			DEFB    TRACE
1865+ 8C17 8C           LIST2:			DEFB    THEN
1866+ 8C18 8B           			DEFB    ELSE
1867+ 8C19              LIST1L:			EQU     $-LIST1
1868+ 8C19 F5           			DEFB    REPEAT
1869+ 8C1A 85           			DEFB    TERROR
1870+ 8C1B 3A           			DEFB    ':'
1871+ 8C1C              LIST2L:			EQU     $-LIST2
1872+ 8C1C              ;
1873+ 8C1C              ;ENCODE - ENCODE LINE NUMBER INTO PSEUDO-BINARY FORM.
1874+ 8C1C              ;   Inputs: HL=line number, DE=string pointer
1875+ 8C1C              ;  Outputs: DE updated, BIT 4,C set.
1876+ 8C1C              ; Destroys: A,B,C,D,E,H,L,F
1877+ 8C1C              ;
1878+ 8C1C CB E1        ENCODE:			SET     4,C
1879+ 8C1E EB           			EX      DE,HL
1880+ 8C1F 36 8D        			LD      (HL),LINO
1881+ 8C21 23           			INC     HL
1882+ 8C22 7A           			LD      A,D
1883+ 8C23 E6 C0        			AND     0C0H
1884+ 8C25 0F           			RRCA
1885+ 8C26 0F           			RRCA
1886+ 8C27 47           			LD      B,A
1887+ 8C28 7B           			LD      A,E
1888+ 8C29 E6 C0        			AND     0C0H
1889+ 8C2B B0           			OR      B
1890+ 8C2C 0F           			RRCA
1891+ 8C2D 0F           			RRCA
1892+ 8C2E EE 54        			XOR     01010100B
1893+ 8C30 77           			LD      (HL),A
1894+ 8C31 23           			INC     HL
1895+ 8C32 7B           			LD      A,E
1896+ 8C33 E6 3F        			AND     3FH
1897+ 8C35 F6 40        			OR      '@'
1898+ 8C37 77           			LD      (HL),A
1899+ 8C38 23           			INC     HL
1900+ 8C39 7A           			LD      A,D
1901+ 8C3A E6 3F        			AND     3FH
1902+ 8C3C F6 40        			OR      '@'
1903+ 8C3E 77           			LD      (HL),A
1904+ 8C3F 23           			INC     HL
1905+ 8C40 EB           			EX      DE,HL
1906+ 8C41 C9           			RET
1907+ 8C42              ;
1908+ 8C42              ;TEXT - OUTPUT MESSAGE.
1909+ 8C42              ;   Inputs: HL addresses text (terminated by nul)
1910+ 8C42              ;  Outputs: HL addresses character following nul.
1911+ 8C42              ; Destroys: A,H,L,F
1912+ 8C42              ;
1913+ 8C42 2A EE B5     @REPORT:		LD      HL,(ERRTXT)
1914+ 8C45 7E           TEXT:			LD      A,(HL)
1915+ 8C46 23           			INC     HL
1916+ 8C47 B7           			OR      A
1917+ 8C48 C8           			RET     Z
1918+ 8C49 CD B0 88     			CALL    OUT
1919+ 8C4C 18 F7        			JR      TEXT
1920+ 8C4E              ;
1921+ 8C4E              ;TELL - OUTPUT MESSAGE.
1922+ 8C4E              ;   Inputs: Text follows subroutine call (term=nul)
1923+ 8C4E              ; Destroys: A,F
1924+ 8C4E              ;
1925+ 8C4E E3           @TELL:			EX      (SP),HL         ;GET RETURN ADDRESS
1926+ 8C4F CD 45 8C     			CALL    TEXT
1927+ 8C52 E3           			EX      (SP),HL
1928+ 8C53 C9           			RET
1929+ 8C54              ;
1930+ 8C54              @CR:			EQU     0DH
1931+ 8C54              @LF:			EQU     0AH
1932+ 8C54              @ESC:			EQU     1BH
1933+ 8C54
1934+ 8C54              			ENDMODULE
# file closed: main.z80
  32  8C54              			include "exec.z80"
# file opened: exec.z80
   1+ 8C54              ;
   2+ 8C54              ;BBC BASIC INTERPRETER - Z80 VERSION
   3+ 8C54              ;STATEMENT EXECUTION & ASSEMBLER MODULE - "EXEC"
   4+ 8C54              ;(C) COPYRIGHT  R.T.RUSSELL  1984
   5+ 8C54              ;VERSION 2.1, 22-01-1984
   6+ 8C54              ;VERSION 3.0, 02-03-1987
   7+ 8C54              ;VERSION 3.1, 11-06-1987
   8+ 8C54              ;
   9+ 8C54              			MODULE EXEC
  10+ 8C54              ;
  11+ 8C54              TAND:			EQU     80H
  12+ 8C54              TOR:			EQU     84H
  13+ 8C54              TERROR:			EQU     85H
  14+ 8C54              LINE:			EQU     86H
  15+ 8C54              OFF:			EQU     87H
  16+ 8C54              STEP:			EQU     88H
  17+ 8C54              SPC:			EQU     89H
  18+ 8C54              TAB:			EQU     8AH
  19+ 8C54              ELSE:			EQU     8BH
  20+ 8C54              THEN:			EQU     8CH
  21+ 8C54              LINO:			EQU     8DH
  22+ 8C54              TO:			EQU     0B8H
  23+ 8C54              TCMD:			EQU     0C6H
  24+ 8C54              TCALL:			EQU     0D6H
  25+ 8C54              DATA:			EQU     0DCH
  26+ 8C54              DEF:			EQU     0DDH
  27+ 8C54              TGOSUB:			EQU     0E4H
  28+ 8C54              TGOTO:			EQU     0E5H
  29+ 8C54              TON:			EQU     0EEH
  30+ 8C54              TPROC:			EQU     0F2H
  31+ 8C54              TSTOP:			EQU     0FAH
  32+ 8C54              ;
  33+ 8C54 9A 86        CMDTAB:			DEFW    AUTO
  34+ 8C56 34 85        			DEFW    DELETE
  35+ 8C58 D2 86        			DEFW    LOAD
  36+ 8C5A 63 85        			DEFW    LIST
  37+ 8C5C B4 86        			DEFW    NEW
  38+ 8C5E B9 86        			DEFW    OLD
  39+ 8C60 E1 85        			DEFW    RENUM
  40+ 8C62 E0 86        			DEFW    SAVE
  41+ 8C64 5B 95        			DEFW    PUT
  42+ 8C66 11 94        			DEFW    PTR
  43+ 8C68 26 94        			DEFW    PAGEV
  44+ 8C6A 35 94        			DEFW    TIMEV
  45+ 8C6C 56 94        			DEFW    LOMEMV
  46+ 8C6E 69 94        			DEFW    HIMEMV
  47+ 8C70 B5 B0        			DEFW    SOUND
  48+ 8C72 DD 94        			DEFW    BPUT
  49+ 8C74 F0 94        			DEFW    CALL
  50+ 8C76 CD 8C        			DEFW    CHAIN
  51+ 8C78 EB 93        			DEFW    CLR
  52+ 8C7A D4 94        			DEFW    CLOSE
  53+ 8C7C B5 B0        			DEFW    CLG
  54+ 8C7E C8 93        			DEFW    CLS
  55+ 8C80 84 8D        			DEFW    REM             ;DATA
  56+ 8C82 84 8D        			DEFW    REM             ;DEF
  57+ 8C84 31 8E        			DEFW    DIM
  58+ 8C86 B5 B0        			DEFW    DRAW
  59+ 8C88 33 8D        			DEFW    END
  60+ 8C8A 20 92        			DEFW    ENDPRO
  61+ 8C8C B5 B0        			DEFW    ENVEL
  62+ 8C8E 75 90        			DEFW    FOR
  63+ 8C90 30 90        			DEFW    GOSUB
  64+ 8C92 19 90        			DEFW    GOTO
  65+ 8C94 B5 B0        			DEFW    GCOL
  66+ 8C96 9B 93        			DEFW    IF
  67+ 8C98 AB 92        			DEFW    INPUT
  68+ 8C9A A4 8D        			DEFW    LET
  69+ 8C9C D2 91        			DEFW    LOCAL
  70+ 8C9E B5 B0        			DEFW    MODE
  71+ 8CA0 B5 B0        			DEFW    MOVE
  72+ 8CA2 BA 90        			DEFW    NEXT
  73+ 8CA4 B3 8F        			DEFW    ON
  74+ 8CA6 B3 94        			DEFW    VDU
  75+ 8CA8 B5 B0        			DEFW    PLOT
  76+ 8CAA DE 8E        			DEFW    PRINT
  77+ 8CAC 43 91        			DEFW    PROC
  78+ 8CAE 4A 93        			DEFW    READ
  79+ 8CB0 84 8D        			DEFW    REM
  80+ 8CB2 4B 90        			DEFW    REPEAT
  81+ 8CB4 E5 93        			DEFW    REPOR
  82+ 8CB6 F3 93        			DEFW    RESTOR
  83+ 8CB8 3B 90        			DEFW    RETURN
  84+ 8CBA C8 8C        			DEFW    RUN
  85+ 8CBC D2 93        			DEFW    STOP
  86+ 8CBE DE B1        			DEFW    COLOUR
  87+ 8CC0 99 94        			DEFW    TRACE
  88+ 8CC2 53 90        			DEFW    UNTIL
  89+ 8CC4 8E 94        			DEFW    WIDTHV
  90+ 8CC6 70 8D        			DEFW    CLI             ;OSCLI
  91+ 8CC8              ;
  92+ 8CC8 CD E5 96     RUN:			CALL    TERM?
  93+ 8CCB 28 0D        			JR      Z,RUN0
  94+ 8CCD CD BE 9E     CHAIN:			CALL    EXPRS
  95+ 8CD0 3E 0D        			LD      A,CR
  96+ 8CD2 12           			LD      (DE),A
  97+ 8CD3 ED 7B E4 B5  @CHAIN0:		LD      SP,(HIMEM)
  98+ 8CD7 CD A6 87     			CALL    LOAD0
  99+ 8CDA ED 7B E4 B5  @RUN0:			LD      SP,(HIMEM)      ;PREPARE FOR RUN
 100+ 8CDE DD 21 F6 B5  			LD      IX,RANDOM
 101+ 8CE2              ; dtrg: bugfix here; on emulators, R is always zero, and the original
 102+ 8CE2              ; code always waiting until it was non-zero, resulting in a hang.
 103+ 8CE2              ; Instead we crudely hack around it.
 104+ 8CE2 ED 5F        			ld      a, r
 105+ 8CE4 20 01        			jr      nz, 1F
 106+ 8CE6 3C           			inc     a
 107+ 8CE7              ;
 108+ 8CE7 07           1:			RLCA
 109+ 8CE8 07           			RLCA
 110+ 8CE9 DD 77 03     			LD      (IX+3),A
 111+ 8CEC 9F           			SBC     A,A
 112+ 8CED DD 77 04     			LD      (IX+4),A
 113+ 8CF0 CD EF 87     			CALL    CLEAR
 114+ 8CF3 21 00 00     			LD      HL,0
 115+ 8CF6 22 EC B5     			LD      (ERRTRP),HL
 116+ 8CF9 2A DC B5     			LD      HL,(PAGE)
 117+ 8CFC 3E DC        			LD      A,DATA
 118+ 8CFE CD A3 97     			CALL    SEARCH          ;LOOK FOR "DATA"
 119+ 8D01 22 F0 B5     			LD      (DATPTR),HL     ;SET DATA POINTER
 120+ 8D04 FD 2A DC B5  			LD      IY,(PAGE)
 121+ 8D08 CD 43 8D     XEQ0:			CALL    NEWLIN
 122+ 8D0B FD 22 F4 B5  @XEQ:			LD      (ERRLIN),IY     ;ERROR POINTER
 123+ 8D0F CD 02 B1     			CALL    TRAP            ;CHECK KEYBOARD
 124+ 8D12 CD 99 A4     XEQ1:			CALL    NXT
 125+ 8D15 FD 23        			INC     IY
 126+ 8D17 FE 3A        			CP      ':'             ;SEPARATOR
 127+ 8D19 28 F7        			JR      Z,XEQ1
 128+ 8D1B FE 0D        			CP      CR
 129+ 8D1D 28 E9        			JR      Z,XEQ0          ;NEW PROGRAM LINE
 130+ 8D1F D6 C6        			SUB     TCMD
 131+ 8D21 38 6F        			JR      C,LET0          ;IMPLIED "LET"
 132+ 8D23 87           			ADD     A,A
 133+ 8D24 4F           			LD      C,A
 134+ 8D25 06 00        			LD      B,0
 135+ 8D27 21 54 8C     			LD      HL,CMDTAB
 136+ 8D2A 09           			ADD     HL,BC
 137+ 8D2B 7E           			LD      A,(HL)          ;TABLE ENTRY
 138+ 8D2C 23           			INC     HL
 139+ 8D2D 66           			LD      H,(HL)
 140+ 8D2E 6F           			LD      L,A
 141+ 8D2F CD 99 A4     			CALL    NXT
 142+ 8D32 E9           			JP      (HL)            ;EXECUTE STATEMENT
 143+ 8D33              ;
 144+ 8D33              ;END
 145+ 8D33              ;
 146+ 8D33 CD E7 88     END:			CALL    SETLIN          ;FIND CURRENT LINE
 147+ 8D36 7C           			LD      A,H
 148+ 8D37 B5           			OR      L               ;DIRECT?
 149+ 8D38 CA 92 80     			JP      Z,CLOOP
 150+ 8D3B 1E 00        			LD      E,0
 151+ 8D3D CD 02 B2     			CALL    OSSHUT          ;CLOSE ALL FILES
 152+ 8D40 C3 91 80     			JP      WARM            ;"Ready"
 153+ 8D43              ;
 154+ 8D43 FD 7E 00     NEWLIN:			LD      A,(IY+0)        ;A=LINE LENGTH
 155+ 8D46 01 03 00     			LD      BC,3
 156+ 8D49 FD 09        			ADD     IY,BC
 157+ 8D4B B7           			OR      A
 158+ 8D4C 28 E5        			JR      Z,END           ;LENGTH=0, EXIT
 159+ 8D4E 2A E8 B5     			LD      HL,(TRACEN)
 160+ 8D51 7C           			LD      A,H
 161+ 8D52 B5           			OR      L
 162+ 8D53 C8           			RET     Z
 163+ 8D54 FD 56 FF     			LD      D,(IY-1)        ;DE = LINE NUMBER
 164+ 8D57 FD 5E FE     			LD      E,(IY-2)
 165+ 8D5A ED 52        			SBC     HL,DE
 166+ 8D5C D8           			RET     C
 167+ 8D5D EB           			EX      DE,HL
 168+ 8D5E 3E 5B        			LD      A,'['           ;TRACE
 169+ 8D60 CD 97 88     			CALL    OUTCHR
 170+ 8D63 CD 24 89     			CALL    PBCDL
 171+ 8D66 3E 5D        			LD      A,']'
 172+ 8D68 CD 97 88     			CALL    OUTCHR
 173+ 8D6B 3E 20        			LD      A,' '
 174+ 8D6D C3 97 88     			JP      OUTCHR
 175+ 8D70              ;
 176+ 8D70              ;ROUTINES FOR EACH STATEMENT:
 177+ 8D70              ;
 178+ 8D70              ;OSCLI
 179+ 8D70              ;
 180+ 8D70 CD BE 9E     CLI:			CALL    EXPRS
 181+ 8D73 3E 0D        			LD      A,CR
 182+ 8D75 12           			LD      (DE),A
 183+ 8D76 21 00 B3     			LD      HL,ACCS
 184+ 8D79 CD 41 B1     			CALL    OSCLI
 185+ 8D7C 18 8D        			JR      XEQ
 186+ 8D7E              ;
 187+ 8D7E              ;REM, *
 188+ 8D7E              ;
 189+ 8D7E FD E5        EXT:			PUSH    IY
 190+ 8D80 E1           			POP     HL
 191+ 8D81 CD 41 B1     			CALL    OSCLI
 192+ 8D84 FD E5        REM:			PUSH    IY
 193+ 8D86 E1           			POP     HL
 194+ 8D87 3E 0D        			LD      A,CR
 195+ 8D89 47           			LD      B,A
 196+ 8D8A ED B1        			CPIR                    ;FIND LINE END
 197+ 8D8C E5           			PUSH    HL
 198+ 8D8D FD E1        			POP     IY
 199+ 8D8F C3 08 8D     			JP      XEQ0
 200+ 8D92              ;
 201+ 8D92              ;[LET] var = expr
 202+ 8D92              ;
 203+ 8D92 FE C5        LET0:			CP      ELSE-TCMD
 204+ 8D94 28 EE        			JR      Z,REM
 205+ 8D96 FE 64        			CP      ('*'-TCMD) AND 0xFF
 206+ 8D98 28 E4        			JR      Z,EXT
 207+ 8D9A FE 77        			CP      ('='-TCMD) AND 0xFF
 208+ 8D9C 28 4C        			JR      Z,FNEND
 209+ 8D9E FE 95        			CP      ('['-TCMD) AND 0xFF
 210+ 8DA0 28 1E        			JR      Z,ASM
 211+ 8DA2 FD 2B        			DEC     IY
 212+ 8DA4 CD 6D 95     LET:			CALL    ASSIGN
 213+ 8DA7 CA 0B 8D     			JP      Z,XEQ
 214+ 8DAA 38 36        			JR      C,SYNTAX        ;"Syntax error"
 215+ 8DAC F5           			PUSH    AF              ;SAVE STRING TYPE
 216+ 8DAD CD F9 96     			CALL    EQUALS
 217+ 8DB0 E5           			PUSH    HL
 218+ 8DB1 CD BE 9E     			CALL    EXPRS
 219+ 8DB4 DD E1        			POP     IX
 220+ 8DB6 F1           			POP     AF
 221+ 8DB7 CD AA 95     			CALL    STACCS
 222+ 8DBA C3 0B 8D     XEQR:			JP      XEQ
 223+ 8DBD              ;
 224+ 8DBD CD 43 8D     ASM0:			CALL    NEWLIN
 225+ 8DC0 FD 22 F4 B5  ASM:			LD      (ERRLIN),IY
 226+ 8DC4 CD 02 B1     			CALL    TRAP
 227+ 8DC7 CD EC 97     			CALL    ASSEM
 228+ 8DCA 38 16        			JR      C,SYNTAX
 229+ 8DCC FE 0D        			CP      CR
 230+ 8DCE 28 ED        			JR      Z,ASM0
 231+ 8DD0 21 FE B5     			LD      HL,LISTON
 232+ 8DD3 7E           			LD      A,(HL)
 233+ 8DD4 E6 0F        			AND     0FH
 234+ 8DD6 F6 30        			OR      30H
 235+ 8DD8 77           			LD      (HL),A
 236+ 8DD9 18 DF        			JR      XEQR
 237+ 8DDB              ;
 238+ 8DDB CD 62 89     VAR:			CALL    GETVAR
 239+ 8DDE C8           			RET     Z
 240+ 8DDF D2 53 89     			JP      NC,PUTVAR
 241+ 8DE2 3E 10        @SYNTAX:		LD      A,16            ;"Syntax error"
 242+ 8DE4 21           			DEFB    21H
 243+ 8DE5 3E 11        @ESCAPE:		LD      A,17            ;"Escape"
 244+ 8DE7 C3 FE 86     ERROR0:			JP      ERROR
 245+ 8DEA              ;
 246+ 8DEA              ;=
 247+ 8DEA              ;
 248+ 8DEA CD A5 9D     FNEND:			CALL    EXPR            ;FUNCTION RESULT
 249+ 8DED 43           			LD      B,E
 250+ 8DEE EB           			EX      DE,HL
 251+ 8DEF D9           			EXX                     ;SAVE RESULT
 252+ 8DF0 EB           			EX      DE,HL           ; IN DEB'C'D'E'
 253+ 8DF1 C1           FNEND5:			POP     BC
 254+ 8DF2 21 C5 96     			LD      HL,LOCCHK
 255+ 8DF5 B7           			OR      A
 256+ 8DF6 ED 42        			SBC     HL,BC
 257+ 8DF8 28 19        			JR      Z,FNEND0        ;LOCAL VARIABLE
 258+ 8DFA 21 43 91     			LD      HL,FNCHK
 259+ 8DFD B7           			OR      A
 260+ 8DFE ED 42        			SBC     HL,BC
 261+ 8E00 3E 07        			LD      A,7
 262+ 8E02 20 E3        			JR      NZ,ERROR0       ;"No FN"
 263+ 8E04 FD E1        			POP     IY
 264+ 8E06 FD 22 F4 B5  			LD      (ERRLIN),IY     ;IN CASE OF ERROR
 265+ 8E0A EB           			EX      DE,HL
 266+ 8E0B D9           			EXX
 267+ 8E0C EB           			EX      DE,HL
 268+ 8E0D 11 00 B3     			LD      DE,ACCS
 269+ 8E10 58           			LD      E,B
 270+ 8E11 08           			EX      AF,AF'
 271+ 8E12 C9           			RET
 272+ 8E13              ;
 273+ 8E13 DD E1        FNEND0:			POP     IX
 274+ 8E15 C1           			POP     BC
 275+ 8E16 78           			LD      A,B
 276+ 8E17 B7           			OR      A
 277+ 8E18 FA 24 8E     			JP      M,FNEND1        ;STRING
 278+ 8E1B E1           			POP     HL
 279+ 8E1C D9           			EXX
 280+ 8E1D E1           			POP     HL
 281+ 8E1E D9           			EXX
 282+ 8E1F CD 81 95     			CALL    STORE
 283+ 8E22 18 CD        			JR      FNEND5
 284+ 8E24 21 00 00     FNEND1:			LD      HL,0
 285+ 8E27 39           			ADD     HL,SP
 286+ 8E28 D5           			PUSH    DE
 287+ 8E29 59           			LD      E,C
 288+ 8E2A CD AD 95     			CALL    STORES
 289+ 8E2D D1           			POP     DE
 290+ 8E2E F9           			LD      SP,HL
 291+ 8E2F 18 C0        			JR      FNEND5
 292+ 8E31              ;
 293+ 8E31              ;DIM var(dim1[,dim2[,...]])[,var(...]
 294+ 8E31              ;DIM var expr[,var expr...]
 295+ 8E31              ;
 296+ 8E31 CD 62 89     DIM:			CALL    GETVAR          ;VARIABLE
 297+ 8E34 38 7B        			JR      C,BADDIM
 298+ 8E36 CA B9 8E     			JP      Z,DIM4
 299+ 8E39 CD A0 8A     			CALL    CREATE
 300+ 8E3C E5           			PUSH    HL
 301+ 8E3D DD E1        			POP     IX
 302+ 8E3F FD 7E 00     			LD      A,(IY)
 303+ 8E42 FE 28        			CP      '('
 304+ 8E44 7A           			LD      A,D
 305+ 8E45 20 72        			JR      NZ,DIM4
 306+ 8E47 E5           			PUSH    HL
 307+ 8E48 F5           			PUSH    AF              ;SAVE TYPE
 308+ 8E49 11 01 00     			LD      DE,1
 309+ 8E4C 42           			LD      B,D             ;DIMENSION COUNTER
 310+ 8E4D FD 23        DIM1:			INC     IY
 311+ 8E4F C5           			PUSH    BC
 312+ 8E50 D5           			PUSH    DE
 313+ 8E51 DD E5        			PUSH    IX
 314+ 8E53 CD B5 9E     			CALL    EXPRI           ;DIMENSION SIZE
 315+ 8E56 CB 7C        			BIT     7,H
 316+ 8E58 20 57        			JR      NZ,BADDIM
 317+ 8E5A D9           			EXX
 318+ 8E5B 23           			INC     HL
 319+ 8E5C DD E1        			POP     IX
 320+ 8E5E DD 23        			INC     IX
 321+ 8E60 DD 75 00     			LD      (IX),L          ;SAVE SIZE
 322+ 8E63 DD 23        			INC     IX
 323+ 8E65 DD 74 00     			LD      (IX),H
 324+ 8E68 C1           			POP     BC
 325+ 8E69 CD C6 97     			CALL    MUL16           ;HL=HL*BC
 326+ 8E6C 38 46        			JR      C,NOROOM        ;TOO LARGE
 327+ 8E6E EB           			EX      DE,HL           ;DE=PRODUCT
 328+ 8E6F C1           			POP     BC
 329+ 8E70 04           			INC     B               ;DIMENSION COUNTER
 330+ 8E71 FD 7E 00     			LD      A,(IY)
 331+ 8E74 FE 2C        			CP      ','             ;ANOTHER
 332+ 8E76 28 D5        			JR      Z,DIM1
 333+ 8E78 CD 5D A4     			CALL    BRAKET          ;CLOSING BRACKET
 334+ 8E7B F1           			POP     AF              ;RESTORE TYPE
 335+ 8E7C DD 23        			INC     IX
 336+ 8E7E DD E3        			EX      (SP),IX
 337+ 8E80 DD 70 00     			LD      (IX),B          ;NO. OF DIMENSIONS
 338+ 8E83 CD B9 97     			CALL    X4OR5           ;DE=DE*n
 339+ 8E86 E1           			POP     HL
 340+ 8E87 38 2B        			JR      C,NOROOM
 341+ 8E89 19           DIM3:			ADD     HL,DE
 342+ 8E8A 38 28        			JR      C,NOROOM
 343+ 8E8C E5           			PUSH    HL
 344+ 8E8D 24           			INC     H
 345+ 8E8E 28 24        			JR      Z,NOROOM
 346+ 8E90 ED 72        			SBC     HL,SP
 347+ 8E92 30 20        			JR      NC,NOROOM       ;OUT OF SPACE
 348+ 8E94 E1           			POP     HL
 349+ 8E95 22 E2 B5     			LD      (FREE),HL
 350+ 8E98 7A           DIM2:			LD      A,D
 351+ 8E99 B3           			OR      E
 352+ 8E9A 28 06        			JR      Z,DIM5
 353+ 8E9C 2B           			DEC     HL
 354+ 8E9D 36 00        			LD      (HL),0          ;INITIALISE ARRAY
 355+ 8E9F 1B           			DEC     DE
 356+ 8EA0 18 F6        			JR      DIM2
 357+ 8EA2 CD 99 A4     DIM5:			CALL    NXT
 358+ 8EA5 FE 2C        			CP      ','             ;ANOTHER VARIABLE?
 359+ 8EA7 C2 0B 8D     			JP      NZ,XEQ
 360+ 8EAA FD 23        			INC     IY
 361+ 8EAC CD 99 A4     			CALL    NXT
 362+ 8EAF 18 80        			JR      DIM
 363+ 8EB1              ;
 364+ 8EB1 3E 0A        BADDIM:			LD      A,10            ;"Bad DIM"
 365+ 8EB3 21           			DEFB    21H
 366+ 8EB4 3E 0B        NOROOM:			LD      A,11            ;"DIM space"
 367+ 8EB6 C3 FE 86     ERROR1:			JP      ERROR
 368+ 8EB9              ;
 369+ 8EB9 B7           DIM4:			OR      A
 370+ 8EBA 28 F5        			JR      Z,BADDIM
 371+ 8EBC FA B1 8E     			JP      M,BADDIM
 372+ 8EBF 47           			LD      B,A
 373+ 8EC0 FD 7E FF     			LD      A,(IY-1)
 374+ 8EC3 FE 29        			CP      ')'
 375+ 8EC5 78           			LD      A,B
 376+ 8EC6 28 E9        			JR      Z,BADDIM
 377+ 8EC8 2A E2 B5     			LD      HL,(FREE)
 378+ 8ECB D9           			EXX
 379+ 8ECC 21 00 00     			LD      HL,0
 380+ 8ECF 4C           			LD      C,H
 381+ 8ED0 CD 81 95     			CALL    STORE           ;RESERVED AREA
 382+ 8ED3 CD B5 9E     			CALL    EXPRI
 383+ 8ED6 D9           			EXX
 384+ 8ED7 23           			INC     HL
 385+ 8ED8 EB           			EX      DE,HL
 386+ 8ED9 2A E2 B5     			LD      HL,(FREE)
 387+ 8EDC 18 AB        			JR      DIM3
 388+ 8EDE              ;
 389+ 8EDE              ;PRINT list...
 390+ 8EDE              ;PRINT #channel,list...
 391+ 8EDE              ;
 392+ 8EDE FE 23        PRINT:			CP      '#'
 393+ 8EE0 20 6B        			JR      NZ,PRINT0
 394+ 8EE2 CD E4 97     			CALL    CHNL            ;CHANNEL NO. = E
 395+ 8EE5 CD 99 A4     PRNTN1:			CALL    NXT
 396+ 8EE8 FE 2C        			CP      ','
 397+ 8EEA C2 0B 8D     			JP      NZ,XEQ
 398+ 8EED FD 23        			INC     IY
 399+ 8EEF D5           			PUSH    DE
 400+ 8EF0 CD A5 9D     			CALL    EXPR            ;ITEM TO PRINT
 401+ 8EF3 08           			EX      AF,AF'
 402+ 8EF4 FA 14 8F     			JP      M,PRNTN2        ;STRING
 403+ 8EF7 D1           			POP     DE
 404+ 8EF8 C5           			PUSH    BC
 405+ 8EF9 D9           			EXX
 406+ 8EFA 7D           			LD      A,L
 407+ 8EFB D9           			EXX
 408+ 8EFC CD 02 B2     			CALL    OSBPUT
 409+ 8EFF D9           			EXX
 410+ 8F00 7C           			LD      A,H
 411+ 8F01 D9           			EXX
 412+ 8F02 CD 02 B2     			CALL    OSBPUT
 413+ 8F05 7D           			LD      A,L
 414+ 8F06 CD 02 B2     			CALL    OSBPUT
 415+ 8F09 7C           			LD      A,H
 416+ 8F0A CD 02 B2     			CALL    OSBPUT
 417+ 8F0D C1           			POP     BC
 418+ 8F0E 79           			LD      A,C
 419+ 8F0F CD 02 B2     			CALL    OSBPUT
 420+ 8F12 18 D1        			JR      PRNTN1
 421+ 8F14 4B           PRNTN2:			LD      C,E
 422+ 8F15 D1           			POP     DE
 423+ 8F16 21 00 B3     			LD      HL,ACCS
 424+ 8F19 0C           			INC     C
 425+ 8F1A 0D           PRNTN3:			DEC     C
 426+ 8F1B 28 09        			JR      Z,PRNTN4
 427+ 8F1D 7E           			LD      A,(HL)
 428+ 8F1E 23           			INC     HL
 429+ 8F1F C5           			PUSH    BC
 430+ 8F20 CD 02 B2     			CALL    OSBPUT
 431+ 8F23 C1           			POP     BC
 432+ 8F24 18 F4        			JR      PRNTN3
 433+ 8F26 3E 0D        PRNTN4:			LD      A,CR
 434+ 8F28 CD 02 B2     			CALL    OSBPUT
 435+ 8F2B 18 B8        			JR      PRNTN1
 436+ 8F2D              ;
 437+ 8F2D 06 02        PRINT6:			LD      B,2
 438+ 8F2F 18 22        			JR      PRINTC
 439+ 8F31 01 00 01     PRINT8:			LD      BC,100H
 440+ 8F34 18 1D        			JR      PRINTC
 441+ 8F36 21 00 B5     PRINT9:			LD      HL,STAVAR
 442+ 8F39 AF           			XOR     A
 443+ 8F3A BE           			CP      (HL)
 444+ 8F3B 28 10        			JR      Z,PRINT0
 445+ 8F3D 3A FB B5     			LD      A,(COUNT)
 446+ 8F40 B7           			OR      A
 447+ 8F41 28 0A        			JR      Z,PRINT0
 448+ 8F43 96           PRINTA:			SUB     (HL)
 449+ 8F44 28 07        			JR      Z,PRINT0
 450+ 8F46 30 FB        			JR      NC,PRINTA
 451+ 8F48 ED 44        			NEG
 452+ 8F4A CD 4D 97     			CALL    FILL
 453+ 8F4D 3A 00 B5     PRINT0:			LD      A,(STAVAR)
 454+ 8F50 4F           			LD      C,A             ;PRINTS
 455+ 8F51 06 00        			LD      B,0             ;PRINTF
 456+ 8F53 CD E5 96     PRINTC:			CALL    TERM?
 457+ 8F56 28 38        			JR      Z,PRINT4
 458+ 8F58 CB 80        			RES     0,B
 459+ 8F5A FD 23        			INC     IY
 460+ 8F5C FE 7E        			CP      '~'
 461+ 8F5E 28 CD        			JR      Z,PRINT6
 462+ 8F60 FE 3B        			CP      ';'
 463+ 8F62 28 CD        			JR      Z,PRINT8
 464+ 8F64 FE 2C        			CP      ','
 465+ 8F66 28 CE        			JR      Z,PRINT9
 466+ 8F68 CD 06 97     			CALL    FORMAT          ;SPC, TAB, '
 467+ 8F6B 28 E6        			JR      Z,PRINTC
 468+ 8F6D FD 2B        			DEC     IY
 469+ 8F6F C5           			PUSH    BC
 470+ 8F70 CD A5 9D     			CALL    EXPR            ;VARIABLE TYPE
 471+ 8F73 08           			EX      AF,AF'
 472+ 8F74 FA 8A 8F     			JP      M,PRINT3        ;STRING
 473+ 8F77 D1           			POP     DE
 474+ 8F78 D5           			PUSH    DE
 475+ 8F79 CB 4A        			BIT     1,D
 476+ 8F7B F5           			PUSH    AF
 477+ 8F7C CC B7 A3     			CALL    Z,STR           ;DECIMAL
 478+ 8F7F F1           			POP     AF
 479+ 8F80 C4 74 A3     			CALL    NZ,HEXSTR       ;HEX
 480+ 8F83 C1           			POP     BC
 481+ 8F84 C5           			PUSH    BC
 482+ 8F85 79           			LD      A,C
 483+ 8F86 93           			SUB     E
 484+ 8F87 D4 4D 97     			CALL    NC,FILL         ;RIGHT JUSTIFY
 485+ 8F8A C1           PRINT3:			POP     BC
 486+ 8F8B CD 5B 97     			CALL    PTEXT           ;PRINT
 487+ 8F8E 18 C3        			JR      PRINTC
 488+ 8F90 CB 40        PRINT4:			BIT     0,B
 489+ 8F92 CC 90 88     			CALL    Z,CRLF
 490+ 8F95 C3 0B 8D     			JP      XEQ
 491+ 8F98              ;
 492+ 8F98              ;
 493+ 8F98 FD 23        ONERR:			INC     IY              ;SKIP "ERROR"
 494+ 8F9A 21 00 00     			LD      HL,0
 495+ 8F9D 22 EC B5     			LD      (ERRTRP),HL
 496+ 8FA0 CD 99 A4     			CALL    NXT
 497+ 8FA3 FE 87        			CP      OFF
 498+ 8FA5 FD 23        			INC     IY
 499+ 8FA7 CA 0B 8D     			JP      Z,XEQ
 500+ 8FAA FD 2B        			DEC     IY
 501+ 8FAC FD 22 EC B5  			LD      (ERRTRP),IY
 502+ 8FB0 C3 84 8D     			JP      REM
 503+ 8FB3              ;
 504+ 8FB3              ;ON expr GOTO line[,line...] [ELSE statement]
 505+ 8FB3              ;ON expr GOTO line[,line...] [ELSE line]
 506+ 8FB3              ;ON expr GOSUB line[,line...] [ELSE statement]
 507+ 8FB3              ;ON expr GOSUB line[,line...] [ELSE line]
 508+ 8FB3              ;ON expr PROCone [,PROCtwo..] [ELSE PROCotherwise]
 509+ 8FB3              ;ON ERROR statement [:statement...]
 510+ 8FB3              ;ON ERROR OFF
 511+ 8FB3              ;
 512+ 8FB3 FE 85        ON:			CP      TERROR
 513+ 8FB5 28 E1        			JR      Z,ONERR         ;"ON ERROR"
 514+ 8FB7 CD B5 9E     			CALL    EXPRI
 515+ 8FBA FD 7E 00     			LD      A,(IY)
 516+ 8FBD FD 23        			INC     IY
 517+ 8FBF 1E 2C        			LD      E,','           ;SEPARATOR
 518+ 8FC1 FE E5        			CP      TGOTO
 519+ 8FC3 28 0B        			JR      Z,ON1
 520+ 8FC5 FE E4        			CP      TGOSUB
 521+ 8FC7 28 07        			JR      Z,ON1
 522+ 8FC9 1E F2        			LD      E,TPROC
 523+ 8FCB BB           			CP      E
 524+ 8FCC 3E 27        			LD      A,39
 525+ 8FCE 20 41        			JR      NZ,ERROR2       ;"ON syntax"
 526+ 8FD0 57           ON1:			LD      D,A
 527+ 8FD1 D9           			EXX
 528+ 8FD2 E5           			PUSH    HL
 529+ 8FD3 D9           			EXX
 530+ 8FD4 C1           			POP     BC              ;ON INDEX
 531+ 8FD5 78           			LD      A,B
 532+ 8FD6 B4           			OR      H
 533+ 8FD7 B5           			OR      L
 534+ 8FD8 20 27        			JR      NZ,ON4          ;OUT OF RANGE
 535+ 8FDA B1           			OR      C
 536+ 8FDB 28 24        			JR      Z,ON4
 537+ 8FDD 0D           			DEC     C
 538+ 8FDE 28 0D        			JR      Z,ON3           ;INDEX=1
 539+ 8FE0 CD E5 96     ON2:			CALL    TERM?
 540+ 8FE3 28 1C        			JR      Z,ON4           ;OUT OF RANGE
 541+ 8FE5 FD 23        			INC     IY              ;SKIP DELIMITER
 542+ 8FE7 BB           			CP      E
 543+ 8FE8 20 F6        			JR      NZ,ON2
 544+ 8FEA 0D           			DEC     C
 545+ 8FEB 20 F3        			JR      NZ,ON2
 546+ 8FED 7B           ON3:			LD      A,E
 547+ 8FEE FE F2        			CP      TPROC
 548+ 8FF0 28 22        			JR      Z,ONPROC
 549+ 8FF2 D5           			PUSH    DE
 550+ 8FF3 CD CC 9E     			CALL    ITEMI           ;LINE NUMBER
 551+ 8FF6 D1           			POP     DE
 552+ 8FF7 7A           			LD      A,D
 553+ 8FF8 FE E5        			CP      TGOTO
 554+ 8FFA 28 26        			JR      Z,GOTO2
 555+ 8FFC CD F1 96     			CALL    SPAN            ;SKIP REST OF LIST
 556+ 8FFF 18 32        			JR      GOSUB1
 557+ 9001              ;
 558+ 9001 FD 7E 00     ON4:			LD      A,(IY)
 559+ 9004 FD 23        			INC     IY
 560+ 9006 FE 8B        			CP      ELSE
 561+ 9008 CA AD 93     			JP      Z,IF1           ;ELSE CLAUSE
 562+ 900B FE 0D        			CP      CR
 563+ 900D 20 F2        			JR      NZ,ON4
 564+ 900F 3E 28        			LD      A,40
 565+ 9011 C3 FE 86     ERROR2:			JP      ERROR           ;"ON range"
 566+ 9014              ;
 567+ 9014 3E EE        ONPROC:			LD      A,TON
 568+ 9016 C3 43 91     			JP      PROC
 569+ 9019              ;
 570+ 9019              ;GOTO line
 571+ 9019              ;
 572+ 9019 CD CC 9E     GOTO:			CALL    ITEMI           ;LINE NUMBER
 573+ 901C CD E5 96     GOTO1:			CALL    TERM?
 574+ 901F C2 E2 8D     			JP      NZ,SYNTAX
 575+ 9022 D9           GOTO2:			EXX
 576+ 9023 CD CE 88     			CALL    FINDL
 577+ 9026 E5           			PUSH    HL
 578+ 9027 FD E1        			POP     IY
 579+ 9029 CA 08 8D     			JP      Z,XEQ0
 580+ 902C 3E 29        			LD      A,41
 581+ 902E 18 E1        			JR      ERROR2          ;"No such line"
 582+ 9030              ;
 583+ 9030              ;GOSUB line
 584+ 9030              ;
 585+ 9030 CD CC 9E     GOSUB:			CALL    ITEMI           ;LINE NUMBER
 586+ 9033 FD E5        GOSUB1:			PUSH    IY              ;TEXT POINTER
 587+ 9035 CD E2 95     			CALL    CHECK           ;CHECK ROOM
 588+ 9038 CD 1C 90     			CALL    GOTO1           ;SAVE MARKER
 589+ 903B              GOSCHK:			EQU     $
 590+ 903B              ;
 591+ 903B              ;RETURN
 592+ 903B              ;
 593+ 903B D1           RETURN:			POP     DE              ;MARKER
 594+ 903C 21 3B 90     			LD      HL,GOSCHK
 595+ 903F B7           			OR      A
 596+ 9040 ED 52        			SBC     HL,DE
 597+ 9042 FD E1        			POP     IY
 598+ 9044 CA 0B 8D     			JP      Z,XEQ
 599+ 9047 3E 26        			LD      A,38
 600+ 9049 18 C6        			JR      ERROR2          ;"No GOSUB"
 601+ 904B              ;
 602+ 904B              ;REPEAT
 603+ 904B              ;
 604+ 904B FD E5        REPEAT:			PUSH    IY
 605+ 904D CD E2 95     			CALL    CHECK
 606+ 9050 CD 0B 8D     			CALL    XEQ
 607+ 9053              REPCHK:			EQU     $
 608+ 9053              ;
 609+ 9053              ;UNTIL expr
 610+ 9053              ;
 611+ 9053 C1           UNTIL:			POP     BC
 612+ 9054 C5           			PUSH    BC
 613+ 9055 21 53 90     			LD      HL,REPCHK
 614+ 9058 B7           			OR      A
 615+ 9059 ED 42        			SBC     HL,BC
 616+ 905B 3E 2B        			LD      A,43
 617+ 905D 20 B2        			JR      NZ,ERROR2       ;"No REPEAT"
 618+ 905F CD B5 9E     			CALL    EXPRI
 619+ 9062 CD 40 A3     			CALL    TEST
 620+ 9065 C1           			POP     BC
 621+ 9066 D1           			POP     DE
 622+ 9067 20 05        			JR      NZ,XEQ2         ;TRUE
 623+ 9069 D5           			PUSH    DE
 624+ 906A C5           			PUSH    BC
 625+ 906B D5           			PUSH    DE
 626+ 906C FD E1        			POP     IY
 627+ 906E C3 0B 8D     XEQ2:			JP      XEQ
 628+ 9071              ;
 629+ 9071              ;FOR var = expr TO expr [STEP expr]
 630+ 9071              ;
 631+ 9071 3E 22        FORVAR:			LD      A,34
 632+ 9073 18 9C        			JR      ERROR2          ;"FOR variable"
 633+ 9075              ;
 634+ 9075 CD 6D 95     FOR:			CALL    ASSIGN
 635+ 9078 20 F7        			JR      NZ,FORVAR       ;"FOR variable"
 636+ 907A F5           			PUSH    AF              ;SAVE TYPE
 637+ 907B FD 7E 00     			LD      A,(IY)
 638+ 907E FE B8        			CP      TO
 639+ 9080 3E 24        			LD      A,36
 640+ 9082 20 8D        			JR      NZ,ERROR2       ;"No TO"
 641+ 9084 FD 23        			INC     IY
 642+ 9086 DD E5        			PUSH    IX
 643+ 9088 CD AE 9E     			CALL    EXPRN           ;LIMIT
 644+ 908B DD E1        			POP     IX
 645+ 908D F1           			POP     AF
 646+ 908E 47           			LD      B,A             ;TYPE
 647+ 908F C5           			PUSH    BC              ;SAVE ON STACK
 648+ 9090 E5           			PUSH    HL
 649+ 9091 21 00 00     			LD      HL,0
 650+ 9094 4C           			LD      C,H
 651+ 9095 D9           			EXX
 652+ 9096 E5           			PUSH    HL
 653+ 9097 21 01 00     			LD      HL,1            ;PRESET STEP
 654+ 909A D9           			EXX
 655+ 909B FD 7E 00     			LD      A,(IY)
 656+ 909E FE 88        			CP      STEP
 657+ 90A0 20 09        			JR      NZ,FOR1
 658+ 90A2 FD 23        			INC     IY
 659+ 90A4 DD E5        			PUSH    IX
 660+ 90A6 CD AE 9E     			CALL    EXPRN           ;STEP
 661+ 90A9 DD E1        			POP     IX
 662+ 90AB C5           FOR1:			PUSH    BC
 663+ 90AC E5           			PUSH    HL
 664+ 90AD D9           			EXX
 665+ 90AE E5           			PUSH    HL
 666+ 90AF D9           			EXX
 667+ 90B0 FD E5        			PUSH    IY              ;SAVE TEXT POINTER
 668+ 90B2 DD E5        			PUSH    IX              ;LOOP VARIABLE
 669+ 90B4 CD E2 95     			CALL    CHECK
 670+ 90B7 CD 0B 8D     			CALL    XEQ
 671+ 90BA              FORCHK:			EQU     $
 672+ 90BA              ;
 673+ 90BA              ;NEXT [var[,var...]]
 674+ 90BA              ;
 675+ 90BA C1           NEXT:			POP     BC              ;MARKER
 676+ 90BB 21 BA 90     			LD      HL,FORCHK
 677+ 90BE B7           			OR      A
 678+ 90BF ED 42        			SBC     HL,BC
 679+ 90C1 3E 20        			LD      A,32
 680+ 90C3 20 77        			JR      NZ,ERROR3       ;"No FOR"
 681+ 90C5 CD E5 96     			CALL    TERM?
 682+ 90C8 E1           			POP     HL
 683+ 90C9 E5           			PUSH    HL
 684+ 90CA C5           			PUSH    BC
 685+ 90CB E5           			PUSH    HL
 686+ 90CC C4 62 89     			CALL    NZ,GETVAR       ;VARIABLE
 687+ 90CF D1           			POP     DE
 688+ 90D0 EB           			EX      DE,HL
 689+ 90D1 B7           			OR      A
 690+ 90D2 ED 52        NEXT0:			SBC     HL,DE
 691+ 90D4 20 54        			JR      NZ,NEXT1
 692+ 90D6 D5           			PUSH    DE
 693+ 90D7 DD 21 08 00  			LD      IX,6+2
 694+ 90DB DD 39        			ADD     IX,SP
 695+ 90DD CD E6 9F     			CALL    DLOAD5          ;STEP
 696+ 90E0 DD 7E 0B     			LD      A,(IX+11)       ;TYPE
 697+ 90E3 DD E1        			POP     IX
 698+ 90E5 CD 6E 9F     			CALL    LOADN           ;LOOP VARIABLE
 699+ 90E8 CB 7A        			BIT     7,D             ;SIGN?
 700+ 90EA F5           			PUSH    AF
 701+ 90EB 3E 0B        			LD      A,'+' AND 0FH
 702+ 90ED CD BD A4     			CALL    FPP             ;ADD STEP
 703+ 90F0 38 4A        			JR      C,ERROR3
 704+ 90F2 F1           			POP     AF              ;RESTORE TYPE
 705+ 90F3 F5           			PUSH    AF
 706+ 90F4 CD 81 95     			CALL    STORE           ;UPDATE VARIABLE
 707+ 90F7 DD 21 0E 00  			LD      IX,12+2
 708+ 90FB DD 39        			ADD     IX,SP
 709+ 90FD CD E6 9F     			CALL    DLOAD5          ;LIMIT
 710+ 9100 F1           			POP     AF
 711+ 9101 CC 38 A3     			CALL    Z,SWAP
 712+ 9104 3E 08        			LD      A,0+('<'-4) AND 0FH
 713+ 9106 CD BD A4     			CALL    FPP             ;TEST AGAINST LIMIT
 714+ 9109 38 31        			JR      C,ERROR3
 715+ 910B 24           			INC     H
 716+ 910C 20 11        			JR      NZ,LOOP         ;KEEP LOOPING
 717+ 910E 21 12 00     			LD      HL,18
 718+ 9111 39           			ADD     HL,SP
 719+ 9112 F9           			LD      SP,HL
 720+ 9113 CD 99 A4     			CALL    NXT
 721+ 9116 FE 2C        			CP      ','
 722+ 9118 C2 0B 8D     			JP      NZ,XEQ
 723+ 911B FD 23        			INC     IY
 724+ 911D 18 9B        			JR      NEXT
 725+ 911F              ;
 726+ 911F C1           LOOP:			POP     BC
 727+ 9120 D1           			POP     DE
 728+ 9121 FD E1        			POP     IY
 729+ 9123 FD E5        			PUSH    IY
 730+ 9125 D5           			PUSH    DE
 731+ 9126 C5           			PUSH    BC
 732+ 9127 C3 0B 8D     			JP      XEQ
 733+ 912A              ;
 734+ 912A 21 12 00     NEXT1:			LD      HL,18
 735+ 912D 39           			ADD     HL,SP
 736+ 912E F9           			LD      SP,HL           ;"POP" THE STACK
 737+ 912F C1           			POP     BC
 738+ 9130 21 BA 90     			LD      HL,FORCHK
 739+ 9133 ED 42        			SBC     HL,BC
 740+ 9135 E1           			POP     HL              ;VARIABLE POINTER
 741+ 9136 E5           			PUSH    HL
 742+ 9137 C5           			PUSH    BC
 743+ 9138 28 98        			JR      Z,NEXT0
 744+ 913A 3E 21        			LD      A,33
 745+ 913C C3 FE 86     ERROR3:			JP      ERROR           ;"Can't match FOR"
 746+ 913F              ;
 747+ 913F              ;FNname
 748+ 913F              ;N.B. ENTERED WITH A <> TON
 749+ 913F              ;
 750+ 913F F5           @FN:			PUSH    AF              ;MAKE SPACE ON STACK
 751+ 9140 CD 47 91     			CALL    PROC1
 752+ 9143              FNCHK:			EQU     $
 753+ 9143              ;
 754+ 9143              ;PROCname
 755+ 9143              ;N.B. ENTERED WITH A = ON PROC FLAG
 756+ 9143              ;
 757+ 9143 F5           PROC:			PUSH    AF              ;MAKE SPACE ON STACK
 758+ 9144 CD 47 91     			CALL    PROC1
 759+ 9147              PROCHK:			EQU     $
 760+ 9147              PROC1:
 760+ 9147 CD E2 95      			CALL    CHECK
 761+ 914A FD 2B        			DEC     IY
 762+ 914C FD E5        			PUSH    IY
 763+ 914E CD FE 89     			CALL    GETDEF
 764+ 9151 C1           			POP     BC
 765+ 9152 28 39        			JR      Z,PROC4
 766+ 9154 3E 1E        			LD      A,30
 767+ 9156 38 E4        			JR      C,ERROR3        ;"Bad call"
 768+ 9158 C5           			PUSH    BC
 769+ 9159 2A DC B5     			LD      HL,(PAGE)
 770+ 915C 3E DD        PROC2:			LD      A,DEF
 771+ 915E CD A3 97     			CALL    SEARCH          ;LOOK FOR "DEF"
 772+ 9161 38 21        			JR      C,PROC3
 773+ 9163 E5           			PUSH    HL
 774+ 9164 FD E1        			POP     IY
 775+ 9166 FD 23        			INC     IY              ;SKIP DEF
 776+ 9168 CD 99 A4     			CALL    NXT
 777+ 916B CD FE 89     			CALL    GETDEF
 778+ 916E FD E5        			PUSH    IY
 779+ 9170 D1           			POP     DE
 780+ 9171 38 09        			JR      C,PROC6
 781+ 9173 C4 A0 8A     			CALL    NZ,CREATE
 782+ 9176 FD E5        			PUSH    IY
 783+ 9178 D1           			POP     DE
 784+ 9179 73           			LD      (HL),E
 785+ 917A 23           			INC     HL
 786+ 917B 72           			LD      (HL),D          ;SAVE ADDRESS
 787+ 917C EB           PROC6:			EX      DE,HL
 788+ 917D 3E 0D        			LD      A,CR
 789+ 917F 47           			LD      B,A
 790+ 9180 ED B1        			CPIR                    ;SKIP TO END OF LINE
 791+ 9182 18 D8        			JR      PROC2
 792+ 9184 FD E1        PROC3:			POP     IY              ;RESTORE TEXT POINTER
 793+ 9186 CD FE 89     			CALL    GETDEF
 794+ 9189 3E 1D        			LD      A,29
 795+ 918B 20 AF        			JR      NZ,ERROR3       ;"No such FN/PROC"
 796+ 918D 5E           PROC4:			LD      E,(HL)
 797+ 918E 23           			INC     HL
 798+ 918F 56           			LD      D,(HL)          ;GET ADDRESS
 799+ 9190 21 02 00     			LD      HL,2
 800+ 9193 39           			ADD     HL,SP
 801+ 9194 CD 99 A4     			CALL    NXT             ;ALLOW SPACE BEFORE (
 802+ 9197 D5           			PUSH    DE              ;EXCHANGE DE,IY
 803+ 9198 FD E3        			EX      (SP),IY
 804+ 919A D1           			POP     DE
 805+ 919B FE 28        			CP      '('             ;ARGUMENTS?
 806+ 919D 20 1B        			JR      NZ,PROC5
 807+ 919F CD 99 A4     			CALL    NXT             ;ALLOW SPACE BEFORE (
 808+ 91A2 FE 28        			CP      '('
 809+ 91A4 C2 E2 8D     			JP      NZ,SYNTAX       ;"Syntax error"
 810+ 91A7 FD E5        			PUSH    IY
 811+ 91A9 C1           			POP     BC              ;SAVE IY IN BC
 812+ 91AA D9           			EXX
 813+ 91AB CD 73 96     			CALL    SAVLOC          ;SAVE DUMMY VARIABLES
 814+ 91AE CD 5D A4     			CALL    BRAKET          ;CLOSING BRACKET
 815+ 91B1 D9           			EXX
 816+ 91B2 C5           			PUSH    BC
 817+ 91B3 FD E1        			POP     IY              ;RESTORE IY
 818+ 91B5 E5           			PUSH    HL
 819+ 91B6 CD FE 95     			CALL    ARGUE           ;TRANSFER ARGUMENTS
 820+ 91B9 E1           			POP     HL
 821+ 91BA 73           PROC5:			LD      (HL),E          ;SAVE "RETURN ADDRESS"
 822+ 91BB 23           			INC     HL
 823+ 91BC 7E           			LD      A,(HL)
 824+ 91BD 72           			LD      (HL),D
 825+ 91BE FE EE        			CP      TON             ;WAS IT "ON PROC" ?
 826+ 91C0 C2 0B 8D     			JP      NZ,XEQ
 827+ 91C3 D5           			PUSH    DE
 828+ 91C4 FD E3        			EX      (SP),IY
 829+ 91C6 CD F1 96     			CALL    SPAN            ;SKIP REST OF ON LIST
 830+ 91C9 FD E3        			EX      (SP),IY
 831+ 91CB D1           			POP     DE
 832+ 91CC 72           			LD      (HL),D
 833+ 91CD 2B           			DEC     HL
 834+ 91CE 73           			LD      (HL),E
 835+ 91CF C3 0B 8D     			JP      XEQ
 836+ 91D2              ;
 837+ 91D2              ;LOCAL var[,var...]
 838+ 91D2              ;
 839+ 91D2 C1           LOCAL:			POP     BC
 840+ 91D3 C5           			PUSH    BC
 841+ 91D4 21 43 91     			LD      HL,FNCHK
 842+ 91D7 B7           			OR      A
 843+ 91D8 ED 42        			SBC     HL,BC
 844+ 91DA 28 13        			JR      Z,LOCAL1
 845+ 91DC 21 47 91     			LD      HL,PROCHK
 846+ 91DF B7           			OR      A
 847+ 91E0 ED 42        			SBC     HL,BC
 848+ 91E2 28 0B        			JR      Z,LOCAL1
 849+ 91E4 21 C5 96     			LD      HL,LOCCHK
 850+ 91E7 B7           			OR      A
 851+ 91E8 ED 42        			SBC     HL,BC
 852+ 91EA 3E 0C        			LD      A,12
 853+ 91EC C2 FE 86     			JP      NZ,ERROR        ;"Not LOCAL"
 854+ 91EF FD E5        LOCAL1:			PUSH    IY
 855+ 91F1 C1           			POP     BC
 856+ 91F2 D9           			EXX
 857+ 91F3 FD 2B        			DEC     IY
 858+ 91F5 CD 73 96     			CALL    SAVLOC
 859+ 91F8 D9           			EXX
 860+ 91F9 C5           			PUSH    BC
 861+ 91FA FD E1        			POP     IY
 862+ 91FC CD 62 89     LOCAL2:			CALL    GETVAR
 863+ 91FF C2 E2 8D     			JP      NZ,SYNTAX
 864+ 9202 B7           			OR      A               ;TYPE
 865+ 9203 08           			EX      AF,AF'
 866+ 9204 CD DF A3     			CALL    ZERO
 867+ 9207 08           			EX      AF,AF'
 868+ 9208 F5           			PUSH    AF
 869+ 9209 F4 81 95     			CALL    P,STORE         ;ZERO
 870+ 920C F1           			POP     AF
 871+ 920D 59           			LD      E,C
 872+ 920E FC AD 95     			CALL    M,STORES
 873+ 9211 CD 99 A4     			CALL    NXT
 874+ 9214 FE 2C        			CP      ','
 875+ 9216 C2 0B 8D     			JP      NZ,XEQ
 876+ 9219 FD 23        			INC     IY
 877+ 921B CD 99 A4     			CALL    NXT
 878+ 921E 18 DC        			JR      LOCAL2
 879+ 9220              ;
 880+ 9220              ;ENDPROC
 881+ 9220              ;
 882+ 9220 C1           ENDPRO:			POP     BC
 883+ 9221 21 C5 96     			LD      HL,LOCCHK
 884+ 9224 B7           			OR      A
 885+ 9225 ED 42        			SBC     HL,BC
 886+ 9227 28 10        			JR      Z,UNSTK         ;LOCAL VARIABLE
 887+ 9229 21 47 91     			LD      HL,PROCHK       ;PROC MARKER
 888+ 922C B7           			OR      A
 889+ 922D ED 42        			SBC     HL,BC
 890+ 922F FD E1        			POP     IY
 891+ 9231 CA 0B 8D     			JP      Z,XEQ
 892+ 9234 3E 0D        			LD      A,13
 893+ 9236 C3 FE 86     			JP      ERROR           ;"No PROC"
 894+ 9239              ;
 895+ 9239 DD E1        UNSTK:			POP     IX
 896+ 923B C1           			POP     BC
 897+ 923C 78           			LD      A,B
 898+ 923D B7           			OR      A
 899+ 923E FA 4A 92     			JP      M,UNSTK1        ;STRING
 900+ 9241 E1           			POP     HL
 901+ 9242 D9           			EXX
 902+ 9243 E1           			POP     HL
 903+ 9244 D9           			EXX
 904+ 9245 CD 81 95     			CALL    STORE
 905+ 9248 18 D6        			JR      ENDPRO
 906+ 924A 21 00 00     UNSTK1:			LD      HL,0
 907+ 924D 39           			ADD     HL,SP
 908+ 924E 59           			LD      E,C
 909+ 924F CD AD 95     			CALL    STORES
 910+ 9252 F9           			LD      SP,HL
 911+ 9253 18 CB        			JR      ENDPRO
 912+ 9255              ;
 913+ 9255              ;INPUT #channel,var,var...
 914+ 9255              ;
 915+ 9255 CD E4 97     INPUTN:			CALL    CHNL            ;E = CHANNEL NUMBER
 916+ 9258 CD 99 A4     INPN1:			CALL    NXT
 917+ 925B FE 2C        			CP      ','
 918+ 925D C2 0B 8D     			JP      NZ,XEQ
 919+ 9260 FD 23        			INC     IY
 920+ 9262 CD 99 A4     			CALL    NXT
 921+ 9265 D5           			PUSH    DE
 922+ 9266 CD DB 8D     			CALL    VAR
 923+ 9269 D1           			POP     DE
 924+ 926A F5           			PUSH    AF              ;SAVE TYPE
 925+ 926B E5           			PUSH    HL              ;VARPTR
 926+ 926C B7           			OR      A
 927+ 926D FA 92 92     			JP      M,INPN2         ;STRING
 928+ 9270 CD 02 B2     			CALL    OSBGET
 929+ 9273 D9           			EXX
 930+ 9274 6F           			LD      L,A
 931+ 9275 D9           			EXX
 932+ 9276 CD 02 B2     			CALL    OSBGET
 933+ 9279 D9           			EXX
 934+ 927A 67           			LD      H,A
 935+ 927B D9           			EXX
 936+ 927C CD 02 B2     			CALL    OSBGET
 937+ 927F 6F           			LD      L,A
 938+ 9280 CD 02 B2     			CALL    OSBGET
 939+ 9283 67           			LD      H,A
 940+ 9284 CD 02 B2     			CALL    OSBGET
 941+ 9287 4F           			LD      C,A
 942+ 9288 DD E1        			POP     IX
 943+ 928A F1           			POP     AF              ;RESTORE TYPE
 944+ 928B D5           			PUSH    DE              ;SAVE CHANNEL
 945+ 928C CD 81 95     			CALL    STORE
 946+ 928F D1           			POP     DE
 947+ 9290 18 C6        			JR      INPN1
 948+ 9292 21 00 B3     INPN2:			LD      HL,ACCS
 949+ 9295 CD 02 B2     INPN3:			CALL    OSBGET
 950+ 9298 FE 0D        			CP      CR
 951+ 929A 28 04        			JR      Z,INPN4
 952+ 929C 77           			LD      (HL),A
 953+ 929D 2C           			INC     L
 954+ 929E 20 F5        			JR      NZ,INPN3
 955+ 92A0 DD E1        INPN4:			POP     IX
 956+ 92A2 F1           			POP     AF
 957+ 92A3 D5           			PUSH    DE
 958+ 92A4 EB           			EX      DE,HL
 959+ 92A5 CD AA 95     			CALL    STACCS
 960+ 92A8 D1           			POP     DE
 961+ 92A9 18 AD        			JR      INPN1
 962+ 92AB              ;
 963+ 92AB              ;INPUT ['][SPC(x)][TAB(x[,y])]["prompt",]var[,var...]
 964+ 92AB              ;INPUT LINE [SPC(x)][TAB(x[,y])]["prompt",]var[,var...]
 965+ 92AB              ;
 966+ 92AB FE 23        INPUT:			CP      '#'
 967+ 92AD 28 A6        			JR      Z,INPUTN
 968+ 92AF 0E 00        			LD      C,0             ;FLAG PROMPT
 969+ 92B1 FE 86        			CP      LINE
 970+ 92B3 20 04        			JR      NZ,INPUT0
 971+ 92B5 FD 23        			INC     IY              ;SKIP "LINE"
 972+ 92B7 0E 80        			LD      C,80H
 973+ 92B9 21 00 B4     INPUT0:			LD      HL,BUFFER
 974+ 92BC 36 0D        			LD      (HL),CR         ;INITIALISE EMPTY
 975+ 92BE CD E5 96     INPUT1:			CALL    TERM?
 976+ 92C1 CA 0B 8D     			JP      Z,XEQ           ;DONE
 977+ 92C4 FD 23        			INC     IY
 978+ 92C6 FE 2C        			CP      ','
 979+ 92C8 28 51        			JR      Z,INPUT3        ;SKIP COMMA
 980+ 92CA FE 3B        			CP      ';'
 981+ 92CC 28 4D        			JR      Z,INPUT3
 982+ 92CE E5           			PUSH    HL              ;SAVE BUFFER POINTER
 983+ 92CF FE 22        			CP      34		;ASCII ""
 984+ 92D1 20 0A        			JR      NZ,INPUT6
 985+ 92D3 C5           			PUSH    BC
 986+ 92D4 CD B0 9F     			CALL    CONS
 987+ 92D7 C1           			POP     BC
 988+ 92D8 CD 5B 97     			CALL    PTEXT           ;PRINT PROMPT
 989+ 92DB 18 05        			JR      INPUT9
 990+ 92DD CD 06 97     INPUT6:			CALL    FORMAT          ;SPC, TAB, '
 991+ 92E0 20 05        			JR      NZ,INPUT2
 992+ 92E2 E1           INPUT9:			POP     HL
 993+ 92E3 CB C1        			SET     0,C             ;FLAG NO PROMPT
 994+ 92E5 18 D2        			JR      INPUT0
 995+ 92E7 FD 2B        INPUT2:			DEC     IY
 996+ 92E9 C5           			PUSH    BC
 997+ 92EA CD DB 8D     			CALL    VAR
 998+ 92ED C1           			POP     BC
 999+ 92EE E1           			POP     HL
1000+ 92EF F5           			PUSH    AF              ;SAVE TYPE
1001+ 92F0 7E           			LD      A,(HL)
1002+ 92F1 23           			INC     HL
1003+ 92F2 FE 0D        			CP      CR              ;BUFFER EMPTY?
1004+ 92F4 CC 1F 93     			CALL    Z,REFILL
1005+ 92F7 CB 79        			BIT     7,C
1006+ 92F9 F5           			PUSH    AF
1007+ 92FA C4 79 97     			CALL    NZ,LINES
1008+ 92FD F1           			POP     AF
1009+ 92FE CC 68 97     			CALL    Z,FETCHS
1010+ 9301 F1           			POP     AF              ;RESTORE TYPE
1011+ 9302 C5           			PUSH    BC
1012+ 9303 E5           			PUSH    HL
1013+ 9304 B7           			OR      A
1014+ 9305 FA 16 93     			JP      M,INPUT4        ;STRING
1015+ 9308 F5           			PUSH    AF
1016+ 9309 DD E5        			PUSH    IX
1017+ 930B CD 67 A1     			CALL    VAL0
1018+ 930E DD E1        			POP     IX
1019+ 9310 F1           			POP     AF
1020+ 9311 CD 81 95     			CALL    STORE
1021+ 9314 18 03        			JR      INPUT5
1022+ 9316 CD AA 95     INPUT4:			CALL    STACCS
1023+ 9319 E1           INPUT5:			POP     HL
1024+ 931A C1           			POP     BC
1025+ 931B CB 81        INPUT3:			RES     0,C
1026+ 931D 18 9F        			JR      INPUT1
1027+ 931F              ;
1028+ 931F CB 41        REFILL:			BIT     0,C
1029+ 9321 20 0A        			JR      NZ,REFIL0       ;NO PROMPT
1030+ 9323 3E 3F        			LD      A,'?'
1031+ 9325 CD 97 88     			CALL    OUTCHR          ;PROMPT
1032+ 9328 3E 20        			LD      A,' '
1033+ 932A CD 97 88     			CALL    OUTCHR
1034+ 932D 21 00 B4     REFIL0:			LD      HL,BUFFER
1035+ 9330 C5           			PUSH    BC
1036+ 9331 E5           			PUSH    HL
1037+ 9332 DD E5        			PUSH    IX
1038+ 9334 CD 1E B1     			CALL    OSLINE
1039+ 9337 DD E1        			POP     IX
1040+ 9339 E1           			POP     HL
1041+ 933A C1           			POP     BC
1042+ 933B 47           			LD      B,A             ;POS AT ENTRY
1043+ 933C AF           			XOR     A
1044+ 933D 32 FB B5     			LD      (COUNT),A
1045+ 9340 B8           			CP      B
1046+ 9341 C8           			RET     Z
1047+ 9342 7E           REFIL1:			LD      A,(HL)
1048+ 9343 FE 0D        			CP      CR
1049+ 9345 C8           			RET     Z
1050+ 9346 23           			INC     HL
1051+ 9347 10 F9        			DJNZ    REFIL1
1052+ 9349 C9           			RET
1053+ 934A              ;
1054+ 934A              ;READ var[,var...]
1055+ 934A              ;
1056+ 934A FE 23        READ:			CP      '#'
1057+ 934C CA 55 92     			JP      Z,INPUTN
1058+ 934F 2A F0 B5     			LD      HL,(DATPTR)
1059+ 9352 7E           READ0:			LD      A,(HL)
1060+ 9353 23           			INC     HL              ;SKIP COMMA OR "DATA"
1061+ 9354 FE 0D        			CP      CR              ;END OF DATA STMT?
1062+ 9356 CC 8F 93     			CALL    Z,GETDAT
1063+ 9359 E5           			PUSH    HL
1064+ 935A CD DB 8D     			CALL    VAR
1065+ 935D E1           			POP     HL
1066+ 935E B7           			OR      A
1067+ 935F FA 75 93     			JP      M,READ1         ;STRING
1068+ 9362 E5           			PUSH    HL
1069+ 9363 FD E3        			EX      (SP),IY
1070+ 9365 F5           			PUSH    AF              ;SAVE TYPE
1071+ 9366 DD E5        			PUSH    IX
1072+ 9368 CD AE 9E     			CALL    EXPRN
1073+ 936B DD E1        			POP     IX
1074+ 936D F1           			POP     AF
1075+ 936E CD 81 95     			CALL    STORE
1076+ 9371 FD E3        			EX      (SP),IY
1077+ 9373 18 07        			JR      READ2
1078+ 9375 CD 68 97     READ1:			CALL    FETCHS
1079+ 9378 E5           			PUSH    HL
1080+ 9379 CD AA 95     			CALL    STACCS
1081+ 937C E1           READ2:			POP     HL
1082+ 937D 22 F0 B5     			LD      (DATPTR),HL
1083+ 9380 CD 99 A4     			CALL    NXT
1084+ 9383 FE 2C        			CP      ','
1085+ 9385 C2 0B 8D     			JP      NZ,XEQ
1086+ 9388 FD 23        			INC     IY
1087+ 938A CD 99 A4     			CALL    NXT
1088+ 938D 18 C3        			JR      READ0
1089+ 938F              ;
1090+ 938F 3E DC        GETDAT:			LD      A,DATA
1091+ 9391 CD A3 97     			CALL    SEARCH
1092+ 9394 23           			INC     HL
1093+ 9395 D0           			RET     NC
1094+ 9396 3E 2A        			LD      A,42
1095+ 9398 C3 FE 86     ERROR4:			JP      ERROR           ;"Out of DATA"
1096+ 939B              ;
1097+ 939B              ;IF expr statement
1098+ 939B              ;IF expr THEN statement [ELSE statement]
1099+ 939B              ;IF expr THEN line [ELSE line]
1100+ 939B              ;
1101+ 939B CD B5 9E     IF:			CALL    EXPRI
1102+ 939E CD 40 A3     			CALL    TEST
1103+ 93A1 28 15        			JR      Z,IFNOT         ;FALSE
1104+ 93A3 FD 7E 00     			LD      A,(IY)
1105+ 93A6 FE 8C        			CP      THEN
1106+ 93A8 C2 0B 8D     			JP      NZ,XEQ
1107+ 93AB FD 23        			INC     IY              ;SKIP "THEN"
1108+ 93AD CD 99 A4     IF1:			CALL    NXT
1109+ 93B0 FE 8D        			CP      LINO
1110+ 93B2 C2 0B 8D     			JP      NZ,XEQ          ;STATEMENT FOLLOWS
1111+ 93B5 C3 19 90     			JP      GOTO            ;LINE NO. FOLLOWS
1112+ 93B8 FD 7E 00     IFNOT:			LD      A,(IY)
1113+ 93BB FE 0D        			CP      CR
1114+ 93BD FD 23        			INC     IY
1115+ 93BF CA 08 8D     			JP      Z,XEQ0          ;END OF LINE
1116+ 93C2 FE 8B        			CP      ELSE
1117+ 93C4 20 F2        			JR      NZ,IFNOT
1118+ 93C6 18 E5        			JR      IF1
1119+ 93C8              ;
1120+ 93C8              ;CLS
1121+ 93C8              ;
1122+ 93C8 CD BF B0     CLS:			CALL    CLRSCN
1123+ 93CB AF           			XOR     A
1124+ 93CC 32 FB B5     			LD      (COUNT),A
1125+ 93CF C3 0B 8D     			JP      XEQ
1126+ 93D2              ;
1127+ 93D2              ;STOP
1128+ 93D2              ;
1129+ 93D2 CD 4E 8C     STOP:			CALL    TELL
1130+ 93D5 0D           			DEFB    CR
1131+ 93D6 0A           			DEFB    LF
1132+ 93D7 FA           			DEFB    TSTOP
1133+ 93D8 00           			DEFB    0
1134+ 93D9 CD E7 88     			CALL    SETLIN          ;FIND CURRENT LINE
1135+ 93DC CD 11 89     			CALL    SAYLN
1136+ 93DF CD 90 88     			CALL    CRLF
1137+ 93E2 C3 92 80     			JP      CLOOP
1138+ 93E5              ;
1139+ 93E5              ;REPORT
1140+ 93E5              ;
1141+ 93E5 CD 42 8C     REPOR:			CALL    REPORT
1142+ 93E8 C3 0B 8D     			JP      XEQ
1143+ 93EB              ;
1144+ 93EB              ;CLEAR
1145+ 93EB              ;
1146+ 93EB CD EF 87     CLR:			CALL    CLEAR
1147+ 93EE 2A DC B5     			LD      HL,(PAGE)
1148+ 93F1 18 13        			JR      RESTR1
1149+ 93F3              ;
1150+ 93F3              ;RESTORE [line]
1151+ 93F3              ;
1152+ 93F3 2A DC B5     RESTOR:			LD      HL,(PAGE)
1153+ 93F6 CD E5 96     			CALL    TERM?
1154+ 93F9 28 0B        			JR      Z,RESTR1
1155+ 93FB CD CC 9E     			CALL    ITEMI
1156+ 93FE D9           			EXX
1157+ 93FF CD CE 88     			CALL    FINDL           ;SEARCH FOR LINE
1158+ 9402 3E 29        			LD      A,41
1159+ 9404 20 92        			JR      NZ,ERROR4       ;"No such line"
1160+ 9406 3E DC        RESTR1:			LD      A,DATA
1161+ 9408 CD A3 97     			CALL    SEARCH
1162+ 940B 22 F0 B5     			LD      (DATPTR),HL
1163+ 940E C3 0B 8D     			JP      XEQ
1164+ 9411              ;
1165+ 9411              ;PTR#channel=expr
1166+ 9411              ;PAGE=expr
1167+ 9411              ;TIME=expr
1168+ 9411              ;LOMEM=expr
1169+ 9411              ;HIMEM=expr
1170+ 9411              ;
1171+ 9411 CD DA 97     PTR:			CALL    CHANEL
1172+ 9414 CD F9 96     			CALL    EQUALS
1173+ 9417 7B           			LD      A,E
1174+ 9418 F5           			PUSH    AF
1175+ 9419 CD B5 9E     			CALL    EXPRI
1176+ 941C E5           			PUSH    HL
1177+ 941D D9           			EXX
1178+ 941E D1           			POP     DE
1179+ 941F F1           			POP     AF
1180+ 9420 CD 02 B2     			CALL    PUTPTR
1181+ 9423 C3 0B 8D     			JP      XEQ
1182+ 9426              ;
1183+ 9426 CD F9 96     PAGEV:			CALL    EQUALS
1184+ 9429 CD B5 9E     			CALL    EXPRI
1185+ 942C D9           			EXX
1186+ 942D 2E 00        			LD      L,0
1187+ 942F 22 DC B5     			LD      (PAGE),HL
1188+ 9432 C3 0B 8D     			JP      XEQ
1189+ 9435              ;
1190+ 9435 FE 24        TIMEV:			CP      '$'
1191+ 9437 28 0F        			JR      Z,TIMEVS
1192+ 9439 CD F9 96     			CALL    EQUALS
1193+ 943C CD B5 9E     			CALL    EXPRI
1194+ 943F E5           			PUSH    HL
1195+ 9440 D9           			EXX
1196+ 9441 D1           			POP     DE
1197+ 9442 CD CE B0     			CALL    PUTIME
1198+ 9445 C3 0B 8D     			JP      XEQ
1199+ 9448              ;
1200+ 9448 FD 23        TIMEVS:			INC     IY              ;SKIP '$'
1201+ 944A CD F9 96     			CALL    EQUALS
1202+ 944D CD BE 9E     			CALL    EXPRS
1203+ 9450 CD B5 B0     			CALL    PUTIMS
1204+ 9453 C3 0B 8D     			JP      XEQ
1205+ 9456              ;
1206+ 9456 CD F9 96     LOMEMV:			CALL    EQUALS
1207+ 9459 CD B5 9E     			CALL    EXPRI
1208+ 945C CD EF 87     			CALL    CLEAR
1209+ 945F D9           			EXX
1210+ 9460 22 E0 B5     			LD      (LOMEM),HL
1211+ 9463 22 E2 B5     			LD      (FREE),HL
1212+ 9466 C3 0B 8D     			JP      XEQ
1213+ 9469              ;
1214+ 9469 CD F9 96     HIMEMV:			CALL    EQUALS
1215+ 946C CD B5 9E     			CALL    EXPRI
1216+ 946F D9           			EXX
1217+ 9470 ED 5B E2 B5  			LD      DE,(FREE)
1218+ 9474 14           			INC     D
1219+ 9475 AF           			XOR     A
1220+ 9476 ED 52        			SBC     HL,DE
1221+ 9478 19           			ADD     HL,DE
1222+ 9479 DA FE 86     			JP      C,ERROR         ;"No room"
1223+ 947C ED 5B E4 B5  			LD      DE,(HIMEM)
1224+ 9480 22 E4 B5     			LD      (HIMEM),HL
1225+ 9483 EB           			EX      DE,HL
1226+ 9484 ED 72        			SBC     HL,SP
1227+ 9486 C2 0B 8D     			JP      NZ,XEQ
1228+ 9489 EB           			EX      DE,HL
1229+ 948A F9           			LD      SP,HL           ;LOAD STACK POINTER
1230+ 948B C3 0B 8D     			JP      XEQ
1231+ 948E              ;
1232+ 948E              ;WIDTH expr
1233+ 948E              ;
1234+ 948E CD B5 9E     WIDTHV:			CALL    EXPRI
1235+ 9491 D9           			EXX
1236+ 9492 7D           			LD      A,L
1237+ 9493 32 FC B5     			LD      (WIDTH),A
1238+ 9496 C3 0B 8D     			JP      XEQ
1239+ 9499              ;
1240+ 9499              ;TRACE ON
1241+ 9499              ;TRACE OFF
1242+ 9499              ;TRACE line
1243+ 9499              ;
1244+ 9499 FD 23        TRACE:			INC     IY
1245+ 949B 21 00 00     			LD      HL,0
1246+ 949E FE EE        			CP      TON
1247+ 94A0 28 0A        			JR      Z,TRACE0
1248+ 94A2 FE 87        			CP      OFF
1249+ 94A4 28 07        			JR      Z,TRACE1
1250+ 94A6 FD 2B        			DEC     IY
1251+ 94A8 CD B5 9E     			CALL    EXPRI
1252+ 94AB D9           			EXX
1253+ 94AC 2B           TRACE0:			DEC     HL
1254+ 94AD 22 E8 B5     TRACE1:			LD      (TRACEN),HL
1255+ 94B0 C3 0B 8D     			JP      XEQ
1256+ 94B3              ;
1257+ 94B3              ;VDU expr,expr;....
1258+ 94B3              ;
1259+ 94B3 CD B5 9E     VDU:			CALL    EXPRI
1260+ 94B6 D9           			EXX
1261+ 94B7 7D           			LD      A,L
1262+ 94B8 CD E2 B0     			CALL    OSWRCH
1263+ 94BB FD 7E 00     			LD      A,(IY)
1264+ 94BE FE 2C        			CP      ','
1265+ 94C0 28 08        			JR      Z,VDU2
1266+ 94C2 FE 3B        			CP      ';'
1267+ 94C4 20 06        			JR      NZ,VDU3
1268+ 94C6 7C           			LD      A,H
1269+ 94C7 CD E2 B0     			CALL    OSWRCH
1270+ 94CA FD 23        VDU2:			INC     IY
1271+ 94CC CD E5 96     VDU3:			CALL    TERM?
1272+ 94CF 20 E2        			JR      NZ,VDU
1273+ 94D1 C3 0B 8D     			JP      XEQ
1274+ 94D4              ;
1275+ 94D4              ;CLOSE channel number
1276+ 94D4              ;
1277+ 94D4 CD DA 97     CLOSE:			CALL    CHANEL
1278+ 94D7 CD 02 B2     			CALL    OSSHUT
1279+ 94DA C3 0B 8D     			JP      XEQ
1280+ 94DD              ;
1281+ 94DD              ;BPUT channel,byte
1282+ 94DD              ;
1283+ 94DD CD DA 97     BPUT:			CALL    CHANEL          ;CHANNEL NUMBER
1284+ 94E0 D5           			PUSH    DE
1285+ 94E1 CD 51 A4     			CALL    COMMA
1286+ 94E4 CD B5 9E     			CALL    EXPRI           ;BYTE
1287+ 94E7 D9           			EXX
1288+ 94E8 7D           			LD      A,L
1289+ 94E9 D1           			POP     DE
1290+ 94EA CD 02 B2     			CALL    OSBPUT
1291+ 94ED C3 0B 8D     			JP      XEQ
1292+ 94F0              ;
1293+ 94F0              ;CALL address[,var[,var...]]
1294+ 94F0              ;
1295+ 94F0 CD B5 9E     CALL:			CALL    EXPRI           ;ADDRESS
1296+ 94F3 D9           			EXX
1297+ 94F4 E5           			PUSH    HL              ;SAVE IT
1298+ 94F5 06 00        			LD      B,0             ;PARAMETER COUNTER
1299+ 94F7 11 00 B4     			LD      DE,BUFFER       ;VECTOR
1300+ 94FA CD 99 A4     CALL1:			CALL    NXT
1301+ 94FD FE 2C        			CP      ','
1302+ 94FF 20 17        			JR      NZ,CALL2
1303+ 9501 FD 23        			INC     IY
1304+ 9503 04           			INC     B
1305+ 9504 CD 99 A4     			CALL    NXT
1306+ 9507 C5           			PUSH    BC
1307+ 9508 D5           			PUSH    DE
1308+ 9509 CD DB 8D     			CALL    VAR
1309+ 950C D1           			POP     DE
1310+ 950D C1           			POP     BC
1311+ 950E 13           			INC     DE
1312+ 950F 12           			LD      (DE),A          ;PARAMETER TYPE
1313+ 9510 13           			INC     DE
1314+ 9511 EB           			EX      DE,HL
1315+ 9512 73           			LD      (HL),E          ;PARAMETER ADDRESS
1316+ 9513 23           			INC     HL
1317+ 9514 72           			LD      (HL),D
1318+ 9515 EB           			EX      DE,HL
1319+ 9516 18 E2        			JR      CALL1
1320+ 9518 78           CALL2:			LD      A,B
1321+ 9519 32 00 B4     			LD      (BUFFER),A      ;PARAMETER COUNT
1322+ 951C E1           			POP     HL              ;RESTORE ADDRESS
1323+ 951D CD 27 95     			CALL    USR1
1324+ 9520 C3 0B 8D     			JP      XEQ
1325+ 9523              ;
1326+ 9523              ;USR(address)
1327+ 9523              ;
1328+ 9523 CD CC 9E     @USR:			CALL    ITEMI
1329+ 9526 D9           			EXX
1330+ 9527 E5           USR1:			PUSH    HL              ;ADDRESS ON STACK
1331+ 9528 FD E3        			EX      (SP),IY
1332+ 952A 24           			INC     H               ;PAGE &FF?
1333+ 952B 21 56 95     			LD      HL,USR2         ;RETURN ADDRESS
1334+ 952E E5           			PUSH    HL
1335+ 952F DD 21 00 B5  			LD      IX,STAVAR
1336+ 9533 CC 02 B2     			CALL    Z,OSCALL        ;INTERCEPT PAGE &FF
1337+ 9536 DD 4E 18     			LD      C,(IX+24)
1338+ 9539 C5           			PUSH    BC
1339+ 953A F1           			POP     AF              ;LOAD FLAGS
1340+ 953B DD 7E 04     			LD      A,(IX+4)        ;LOAD Z80 REGISTERS
1341+ 953E DD 46 08     			LD      B,(IX+8)
1342+ 9541 DD 4E 0C     			LD      C,(IX+12)
1343+ 9544 DD 56 10     			LD      D,(IX+16)
1344+ 9547 DD 5E 14     			LD      E,(IX+20)
1345+ 954A DD 66 20     			LD      H,(IX+32)
1346+ 954D DD 6E 30     			LD      L,(IX+48)
1347+ 9550 DD 21 00 B4  			LD      IX,BUFFER
1348+ 9554 FD E9        			JP      (IY)            ;OFF TO USER ROUTINE
1349+ 9556 FD E1        USR2:			POP     IY
1350+ 9558 AF           			XOR     A
1351+ 9559 4F           			LD      C,A
1352+ 955A C9           			RET
1353+ 955B              ;
1354+ 955B              ;PUT port,data
1355+ 955B              ;
1356+ 955B CD B5 9E     PUT:			CALL    EXPRI           ;PORT ADDRESS
1357+ 955E D9           			EXX
1358+ 955F E5           			PUSH    HL
1359+ 9560 CD 51 A4     			CALL    COMMA
1360+ 9563 CD B5 9E     			CALL    EXPRI           ;DATA
1361+ 9566 D9           			EXX
1362+ 9567 C1           			POP     BC
1363+ 9568 ED 69        			OUT     (C),L           ;OUTPUT TO PORT BC
1364+ 956A C3 0B 8D     			JP      XEQ
1365+ 956D              ;
1366+ 956D              ;SUBROUTINES:
1367+ 956D              ;
1368+ 956D              ;ASSIGN - Assign a numeric value to a variable.
1369+ 956D              ;Outputs: NC,  Z - OK, numeric.
1370+ 956D              ;         NC, NZ - OK, string.
1371+ 956D              ;          C, NZ - illegal
1372+ 956D              ;
1373+ 956D CD 62 89     ASSIGN:			CALL    GETVAR          ;VARIABLE
1374+ 9570 D8           			RET     C               ;ILLEGAL VARIABLE
1375+ 9571 C4 53 89     			CALL    NZ,PUTVAR
1376+ 9574 B7           			OR      A
1377+ 9575 F8           			RET     M               ;STRING VARIABLE
1378+ 9576 F5           			PUSH    AF              ;NUMERIC TYPE
1379+ 9577 CD F9 96     			CALL    EQUALS
1380+ 957A E5           			PUSH    HL
1381+ 957B CD AE 9E     			CALL    EXPRN
1382+ 957E DD E1        			POP     IX
1383+ 9580 F1           			POP     AF
1384+ 9581 CB 47        STORE:			BIT     0,A
1385+ 9583 28 13        			JR      Z,STOREI
1386+ 9585 BF           			CP      A               ;SET ZERO
1387+ 9586 DD 71 04     @STORE5:		LD      (IX+4),C
1388+ 9589 D9           @STORE4:		EXX
1389+ 958A DD 75 00     			LD      (IX+0),L
1390+ 958D DD 74 01     			LD      (IX+1),H
1391+ 9590 D9           			EXX
1392+ 9591 DD 75 02     			LD      (IX+2),L
1393+ 9594 DD 74 03     			LD      (IX+3),H
1394+ 9597 C9           			RET
1395+ 9598 F5           STOREI:			PUSH    AF
1396+ 9599 0C           			INC     C               ;SPEED - & PRESERVE F'
1397+ 959A 0D           			DEC     C               ; WHEN CALLED BY FNEND0
1398+ 959B C4 5C A1     			CALL    NZ,SFIX         ;CONVERT TO INTEGER
1399+ 959E F1           			POP     AF
1400+ 959F FE 04        			CP      4
1401+ 95A1 28 E6        			JR      Z,STORE4
1402+ 95A3 BF           			CP      A               ;SET ZERO
1403+ 95A4 D9           STORE1:			EXX
1404+ 95A5 DD 75 00     			LD      (IX+0),L
1405+ 95A8 D9           			EXX
1406+ 95A9 C9           			RET
1407+ 95AA              ;
1408+ 95AA 21 00 B3     STACCS:			LD      HL,ACCS
1409+ 95AD 1F           STORES:			RRA
1410+ 95AE 30 3F        			JR      NC,STORS3       ;FIXED STRING
1411+ 95B0 E5           			PUSH    HL
1412+ 95B1 CD 7A 9F     			CALL    LOAD4
1413+ 95B4 7B           			LD      A,E             ;LENGTH OF STRING
1414+ 95B5 D9           			EXX
1415+ 95B6 6F           			LD      L,A
1416+ 95B7 7C           			LD      A,H             ;LENGTH ALLOCATED
1417+ 95B8 D9           			EXX
1418+ 95B9 BB           			CP      E
1419+ 95BA 30 14        			JR      NC,STORS1       ;ENOUGH ROOM
1420+ 95BC D9           			EXX
1421+ 95BD 65           			LD      H,L
1422+ 95BE D9           			EXX
1423+ 95BF E5           			PUSH    HL
1424+ 95C0 06 00        			LD      B,0
1425+ 95C2 4F           			LD      C,A
1426+ 95C3 09           			ADD     HL,BC
1427+ 95C4 ED 4B E2 B5  			LD      BC,(FREE)
1428+ 95C8 ED 42        			SBC     HL,BC           ;IS STRING LAST?
1429+ 95CA E1           			POP     HL
1430+ 95CB 37           			SCF
1431+ 95CC 28 02        			JR      Z,STORS1
1432+ 95CE 60           			LD      H,B
1433+ 95CF 69           			LD      L,C
1434+ 95D0 CD 89 95     STORS1:			CALL    STORE4          ;PRESERVES CARRY!
1435+ 95D3 06 00        			LD      B,0
1436+ 95D5 4B           			LD      C,E
1437+ 95D6 EB           			EX      DE,HL
1438+ 95D7 E1           			POP     HL
1439+ 95D8 0D           			DEC     C
1440+ 95D9 0C           			INC     C
1441+ 95DA C8           			RET     Z               ;NULL STRING
1442+ 95DB ED B0        			LDIR
1443+ 95DD D0           			RET     NC              ;STRING REPLACED
1444+ 95DE ED 53 E2 B5  			LD      (FREE),DE
1445+ 95E2 E5           @CHECK:			PUSH    HL
1446+ 95E3 2A E2 B5     			LD      HL,(FREE)
1447+ 95E6 24           			INC     H
1448+ 95E7 ED 72        			SBC     HL,SP
1449+ 95E9 E1           			POP     HL
1450+ 95EA D8           			RET     C
1451+ 95EB AF           			XOR     A
1452+ 95EC C3 FE 86     			JP      ERROR           ;"No room"
1453+ 95EF              ;
1454+ 95EF 4B           STORS3:			LD      C,E
1455+ 95F0 DD E5        			PUSH    IX
1456+ 95F2 D1           			POP     DE
1457+ 95F3 AF           			XOR     A
1458+ 95F4 47           			LD      B,A
1459+ 95F5 B9           			CP      C
1460+ 95F6 28 02        			JR      Z,STORS5
1461+ 95F8 ED B0        			LDIR
1462+ 95FA 3E 0D        STORS5:			LD      A,CR
1463+ 95FC 12           			LD      (DE),A
1464+ 95FD C9           			RET
1465+ 95FE              ;
1466+ 95FE              ;ARGUE: TRANSFER FN OR PROC ARGUMENTS FROM THE
1467+ 95FE              ; CALLING STATEMENT TO THE DUMMY VARIABLES VIA
1468+ 95FE              ; THE STACK.  IT MUST BE DONE THIS WAY TO MAKE
1469+ 95FE              ; PROCFRED(A,B)    DEF PROCFRED(B,A)     WORK.
1470+ 95FE              ;   Inputs: DE addresses parameter list
1471+ 95FE              ;           IY addresses dummy variable list
1472+ 95FE              ;  Outputs: DE,IY updated
1473+ 95FE              ; Destroys: Everything
1474+ 95FE              ;
1475+ 95FE 3E FF        ARGUE:			LD      A,-1
1476+ 9600 F5           			PUSH    AF              ;PUT MARKER ON STACK
1477+ 9601 FD 23        ARGUE1:			INC     IY              ;BUMP PAST ( OR ,
1478+ 9603 13           			INC     DE
1479+ 9604 D5           			PUSH    DE
1480+ 9605 CD 99 A4     			CALL    NXT
1481+ 9608 CD 62 89     			CALL    GETVAR
1482+ 960B 38 38        			JR      C,ARGERR
1483+ 960D C4 53 89     			CALL    NZ,PUTVAR
1484+ 9610 D1           			POP     DE
1485+ 9611 E5           			PUSH    HL              ;VARPTR
1486+ 9612 B7           			OR      A               ;TYPE
1487+ 9613 F5           			PUSH    AF
1488+ 9614 D5           			PUSH    DE
1489+ 9615 FD E3        			EX      (SP),IY
1490+ 9617 FA 2C 96     			JP      M,ARGUE2        ;STRING
1491+ 961A CD AE 9E     			CALL    EXPRN           ;PARAMETER VALUE
1492+ 961D FD E3        			EX      (SP),IY
1493+ 961F D1           			POP     DE
1494+ 9620 F1           			POP     AF
1495+ 9621 D9           			EXX
1496+ 9622 E5           			PUSH    HL
1497+ 9623 D9           			EXX
1498+ 9624 E5           			PUSH    HL
1499+ 9625 47           			LD      B,A
1500+ 9626 C5           			PUSH    BC
1501+ 9627 CD E2 95     			CALL    CHECK           ;CHECK ROOM
1502+ 962A 18 0D        			JR      ARGUE4
1503+ 962C CD BE 9E     ARGUE2:			CALL    EXPRS
1504+ 962F FD E3        			EX      (SP),IY
1505+ 9631 D9           			EXX
1506+ 9632 D1           			POP     DE
1507+ 9633 D9           			EXX
1508+ 9634 F1           			POP     AF
1509+ 9635 CD 00 A4     			CALL    PUSHS
1510+ 9638 D9           			EXX
1511+ 9639 CD 99 A4     ARGUE4:			CALL    NXT
1512+ 963C FE 2C        			CP      ','
1513+ 963E 20 0A        			JR      NZ,ARGUE5
1514+ 9640 1A           			LD      A,(DE)
1515+ 9641 FE 2C        			CP      ','
1516+ 9643 28 BC        			JR      Z,ARGUE1        ;ANOTHER
1517+ 9645 3E 1F        ARGERR:			LD      A,31
1518+ 9647 C3 FE 86     			JP      ERROR           ;"Arguments"
1519+ 964A CD 5D A4     ARGUE5:			CALL    BRAKET
1520+ 964D 1A           			LD      A,(DE)
1521+ 964E FE 29        			CP      ')'
1522+ 9650 20 F3        			JR      NZ,ARGERR
1523+ 9652 13           			INC     DE
1524+ 9653 D9           			EXX
1525+ 9654 C1           ARGUE6:			POP     BC
1526+ 9655 78           			LD      A,B
1527+ 9656 3C           			INC     A
1528+ 9657 D9           			EXX
1529+ 9658 C8           			RET     Z               ;MARKER POPPED
1530+ 9659 D9           			EXX
1531+ 965A 3D           			DEC     A
1532+ 965B FA 69 96     			JP      M,ARGUE7        ;STRING
1533+ 965E E1           			POP     HL
1534+ 965F D9           			EXX
1535+ 9660 E1           			POP     HL
1536+ 9661 D9           			EXX
1537+ 9662 DD E1        			POP     IX
1538+ 9664 CD 81 95     			CALL    STORE           ;WRITE TO DUMMY
1539+ 9667 18 EB        			JR      ARGUE6
1540+ 9669 CD 1F A4     ARGUE7:			CALL    POPS
1541+ 966C DD E1        			POP     IX
1542+ 966E CD AA 95     			CALL    STACCS
1543+ 9671 18 E1        			JR      ARGUE6
1544+ 9673              ;
1545+ 9673              ;SAVLOC: SUBROUTINE TO STACK LOCAL PARAMETERS
1546+ 9673              ;  OF A FUNCTION OR PROCEDURE.
1547+ 9673              ;THERE IS A LOT OF STACK MANIPULATION - CARE!!
1548+ 9673              ;   Inputs: IY is parameters pointer
1549+ 9673              ;  Outputs: IY updated
1550+ 9673              ; Destroys: A,B,C,D,E,H,L,IX,IY,F,SP
1551+ 9673              ;
1552+ 9673 D1           SAVLOC:			POP     DE              ;RETURN ADDRESS
1553+ 9674 FD 23        SAVLO1:			INC     IY              ;BUMP PAST ( OR ,
1554+ 9676 CD 99 A4     			CALL    NXT
1555+ 9679 D5           			PUSH    DE
1556+ 967A D9           			EXX
1557+ 967B C5           			PUSH    BC
1558+ 967C D5           			PUSH    DE
1559+ 967D E5           			PUSH    HL
1560+ 967E D9           			EXX
1561+ 967F CD DB 8D     			CALL    VAR             ;DUMMY VARIABLE
1562+ 9682 D9           			EXX
1563+ 9683 E1           			POP     HL
1564+ 9684 D1           			POP     DE
1565+ 9685 C1           			POP     BC
1566+ 9686 D9           			EXX
1567+ 9687 D1           			POP     DE
1568+ 9688 B7           			OR      A               ;TYPE
1569+ 9689 FA 9A 96     			JP      M,SAVLO2        ;STRING
1570+ 968C D9           			EXX
1571+ 968D E5           			PUSH    HL              ;SAVE H'L'
1572+ 968E D9           			EXX
1573+ 968F 47           			LD      B,A             ;TYPE
1574+ 9690 CD 6E 9F     			CALL    LOADN
1575+ 9693 D9           			EXX
1576+ 9694 E3           			EX      (SP),HL
1577+ 9695 D9           			EXX
1578+ 9696 E5           			PUSH    HL
1579+ 9697 C5           			PUSH    BC
1580+ 9698 18 26        			JR      SAVLO4
1581+ 969A F5           SAVLO2:			PUSH    AF              ;STRING TYPE
1582+ 969B D5           			PUSH    DE
1583+ 969C D9           			EXX
1584+ 969D E5           			PUSH    HL
1585+ 969E D9           			EXX
1586+ 969F CD F8 9F     			CALL    LOADS
1587+ 96A2 D9           			EXX
1588+ 96A3 E1           			POP     HL
1589+ 96A4 D9           			EXX
1590+ 96A5 4B           			LD      C,E
1591+ 96A6 D1           			POP     DE
1592+ 96A7 CD E2 95     			CALL    CHECK
1593+ 96AA F1           			POP     AF              ;LEVEL STACK
1594+ 96AB 21 00 00     			LD      HL,0
1595+ 96AE 45           			LD      B,L
1596+ 96AF ED 42        			SBC     HL,BC
1597+ 96B1 39           			ADD     HL,SP
1598+ 96B2 F9           			LD      SP,HL
1599+ 96B3 47           			LD      B,A             ;TYPE
1600+ 96B4 C5           			PUSH    BC
1601+ 96B5 28 09        			JR      Z,SAVLO4
1602+ 96B7 D5           			PUSH    DE
1603+ 96B8 11 00 B3     			LD      DE,ACCS
1604+ 96BB EB           			EX      DE,HL
1605+ 96BC 45           			LD      B,L
1606+ 96BD ED B0        			LDIR                    ;SAVE STRING ON STACK
1607+ 96BF D1           			POP     DE
1608+ 96C0 DD E5        SAVLO4:			PUSH    IX              ;VARPTR
1609+ 96C2 CD C5 96     			CALL    SAVLO5
1610+ 96C5              LOCCHK:			EQU     $
1611+ 96C5 CD E2 95     SAVLO5:			CALL    CHECK
1612+ 96C8 CD 99 A4     			CALL    NXT
1613+ 96CB FE 2C        			CP      ','             ;MORE?
1614+ 96CD 28 A5        			JR      Z,SAVLO1
1615+ 96CF EB           			EX      DE,HL
1616+ 96D0 E9           			JP      (HL)            ;"RETURN"
1617+ 96D1              ;
1618+ 96D1 FD 7E 00     DELIM:			LD      A,(IY)          ;ASSEMBLER DELIMITER
1619+ 96D4 FE 20        			CP      ' '
1620+ 96D6 C8           			RET     Z
1621+ 96D7 FE 2C        			CP      ','
1622+ 96D9 C8           			RET     Z
1623+ 96DA FE 29        			CP      ')'
1624+ 96DC C8           			RET     Z
1625+ 96DD FE 3B        TERM:			CP      ';'             ;ASSEMBLER TERMINATOR
1626+ 96DF C8           			RET     Z
1627+ 96E0 FE 5C        			CP      '\'
1628+ 96E2 C8           			RET     Z
1629+ 96E3 18 06        			JR      TERM0
1630+ 96E5              ;
1631+ 96E5 CD 99 A4     @TERM?:			CALL    NXT
1632+ 96E8 FE 8B        			CP      ELSE
1633+ 96EA D0           			RET     NC
1634+ 96EB FE 3A        TERM0:			CP      ':'             ;ASSEMBLER SEPARATOR
1635+ 96ED D0           			RET     NC
1636+ 96EE FE 0D        			CP      CR
1637+ 96F0 C9           			RET
1638+ 96F1              ;
1639+ 96F1 CD E5 96     SPAN:			CALL    TERM?
1640+ 96F4 C8           			RET     Z
1641+ 96F5 FD 23        			INC     IY
1642+ 96F7 18 F8        			JR      SPAN
1643+ 96F9              ;
1644+ 96F9 CD 99 A4     EQUALS:			CALL    NXT
1645+ 96FC FD 23        			INC     IY
1646+ 96FE FE 3D        			CP      '='
1647+ 9700 C8           			RET     Z
1648+ 9701 3E 04        			LD      A,4
1649+ 9703 C3 FE 86     			JP      ERROR           ;"Mistake"
1650+ 9706              ;
1651+ 9706 FE 8A        FORMAT:			CP      TAB
1652+ 9708 28 0C        			JR      Z,DOTAB
1653+ 970A FE 89        			CP      SPC
1654+ 970C 28 38        			JR      Z,DOSPC
1655+ 970E FE 27        			CP      ''''
1656+ 9710 C0           			RET     NZ
1657+ 9711 CD 90 88     			CALL    CRLF
1658+ 9714 AF           			XOR     A
1659+ 9715 C9           			RET
1660+ 9716              ;
1661+ 9716 C5           DOTAB:			PUSH    BC
1662+ 9717 CD B5 9E     			CALL    EXPRI
1663+ 971A D9           			EXX
1664+ 971B C1           			POP     BC
1665+ 971C FD 7E 00     			LD      A,(IY)
1666+ 971F FE 2C        			CP      ','
1667+ 9721 28 11        			JR      Z,DOTAB1
1668+ 9723 CD 5D A4     			CALL    BRAKET
1669+ 9726 7D           			LD      A,L
1670+ 9727 21 FB B5     TABIT:			LD      HL,COUNT
1671+ 972A BE           			CP      (HL)
1672+ 972B C8           			RET     Z
1673+ 972C F5           			PUSH    AF
1674+ 972D DC 90 88     			CALL    C,CRLF
1675+ 9730 F1           			POP     AF
1676+ 9731 96           			SUB     (HL)
1677+ 9732 18 19        			JR      FILL
1678+ 9734 FD 23        DOTAB1:			INC     IY
1679+ 9736 C5           			PUSH    BC
1680+ 9737 E5           			PUSH    HL
1681+ 9738 CD B5 9E     			CALL    EXPRI
1682+ 973B D9           			EXX
1683+ 973C D1           			POP     DE
1684+ 973D C1           			POP     BC
1685+ 973E CD 5D A4     			CALL    BRAKET
1686+ 9741 CD D6 B0     			CALL    PUTCSR
1687+ 9744 AF           			XOR     A
1688+ 9745 C9           			RET
1689+ 9746              ;
1690+ 9746 C5           DOSPC:			PUSH    BC
1691+ 9747 CD CC 9E     			CALL    ITEMI
1692+ 974A D9           			EXX
1693+ 974B 7D           			LD      A,L
1694+ 974C C1           			POP     BC
1695+ 974D B7           @FILL:			OR      A
1696+ 974E C8           			RET     Z
1697+ 974F C5           			PUSH    BC
1698+ 9750 47           			LD      B,A
1699+ 9751 3E 20        FILL1:			LD      A,' '
1700+ 9753 CD 97 88     			CALL    OUTCHR
1701+ 9756 10 F9        			DJNZ    FILL1
1702+ 9758 C1           			POP     BC
1703+ 9759 AF           			XOR     A
1704+ 975A C9           			RET
1705+ 975B              ;
1706+ 975B 21 00 B3     PTEXT:			LD      HL,ACCS
1707+ 975E 1C           			INC     E
1708+ 975F 1D           PTEXT1:			DEC     E
1709+ 9760 C8           			RET     Z
1710+ 9761 7E           			LD      A,(HL)
1711+ 9762 23           			INC     HL
1712+ 9763 CD 97 88     			CALL    OUTCHR
1713+ 9766 18 F7        			JR      PTEXT1
1714+ 9768              ;
1715+ 9768 F5           FETCHS:			PUSH    AF
1716+ 9769 C5           			PUSH    BC
1717+ 976A E5           			PUSH    HL
1718+ 976B FD E3        			EX      (SP),IY
1719+ 976D CD 85 97     			CALL    XTRACT
1720+ 9770 CD 99 A4     			CALL    NXT
1721+ 9773 FD E3        			EX      (SP),IY
1722+ 9775 E1           			POP     HL
1723+ 9776 C1           			POP     BC
1724+ 9777 F1           			POP     AF
1725+ 9778 C9           			RET
1726+ 9779              ;
1727+ 9779 11 00 B3     LINES:			LD      DE,ACCS
1728+ 977C 7E           LINE1S:			LD      A,(HL)
1729+ 977D 12           			LD      (DE),A
1730+ 977E FE 0D        			CP      CR
1731+ 9780 C8           			RET     Z
1732+ 9781 23           			INC     HL
1733+ 9782 1C           			INC     E
1734+ 9783 18 F7        			JR      LINE1S
1735+ 9785              ;
1736+ 9785 CD 99 A4     XTRACT:			CALL    NXT
1737+ 9788 FE 22        			CP      34		;ASCII ""
1738+ 978A FD 23        			INC     IY
1739+ 978C CA B0 9F     			JP      Z,CONS
1740+ 978F FD 2B        			DEC     IY
1741+ 9791 11 00 B3     			LD      DE,ACCS
1742+ 9794 FD 7E 00     XTRAC1:			LD      A,(IY)
1743+ 9797 12           			LD      (DE),A
1744+ 9798 FE 2C        			CP      ','
1745+ 979A C8           			RET     Z
1746+ 979B FE 0D        			CP      CR
1747+ 979D C8           			RET     Z
1748+ 979E FD 23        			INC     IY
1749+ 97A0 1C           			INC     E
1750+ 97A1 18 F1        			JR      XTRAC1
1751+ 97A3              ;
1752+ 97A3 06 00        SEARCH:			LD      B,0
1753+ 97A5 4E           SRCH1:			LD      C,(HL)
1754+ 97A6 0C           			INC     C
1755+ 97A7 0D           			DEC     C
1756+ 97A8 28 0C        			JR      Z,SRCH2         ;FAIL
1757+ 97AA 23           			INC     HL
1758+ 97AB 23           			INC     HL
1759+ 97AC 23           			INC     HL
1760+ 97AD BE           			CP      (HL)
1761+ 97AE C8           			RET     Z
1762+ 97AF 0D           			DEC     C
1763+ 97B0 0D           			DEC     C
1764+ 97B1 0D           			DEC     C
1765+ 97B2 09           			ADD     HL,BC
1766+ 97B3 C3 A5 97     			JP      SRCH1
1767+ 97B6 2B           SRCH2:			DEC     HL              ;POINT TO CR
1768+ 97B7 37           			SCF
1769+ 97B8 C9           			RET
1770+ 97B9              ;
1771+ 97B9 FE 05        @X4OR5:			CP      5
1772+ 97BB 62           			LD      H,D
1773+ 97BC 6B           			LD      L,E
1774+ 97BD 29           			ADD     HL,HL
1775+ 97BE D8           			RET     C
1776+ 97BF 29           			ADD     HL,HL
1777+ 97C0 D8           			RET     C
1778+ 97C1 EB           			EX      DE,HL
1779+ 97C2 C0           			RET     NZ
1780+ 97C3 19           			ADD     HL,DE
1781+ 97C4 EB           			EX      DE,HL
1782+ 97C5 C9           			RET
1783+ 97C6              ;
1784+ 97C6 EB           @MUL16:			EX      DE,HL
1785+ 97C7 21 00 00     			LD      HL,0
1786+ 97CA 3E 10        			LD      A,16
1787+ 97CC 29           MUL161:			ADD     HL,HL
1788+ 97CD D8           			RET     C               ;OVERFLOW
1789+ 97CE CB 23        			SLA     E
1790+ 97D0 CB 12        			RL      D
1791+ 97D2 30 02        			JR      NC,MUL162
1792+ 97D4 09           			ADD     HL,BC
1793+ 97D5 D8           			RET     C
1794+ 97D6 3D           MUL162:			DEC     A
1795+ 97D7 20 F3        			JR      NZ,MUL161
1796+ 97D9 C9           			RET
1797+ 97DA              ;
1798+ 97DA CD 99 A4     @CHANEL:		CALL    NXT
1799+ 97DD FE 23        			CP      '#'
1800+ 97DF 3E 2D        			LD      A,45
1801+ 97E1 C2 FE 86     			JP      NZ,ERROR        ;"Missing #"
1802+ 97E4 FD 23        CHNL:			INC     IY              ;SKIP '#'
1803+ 97E6 CD CC 9E     			CALL    ITEMI
1804+ 97E9 D9           			EXX
1805+ 97EA EB           			EX      DE,HL
1806+ 97EB C9           			RET
1807+ 97EC              ;
1808+ 97EC              ;ASSEMBLER:
1809+ 97EC              ;LANGUAGE-INDEPENDENT CONTROL SECTION:
1810+ 97EC              ; Outputs: A=delimiter, carry set if syntax error.
1811+ 97EC              ;
1812+ 97EC CD 62 9B     ASSEM:			CALL    SKIP
1813+ 97EF FD 23        			INC     IY
1814+ 97F1 FE 3A        			CP      ':'
1815+ 97F3 28 F7        			JR      Z,ASSEM
1816+ 97F5 FE 5D        			CP      ']'
1817+ 97F7 C8           			RET     Z
1818+ 97F8 FE 0D        			CP      CR
1819+ 97FA C8           			RET     Z
1820+ 97FB FD 2B        			DEC     IY
1821+ 97FD DD 2A 40 B5  			LD      IX,(PC)         ;PROGRAM COUNTER
1822+ 9801 21 FE B5     			LD      HL,LISTON
1823+ 9804 CB 76        			BIT     6,(HL)
1824+ 9806 28 04        			JR      Z,ASSEM0
1825+ 9808 DD 2A 3C B5  			LD      IX,(OC)         ;ORIGIN of CODE
1826+ 980C DD E5        ASSEM0:			PUSH    IX
1827+ 980E FD E5        			PUSH    IY
1828+ 9810 CD A0 98     			CALL    ASMB
1829+ 9813 C1           			POP     BC
1830+ 9814 D1           			POP     DE
1831+ 9815 D8           			RET     C
1832+ 9816 CD 62 9B     			CALL    SKIP
1833+ 9819 37           			SCF
1834+ 981A C0           			RET     NZ
1835+ 981B FD 2B        			DEC     IY
1836+ 981D FD 23        ASSEM3:			INC     IY
1837+ 981F FD 7E 00     			LD      A,(IY)
1838+ 9822 CD EB 96     			CALL    TERM0
1839+ 9825 20 F6        			JR      NZ,ASSEM3
1840+ 9827 3A FE B5     			LD      A,(LISTON)
1841+ 982A DD E5        			PUSH    IX
1842+ 982C E1           			POP     HL
1843+ 982D B7           			OR      A
1844+ 982E ED 52        			SBC     HL,DE
1845+ 9830 EB           			EX      DE,HL           ;DE= NO. OF BYTES
1846+ 9831 E5           			PUSH    HL
1847+ 9832 2A 40 B5     			LD      HL,(PC)
1848+ 9835 E5           			PUSH    HL
1849+ 9836 19           			ADD     HL,DE
1850+ 9837 22 40 B5     			LD      (PC),HL         ;UPDATE PC
1851+ 983A CB 77        			BIT     6,A
1852+ 983C 28 07        			JR      Z,ASSEM5
1853+ 983E 2A 3C B5     			LD      HL,(OC)
1854+ 9841 19           			ADD     HL,DE
1855+ 9842 22 3C B5     			LD      (OC),HL         ;UPDATE OC
1856+ 9845 E1           ASSEM5:			POP     HL              ;OLD PC
1857+ 9846 DD E1        			POP     IX              ;CODE HERE
1858+ 9848 CB 67        			BIT     4,A
1859+ 984A 28 A0        			JR      Z,ASSEM
1860+ 984C 7C           			LD      A,H
1861+ 984D CD 8C 98     			CALL    HEX
1862+ 9850 7D           			LD      A,L
1863+ 9851 CD 85 98     			CALL    HEXSP
1864+ 9854 AF           			XOR     A
1865+ 9855 BB           			CP      E
1866+ 9856 28 15        			JR      Z,ASSEM2
1867+ 9858 3A FB B5     ASSEM1:			LD      A,(COUNT)
1868+ 985B FE 11        			CP      17
1869+ 985D 3E 05        			LD      A,5
1870+ 985F D4 27 97     			CALL    NC,TABIT        ;NEXT LINE
1871+ 9862 DD 7E 00     			LD      A,(IX)
1872+ 9865 CD 85 98     			CALL    HEXSP
1873+ 9868 DD 23        			INC     IX
1874+ 986A 1D           			DEC     E
1875+ 986B 20 EB        			JR      NZ,ASSEM1
1876+ 986D 3E 12        ASSEM2:			LD      A,18
1877+ 986F CD 27 97     			CALL    TABIT
1878+ 9872 FD E5        			PUSH    IY
1879+ 9874 E1           			POP     HL
1880+ 9875 ED 42        			SBC     HL,BC
1881+ 9877 0A           ASSEM4:			LD      A,(BC)
1882+ 9878 CD B0 88     			CALL    OUT
1883+ 987B 03           			INC     BC
1884+ 987C 2D           			DEC     L
1885+ 987D 20 F8        			JR      NZ,ASSEM4
1886+ 987F CD 90 88     			CALL    CRLF
1887+ 9882 C3 EC 97     			JP      ASSEM
1888+ 9885              ;
1889+ 9885 CD 8C 98     HEXSP:			CALL    HEX
1890+ 9888 3E 20        			LD      A,' '
1891+ 988A 18 11        			JR      OUTCH1
1892+ 988C F5           HEX:			PUSH    AF
1893+ 988D 0F           			RRCA
1894+ 988E 0F           			RRCA
1895+ 988F 0F           			RRCA
1896+ 9890 0F           			RRCA
1897+ 9891 CD 95 98     			CALL    HEXOUT
1898+ 9894 F1           			POP     AF
1899+ 9895 E6 0F        HEXOUT:			AND     0FH
1900+ 9897 C6 90        			ADD     A,90H
1901+ 9899 27           			DAA
1902+ 989A CE 40        			ADC     A,40H
1903+ 989C 27           			DAA
1904+ 989D C3 B0 88     OUTCH1:			JP      OUT
1905+ 98A0              ;
1906+ 98A0              ;PROCESSOR-SPECIFIC TRANSLATION SECTION:
1907+ 98A0              ;
1908+ 98A0              ;REGISTER USAGE: B - TYPE OF MOST RECENT OPERAND
1909+ 98A0              ;                C - OPCODE BEING BUILT
1910+ 98A0              ;                D - (IX) OR (IY) FLAG
1911+ 98A0              ;                E - OFFSET FROM IX OR IY
1912+ 98A0              ;               HL - NUMERIC OPERAND VALUE
1913+ 98A0              ;               IX - CODE DESTINATION
1914+ 98A0              ;               IY - SOURCE TEXT POINTER
1915+ 98A0              ;   Inputs: A = initial character
1916+ 98A0              ;  Outputs: Carry set if syntax error.
1917+ 98A0              ;
1918+ 98A0 FE 2E        ASMB:			CP      '.'
1919+ 98A2 20 16        			JR      NZ,ASMB1
1920+ 98A4 FD 23        			INC     IY
1921+ 98A6 DD E5        			PUSH    IX
1922+ 98A8 CD DB 8D     			CALL    VAR
1923+ 98AB F5           			PUSH    AF
1924+ 98AC CD DF A3     			CALL    ZERO
1925+ 98AF D9           			EXX
1926+ 98B0 2A 40 B5     			LD      HL,(PC)
1927+ 98B3 D9           			EXX
1928+ 98B4 F1           			POP     AF
1929+ 98B5 CD 81 95     			CALL    STORE
1930+ 98B8 DD E1        			POP     IX
1931+ 98BA CD 62 9B     ASMB1:			CALL    SKIP
1932+ 98BD C8           			RET     Z
1933+ 98BE FE D6        			CP      TCALL
1934+ 98C0 0E C4        			LD      C,0C4H
1935+ 98C2 FD 23        			INC     IY
1936+ 98C4 CA B1 99     			JP      Z,GRPC
1937+ 98C7 FD 2B        			DEC     IY
1938+ 98C9 21 74 9B     			LD      HL,OPCODS
1939+ 98CC CD 19 9B     			CALL    FIND
1940+ 98CF D8           			RET     C
1941+ 98D0 48           			LD      C,B     ;ROOT OPCODE
1942+ 98D1 16 00        			LD      D,0     ;CLEAR IX/IY FLAG
1943+ 98D3              ;
1944+ 98D3              ;GROUP 0 - TRIVIAL CASES REQUIRING NO COMPUTATION
1945+ 98D3              ;GROUP 1 - AS GROUP 0 BUT WITH "ED" PREFIX
1946+ 98D3              ;
1947+ 98D3 D6 27        			SUB     39
1948+ 98D5 30 07        			JR      NC,GROUP2
1949+ 98D7 FE E8        			CP      15-39
1950+ 98D9 D4 7F 9A     			CALL    NC,ED
1951+ 98DC 18 68        			JR      BYTE0
1952+ 98DE              ;
1953+ 98DE              ;GROUP 2 - BIT, RES, SET
1954+ 98DE              ;GROUP 3 - RLC, RRC, RL, RR, SLA, SRA, SRL
1955+ 98DE              ;
1956+ 98DE D6 0A        GROUP2:			SUB     10
1957+ 98E0 30 0F        			JR      NC,GROUP4
1958+ 98E2 FE F9        			CP      3-10
1959+ 98E4 DC 09 9B     			CALL    C,BIT
1960+ 98E7 D8           			RET     C
1961+ 98E8 CD DE 9A     			CALL    REGLO
1962+ 98EB D8           			RET     C
1963+ 98EC CD 83 9A     			CALL    CB
1964+ 98EF 18 55        			JR      BYTE0
1965+ 98F1              ;
1966+ 98F1              ;GROUP 4 - PUSH, POP, EX (SP)
1967+ 98F1              ;
1968+ 98F1 D6 03        GROUP4:			SUB     3
1969+ 98F3 30 06        			JR      NC,GROUP5
1970+ 98F5 CD FD 9A     G4:			CALL    PAIR
1971+ 98F8 D8           			RET     C
1972+ 98F9 18 4B        			JR      BYTE0
1973+ 98FB              ;
1974+ 98FB              ;GROUP 5 - SUB, AND, XOR, OR, CP
1975+ 98FB              ;GROUP 6 - ADD, ADC, SBC
1976+ 98FB              ;
1977+ 98FB D6 0A        GROUP5:			SUB     8+2
1978+ 98FD 30 32        			JR      NC,GROUP7
1979+ 98FF FE FD        			CP      5-8
1980+ 9901 06 07        			LD      B,7
1981+ 9903 D4 91 9A     			CALL    NC,OPND
1982+ 9906 78           			LD      A,B
1983+ 9907 FE 07        			CP      7
1984+ 9909 20 10        			JR      NZ,G6HL
1985+ 990B CD DE 9A     G6:			CALL    REGLO
1986+ 990E 79           			LD      A,C
1987+ 990F 30 28        			JR      NC,BIND1
1988+ 9911 EE 46        			XOR     46H
1989+ 9913 CD 85 9A     			CALL    BIND
1990+ 9916 CD C1 9A     DB:			CALL    NUMBER
1991+ 9919 18 78        			JR      VAL8
1992+ 991B              ;
1993+ 991B E6 3F        G6HL:			AND     3FH
1994+ 991D FE 0C        			CP      12
1995+ 991F 37           			SCF
1996+ 9920 C0           			RET     NZ
1997+ 9921 79           			LD      A,C
1998+ 9922 FE 80        			CP      80H
1999+ 9924 0E 09        			LD      C,9
2000+ 9926 28 CD        			JR      Z,G4
2001+ 9928 EE 1C        			XOR     1CH
2002+ 992A 0F           			RRCA
2003+ 992B 4F           			LD      C,A
2004+ 992C CD 7F 9A     			CALL    ED
2005+ 992F 18 C4        			JR      G4
2006+ 9931              ;
2007+ 9931              ;GROUP 7 - INC, DEC
2008+ 9931              ;
2009+ 9931 D6 02        GROUP7:			SUB     2
2010+ 9933 30 14        			JR      NC,GROUP8
2011+ 9935 CD E4 9A     			CALL    REGHI
2012+ 9938 79           			LD      A,C
2013+ 9939 D2 85 9A     BIND1:			JP      NC,BIND
2014+ 993C EE 64        			XOR     64H
2015+ 993E 07           			RLCA
2016+ 993F 07           			RLCA
2017+ 9940 07           			RLCA
2018+ 9941 4F           			LD      C,A
2019+ 9942 CD 01 9B     			CALL    PAIR1
2020+ 9945 D8           			RET     C
2021+ 9946 79           BYTE0:			LD      A,C
2022+ 9947 18 7F        			JR      BYTE2
2023+ 9949              ;
2024+ 9949              ;GROUP 8 - IN
2025+ 9949              ;GROUP 9 - OUT
2026+ 9949              ;
2027+ 9949 D6 02        GROUP8:			SUB     2
2028+ 994B 30 21        			JR      NC,GROUPA
2029+ 994D FE FF        			CP      1-2
2030+ 994F CC 74 9A     			CALL    Z,CORN
2031+ 9952 08           			EX      AF,AF'
2032+ 9953 CD E4 9A     			CALL    REGHI
2033+ 9956 D8           			RET     C
2034+ 9957 08           			EX      AF,AF'
2035+ 9958 DC 74 9A     			CALL    C,CORN
2036+ 995B 24           			INC     H
2037+ 995C 28 E8        			JR      Z,BYTE0
2038+ 995E 78           			LD      A,B
2039+ 995F FE 07        			CP      7
2040+ 9961 37           			SCF
2041+ 9962 C0           			RET     NZ
2042+ 9963 79           			LD      A,C
2043+ 9964 EE 03        			XOR     3
2044+ 9966 07           			RLCA
2045+ 9967 07           			RLCA
2046+ 9968 07           			RLCA
2047+ 9969 CD B1 9A     			CALL    BYTE
2048+ 996C 18 25        			JR      VAL8
2049+ 996E              ;
2050+ 996E              ;GROUP 10 - JR, DJNZ
2051+ 996E              ;
2052+ 996E D6 02        GROUPA:			SUB     2
2053+ 9970 30 24        			JR      NC,GROUPB
2054+ 9972 FE FF        			CP      1-2
2055+ 9974 C4 EA 9A     			CALL    NZ,COND
2056+ 9977 79           			LD      A,C
2057+ 9978 30 02        			JR      NC,GRPA
2058+ 997A 3E 18        			LD      A,18H
2059+ 997C CD B1 9A     GRPA:			CALL    BYTE
2060+ 997F CD C1 9A     			CALL    NUMBER
2061+ 9982 ED 5B 40 B5  			LD      DE,(PC)
2062+ 9986 13           			INC     DE
2063+ 9987 37           			SCF
2064+ 9988 ED 52        			SBC     HL,DE
2065+ 998A 7D           			LD      A,L
2066+ 998B 17           			RLA
2067+ 998C 9F           			SBC     A,A
2068+ 998D BC           			CP      H
2069+ 998E 3E 01        TOOFAR:			LD      A,1
2070+ 9990 C2 FE 86     			JP      NZ,ERROR        ;"Out of range"
2071+ 9993 7D           VAL8:			LD      A,L
2072+ 9994 18 32        			JR      BYTE2
2073+ 9996              ;
2074+ 9996              ;GROUP 11 - JP
2075+ 9996              ;
2076+ 9996 47           GROUPB:			LD      B,A
2077+ 9997 20 16        			JR      NZ,GROUPC
2078+ 9999 CD EA 9A     			CALL    COND
2079+ 999C 79           			LD      A,C
2080+ 999D 30 0B        			JR      NC,GRPB
2081+ 999F 78           			LD      A,B
2082+ 99A0 E6 3F        			AND     3FH
2083+ 99A2 FE 06        			CP      6
2084+ 99A4 3E E9        			LD      A,0E9H
2085+ 99A6 28 20        			JR      Z,BYTE2
2086+ 99A8 3E C3        			LD      A,0C3H
2087+ 99AA CD B1 9A     GRPB:			CALL    BYTE
2088+ 99AD 18 05        			JR      ADDR
2089+ 99AF              ;
2090+ 99AF              ;GROUP 12 - CALL
2091+ 99AF              ;
2092+ 99AF 10 0C        GROUPC:			DJNZ    GROUPD
2093+ 99B1 CD CC 99     GRPC:			CALL    GRPE
2094+ 99B4 CD C1 9A     ADDR:			CALL    NUMBER
2095+ 99B7 CD 93 99     VAL16:			CALL    VAL8
2096+ 99BA 7C           			LD      A,H
2097+ 99BB 18 0B        			JR      BYTE2
2098+ 99BD              ;
2099+ 99BD              ;GROUP 13 - RST
2100+ 99BD              ;
2101+ 99BD 10 0B        GROUPD:			DJNZ    GROUPE
2102+ 99BF CD C1 9A     			CALL    NUMBER
2103+ 99C2 A1           			AND     C
2104+ 99C3 B4           			OR      H
2105+ 99C4 20 C8        			JR      NZ,TOOFAR
2106+ 99C6 7D           			LD      A,L
2107+ 99C7 B1           			OR      C
2108+ 99C8 18 78        BYTE2:  		JR      BYTE1
2109+ 99CA              ;
2110+ 99CA              ;GROUP 14 - RET
2111+ 99CA              ;
2112+ 99CA 10 0A        GROUPE:			DJNZ    GROUPF
2113+ 99CC CD EA 9A     GRPE:			CALL    COND
2114+ 99CF 79           			LD      A,C
2115+ 99D0 30 70        			JR      NC,BYTE1
2116+ 99D2 F6 09        			OR      9
2117+ 99D4 18 6C        			JR      BYTE1
2118+ 99D6              ;
2119+ 99D6              ;GROUP 15 - LD
2120+ 99D6              ;
2121+ 99D6 10 6C        GROUPF:			DJNZ    MISC
2122+ 99D8 CD 16 9B     			CALL    LDOP
2123+ 99DB 30 5F        			JR      NC,LDA
2124+ 99DD CD E4 9A     			CALL    REGHI
2125+ 99E0 08           			EX      AF,AF'
2126+ 99E1 CD 62 9B     			CALL    SKIP
2127+ 99E4 FE 28        			CP      '('
2128+ 99E6 28 1D        			JR      Z,LDIN
2129+ 99E8 08           			EX      AF,AF'
2130+ 99E9 D2 0B 99     			JP      NC,G6
2131+ 99EC 0E 01        			LD      C,1
2132+ 99EE CD 01 9B     			CALL    PAIR1
2133+ 99F1 D8           			RET     C
2134+ 99F2 3E 0E        			LD      A,14
2135+ 99F4 B8           			CP      B
2136+ 99F5 47           			LD      B,A
2137+ 99F6 CC FD 9A     			CALL    Z,PAIR
2138+ 99F9 78           			LD      A,B
2139+ 99FA E6 3F        			AND     3FH
2140+ 99FC FE 0C        			CP      12
2141+ 99FE 79           			LD      A,C
2142+ 99FF 20 A9        			JR      NZ,GRPB
2143+ 9A01 3E F9        			LD      A,0F9H
2144+ 9A03 18 3D        			JR      BYTE1
2145+ 9A05              ;
2146+ 9A05 08           LDIN:			EX      AF,AF'
2147+ 9A06 C5           			PUSH    BC
2148+ 9A07 D4 DE 9A     			CALL    NC,REGLO
2149+ 9A0A 79           			LD      A,C
2150+ 9A0B C1           			POP     BC
2151+ 9A0C 30 77        			JR      NC,BIND
2152+ 9A0E 0E 0A        			LD      C,0AH
2153+ 9A10 CD 01 9B     			CALL    PAIR1
2154+ 9A13 CD 5B 9A     			CALL    LD16
2155+ 9A16 30 92        			JR      NC,GRPB
2156+ 9A18 CD C1 9A     			CALL    NUMBER
2157+ 9A1B 0E 02        			LD      C,2
2158+ 9A1D CD FD 9A     			CALL    PAIR
2159+ 9A20 CD 5B 9A     			CALL    LD16
2160+ 9A23 D8           			RET     C
2161+ 9A24 CD B1 9A     			CALL    BYTE
2162+ 9A27 18 8E        			JR      VAL16
2163+ 9A29              ;
2164+ 9A29              ;OPT - SET OPTION
2165+ 9A29              ;
2166+ 9A29 05           OPT:			DEC     B
2167+ 9A2A CA 16 99     			JP      Z,DB
2168+ 9A2D 10 85        			DJNZ    ADDR
2169+ 9A2F CD C1 9A     			CALL    NUMBER
2170+ 9A32 21 FE B5     			LD      HL,LISTON
2171+ 9A35 4F           			LD      C,A
2172+ 9A36 ED 6F        			RLD
2173+ 9A38 79           			LD      A,C
2174+ 9A39 ED 67        			RRD
2175+ 9A3B C9           			RET
2176+ 9A3C              ;
2177+ 9A3C FE 04        LDA:			CP      4
2178+ 9A3E DC 7F 9A     			CALL    C,ED
2179+ 9A41 78           			LD      A,B
2180+ 9A42 18 6D        BYTE1:			JR      BYTE
2181+ 9A44              ;
2182+ 9A44              ;MISC - DEFB, DEFW, DEFM
2183+ 9A44              ;
2184+ 9A44 10 E3        MISC:			DJNZ    OPT
2185+ 9A46 DD E5        			PUSH    IX
2186+ 9A48 CD BE 9E     			CALL    EXPRS
2187+ 9A4B DD E1        			POP     IX
2188+ 9A4D 21 00 B3     			LD      HL,ACCS
2189+ 9A50 AF           DEFM1:			XOR     A
2190+ 9A51 BB           			CP      E
2191+ 9A52 C8           			RET     Z
2192+ 9A53 7E           			LD      A,(HL)
2193+ 9A54 23           			INC     HL
2194+ 9A55 CD B1 9A     			CALL    BYTE
2195+ 9A58 1D           			DEC     E
2196+ 9A59 18 F5        			JR      DEFM1
2197+ 9A5B              ;
2198+ 9A5B              ;SUBROUTINES:
2199+ 9A5B              ;
2200+ 9A5B 78           LD16:			LD      A,B
2201+ 9A5C 38 0E        			JR      C,LD8
2202+ 9A5E 78           			LD      A,B
2203+ 9A5F E6 3F        			AND     3FH
2204+ 9A61 FE 0C        			CP      12
2205+ 9A63 79           			LD      A,C
2206+ 9A64 C8           			RET     Z
2207+ 9A65 CD 7F 9A     			CALL    ED
2208+ 9A68 79           			LD      A,C
2209+ 9A69 F6 43        			OR      43H
2210+ 9A6B C9           			RET
2211+ 9A6C              ;
2212+ 9A6C FE 07        LD8:			CP      7
2213+ 9A6E 37           			SCF
2214+ 9A6F C0           			RET     NZ
2215+ 9A70 79           			LD      A,C
2216+ 9A71 F6 30        			OR      30H
2217+ 9A73 C9           			RET
2218+ 9A74              ;
2219+ 9A74 C5           CORN:			PUSH    BC
2220+ 9A75 CD 91 9A     			CALL    OPND
2221+ 9A78 CB 68        			BIT     5,B
2222+ 9A7A C1           			POP     BC
2223+ 9A7B 28 44        			JR      Z,NUMBER
2224+ 9A7D 26 FF        			LD      H,-1
2225+ 9A7F 3E ED        ED:			LD      A,0EDH
2226+ 9A81 18 2E        			JR      BYTE
2227+ 9A83              ;
2228+ 9A83 3E CB        CB:			LD      A,0CBH
2229+ 9A85 FE 76        BIND:			CP      76H
2230+ 9A87 37           			SCF
2231+ 9A88 C8           			RET     Z               ;REJECT LD (HL),(HL)
2232+ 9A89 CD B1 9A     			CALL    BYTE
2233+ 9A8C 14           			INC     D
2234+ 9A8D F0           			RET     P
2235+ 9A8E 7B           			LD      A,E
2236+ 9A8F 18 20        			JR      BYTE
2237+ 9A91              ;
2238+ 9A91 E5           OPND:			PUSH    HL
2239+ 9A92 21 BB 9C     			LD      HL,OPRNDS
2240+ 9A95 CD 19 9B     			CALL    FIND
2241+ 9A98 E1           			POP     HL
2242+ 9A99 D8           			RET     C
2243+ 9A9A CB 78        			BIT     7,B
2244+ 9A9C C8           			RET     Z
2245+ 9A9D CB 58        			BIT     3,B
2246+ 9A9F E5           			PUSH    HL
2247+ 9AA0 CC B8 9A     			CALL    Z,OFFSET
2248+ 9AA3 5D           			LD      E,L
2249+ 9AA4 E1           			POP     HL
2250+ 9AA5 3E DD        			LD      A,0DDH
2251+ 9AA7 CB 70        			BIT     6,B
2252+ 9AA9 28 02        			JR      Z,OP1
2253+ 9AAB 3E FD        			LD      A,0FDH
2254+ 9AAD B7           OP1:			OR      A
2255+ 9AAE 14           			INC     D
2256+ 9AAF 57           			LD      D,A
2257+ 9AB0 F8           			RET     M
2258+ 9AB1 DD 77 00     BYTE:			LD      (IX),A
2259+ 9AB4 DD 23        			INC     IX
2260+ 9AB6 B7           			OR      A
2261+ 9AB7 C9           			RET
2262+ 9AB8              ;
2263+ 9AB8 FD 7E 00     OFFSET:			LD      A,(IY)
2264+ 9ABB FE 29        			CP      ')'
2265+ 9ABD 21 00 00     			LD      HL,0
2266+ 9AC0 C8           			RET     Z
2267+ 9AC1 CD 62 9B     NUMBER:			CALL    SKIP
2268+ 9AC4 C5           			PUSH    BC
2269+ 9AC5 D5           			PUSH    DE
2270+ 9AC6 DD E5        			PUSH    IX
2271+ 9AC8 CD B5 9E     			CALL    EXPRI
2272+ 9ACB DD E1        			POP     IX
2273+ 9ACD D9           			EXX
2274+ 9ACE D1           			POP     DE
2275+ 9ACF C1           			POP     BC
2276+ 9AD0 7D           			LD      A,L
2277+ 9AD1 B7           			OR      A
2278+ 9AD2 C9           			RET
2279+ 9AD3              ;
2280+ 9AD3 CD 91 9A     REG:			CALL    OPND
2281+ 9AD6 D8           			RET     C
2282+ 9AD7 78           			LD      A,B
2283+ 9AD8 E6 3F        			AND     3FH
2284+ 9ADA FE 08        			CP      8
2285+ 9ADC 3F           			CCF
2286+ 9ADD C9           			RET
2287+ 9ADE              ;
2288+ 9ADE CD D3 9A     REGLO:			CALL    REG
2289+ 9AE1 D8           			RET     C
2290+ 9AE2 18 2F        			JR      ORC
2291+ 9AE4              ;
2292+ 9AE4 CD D3 9A     REGHI:			CALL    REG
2293+ 9AE7 D8           			RET     C
2294+ 9AE8 18 26        			JR      SHL3
2295+ 9AEA              ;
2296+ 9AEA CD 91 9A     COND:			CALL    OPND
2297+ 9AED D8           			RET     C
2298+ 9AEE 78           			LD      A,B
2299+ 9AEF E6 1F        			AND     1FH
2300+ 9AF1 D6 10        			SUB     16
2301+ 9AF3 30 1B        			JR      NC,SHL3
2302+ 9AF5 FE F1        			CP      -15
2303+ 9AF7 37           			SCF
2304+ 9AF8 C0           			RET     NZ
2305+ 9AF9 3E 03        			LD      A,3
2306+ 9AFB 18 13        			JR      SHL3
2307+ 9AFD              ;
2308+ 9AFD CD 91 9A     PAIR:			CALL    OPND
2309+ 9B00 D8           			RET     C
2310+ 9B01 78           PAIR1:			LD      A,B
2311+ 9B02 E6 0F        			AND     0FH
2312+ 9B04 D6 08        			SUB     8
2313+ 9B06 D8           			RET     C
2314+ 9B07 18 07        			JR      SHL3
2315+ 9B09              ;
2316+ 9B09 CD C1 9A     BIT:			CALL    NUMBER
2317+ 9B0C FE 08        			CP      8
2318+ 9B0E 3F           			CCF
2319+ 9B0F D8           			RET     C
2320+ 9B10 07           SHL3:			RLCA
2321+ 9B11 07           			RLCA
2322+ 9B12 07           			RLCA
2323+ 9B13 B1           ORC:			OR      C
2324+ 9B14 4F           			LD      C,A
2325+ 9B15 C9           			RET
2326+ 9B16              ;
2327+ 9B16 21 00 9D     LDOP:			LD      HL,LDOPS
2328+ 9B19 CD 62 9B     FIND:			CALL    SKIP
2329+ 9B1C 06 00        EXIT:			LD      B,0
2330+ 9B1E 37           			SCF
2331+ 9B1F C8           			RET     Z
2332+ 9B20 FE DD        			CP      DEF
2333+ 9B22 28 04        			JR      Z,FIND0
2334+ 9B24 FE 85        			CP      TOR+1
2335+ 9B26 3F           			CCF
2336+ 9B27 D8           			RET     C
2337+ 9B28 7E           FIND0:			LD      A,(HL)
2338+ 9B29 B7           			OR      A
2339+ 9B2A 28 F0        			JR      Z,EXIT
2340+ 9B2C FD AE 00     			XOR     (IY)
2341+ 9B2F E6 5F        			AND     01011111B
2342+ 9B31 28 09        			JR      Z,FIND2
2343+ 9B33 CB 7E        FIND1:			BIT     7,(HL)
2344+ 9B35 23           			INC     HL
2345+ 9B36 28 FB        			JR      Z,FIND1
2346+ 9B38 23           			INC     HL
2347+ 9B39 04           			INC     B
2348+ 9B3A 18 EC        			JR      FIND0
2349+ 9B3C              ;
2350+ 9B3C FD E5        FIND2:			PUSH    IY
2351+ 9B3E CB 7E        FIND3:			BIT     7,(HL)
2352+ 9B40 FD 23        			INC     IY
2353+ 9B42 23           			INC     HL
2354+ 9B43 20 10        			JR      NZ,FIND5
2355+ 9B45 BE           			CP      (HL)
2356+ 9B46 CC 61 9B     			CALL    Z,SKIP0
2357+ 9B49 7E           			LD      A,(HL)
2358+ 9B4A FD AE 00     			XOR     (IY)
2359+ 9B4D E6 5F        			AND     01011111B
2360+ 9B4F 28 ED        			JR      Z,FIND3
2361+ 9B51 FD E1        FIND4:			POP     IY
2362+ 9B53 18 DE        			JR      FIND1
2363+ 9B55              ;
2364+ 9B55 CD D1 96     FIND5:			CALL    DELIM
2365+ 9B58 C4 6E 9B     			CALL    NZ,SIGN
2366+ 9B5B 20 F4        			JR      NZ,FIND4
2367+ 9B5D 78           FIND6:			LD      A,B
2368+ 9B5E 46           			LD      B,(HL)
2369+ 9B5F E1           			POP     HL
2370+ 9B60 C9           			RET
2371+ 9B61              ;
2372+ 9B61 23           SKIP0:			INC     HL
2373+ 9B62 CD D1 96     SKIP:			CALL    DELIM
2374+ 9B65 C0           			RET     NZ
2375+ 9B66 CD DD 96     			CALL    TERM
2376+ 9B69 C8           			RET     Z
2377+ 9B6A FD 23        			INC     IY
2378+ 9B6C 18 F4        			JR      SKIP
2379+ 9B6E              ;
2380+ 9B6E FE 2B        SIGN:			CP      '+'
2381+ 9B70 C8           			RET     Z
2382+ 9B71 FE 2D        			CP      '-'
2383+ 9B73 C9           			RET
2384+ 9B74              ;
2385+ 9B74              ;.XLIST
2386+ 9B74 4E 4F        OPCODS:			DEFM    'NO'
2387+ 9B76 D0           			DEFB    'P'+80H
2388+ 9B77 00           			DEFB    0
2389+ 9B78 52 4C 43     			DEFM    'RLC'
2390+ 9B7B C1           			DEFB    'A'+80H
2391+ 9B7C 07           			DEFB    7
2392+ 9B7D 45 58        			DEFM    'EX'
2393+ 9B7F 00           			DEFB    0
2394+ 9B80 41 46        			DEFM    'AF'
2395+ 9B82 00           			DEFB    0
2396+ 9B83 41 46        			DEFM    'AF'
2397+ 9B85 A7           			DEFB    ''''+80H
2398+ 9B86 08           			DEFB    8
2399+ 9B87 52 52 43     			DEFM    'RRC'
2400+ 9B8A C1           			DEFB    'A'+80H
2401+ 9B8B 0F           			DEFB    0FH
2402+ 9B8C 52 4C        			DEFM    'RL'
2403+ 9B8E C1           			DEFB    'A'+80H
2404+ 9B8F 17           			DEFB    17H
2405+ 9B90 52 52        			DEFM    'RR'
2406+ 9B92 C1           			DEFB    'A'+80H
2407+ 9B93 1F           			DEFB    1FH
2408+ 9B94 44 41        			DEFM    'DA'
2409+ 9B96 C1           			DEFB    'A'+80H
2410+ 9B97 27           			DEFB    27H
2411+ 9B98 43 50        			DEFM    'CP'
2412+ 9B9A CC           			DEFB    'L'+80H
2413+ 9B9B 2F           			DEFB    2FH
2414+ 9B9C 53 43        			DEFM    'SC'
2415+ 9B9E C6           			DEFB    'F'+80H
2416+ 9B9F 37           			DEFB    37H
2417+ 9BA0 43 43        			DEFM    'CC'
2418+ 9BA2 C6           			DEFB    'F'+80H
2419+ 9BA3 3F           			DEFB    3FH
2420+ 9BA4 48 41 4C     			DEFM    'HAL'
2421+ 9BA7 D4           			DEFB    'T'+80H
2422+ 9BA8 76           			DEFB    76H
2423+ 9BA9 45 58        			DEFM    'EX'
2424+ 9BAB D8           			DEFB    'X'+80H
2425+ 9BAC D9           			DEFB    0D9H
2426+ 9BAD 45 58        			DEFM    'EX'
2427+ 9BAF 00           			DEFB    0
2428+ 9BB0 44 45        			DEFM    'DE'
2429+ 9BB2 00           			DEFB    0
2430+ 9BB3 48           			DEFM    'H'
2431+ 9BB4 CC           			DEFB    'L'+80H
2432+ 9BB5 EB           			DEFB    0EBH
2433+ 9BB6 44           			DEFM    'D'
2434+ 9BB7 C9           			DEFB    'I'+80H
2435+ 9BB8 F3           			DEFB    0F3H
2436+ 9BB9 45           			DEFM    'E'
2437+ 9BBA C9           			DEFB    'I'+80H
2438+ 9BBB FB           			DEFB    0FBH
2439+ 9BBC              ;
2440+ 9BBC 4E 45        			DEFM    'NE'
2441+ 9BBE C7           			DEFB    'G'+80H
2442+ 9BBF 44           			DEFB    44H
2443+ 9BC0 49 4D        			DEFM    'IM'
2444+ 9BC2 00           			DEFB    0
2445+ 9BC3 B0           			DEFB    '0'+80H
2446+ 9BC4 46           			DEFB    46H
2447+ 9BC5 52 45 54     			DEFM    'RET'
2448+ 9BC8 CE           			DEFB    'N'+80H
2449+ 9BC9 45           			DEFB    45H
2450+ 9BCA 52 45 54     			DEFM    'RET'
2451+ 9BCD C9           			DEFB    'I'+80H
2452+ 9BCE 4D           			DEFB    4DH
2453+ 9BCF 49 4D        			DEFM    'IM'
2454+ 9BD1 00           			DEFB    0
2455+ 9BD2 B1           			DEFB    '1'+80H
2456+ 9BD3 56           			DEFB    56H
2457+ 9BD4 49 4D        			DEFM    'IM'
2458+ 9BD6 00           			DEFB    0
2459+ 9BD7 B2           			DEFB    '2'+80H
2460+ 9BD8 5E           			DEFB    5EH
2461+ 9BD9 52 52        			DEFM    'RR'
2462+ 9BDB C4           			DEFB    'D'+80H
2463+ 9BDC 67           			DEFB    67H
2464+ 9BDD 52 4C        			DEFM    'RL'
2465+ 9BDF C4           			DEFB    'D'+80H
2466+ 9BE0 6F           			DEFB    6FH
2467+ 9BE1 4C 44        			DEFM    'LD'
2468+ 9BE3 C9           			DEFB    'I'+80H
2469+ 9BE4 A0           			DEFB    0A0H
2470+ 9BE5 43 50        			DEFM    'CP'
2471+ 9BE7 C9           			DEFB    'I'+80H
2472+ 9BE8 A1           			DEFB    0A1H
2473+ 9BE9 49 4E        			DEFM    'IN'
2474+ 9BEB C9           			DEFB    'I'+80H
2475+ 9BEC A2           			DEFB    0A2H
2476+ 9BED 4F 55 54     			DEFM    'OUT'
2477+ 9BF0 C9           			DEFB    'I'+80H
2478+ 9BF1 A3           			DEFB    0A3H
2479+ 9BF2 4C 44        			DEFM    'LD'
2480+ 9BF4 C4           			DEFB    'D'+80H
2481+ 9BF5 A8           			DEFB    0A8H
2482+ 9BF6 43 50        			DEFM    'CP'
2483+ 9BF8 C4           			DEFB    'D'+80H
2484+ 9BF9 A9           			DEFB    0A9H
2485+ 9BFA 49 4E        			DEFM    'IN'
2486+ 9BFC C4           			DEFB    'D'+80H
2487+ 9BFD AA           			DEFB    0AAH
2488+ 9BFE 4F 55 54     			DEFM    'OUT'
2489+ 9C01 C4           			DEFB    'D'+80H
2490+ 9C02 AB           			DEFB    0ABH
2491+ 9C03 4C 44 49     			DEFM    'LDI'
2492+ 9C06 D2           			DEFB    'R'+80H
2493+ 9C07 B0           			DEFB    0B0H
2494+ 9C08 43 50 49     			DEFM    'CPI'
2495+ 9C0B D2           			DEFB    'R'+80H
2496+ 9C0C B1           			DEFB    0B1H
2497+ 9C0D 49 4E 49     			DEFM    'INI'
2498+ 9C10 D2           			DEFB    'R'+80H
2499+ 9C11 B2           			DEFB    0B2H
2500+ 9C12 4F 54 49     			DEFM    'OTI'
2501+ 9C15 D2           			DEFB    'R'+80H
2502+ 9C16 B3           			DEFB    0B3H
2503+ 9C17 4C 44 44     			DEFM    'LDD'
2504+ 9C1A D2           			DEFB    'R'+80H
2505+ 9C1B B8           			DEFB    0B8H
2506+ 9C1C 43 50 44     			DEFM    'CPD'
2507+ 9C1F D2           			DEFB    'R'+80H
2508+ 9C20 B9           			DEFB    0B9H
2509+ 9C21 49 4E 44     			DEFM    'IND'
2510+ 9C24 D2           			DEFB    'R'+80H
2511+ 9C25 BA           			DEFB    0BAH
2512+ 9C26 4F 54 44     			DEFM    'OTD'
2513+ 9C29 D2           			DEFB    'R'+80H
2514+ 9C2A BB           			DEFB    0BBH
2515+ 9C2B              ;
2516+ 9C2B 42 49        			DEFM    'BI'
2517+ 9C2D D4           			DEFB    'T'+80H
2518+ 9C2E 40           			DEFB    40H
2519+ 9C2F 52 45        			DEFM    'RE'
2520+ 9C31 D3           			DEFB    'S'+80H
2521+ 9C32 80           			DEFB    80H
2522+ 9C33 53 45        			DEFM    'SE'
2523+ 9C35 D4           			DEFB    'T'+80H
2524+ 9C36 C0           			DEFB    0C0H
2525+ 9C37              ;
2526+ 9C37 52 4C        			DEFM    'RL'
2527+ 9C39 C3           			DEFB    'C'+80H
2528+ 9C3A 00           			DEFB    0
2529+ 9C3B 52 52        			DEFM    'RR'
2530+ 9C3D C3           			DEFB    'C'+80H
2531+ 9C3E 08           			DEFB    8
2532+ 9C3F 52           			DEFM    'R'
2533+ 9C40 CC           			DEFB    'L'+80H
2534+ 9C41 10           			DEFB    10H
2535+ 9C42 52           			DEFM    'R'
2536+ 9C43 D2           			DEFB    'R'+80H
2537+ 9C44 18           			DEFB    18H
2538+ 9C45 53 4C        			DEFM    'SL'
2539+ 9C47 C1           			DEFB    'A'+80H
2540+ 9C48 20           			DEFB    20H
2541+ 9C49 53 52        			DEFM    'SR'
2542+ 9C4B C1           			DEFB    'A'+80H
2543+ 9C4C 28           			DEFB    28H
2544+ 9C4D 53 52        			DEFM    'SR'
2545+ 9C4F CC           			DEFB    'L'+80H
2546+ 9C50 38           			DEFB    38H
2547+ 9C51              ;
2548+ 9C51 50 4F        			DEFM    'PO'
2549+ 9C53 D0           			DEFB    'P'+80H
2550+ 9C54 C1           			DEFB    0C1H
2551+ 9C55 50 55 53     			DEFM    'PUS'
2552+ 9C58 C8           			DEFB    'H'+80H
2553+ 9C59 C5           			DEFB    0C5H
2554+ 9C5A 45 58        			DEFM    'EX'
2555+ 9C5C 00           			DEFB    0
2556+ 9C5D 28 53        			DEFM    '(S'
2557+ 9C5F D0           			DEFB    'P'+80H
2558+ 9C60 E3           			DEFB    0E3H
2559+ 9C61              ;
2560+ 9C61 53 55        			DEFM    'SU'
2561+ 9C63 C2           			DEFB    'B'+80H
2562+ 9C64 90           			DEFB    90H
2563+ 9C65 41 4E        			DEFM    'AN'
2564+ 9C67 C4           			DEFB    'D'+80H
2565+ 9C68 A0           			DEFB    0A0H
2566+ 9C69 58 4F        			DEFM    'XO'
2567+ 9C6B D2           			DEFB    'R'+80H
2568+ 9C6C A8           			DEFB    0A8H
2569+ 9C6D 4F           			DEFM    'O'
2570+ 9C6E D2           			DEFB    'R'+80H
2571+ 9C6F B0           			DEFB    0B0H
2572+ 9C70 43           			DEFM    'C'
2573+ 9C71 D0           			DEFB    'P'+80H
2574+ 9C72 B8           			DEFB    0B8H
2575+ 9C73 80           			DEFB    TAND
2576+ 9C74 A0           			DEFB    0A0H
2577+ 9C75 84           			DEFB    TOR
2578+ 9C76 B0           			DEFB    0B0H
2579+ 9C77              ;
2580+ 9C77 41 44        			DEFM    'AD'
2581+ 9C79 C4           			DEFB    'D'+80H
2582+ 9C7A 80           			DEFB    80H
2583+ 9C7B 41 44        			DEFM    'AD'
2584+ 9C7D C3           			DEFB    'C'+80H
2585+ 9C7E 88           			DEFB    88H
2586+ 9C7F 53 42        			DEFM    'SB'
2587+ 9C81 C3           			DEFB    'C'+80H
2588+ 9C82 98           			DEFB    98H
2589+ 9C83              ;
2590+ 9C83 49 4E        			DEFM    'IN'
2591+ 9C85 C3           			DEFB    'C'+80H
2592+ 9C86 04           			DEFB    4
2593+ 9C87 44 45        			DEFM    'DE'
2594+ 9C89 C3           			DEFB    'C'+80H
2595+ 9C8A 05           			DEFB    5
2596+ 9C8B              ;
2597+ 9C8B 49           			DEFM    'I'
2598+ 9C8C CE           			DEFB    'N'+80H
2599+ 9C8D 40           			DEFB    40H
2600+ 9C8E 4F 55        			DEFM    'OU'
2601+ 9C90 D4           			DEFB    'T'+80H
2602+ 9C91 41           			DEFB    41H
2603+ 9C92              ;
2604+ 9C92 4A           			DEFM    'J'
2605+ 9C93 D2           			DEFB    'R'+80H
2606+ 9C94 20           			DEFB    20H
2607+ 9C95 44 4A 4E     			DEFM    'DJN'
2608+ 9C98 DA           			DEFB    'Z'+80H
2609+ 9C99 10           			DEFB    10H
2610+ 9C9A              ;
2611+ 9C9A 4A           			DEFM    'J'
2612+ 9C9B D0           			DEFB    'P'+80H
2613+ 9C9C C2           			DEFB    0C2H
2614+ 9C9D              ;
2615+ 9C9D 43 41 4C     			DEFM    'CAL'
2616+ 9CA0 CC           			DEFB    'L'+80H
2617+ 9CA1 C4           			DEFB    0C4H
2618+ 9CA2              ;
2619+ 9CA2 52 53        			DEFM    'RS'
2620+ 9CA4 D4           			DEFB    'T'+80H
2621+ 9CA5 C7           			DEFB    0C7H
2622+ 9CA6              ;
2623+ 9CA6 52 45        			DEFM    'RE'
2624+ 9CA8 D4           			DEFB    'T'+80H
2625+ 9CA9 C0           			DEFB    0C0H
2626+ 9CAA              ;
2627+ 9CAA 4C           			DEFM    'L'
2628+ 9CAB C4           			DEFB    'D'+80H
2629+ 9CAC 40           			DEFB    40H
2630+ 9CAD              ;
2631+ 9CAD 5D           			DEFB    DEF AND 7FH
2632+ 9CAE CD           			DEFB    'M'+80H
2633+ 9CAF 00           			DEFB    0
2634+ 9CB0              ;
2635+ 9CB0 5D           			DEFB    DEF AND 7FH
2636+ 9CB1 C2           			DEFB    'B'+80H
2637+ 9CB2 00           			DEFB    0
2638+ 9CB3              ;
2639+ 9CB3 4F 50        			DEFM    'OP'
2640+ 9CB5 D4           			DEFB    'T'+80H
2641+ 9CB6 00           			DEFB    0
2642+ 9CB7              ;
2643+ 9CB7 5D           			DEFB    DEF AND 7FH
2644+ 9CB8 D7           			DEFB    'W'+80H
2645+ 9CB9 00           			DEFB    0
2646+ 9CBA              ;
2647+ 9CBA 00           			DEFB    0
2648+ 9CBB              ;
2649+ 9CBB C2           OPRNDS:			DEFB    'B'+80H
2650+ 9CBC 00           			DEFB    0
2651+ 9CBD C3           			DEFB    'C'+80H
2652+ 9CBE 01           			DEFB    1
2653+ 9CBF C4           			DEFB    'D'+80H
2654+ 9CC0 02           			DEFB    2
2655+ 9CC1 C5           			DEFB    'E'+80H
2656+ 9CC2 03           			DEFB    3
2657+ 9CC3 C8           			DEFB    'H'+80H
2658+ 9CC4 04           			DEFB    4
2659+ 9CC5 CC           			DEFB    'L'+80H
2660+ 9CC6 05           			DEFB    5
2661+ 9CC7 28 48        			DEFM    '(H'
2662+ 9CC9 CC           			DEFB    'L'+80H
2663+ 9CCA 06           			DEFB    6
2664+ 9CCB C1           			DEFB    'A'+80H
2665+ 9CCC 07           			DEFB    7
2666+ 9CCD 28 49        			DEFM    '(I'
2667+ 9CCF D8           			DEFB    'X'+80H
2668+ 9CD0 86           			DEFB    86H
2669+ 9CD1 28 49        			DEFM    '(I'
2670+ 9CD3 D9           			DEFB    'Y'+80H
2671+ 9CD4 C6           			DEFB    0C6H
2672+ 9CD5              ;
2673+ 9CD5 42           			DEFM    'B'
2674+ 9CD6 C3           			DEFB    'C'+80H
2675+ 9CD7 08           			DEFB    8
2676+ 9CD8 44           			DEFM    'D'
2677+ 9CD9 C5           			DEFB    'E'+80H
2678+ 9CDA 0A           			DEFB    10
2679+ 9CDB 48           			DEFM    'H'
2680+ 9CDC CC           			DEFB    'L'+80H
2681+ 9CDD 0C           			DEFB    12
2682+ 9CDE 49           			DEFM    'I'
2683+ 9CDF D8           			DEFB    'X'+80H
2684+ 9CE0 8C           			DEFB    8CH
2685+ 9CE1 49           			DEFM    'I'
2686+ 9CE2 D9           			DEFB    'Y'+80H
2687+ 9CE3 CC           			DEFB    0CCH
2688+ 9CE4 41           			DEFM    'A'
2689+ 9CE5 C6           			DEFB    'F'+80H
2690+ 9CE6 0E           			DEFB    14
2691+ 9CE7 53           			DEFM    'S'
2692+ 9CE8 D0           			DEFB    'P'+80H
2693+ 9CE9 0E           			DEFB    14
2694+ 9CEA              ;
2695+ 9CEA 4E           			DEFM    'N'
2696+ 9CEB DA           			DEFB    'Z'+80H
2697+ 9CEC 10           			DEFB    16
2698+ 9CED DA           			DEFB    'Z'+80H
2699+ 9CEE 11           			DEFB    17
2700+ 9CEF 4E           			DEFM    'N'
2701+ 9CF0 C3           			DEFB    'C'+80H
2702+ 9CF1 12           			DEFB    18
2703+ 9CF2 50           			DEFM    'P'
2704+ 9CF3 CF           			DEFB    'O'+80H
2705+ 9CF4 14           			DEFB    20
2706+ 9CF5 50           			DEFM    'P'
2707+ 9CF6 C5           			DEFB    'E'+80H
2708+ 9CF7 15           			DEFB    21
2709+ 9CF8 D0           			DEFB    'P'+80H
2710+ 9CF9 16           			DEFB    22
2711+ 9CFA CD           			DEFB    'M'+80H
2712+ 9CFB 17           			DEFB    23
2713+ 9CFC              ;
2714+ 9CFC 28           			DEFM    '('
2715+ 9CFD C3           			DEFB    'C'+80H
2716+ 9CFE 20           			DEFB    20H
2717+ 9CFF              ;
2718+ 9CFF 00           			DEFB    0
2719+ 9D00              ;
2720+ 9D00 49           LDOPS:			DEFM    'I'
2721+ 9D01 00           			DEFB    0
2722+ 9D02 C1           			DEFB    'A'+80H
2723+ 9D03 47           			DEFB    47H
2724+ 9D04 52           			DEFM    'R'
2725+ 9D05 00           			DEFB    0
2726+ 9D06 C1           			DEFB    'A'+80H
2727+ 9D07 4F           			DEFB    4FH
2728+ 9D08 41           			DEFM    'A'
2729+ 9D09 00           			DEFB    0
2730+ 9D0A C9           			DEFB    'I'+80H
2731+ 9D0B 57           			DEFB    57H
2732+ 9D0C 41           			DEFM    'A'
2733+ 9D0D 00           			DEFB    0
2734+ 9D0E D2           			DEFB    'R'+80H
2735+ 9D0F 5F           			DEFB    5FH
2736+ 9D10 28 42 43     			DEFM    '(BC'
2737+ 9D13 00           			DEFB    0
2738+ 9D14 C1           			DEFB    'A'+80H
2739+ 9D15 02           			DEFB    2
2740+ 9D16 28 44 45     			DEFM    '(DE'
2741+ 9D19 00           			DEFB    0
2742+ 9D1A C1           			DEFB    'A'+80H
2743+ 9D1B 12           			DEFB    12H
2744+ 9D1C 41           			DEFM    'A'
2745+ 9D1D 00           			DEFB    0
2746+ 9D1E 28 42        			DEFM    '(B'
2747+ 9D20 C3           			DEFB    'C'+80H
2748+ 9D21 0A           			DEFB    0AH
2749+ 9D22 41           			DEFM    'A'
2750+ 9D23 00           			DEFB    0
2751+ 9D24 28 44        			DEFM    '(D'
2752+ 9D26 C5           			DEFB    'E'+80H
2753+ 9D27 1A           			DEFB    1AH
2754+ 9D28              ;
2755+ 9D28 00           			DEFB    0
2756+ 9D29              ;
2757+ 9D29              ; .LIST
2758+ 9D29              ;
2759+ 9D29              LF:			EQU     0AH
2760+ 9D29              CR:			EQU     0DH
2761+ 9D29              ;
2762+ 9D29              FIN:    		ENDMODULE
# file closed: exec.z80
  33  9D29              			include "eval.z80"
# file opened: eval.z80
   1+ 9D29              ;
   2+ 9D29              ;BBC BASIC INTERPRETER - Z80 VERSION
   3+ 9D29              ;EXPRESSION EVALUATION & ARITHMETIC MODULE - "EVAL"
   4+ 9D29              ;(C) COPYRIGHT  R.T.RUSSELL  1984
   5+ 9D29              ;VERSION 2.3, 07-05-1984
   6+ 9D29              ;Modified to use external FPP, 01-03-1987
   7+ 9D29              ;VERSION 3.0, 08-03-1987
   8+ 9D29              ;INSTR bug fixed, 30-09-1992
   9+ 9D29              ;
  10+ 9D29              ;BINARY FLOATING POINT REPRESENTATION:
  11+ 9D29              ;   32 BIT SIGN-MAGNITUDE NORMALIZED MANTISSA
  12+ 9D29              ;    8 BIT EXCESS-128 SIGNED EXPONENT
  13+ 9D29              ;   SIGN BIT REPLACES MANTISSA MSB (IMPLIED "1")
  14+ 9D29              ;   MANTISSA=0 & EXPONENT=0 IMPLIES VALUE IS ZERO.
  15+ 9D29              ;
  16+ 9D29              ;BINARY INTEGER REPRESENTATION:
  17+ 9D29              ;   32 BIT 2'S-COMPLEMENT SIGNED INTEGER
  18+ 9D29              ;    "EXPONENT" BYTE = 0 (WHEN PRESENT)
  19+ 9D29              ;
  20+ 9D29              ;NORMAL REGISTER ALLOCATION: MANTISSA - HLH'L'
  21+ 9D29              ;                            EXPONENT - C
  22+ 9D29              ;
  23+ 9D29              			MODULE EVAL
  24+ 9D29              ;
  25+ 9D29              ;TABLE OF ADDRESSES FOR FUNCTIONS:
  26+ 9D29              ;
  27+ 9D29              FUNTOK:			EQU     8DH             ;1st FUNCTION TOKEN
  28+ 9D29              ;
  29+ 9D29 47 A3        FUNTBL:			DEFW    DECODE          ;Line number
  30+ 9D2B A0 A0        			DEFW    OPENIN          ;OPENIN
  31+ 9D2D BD A0        			DEFW    PTR             ;PTR
  32+ 9D2F 72 A0        			DEFW    PAGEV           ;PAGE
  33+ 9D31 C5 A0        			DEFW    TIMEV           ;TIME
  34+ 9D33 68 A0        			DEFW    LOMEMV          ;LOMEM
  35+ 9D35 6D A0        			DEFW    HIMEMV          ;HIMEM
eval.z80(36): error: [DW/DEFW/WORD] Syntax error:
  36+ 9D37              			DEFW    ABS             ;ABS
  37+ 9D37 4D A1        			DEFW    ACS             ;ACS
  38+ 9D39 B5 B0        			DEFW    ADVAL           ;ADVAL
  39+ 9D3B 55 A0        			DEFW    ASC             ;ASC
  40+ 9D3D 45 A1        			DEFW    ASN             ;ASN
  41+ 9D3F 49 A1        			DEFW    ATN             ;ATN
  42+ 9D41 31 A0        			DEFW    BGET            ;BGET
  43+ 9D43 31 A1        			DEFW    COS             ;COS
  44+ 9D45 90 A0        			DEFW    COUNTV          ;COUNT
  45+ 9D47 19 A1        			DEFW    DEG             ;DEG
  46+ 9D49 86 A0        			DEFW    ERLV            ;ERL
  47+ 9D4B 8B A0        			DEFW    ERRV            ;ERR
  48+ 9D4D 71 A1        			DEFW    EVAL            ;EVAL
  49+ 9D4F 39 A1        			DEFW    EXP             ;EXP
  50+ 9D51 B5 A0        			DEFW    EXT             ;EXT
  51+ 9D53 DF A3        			DEFW    ZERO            ;FALSE
  52+ 9D55 3F 91        			DEFW    FN              ;FN
  53+ 9D57 3F A0        			DEFW    GET             ;GET
  54+ 9D59 3A A0        			DEFW    INKEY           ;INKEY
  55+ 9D5B 0A A2        			DEFW    INSTR           ;INSTR(
  56+ 9D5D 25 A1        			DEFW    INT             ;INT
  57+ 9D5F 62 A0        			DEFW    LEN             ;LEN
  58+ 9D61 3D A1        			DEFW    LN              ;LN
  59+ 9D63 41 A1        			DEFW    LOG             ;LOG
  60+ 9D65 15 A1        			DEFW    NOTK            ;NOT
  61+ 9D67 9D A0        			DEFW    OPENUP          ;OPENUP
  62+ 9D69 9B A0        			DEFW    OPENOT          ;OPENOUT
  63+ 9D6B 0D A1        			DEFW    PI              ;PI
  64+ 9D6D B5 B0        			DEFW    POINT           ;POINT(
  65+ 9D6F 1A A0        			DEFW    POS             ;POS
  66+ 9D71 1D A1        			DEFW    RAD             ;RAD
  67+ 9D73 9E A1        			DEFW    RND             ;RND
  68+ 9D75 21 A1        			DEFW    SGN             ;SGN
  69+ 9D77 35 A1        			DEFW    SIN             ;SIN
  70+ 9D79 29 A1        			DEFW    SQR             ;SQR
  71+ 9D7B 2D A1        			DEFW    TAN             ;TAN
  72+ 9D7D 77 A0        			DEFW    TOPV            ;TO(P)
  73+ 9D7F 02 A1        			DEFW    TRUE            ;TRUE
  74+ 9D81 23 95        			DEFW    USR             ;USR
  75+ 9D83 64 A1        			DEFW    VAL             ;VAL
  76+ 9D85 20 A0        			DEFW    VPOS            ;VPOS
  77+ 9D87 88 A2        			DEFW    CHRS            ;CHRS
  78+ 9D89 8F A2        			DEFW    GETS            ;GETS
  79+ 9D8B 95 A2        			DEFW    INKEYS          ;INKEYS
  80+ 9D8D D6 A2        			DEFW    LEFTS           ;LEFTS(
  81+ 9D8F A5 A2        			DEFW    MIDS            ;MIDS(
  82+ 9D91 F1 A2        			DEFW    RIGHTS          ;RIGHTS(
  83+ 9D93 9F A3        			DEFW    STRS            ;STR$
  84+ 9D95 05 A3        			DEFW    STRING          ;STRINGS(
  85+ 9D97 25 A0        			DEFW    EOF             ;EOF
  86+ 9D99              ;
  87+ 9D99              TCMD:			EQU     FUNTOK+($-FUNTBL)/2
  88+ 9D99              ;
  89+ 9D99              ANDK:			EQU     80H
  90+ 9D99              DIVK:			EQU     81H
  91+ 9D99              EORK:			EQU     82H
  92+ 9D99              MODK:			EQU     83H
  93+ 9D99              ORK:			EQU     84H
  94+ 9D99              ;
  95+ 9D99 F0 A0        SOPTBL:			DEFW    SLE             ;<= (STRING)
  96+ 9D9B F8 A0        			DEFW    SNE             ;<>
  97+ 9D9D EA A0        			DEFW    SGE             ;>=
  98+ 9D9F DD A0        			DEFW    SLT             ;<
  99+ 9DA1 FE A0        			DEFW    SEQ             ;=
 100+ 9DA3 E3 A0        			DEFW    SGT             ;>
 101+ 9DA5              ;
 102+ 9DA5              ;EXPR - VARIABLE-TYPE EXPRESSION EVALUATION
 103+ 9DA5              ;     Expression type is returned in A'F':
 104+ 9DA5              ;        Numeric - A' bit 7=0, F' sign bit cleared.
 105+ 9DA5              ;         String - A' bit 7=1, F' sign bit set.
 106+ 9DA5              ;Floating-point or integer result returned in HLH'L'C
 107+ 9DA5              ; Integer result denoted by C=0 and HLH'L' non-zero.
 108+ 9DA5              ;String result returned in string accumulator, DE set.
 109+ 9DA5              ;
 110+ 9DA5              ;Hierarchy is: (1) Variables, functions,
 111+ 9DA5              ;                  constants, bracketed expressions.
 112+ 9DA5              ;              (2) ^
 113+ 9DA5              ;              (3) * / MOD DIV
 114+ 9DA5              ;              (4) + -
 115+ 9DA5              ;              (5) = <> <= >= > <
 116+ 9DA5              ;              (6) AND
 117+ 9DA5              ;              (7) EOR OR
 118+ 9DA5              ;
 119+ 9DA5 CD BA 9D     @EXPR:			CALL    EXPR1           ;GET FIRST OPERAND
 120+ 9DA8 FE 82        EXPR0A:			CP      EORK            ;CHECK OPERATOR
 121+ 9DAA 28 03        			JR      Z,EXPR0B
 122+ 9DAC FE 84        			CP      ORK
 123+ 9DAE C0           			RET     NZ
 124+ 9DAF CD 6A A4     EXPR0B:			CALL    SAVE            ;SAVE FIRST OPERAND
 125+ 9DB2 CD BA 9D     			CALL    EXPR1           ;GET SECOND OPERAND
 126+ 9DB5 CD 78 A4     			CALL    DOIT            ;DO OPERATION
 127+ 9DB8 18 EE        			JR      EXPR0A          ;CONTINUE
 128+ 9DBA              ;
 129+ 9DBA CD CB 9D     EXPR1:			CALL    EXPR2
 130+ 9DBD FE 80        EXPR1A:			CP      ANDK
 131+ 9DBF C0           			RET     NZ
 132+ 9DC0 CD 6A A4     			CALL    SAVE
 133+ 9DC3 CD CB 9D     			CALL    EXPR2
 134+ 9DC6 CD 78 A4     			CALL    DOIT
 135+ 9DC9 18 F2        			JR      EXPR1A
 136+ 9DCB              ;
 137+ 9DCB CD 2A 9E     EXPR2:			CALL    EXPR3
 138+ 9DCE CD 45 A4     			CALL    RELOP?
 139+ 9DD1 C0           			RET     NZ
 140+ 9DD2 47           			LD      B,A
 141+ 9DD3 FD 23        			INC     IY              ;BUMP OVER OPERATOR
 142+ 9DD5 CD 99 A4     			CALL    NXT
 143+ 9DD8 CD 45 A4     			CALL    RELOP?          ;COMPOUND OPERATOR?
 144+ 9DDB 20 08        			JR      NZ,EXPR2B
 145+ 9DDD FD 23        			INC     IY
 146+ 9DDF B8           			CP      B
 147+ 9DE0 CA E2 8D     			JP      Z,SYNTAX        ;ILLEGAL COMBINATION
 148+ 9DE3 80           			ADD     A,B
 149+ 9DE4 47           			LD      B,A
 150+ 9DE5 78           EXPR2B:			LD      A,B
 151+ 9DE6 08           			EX      AF,AF'
 152+ 9DE7 FA FD 9D     			JP      M,EXPR2S
 153+ 9DEA 08           			EX      AF,AF'
 154+ 9DEB D6 04        			SUB     4
 155+ 9DED FE 3A        			CP      '>'-4
 156+ 9DEF 20 02        			JR      NZ,EXPR2C
 157+ 9DF1 C6 02        			ADD     A,2
 158+ 9DF3 CD 6C A4     EXPR2C:			CALL    SAVE1
 159+ 9DF6 CD 2A 9E     			CALL    EXPR3
 160+ 9DF9 CD 78 A4     			CALL    DOIT            ;Must NOT be "JP DOIT"
 161+ 9DFC C9           			RET
 162+ 9DFD              ;
 163+ 9DFD 08           EXPR2S:			EX      AF,AF'
 164+ 9DFE 3D           			DEC     A
 165+ 9DFF E6 07        			AND     7
 166+ 9E01 CD 00 A4     			CALL    PUSHS           ;SAVE STRING ON STACK
 167+ 9E04 F5           			PUSH    AF              ;SAVE OPERATOR
 168+ 9E05 CD 2A 9E     			CALL    EXPR3           ;SECOND STRING
 169+ 9E08 08           			EX      AF,AF'
 170+ 9E09 F2 DA 9E     			JP      P,TYPE
 171+ 9E0C F1           			POP     AF
 172+ 9E0D 4B           			LD      C,E             ;LENGTH OF STRING #2
 173+ 9E0E D1           			POP     DE
 174+ 9E0F 21 00 00     			LD      HL,0
 175+ 9E12 39           			ADD     HL,SP
 176+ 9E13 43           			LD      B,E             ;LENGTH OF STRING #1
 177+ 9E14 D5           			PUSH    DE
 178+ 9E15 11 00 B3     			LD      DE,ACCS
 179+ 9E18 EB           			EX      DE,HL
 180+ 9E19 CD A4 A4     			CALL    DISPT2
 181+ 9E1C D1           			POP     DE
 182+ 9E1D EB           			EX      DE,HL
 183+ 9E1E 26 00        			LD      H,0
 184+ 9E20 39           			ADD     HL,SP
 185+ 9E21 F9           			LD      SP,HL
 186+ 9E22 EB           			EX      DE,HL
 187+ 9E23 AF           			XOR     A               ;NUMERIC MARKER
 188+ 9E24 4F           			LD      C,A             ;INTEGER MARKER
 189+ 9E25 08           			EX      AF,AF'
 190+ 9E26 FD 7E 00     			LD      A,(IY)
 191+ 9E29 C9           			RET
 192+ 9E2A              ;
 193+ 9E2A CD 79 9E     EXPR3:			CALL    EXPR4
 194+ 9E2D FE 2D        EXPR3A:			CP      '-'
 195+ 9E2F 28 08        			JR      Z,EXPR3B
 196+ 9E31 FE 2B        			CP      '+'
 197+ 9E33 C0           			RET     NZ
 198+ 9E34 08           			EX      AF,AF'
 199+ 9E35 FA 44 9E     			JP      M,EXPR3S
 200+ 9E38 08           			EX      AF,AF'
 201+ 9E39 CD 6A A4     EXPR3B:			CALL    SAVE
 202+ 9E3C CD 79 9E     			CALL    EXPR4
 203+ 9E3F CD 78 A4     			CALL    DOIT
 204+ 9E42 18 E9        			JR      EXPR3A
 205+ 9E44              ;
 206+ 9E44 08           EXPR3S:			EX      AF,AF'
 207+ 9E45 FD 23        			INC     IY              ;BUMP PAST '+'
 208+ 9E47 CD 00 A4     			CALL    PUSHS           ;SAVE STRING ON STACK
 209+ 9E4A CD 79 9E     			CALL    EXPR4           ;SECOND STRING
 210+ 9E4D 08           			EX      AF,AF'
 211+ 9E4E F2 DA 9E     			JP      P,TYPE
 212+ 9E51 4B           			LD      C,E             ;C=LENGTH
 213+ 9E52 D1           			POP     DE
 214+ 9E53 D5           			PUSH    DE
 215+ 9E54 21 00 B3     			LD      HL,ACCS
 216+ 9E57 54           			LD      D,H
 217+ 9E58 79           			LD      A,C
 218+ 9E59 B7           			OR      A
 219+ 9E5A 28 0F        			JR      Z,EXP3S3
 220+ 9E5C 45           			LD      B,L
 221+ 9E5D 6F           			LD      L,A             ;SOURCE
 222+ 9E5E 83           			ADD     A,E
 223+ 9E5F 5F           			LD      E,A             ;DESTINATION
 224+ 9E60 3E 13        			LD      A,19
 225+ 9E62 DA FE 86     			JP      C,ERROR         ;"String too long"
 226+ 9E65 D5           			PUSH    DE
 227+ 9E66 1D           			DEC     E
 228+ 9E67 2D           			DEC     L
 229+ 9E68 ED B8        			LDDR                    ;COPY
 230+ 9E6A D1           			POP     DE
 231+ 9E6B D9           EXP3S3:			EXX
 232+ 9E6C C1           			POP     BC
 233+ 9E6D CD 1F A4     			CALL    POPS            ;RESTORE FROM STACK
 234+ 9E70 D9           			EXX
 235+ 9E71 F6 80        			OR      80H             ;FLAG STRING
 236+ 9E73 08           			EX      AF,AF'
 237+ 9E74 FD 7E 00     			LD      A,(IY)
 238+ 9E77 18 B4        			JR      EXPR3A
 239+ 9E79              ;
 240+ 9E79 CD 96 9E     EXPR4:			CALL    EXPR5
 241+ 9E7C FE 2A        EXPR4A:			CP      '*'
 242+ 9E7E 28 0B        			JR      Z,EXPR4B
 243+ 9E80 FE 2F        			CP      '/'
 244+ 9E82 28 07        			JR      Z,EXPR4B
 245+ 9E84 FE 83        			CP      MODK
 246+ 9E86 28 03        			JR      Z,EXPR4B
 247+ 9E88 FE 81        			CP      DIVK
 248+ 9E8A C0           			RET     NZ
 249+ 9E8B CD 6A A4     EXPR4B:			CALL    SAVE
 250+ 9E8E CD 96 9E     			CALL    EXPR5
 251+ 9E91 CD 78 A4     			CALL    DOIT
 252+ 9E94 18 E6        			JR      EXPR4A
 253+ 9E96              ;
 254+ 9E96 CD 31 9F     EXPR5:			CALL    ITEM
 255+ 9E99 B7           			OR      A               ;TEST TYPE
 256+ 9E9A 08           			EX      AF,AF'          ;SAVE TYPE
 257+ 9E9B CD 99 A4     EXPR5A:			CALL    NXT
 258+ 9E9E FE 5E        			CP      '^'
 259+ 9EA0 C0           			RET     NZ
 260+ 9EA1 CD 6A A4     			CALL    SAVE
 261+ 9EA4 CD 31 9F     			CALL    ITEM
 262+ 9EA7 B7           			OR      A
 263+ 9EA8 08           			EX      AF,AF'
 264+ 9EA9 CD 78 A4     			CALL    DOIT
 265+ 9EAC 18 ED        			JR      EXPR5A
 266+ 9EAE              ;
 267+ 9EAE CD A5 9D     @EXPRN:			CALL    EXPR
 268+ 9EB1 08           			EX      AF,AF'
 269+ 9EB2 F0           			RET     P
 270+ 9EB3 18 25        			JR      TYPE
 271+ 9EB5              ;
 272+ 9EB5 CD A5 9D     @EXPRI:			CALL    EXPR
 273+ 9EB8 08           			EX      AF,AF'
 274+ 9EB9 F2 5C A1     			JP      P,SFIX
 275+ 9EBC 18 1C        			JR      TYPE
 276+ 9EBE              ;
 277+ 9EBE CD A5 9D     @EXPRS:			CALL    EXPR
 278+ 9EC1 08           			EX      AF,AF'
 279+ 9EC2 F8           			RET     M
 280+ 9EC3 18 15        			JR      TYPE
 281+ 9EC5              ;
 282+ 9EC5              ;
 283+ 9EC5 CD 31 9F     ITEMN:			CALL    ITEM
 284+ 9EC8 B7           			OR      A
 285+ 9EC9 F0           			RET     P
 286+ 9ECA 18 0E        			JR      TYPE
 287+ 9ECC              ;
 288+ 9ECC CD 31 9F     @ITEMI:			CALL    ITEM
 289+ 9ECF B7           			OR      A
 290+ 9ED0 F2 5C A1     			JP      P,SFIX
 291+ 9ED3 18 05        			JR      TYPE
 292+ 9ED5              ;
 293+ 9ED5 CD 31 9F     ITEMS:			CALL    ITEM
 294+ 9ED8 B7           			OR      A
 295+ 9ED9 F8           			RET     M
 296+ 9EDA 3E 06        TYPE:			LD      A,6
 297+ 9EDC C3 FE 86     			JP      ERROR           ;"Type mismatch"
 298+ 9EDF              ;
 299+ 9EDF CD A5 9D     ITEM1:			CALL    EXPR            ;BRACKETED EXPR
 300+ 9EE2 CD 5D A4     			CALL    BRAKET
 301+ 9EE5 08           			EX      AF,AF'
 302+ 9EE6 C9           			RET
 303+ 9EE7              ;
 304+ 9EE7              ;HEX - Get hexadecimal constant.
 305+ 9EE7              ;   Inputs: ASCII string at (IY)
 306+ 9EE7              ;  Outputs: Integer result in H'L'HL, C=0, A7=0.
 307+ 9EE7              ;           IY updated (points to delimiter)
 308+ 9EE7              ;
 309+ 9EE7 CD DF A3     HEX:			CALL    ZERO
 310+ 9EEA CD 32 A4     			CALL    HEXDIG
 311+ 9EED 38 18        			JR      C,BADHEX
 312+ 9EEF FD 23        HEX1:			INC     IY
 313+ 9EF1 E6 0F        			AND     0FH
 314+ 9EF3 06 04        			LD      B,4
 315+ 9EF5 D9           HEX2:			EXX
 316+ 9EF6 29           			ADD     HL,HL
 317+ 9EF7 D9           			EXX
 318+ 9EF8 ED 6A        			ADC     HL,HL
 319+ 9EFA 10 F9        			DJNZ    HEX2
 320+ 9EFC D9           			EXX
 321+ 9EFD B5           			OR      L
 322+ 9EFE 6F           			LD      L,A
 323+ 9EFF D9           			EXX
 324+ 9F00 CD 32 A4     			CALL    HEXDIG
 325+ 9F03 30 EA        			JR      NC,HEX1
 326+ 9F05 AF           			XOR     A
 327+ 9F06 C9           			RET
 328+ 9F07              ;
 329+ 9F07 3E 1C        BADHEX:			LD      A,28
 330+ 9F09 C3 FE 86     			JP      ERROR           ;"Bad HEX"
 331+ 9F0C              ;
 332+ 9F0C              ;MINUS - Unary minus.
 333+ 9F0C              ;   Inputs: IY = text pointer
 334+ 9F0C              ;  Outputs: Numeric result, same type as argument.
 335+ 9F0C              ;           Result in H'L'HLC
 336+ 9F0C              ;
 337+ 9F0C CD C5 9E     MINUS:			CALL    ITEMN
 338+ 9F0F 0D           MINUS0:			DEC     C
 339+ 9F10 0C           			INC     C
 340+ 9F11 28 06        			JR      Z,NEGATE        ;ZERO/INTEGER
 341+ 9F13 7C           			LD      A,H
 342+ 9F14 EE 80        			XOR     80H             ;CHANGE SIGN (FP)
 343+ 9F16 67           			LD      H,A
 344+ 9F17 AF           			XOR     A               ;NUMERIC MARKER
 345+ 9F18 C9           			RET
 346+ 9F19              ;
 347+ 9F19 D9           NEGATE:			EXX
 348+ 9F1A 7C           			LD      A,H
 349+ 9F1B 2F           			CPL
 350+ 9F1C 67           			LD      H,A
 351+ 9F1D 7D           			LD      A,L
 352+ 9F1E 2F           			CPL
 353+ 9F1F 6F           			LD      L,A
 354+ 9F20 D9           			EXX
 355+ 9F21 7C           			LD      A,H
 356+ 9F22 2F           			CPL
 357+ 9F23 67           			LD      H,A
 358+ 9F24 7D           			LD      A,L
 359+ 9F25 2F           			CPL
 360+ 9F26 6F           			LD      L,A
 361+ 9F27 D9           ADD1:			EXX
 362+ 9F28 23           			INC     HL
 363+ 9F29 7C           			LD      A,H
 364+ 9F2A B5           			OR      L
 365+ 9F2B D9           			EXX
 366+ 9F2C 3E 00        			LD      A,0             ;NUMERIC MARKER
 367+ 9F2E C0           			RET     NZ
 368+ 9F2F 23           			INC     HL
 369+ 9F30 C9           			RET
 370+ 9F31              ;
 371+ 9F31              ;ITEM - VARIABLE TYPE NUMERIC OR STRING ITEM.
 372+ 9F31              ;Item type is returned in A:  Bit 7=0 numeric.
 373+ 9F31              ;                             Bit 7=1 string.
 374+ 9F31              ;Numeric item returned in HLH'L'C.
 375+ 9F31              ;String item returned in string accumulator,
 376+ 9F31              ;  DE addresses byte after last (E=length).
 377+ 9F31              ;
 378+ 9F31 CD E2 95     ITEM:			CALL    CHECK
 379+ 9F34 CD 99 A4     			CALL    NXT
 380+ 9F37 FD 23        			INC     IY
 381+ 9F39 FE 26        			CP      '&'
 382+ 9F3B 28 AA        			JR      Z,HEX           ;HEX CONSTANT
 383+ 9F3D FE 2D        			CP      '-'
 384+ 9F3F 28 CB        			JR      Z,MINUS         ;UNARY MINUS
 385+ 9F41 FE 2B        			CP      '+'
 386+ 9F43 28 80        			JR      Z,ITEMN         ;UNARY PLUS
 387+ 9F45 FE 28        			CP      '('
 388+ 9F47 28 96        			JR      Z,ITEM1         ;EXPRESSION
 389+ 9F49 FE 22        			CP      34		;ASCII ""
 390+ 9F4B 28 63        			JR      Z,CONS          ;STRING CONSTANT
 391+ 9F4D FE C5        			CP      TCMD
 392+ 9F4F D2 E2 8D     			JP      NC,SYNTAX       ;SYNTAX ERROR
 393+ 9F52 FE 8D        			CP      FUNTOK
 394+ 9F54 D2 AA A4     			JP      NC,DISPAT       ;FUNCTION
 395+ 9F57 FD 2B        			DEC     IY
 396+ 9F59 FE 3A        			CP      ':'
 397+ 9F5B 30 08        			JR      NC,ITEM2        ;VARIABLE?
 398+ 9F5D FE 30        			CP      '0'
 399+ 9F5F 30 74        			JR      NC,CON          ;NUMERIC CONSTANT
 400+ 9F61 FE 2E        			CP      '.'
 401+ 9F63 28 70        			JR      Z,CON           ;NUMERIC CONSTANT
 402+ 9F65 CD 62 89     ITEM2:			CALL    GETVAR          ;VARIABLE
 403+ 9F68 20 2B        			JR      NZ,NOSUCH
 404+ 9F6A B7           			OR      A
 405+ 9F6B FA F8 9F     			JP      M,LOADS         ;STRING VARIABLE
 406+ 9F6E B7           @LOADN:			OR      A
 407+ 9F6F 28 18        			JR      Z,LOAD1         ;BYTE VARIABLE
 408+ 9F71 0E 00        			LD      C,0
 409+ 9F73 CB 47        			BIT     0,A
 410+ 9F75 28 03        			JR      Z,LOAD4         ;INTEGER VARIABLE
 411+ 9F77 DD 4E 04     LOAD5:			LD      C,(IX+4)
 412+ 9F7A D9           @LOAD4:			EXX
 413+ 9F7B DD 6E 00     			LD      L,(IX+0)
 414+ 9F7E DD 66 01     			LD      H,(IX+1)
 415+ 9F81 D9           			EXX
 416+ 9F82 DD 6E 02     			LD      L,(IX+2)
 417+ 9F85 DD 66 03     			LD      H,(IX+3)
 418+ 9F88 C9           			RET
 419+ 9F89              ;
 420+ 9F89 21 00 00     LOAD1:			LD      HL,0
 421+ 9F8C D9           			EXX
 422+ 9F8D 26 00        			LD      H,0
 423+ 9F8F DD 6E 00     			LD      L,(IX+0)
 424+ 9F92 D9           			EXX
 425+ 9F93 4C           			LD      C,H
 426+ 9F94 C9           			RET
 427+ 9F95              ;
 428+ 9F95 DA E2 8D     NOSUCH:			JP      C,SYNTAX
 429+ 9F98 3A FE B5     			LD      A,(LISTON)
 430+ 9F9B CB 6F        			BIT     5,A
 431+ 9F9D 3E 1A        			LD      A,26
 432+ 9F9F 20 23        			JR      NZ,ERROR0       ;"No such variable"
 433+ 9FA1 FD 23        NOS1:			INC     IY
 434+ 9FA3 CD 49 8B     			CALL    RANGE
 435+ 9FA6 30 F9        			JR      NC,NOS1
 436+ 9FA8 DD 21 40 B5  			LD      IX,PC
 437+ 9FAC AF           			XOR     A
 438+ 9FAD 4F           			LD      C,A
 439+ 9FAE 18 CA        			JR      LOAD4
 440+ 9FB0              ;
 441+ 9FB0              ;CONS - Get string constant from ASCII string.
 442+ 9FB0              ;   Inputs: ASCII string at (IY)
 443+ 9FB0              ;  Outputs: Result in string accumulator.
 444+ 9FB0              ;           D = MS byte of ACCS, E = string length
 445+ 9FB0              ;           A7 = 1 (string marker)
 446+ 9FB0              ;           IY updated
 447+ 9FB0              ;
 448+ 9FB0 11 00 B3     @CONS:			LD      DE,ACCS
 449+ 9FB3 FD 7E 00     CONS3:			LD      A,(IY)
 450+ 9FB6 FD 23        			INC     IY
 451+ 9FB8 FE 22        			CP      34		;ASCII ""
 452+ 9FBA 28 0B        			JR      Z,CONS2
 453+ 9FBC 12           CONS1:			LD      (DE),A
 454+ 9FBD 1C           			INC     E
 455+ 9FBE FE 0D        			CP      CR
 456+ 9FC0 20 F1        			JR      NZ,CONS3
 457+ 9FC2 3E 09        			LD      A,9
 458+ 9FC4 C3 FE 86     ERROR0:			JP      ERROR           ;"Missing """
 459+ 9FC7              ;
 460+ 9FC7 FD 7E 00     CONS2:			LD      A,(IY)
 461+ 9FCA FE 34        			CP      0x34		;ASCII "
 462+ 9FCC FD 23        			INC     IY
 463+ 9FCE 28 EC        			JR      Z,CONS1
 464+ 9FD0 FD 2B        			DEC     IY
 465+ 9FD2 3E 80        			LD      A,80H           ;STRING MARKER
 466+ 9FD4 C9           			RET
 467+ 9FD5              ;
 468+ 9FD5              ;CON - Get unsigned numeric constant from ASCII string.
 469+ 9FD5              ;   Inputs: ASCII string at (IY).
 470+ 9FD5              ;  Outputs: Variable-type result in HLH'L'C
 471+ 9FD5              ;           IY updated (points to delimiter)
 472+ 9FD5              ;           A7 = 0 (numeric marker)
 473+ 9FD5              ;
 474+ 9FD5 FD E5        CON:			PUSH    IY
 475+ 9FD7 DD E1        			POP     IX
 476+ 9FD9 3E 24        			LD      A,36
 477+ 9FDB CD BD A4     			CALL    FPP
 478+ 9FDE 38 E4        			JR      C,ERROR0
 479+ 9FE0 DD E5        			PUSH    IX
 480+ 9FE2 FD E1        			POP     IY
 481+ 9FE4 AF           			XOR     A
 482+ 9FE5 C9           			RET
 483+ 9FE6              ;
 484+ 9FE6 DD 46 04     @DLOAD5:		LD      B,(IX+4)
 485+ 9FE9 D9           			EXX
 486+ 9FEA DD 5E 00     			LD      E,(IX+0)
 487+ 9FED DD 56 01     			LD      D,(IX+1)
 488+ 9FF0 D9           			EXX
 489+ 9FF1 DD 5E 02     			LD      E,(IX+2)
 490+ 9FF4 DD 56 03     			LD      D,(IX+3)
 491+ 9FF7 C9           			RET
 492+ 9FF8              ;
 493+ 9FF8 11 00 B3     @LOADS:			LD      DE,ACCS
 494+ 9FFB 1F           			RRA
 495+ 9FFC 30 10        			JR      NC,LOADS2       ;FIXED STRING
 496+ 9FFE CD 7A 9F     			CALL    LOAD4
 497+ A001 D9           			EXX
 498+ A002 7D           			LD      A,L
 499+ A003 D9           			EXX
 500+ A004 B7           			OR      A
 501+ A005 4F           			LD      C,A
 502+ A006 3E 80        			LD      A,80H           ;STRING MARKER
 503+ A008 C8           			RET     Z
 504+ A009 06 00        			LD      B,0
 505+ A00B ED B0        			LDIR
 506+ A00D C9           			RET
 507+ A00E 7E           LOADS2:			LD      A,(HL)
 508+ A00F 12           			LD      (DE),A
 509+ A010 23           			INC     HL
 510+ A011 FE 0D        			CP      CR
 511+ A013 3E 80        			LD      A,80H           ;STRING MARKER
 512+ A015 C8           			RET     Z
 513+ A016 1C           			INC     E
 514+ A017 20 F5        			JR      NZ,LOADS2
 515+ A019 C9           			RET                     ;RETURN NULL STRING
 516+ A01A              ;
 517+ A01A              ;VARIABLE-TYPE FUNCTIONS:
 518+ A01A              ;
 519+ A01A              ;Result returned in HLH'L'C (floating point)
 520+ A01A              ;Result returned in HLH'L' (C=0) (integer)
 521+ A01A              ;Result returned in string accumulator & DE (string)
 522+ A01A              ;All registers destroyed.
 523+ A01A              ;IY (text pointer) updated.
 524+ A01A              ;Bit 7 of A indicates type: 0 = numeric, 1 = string.
 525+ A01A              ;
 526+ A01A              ;
 527+ A01A              ;POS - horizontal cursor position.
 528+ A01A              ;VPOS - vertical cursor position.
 529+ A01A              ;EOF - return status of file.
 530+ A01A              ;BGET - read byte from file.
 531+ A01A              ;INKEY - as GET but wait only n centiseconds.
 532+ A01A              ;GET - wait for keypress and return ASCII value.
 533+ A01A              ;GET(n) - input from Z80 port n.
 534+ A01A              ;ASC - ASCII value of string.
 535+ A01A              ;LEN - length of string.
 536+ A01A              ;LOMEM - location of dynamic variables.
 537+ A01A              ;HIMEM - top of available RAM.
 538+ A01A              ;PAGE - start of current text page.
 539+ A01A              ;TOP - address of first free byte after program.
 540+ A01A              ;ERL - line number where last error occurred.
 541+ A01A              ;ERR - number of last error.
 542+ A01A              ;COUNT - number of printing characters since CR.
 543+ A01A              ;Results are integer numeric.
 544+ A01A              ;
 545+ A01A CD D7 B0     POS:			CALL    GETCSR
 546+ A01D EB           			EX      DE,HL
 547+ A01E 18 75        			JR      COUNT1
 548+ A020 CD D7 B0     VPOS:			CALL    GETCSR
 549+ A023 18 70        			JR      COUNT1
 550+ A025 CD DA 97     EOF:			CALL    CHANEL
 551+ A028 CD 02 B2     			CALL    OSSTAT
 552+ A02B CA 02 A1     			JP      Z,TRUE
 553+ A02E C3 DF A3     			JP      ZERO
 554+ A031 CD DA 97     BGET:			CALL    CHANEL          ;CHANNEL NUMBER
 555+ A034 CD 02 B2     			CALL    OSBGET
 556+ A037 6F           			LD      L,A
 557+ A038 18 59        			JR      COUNT0
 558+ A03A CD 95 A2     INKEY:			CALL    INKEYS
 559+ A03D 18 19        			JR      ASC0
 560+ A03F CD 99 A4     GET:			CALL    NXT
 561+ A042 FE 28        			CP      '('
 562+ A044 20 0A        			JR      NZ,GET0
 563+ A046 CD CC 9E     			CALL    ITEMI           ;PORT ADDRESS
 564+ A049 D9           			EXX
 565+ A04A 44           			LD      B,H
 566+ A04B 4D           			LD      C,L
 567+ A04C ED 68        			IN      L,(C)           ;INPUT FROM PORT BC
 568+ A04E 18 43        			JR      COUNT0
 569+ A050 CD 8F A2     GET0:			CALL    GETS
 570+ A053 18 08        			JR      ASC1
 571+ A055 CD D5 9E     ASC:			CALL    ITEMS
 572+ A058 AF           ASC0:			XOR     A
 573+ A059 BB           			CP      E
 574+ A05A CA 02 A1     			JP      Z,TRUE          ;NULL STRING
 575+ A05D 2A 00 B3     ASC1:			LD      HL,(ACCS)
 576+ A060 18 31        			JR      COUNT0
 577+ A062 CD D5 9E     LEN:			CALL    ITEMS
 578+ A065 EB           			EX      DE,HL
 579+ A066 18 2B        			JR      COUNT0
 580+ A068 2A E0 B5     LOMEMV:			LD      HL,(LOMEM)
 581+ A06B 18 28        			JR      COUNT1
 582+ A06D 2A E4 B5     HIMEMV:			LD      HL,(HIMEM)
 583+ A070 18 23        			JR      COUNT1
 584+ A072 2A DC B5     PAGEV:			LD      HL,(PAGE)
 585+ A075 18 1E        			JR      COUNT1
 586+ A077 FD 7E 00     TOPV:			LD      A,(IY)
 587+ A07A FD 23        			INC     IY              ;SKIP "P"
 588+ A07C FE 50        			CP      'P'
 589+ A07E C2 E2 8D     			JP      NZ,SYNTAX       ;"Syntax Error"
 590+ A081 2A DE B5     			LD      HL,(TOP)
 591+ A084 18 0F        			JR      COUNT1
 592+ A086 2A F2 B5     ERLV:			LD      HL,(ERL)
 593+ A089 18 0A        			JR      COUNT1
 594+ A08B 2A FD B5     ERRV:			LD      HL,(ERR)
 595+ A08E 18 03        			JR      COUNT0
 596+ A090 2A FB B5     COUNTV:			LD      HL,(COUNT)
 597+ A093 26 00        COUNT0:			LD      H,0
 598+ A095 D9           COUNT1:			EXX
 599+ A096 AF           			XOR     A
 600+ A097 4F           			LD      C,A             ;INTEGER MARKER
 601+ A098 67           			LD      H,A
 602+ A099 6F           			LD      L,A
 603+ A09A C9           			RET
 604+ A09B              ;
 605+ A09B              ;OPENIN - Open a file for reading.
 606+ A09B              ;OPENOUT - Open a file for writing.
 607+ A09B              ;OPENUP - Open a file for reading or writing.
 608+ A09B              ;Result is integer channel number (0 if error)
 609+ A09B              ;
 610+ A09B AF           OPENOT:			XOR     A
 611+ A09C 21           			DEFB    21H             ;SKIP NEXT 2 BYTES
 612+ A09D 3E 02        OPENUP:			LD      A,2
 613+ A09F 21           			DEFB    21H             ;SKIP NEXT 2 BYTES
 614+ A0A0 3E 01        OPENIN:			LD      A,1
 615+ A0A2 F5           			PUSH    AF              ;SAVE OPEN TYPE
 616+ A0A3 CD D5 9E     			CALL    ITEMS           ;FILENAME
 617+ A0A6 3E 0D        			LD      A,CR
 618+ A0A8 12           			LD      (DE),A
 619+ A0A9 F1           			POP     AF              ;RESTORE OPEN TYPE
 620+ A0AA C6 FF        			ADD     A,-1            ;AFFECT FLAGS
 621+ A0AC 21 00 B3     			LD      HL,ACCS
 622+ A0AF CD 02 B2     			CALL    OSOPEN
 623+ A0B2 6F           			LD      L,A
 624+ A0B3 18 DE        			JR      COUNT0
 625+ A0B5              ;
 626+ A0B5              ;EXT - Return length of file.
 627+ A0B5              ;PTR - Return current file pointer.
 628+ A0B5              ;Results are integer numeric.
 629+ A0B5              ;
 630+ A0B5 CD DA 97     EXT:			CALL    CHANEL
 631+ A0B8 CD 02 B2     			CALL    GETEXT
 632+ A0BB 18 12        			JR      TIME0
 633+ A0BD              ;
 634+ A0BD CD DA 97     PTR:			CALL    CHANEL
 635+ A0C0 CD 02 B2     			CALL    GETPTR
 636+ A0C3 18 0A        			JR      TIME0
 637+ A0C5              ;
 638+ A0C5              ;TIME - Return current value of elapsed time.
 639+ A0C5              ;Result is integer numeric.
 640+ A0C5              ;
 641+ A0C5 FD 7E 00     TIMEV:			LD      A,(IY)
 642+ A0C8 FE 24        			CP      '$'
 643+ A0CA 28 09        			JR      Z,TIMEVS
 644+ A0CC CD CF B0     			CALL    GETIME
 645+ A0CF D5           TIME0:			PUSH    DE
 646+ A0D0 D9           			EXX
 647+ A0D1 E1           			POP     HL
 648+ A0D2 AF           			XOR     A
 649+ A0D3 4F           			LD      C,A
 650+ A0D4 C9           			RET
 651+ A0D5              ;
 652+ A0D5              ;TIME$ - Return date/time string.
 653+ A0D5              ;Result is string
 654+ A0D5              ;
 655+ A0D5 FD 23        TIMEVS:			INC     IY              ;SKIP $
 656+ A0D7 CD B5 B0     			CALL    GETIMS
 657+ A0DA 3E 80        			LD      A,80H           ;MARK STRING
 658+ A0DC C9           			RET
 659+ A0DD              ;
 660+ A0DD              ;String comparison:
 661+ A0DD              ;
 662+ A0DD CD DC A3     SLT:			CALL    SCP
 663+ A0E0 D0           			RET     NC
 664+ A0E1 18 1F        			JR      TRUE
 665+ A0E3              ;
 666+ A0E3 CD DC A3     SGT:			CALL    SCP
 667+ A0E6 C8           			RET     Z
 668+ A0E7 D8           			RET     C
 669+ A0E8 18 18        			JR      TRUE
 670+ A0EA              ;
 671+ A0EA CD DC A3     SGE:			CALL    SCP
 672+ A0ED D8           			RET     C
 673+ A0EE 18 12        			JR      TRUE
 674+ A0F0              ;
 675+ A0F0 CD DC A3     SLE:			CALL    SCP
 676+ A0F3 28 0D        			JR      Z,TRUE
 677+ A0F5 D0           			RET     NC
 678+ A0F6 18 0A        			JR      TRUE
 679+ A0F8              ;
 680+ A0F8 CD DC A3     SNE:			CALL    SCP
 681+ A0FB C8           			RET     Z
 682+ A0FC 18 04        			JR      TRUE
 683+ A0FE              ;
 684+ A0FE CD DC A3     SEQ:			CALL    SCP
 685+ A101 C0           			RET     NZ
 686+ A102 3E FF        TRUE:			LD      A,-1
 687+ A104 D9           			EXX
 688+ A105 67           			LD      H,A
 689+ A106 6F           			LD      L,A
 690+ A107 D9           			EXX
 691+ A108 67           			LD      H,A
 692+ A109 6F           			LD      L,A
 693+ A10A 3C           			INC     A
 694+ A10B 4F           			LD      C,A
 695+ A10C C9           			RET
 696+ A10D              ;
 697+ A10D              ;PI - Return PI (3.141592654)
 698+ A10D              ;Result is floating-point numeric.
 699+ A10D              ;
 700+ A10D 3E 23        PI:			LD      A,35
 701+ A10F 18 43        			JR      FPP1
 702+ A111              ;
 703+ A111              ;ABS - Absolute value
 704+ A111              ;Result is numeric, variable type.
 705+ A111              ;
 706+ A111 3E 10        ABS:			LD      A,16
 707+ A113 18 3A        			JR      FPPN
 708+ A115              ;
 709+ A115              ;NOT - Complement integer.
 710+ A115              ;Result is integer numeric.
 711+ A115              ;
 712+ A115 3E 1A        NOTK:			LD      A,26
 713+ A117 18 36        			JR      FPPN
 714+ A119              ;
 715+ A119              ;DEG - Convert radians to degrees
 716+ A119              ;Result is floating-point numeric.
 717+ A119              ;
 718+ A119 3E 15        DEG:			LD      A,21
 719+ A11B 18 32        			JR      FPPN
 720+ A11D              ;
 721+ A11D              ;RAD - Convert degrees to radians
 722+ A11D              ;Result is floating-point numeric.
 723+ A11D              ;
 724+ A11D 3E 1B        RAD:			LD      A,27
 725+ A11F 18 2E        			JR      FPPN
 726+ A121              ;
 727+ A121              ;SGN - Return -1, 0 or +1
 728+ A121              ;Result is integer numeric.
 729+ A121              ;
 730+ A121 3E 1C        SGN:			LD      A,28
 731+ A123 18 2A        			JR      FPPN
 732+ A125              ;
 733+ A125              ;INT - Floor function
 734+ A125              ;Result is integer numeric.
 735+ A125              ;
 736+ A125 3E 17        INT:			LD      A,23
 737+ A127 18 26        			JR      FPPN
 738+ A129              ;
 739+ A129              ;SQR - square root
 740+ A129              ;Result is floating-point numeric.
 741+ A129              ;
 742+ A129 3E 1E        SQR:			LD      A,30
 743+ A12B 18 22        			JR      FPPN
 744+ A12D              ;
 745+ A12D              ;TAN - Tangent function
 746+ A12D              ;Result is floating-point numeric.
 747+ A12D              ;
 748+ A12D 3E 1F        TAN:			LD      A,31
 749+ A12F 18 1E        			JR      FPPN
 750+ A131              ;
 751+ A131              ;COS - Cosine function
 752+ A131              ;Result is floating-point numeric.
 753+ A131              ;
 754+ A131 3E 14        COS:			LD      A,20
 755+ A133 18 1A        			JR      FPPN
 756+ A135              ;
 757+ A135              ;SIN - Sine function
 758+ A135              ;Result is floating-point numeric.
 759+ A135              ;
 760+ A135 3E 1D        SIN:			LD      A,29
 761+ A137 18 16        			JR      FPPN
 762+ A139              ;
 763+ A139              ;EXP - Exponential function
 764+ A139              ;Result is floating-point numeric.
 765+ A139              ;
 766+ A139 3E 16        EXP:			LD      A,22
 767+ A13B 18 12        			JR      FPPN
 768+ A13D              ;
 769+ A13D              ;LN - Natural log.
 770+ A13D              ;Result is floating-point numeric.
 771+ A13D              ;
 772+ A13D 3E 18        LN:			LD      A,24
 773+ A13F 18 0E        			JR      FPPN
 774+ A141              ;
 775+ A141              ;LOG - base-10 logarithm.
 776+ A141              ;Result is floating-point numeric.
 777+ A141              ;
 778+ A141 3E 19        LOG:			LD      A,25
 779+ A143 18 0A        			JR      FPPN
 780+ A145              ;
 781+ A145              ;ASN - Arc-sine
 782+ A145              ;Result is floating-point numeric.
 783+ A145              ;
 784+ A145 3E 12        ASN:			LD      A,18
 785+ A147 18 06        			JR      FPPN
 786+ A149              ;
 787+ A149              ;ATN - arc-tangent
 788+ A149              ;Result is floating-point numeric.
 789+ A149              ;
 790+ A149 3E 13        ATN:			LD      A,19
 791+ A14B 18 02        			JR      FPPN
 792+ A14D              ;
 793+ A14D              ;ACS - arc-cosine
 794+ A14D              ;Result is floating point numeric.
 795+ A14D              ;
 796+ A14D 3E 11        ACS:			LD      A,17
 797+ A14F F5           FPPN:			PUSH    AF
 798+ A150 CD C5 9E     			CALL    ITEMN
 799+ A153 F1           			POP     AF
 800+ A154 CD BD A4     FPP1:			CALL    FPP
 801+ A157 DA FE 86     			JP      C,ERROR
 802+ A15A AF           			XOR     A
 803+ A15B C9           			RET
 804+ A15C              ;
 805+ A15C              ;SFIX - Convert to fixed-point notation
 806+ A15C              ;
 807+ A15C 3E 26        @SFIX:			LD      A,38
 808+ A15E 18 F4        			JR      FPP1
 809+ A160              ;
 810+ A160              ;SFLOAT - Convert to floating-point notation
 811+ A160              ;
 812+ A160 3E 27        SFLOAT:			LD      A,39
 813+ A162 18 F0        			JR      FPP1
 814+ A164              ;
 815+ A164              ;VAL - Return numeric value of string.
 816+ A164              ;Result is variable type numeric.
 817+ A164              ;
 818+ A164 CD D5 9E     VAL:			CALL    ITEMS
 819+ A167 AF           @VAL0:			XOR     A
 820+ A168 12           			LD      (DE),A
 821+ A169 DD 21 00 B3  			LD      IX,ACCS
 822+ A16D 3E 24        			LD      A,36
 823+ A16F 18 E3        			JR      FPP1
 824+ A171              ;
 825+ A171              ;EVAL - Pass string to expression evaluator.
 826+ A171              ;Result is variable type (numeric or string).
 827+ A171              ;
 828+ A171 CD D5 9E     EVAL:			CALL    ITEMS
 829+ A174 3E 0D        			LD      A,CR
 830+ A176 12           			LD      (DE),A
 831+ A177 FD E5        			PUSH    IY
 832+ A179 11 00 B3     			LD      DE,ACCS
 833+ A17C FD 21 00 B3  			LD      IY,ACCS
 834+ A180 0E 00        			LD      C,0
 835+ A182 CD 78 8B     			CALL    LEXAN2          ;TOKENISE
 836+ A185 12           			LD      (DE),A
 837+ A186 13           			INC     DE
 838+ A187 AF           			XOR     A
 839+ A188 CD 00 A4     			CALL    PUSHS           ;PUT ON STACK
 840+ A18B FD 21 02 00  			LD      IY,2
 841+ A18F FD 39        			ADD     IY,SP
 842+ A191 CD A5 9D     			CALL    EXPR
 843+ A194 FD E1        			POP     IY
 844+ A196 FD 39        			ADD     IY,SP
 845+ A198 FD F9        			LD      SP,IY           ;ADJUST STACK POINTER
 846+ A19A FD E1        			POP     IY
 847+ A19C 08           			EX      AF,AF'
 848+ A19D C9           			RET
 849+ A19E              ;
 850+ A19E              ;RND - Random number function.
 851+ A19E              ; RND gives random integer 0-&FFFFFFFF
 852+ A19E              ; RND(-n) seeds random number & returns -n.
 853+ A19E              ; RND(0) returns last value in RND(1) form.
 854+ A19E              ; RND(1) returns floating-point 0-0.99999999.
 855+ A19E              ; RND(n) returns random integer 1-n.
 856+ A19E              ;
 857+ A19E DD 21 F6 B5  RND:			LD      IX,RANDOM
 858+ A1A2 CD 99 A4     			CALL    NXT
 859+ A1A5 FE 28        			CP      '('
 860+ A1A7 28 1C        			JR      Z,RND5          ;ARGUMENT FOLLOWS
 861+ A1A9 CD 77 9F     			CALL    LOAD5
 862+ A1AC CB 19        RND1:			RR      C
 863+ A1AE 06 20        			LD      B,32
 864+ A1B0 D9           RND2:			EXX                     ;CALCULATE NEXT
 865+ A1B1 ED 6A        			ADC     HL,HL
 866+ A1B3 D9           			EXX
 867+ A1B4 ED 6A        			ADC     HL,HL
 868+ A1B6 CB 5D        			BIT     3,L
 869+ A1B8 28 01        			JR      Z,RND3
 870+ A1BA 3F           			CCF
 871+ A1BB 10 F3        RND3:			DJNZ    RND2
 872+ A1BD CB 11        RND4:			RL      C               ;SAVE CARRY
 873+ A1BF CD 86 95     			CALL    STORE5          ;STORE NEW NUMBER
 874+ A1C2 AF           			XOR     A
 875+ A1C3 4F           			LD      C,A
 876+ A1C4 C9           			RET
 877+ A1C5 CD CC 9E     RND5:			CALL    ITEMI
 878+ A1C8 DD 21 F6 B5  			LD      IX,RANDOM
 879+ A1CC CB 7C        			BIT     7,H             ;NEGATIVE?
 880+ A1CE 37           			SCF
 881+ A1CF 20 EC        			JR      NZ,RND4         ;SEED
 882+ A1D1 CD 40 A3     			CALL    TEST
 883+ A1D4 F5           			PUSH    AF
 884+ A1D5 CD 38 A3     			CALL    SWAP
 885+ A1D8 D9           			EXX
 886+ A1D9 CD 77 9F     			CALL    LOAD5
 887+ A1DC C4 AC A1     			CALL    NZ,RND1         ;NEXT IF NON-ZERO
 888+ A1DF D9           			EXX                     ;SCRAMBLE (CARE!)
 889+ A1E0 0E 7F        			LD      C,7FH
 890+ A1E2 CB 7C        RND6:			BIT     7,H             ;FLOAT
 891+ A1E4 20 08        			JR      NZ,RND7
 892+ A1E6 D9           			EXX
 893+ A1E7 29           			ADD     HL,HL
 894+ A1E8 D9           			EXX
 895+ A1E9 ED 6A        			ADC     HL,HL
 896+ A1EB 0D           			DEC     C
 897+ A1EC 20 F4        			JR      NZ,RND6
 898+ A1EE CB BC        RND7:			RES     7,H             ;POSITIVE 0-0.999999
 899+ A1F0 F1           			POP     AF
 900+ A1F1 C8           			RET     Z               ;ZERO ARGUMENT
 901+ A1F2 D9           			EXX
 902+ A1F3 7B           			LD      A,E
 903+ A1F4 3D           			DEC     A
 904+ A1F5 B2           			OR      D
 905+ A1F6 D9           			EXX
 906+ A1F7 B3           			OR      E
 907+ A1F8 B2           			OR      D
 908+ A1F9 C8           			RET     Z               ;ARGUMENT=1
 909+ A1FA 06 00        			LD      B,0             ;INTEGER MARKER
 910+ A1FC 3E 0A        			LD      A,10
 911+ A1FE CD BD A4     			CALL    FPP             ;MULTIPLY
 912+ A201 DA FE 86     			JP      C,ERROR
 913+ A204 CD 5C A1     			CALL    SFIX
 914+ A207 C3 27 9F     			JP      ADD1
 915+ A20A              ;
 916+ A20A              ;INSTR - String search.
 917+ A20A              ;Result is integer numeric.
 918+ A20A              ;
 919+ A20A CD 4E A4     INSTR:			CALL    EXPRSC          ;STRING TO SEARCH
 920+ A20D CD 00 A4     			CALL    PUSHS           ;SAVE STRING ON STACK
 921+ A210 CD BE 9E     			CALL    EXPRS           ;SUB-STRING
 922+ A213 C1           			POP     BC
 923+ A214 21 00 00     			LD      HL,0
 924+ A217 39           			ADD     HL,SP           ;HL ADDRESSES MAIN
 925+ A218 C5           			PUSH    BC              ;C = MAIN STRING LENGTH
 926+ A219 43           			LD      B,E             ;B = SUB-STRING LENGTH
 927+ A21A CD 99 A4     			CALL    NXT
 928+ A21D FE 2C        			CP      ','
 929+ A21F 3E 00        			LD      A,0
 930+ A221 20 17        			JR      NZ,INSTR1
 931+ A223 FD 23        			INC     IY              ;SKIP COMMA
 932+ A225 C5           			PUSH    BC              ;SAVE LENGTHS
 933+ A226 E5           			PUSH    HL              ;SAVE MAIN ADDRESS
 934+ A227 CD 00 A4     			CALL    PUSHS
 935+ A22A CD B5 9E     			CALL    EXPRI
 936+ A22D C1           			POP     BC
 937+ A22E CD 1F A4     			CALL    POPS
 938+ A231 E1           			POP     HL              ;RESTORE MAIN ADDRESS
 939+ A232 C1           			POP     BC              ;RESTORE LENGTHS
 940+ A233 D9           			EXX
 941+ A234 7D           			LD      A,L
 942+ A235 D9           			EXX
 943+ A236 B7           			OR      A
 944+ A237 28 01        			JR      Z,INSTR1
 945+ A239 3D           			DEC     A
 946+ A23A 11 00 B3     INSTR1:			LD      DE,ACCS         ;DE ADDRESSES SUB
 947+ A23D CD 54 A2     			CALL    SEARCH
 948+ A240 D1           			POP     DE
 949+ A241 28 03        			JR      Z,INSTR2        ;N.B. CARRY CLEARED
 950+ A243 ED 62        			SBC     HL,HL
 951+ A245 39           			ADD     HL,SP
 952+ A246 ED 72        INSTR2:			SBC     HL,SP
 953+ A248 EB           			EX      DE,HL
 954+ A249 26 00        			LD      H,0
 955+ A24B 39           			ADD     HL,SP
 956+ A24C F9           			LD      SP,HL
 957+ A24D EB           			EX      DE,HL
 958+ A24E CD 5D A4     			CALL    BRAKET
 959+ A251 C3 95 A0     			JP      COUNT1
 960+ A254              ;
 961+ A254              ;SEARCH - Search string for sub-string
 962+ A254              ;   Inputs: Main string at HL length C
 963+ A254              ;           Sub-string  at DE length B
 964+ A254              ;           Starting offset A
 965+ A254              ;  Outputs: NZ - not found
 966+ A254              ;           Z - found at location HL-1
 967+ A254              ;           Carry always cleared
 968+ A254              ;
 969+ A254 C5           @SEARCH:		PUSH    BC
 970+ A255 06 00        			LD      B,0
 971+ A257 4F           			LD      C,A
 972+ A258 09           			ADD     HL,BC           ;NEW START ADDRESS
 973+ A259 C1           			POP     BC
 974+ A25A 91           			SUB     C
 975+ A25B 30 28        			JR      NC,SRCH4
 976+ A25D ED 44        			NEG
 977+ A25F 4F           			LD      C,A             ;REMAINING LENGTH
 978+ A260 1A           SRCH1:			LD      A,(DE)
 979+ A261 C5           			PUSH    BC
 980+ A262 06 00        			LD      B,0
 981+ A264 ED B1        			CPIR                    ;FIND FIRST CHARACTER
 982+ A266 79           			LD      A,C
 983+ A267 C1           			POP     BC
 984+ A268 20 1B        			JR      NZ,SRCH4
 985+ A26A 4F           			LD      C,A
 986+ A26B 05           			DEC     B               ;Bug fix
 987+ A26C B8           			CP      B               ;Bug fix
 988+ A26D 04           			INC     B               ;Bug fix
 989+ A26E 38 15        			JR      C,SRCH4         ;Bug fix
 990+ A270 C5           			PUSH    BC
 991+ A271 D5           			PUSH    DE
 992+ A272 E5           			PUSH    HL
 993+ A273 05           			DEC     B
 994+ A274 28 08        			JR      Z,SRCH3         ;FOUND !
 995+ A276 13           SRCH2:			INC     DE
 996+ A277 1A           			LD      A,(DE)
 997+ A278 BE           			CP      (HL)
 998+ A279 20 03        			JR      NZ,SRCH3
 999+ A27B 23           			INC     HL
1000+ A27C 10 F8        			DJNZ    SRCH2
1001+ A27E E1           SRCH3:			POP     HL
1002+ A27F D1           			POP     DE
1003+ A280 C1           			POP     BC
1004+ A281 20 DD        			JR      NZ,SRCH1
1005+ A283 AF           			XOR     A               ;Z, NC
1006+ A284 C9           			RET                     ;FOUND
1007+ A285              ;
1008+ A285 F6 FF        SRCH4:			OR      0FFH            ;NZ, NC
1009+ A287 C9           			RET                     ;NOT FOUND
1010+ A288              ;
1011+ A288              ;CHRS - Return character with given ASCII value.
1012+ A288              ;Result is string.
1013+ A288              ;
1014+ A288 CD CC 9E     CHRS:			CALL    ITEMI
1015+ A28B D9           			EXX
1016+ A28C 7D           			LD      A,L
1017+ A28D 18 03        			JR      GET1
1018+ A28F              ;
1019+ A28F              ;GETS - Return key pressed as string.
1020+ A28F              ;Result is string.
1021+ A28F              ;
1022+ A28F CD DE B0     GETS:			CALL    OSRDCH
1023+ A292 37           GET1:			SCF
1024+ A293 18 07        			JR      INKEY1
1025+ A295              ;
1026+ A295              ;INKEYS - Wait up to n centiseconds for keypress.
1027+ A295              ;         Return key pressed as string or null
1028+ A295              ;         string if time elapsed.
1029+ A295              ;Result is string.
1030+ A295              ;
1031+ A295 CD CC 9E     INKEYS:			CALL    ITEMI
1032+ A298 D9           			EXX
1033+ A299 CD E4 B0     			CALL    OSKEY
1034+ A29C 11 00 B3     INKEY1:			LD      DE,ACCS
1035+ A29F 12           			LD      (DE),A
1036+ A2A0 3E 80        			LD      A,80H
1037+ A2A2 D0           			RET     NC
1038+ A2A3 1C           			INC     E
1039+ A2A4 C9           			RET
1040+ A2A5              ;
1041+ A2A5              ;MID$ - Return sub-string.
1042+ A2A5              ;Result is string.
1043+ A2A5              ;
1044+ A2A5 CD 4E A4     MIDS:			CALL    EXPRSC
1045+ A2A8 CD 00 A4     			CALL    PUSHS           ;SAVE STRING ON STACK
1046+ A2AB CD B5 9E     			CALL    EXPRI
1047+ A2AE C1           			POP     BC
1048+ A2AF CD 1F A4     			CALL    POPS
1049+ A2B2 D9           			EXX
1050+ A2B3 7D           			LD      A,L
1051+ A2B4 D9           			EXX
1052+ A2B5 B7           			OR      A
1053+ A2B6 28 0D        			JR      Z,MIDS1
1054+ A2B8 3D           			DEC     A
1055+ A2B9 6F           			LD      L,A
1056+ A2BA 93           			SUB     E
1057+ A2BB 1E 00        			LD      E,0
1058+ A2BD 30 06        			JR      NC,MIDS1
1059+ A2BF ED 44        			NEG
1060+ A2C1 4F           			LD      C,A
1061+ A2C2 CD FC A2     			CALL    RIGHT1
1062+ A2C5 CD 99 A4     MIDS1:			CALL    NXT
1063+ A2C8 FE 2C        			CP      ','
1064+ A2CA FD 23        			INC     IY
1065+ A2CC 28 0B        			JR      Z,LEFT1
1066+ A2CE FD 2B        			DEC     IY
1067+ A2D0 CD 5D A4     			CALL    BRAKET
1068+ A2D3 3E 80        			LD      A,80H
1069+ A2D5 C9           			RET
1070+ A2D6              ;
1071+ A2D6              ;LEFT$ - Return left part of string.
1072+ A2D6              ;Carry cleared if entire string returned.
1073+ A2D6              ;Result is string.
1074+ A2D6              ;
1075+ A2D6 CD 4E A4     LEFTS:			CALL    EXPRSC
1076+ A2D9 CD 00 A4     LEFT1:			CALL    PUSHS           ;SAVE STRING ON STACK
1077+ A2DC CD B5 9E     			CALL    EXPRI
1078+ A2DF C1           			POP     BC
1079+ A2E0 CD 1F A4     			CALL    POPS
1080+ A2E3 CD 5D A4     			CALL    BRAKET
1081+ A2E6 D9           			EXX
1082+ A2E7 7D           			LD      A,L
1083+ A2E8 D9           			EXX
1084+ A2E9 BB           			CP      E
1085+ A2EA 30 02        			JR      NC,LEFT3
1086+ A2EC 6B           			LD      L,E             ;FOR RIGHTS
1087+ A2ED 5F           LEFT2:			LD      E,A
1088+ A2EE 3E 80        LEFT3:			LD      A,80H           ;STRING MARKER
1089+ A2F0 C9           			RET
1090+ A2F1              ;
1091+ A2F1              ;RIGHT$ - Return right part of string.
1092+ A2F1              ;Result is string.
1093+ A2F1              ;
1094+ A2F1 CD D6 A2     RIGHTS:			CALL    LEFTS
1095+ A2F4 D0           			RET     NC
1096+ A2F5 1C           			INC     E
1097+ A2F6 1D           			DEC     E
1098+ A2F7 C8           			RET     Z
1099+ A2F8 4B           			LD      C,E
1100+ A2F9 7D           			LD      A,L
1101+ A2FA 93           			SUB     E
1102+ A2FB 6F           			LD      L,A
1103+ A2FC 06 00        RIGHT1:			LD      B,0
1104+ A2FE 62           			LD      H,D
1105+ A2FF 58           			LD      E,B
1106+ A300 ED B0        			LDIR                    ;MOVE
1107+ A302 3E 80        			LD      A,80H
1108+ A304 C9           			RET
1109+ A305              ;
1110+ A305              ;STRINGS - Return n concatenations of a string.
1111+ A305              ;Result is string.
1112+ A305              ;
1113+ A305 CD B5 9E     STRING:			CALL    EXPRI
1114+ A308 CD 51 A4     			CALL    COMMA
1115+ A30B D9           			EXX
1116+ A30C 7D           			LD      A,L
1117+ A30D D9           			EXX
1118+ A30E F5           			PUSH    AF
1119+ A30F CD BE 9E     			CALL    EXPRS
1120+ A312 CD 5D A4     			CALL    BRAKET
1121+ A315 F1           			POP     AF
1122+ A316 B7           			OR      A
1123+ A317 28 D4        			JR      Z,LEFT2         ;N=0
1124+ A319 3D           			DEC     A
1125+ A31A 4F           			LD      C,A
1126+ A31B 3E 80        			LD      A,80H           ;STRING MARKER
1127+ A31D C8           			RET     Z
1128+ A31E 1C           			INC     E
1129+ A31F 1D           			DEC     E
1130+ A320 C8           			RET     Z               ;NULL STRING
1131+ A321 43           			LD      B,E
1132+ A322 62           			LD      H,D
1133+ A323 2E 00        			LD      L,0
1134+ A325 C5           STRIN1:			PUSH    BC
1135+ A326 7E           STRIN2:			LD      A,(HL)
1136+ A327 23           			INC     HL
1137+ A328 12           			LD      (DE),A
1138+ A329 1C           			INC     E
1139+ A32A 3E 13        			LD      A,19
1140+ A32C CA FE 86     			JP      Z,ERROR         ;"String too long"
1141+ A32F 10 F5        			DJNZ    STRIN2
1142+ A331 C1           			POP     BC
1143+ A332 0D           			DEC     C
1144+ A333 20 F0        			JR      NZ,STRIN1
1145+ A335 3E 80        			LD      A,80H
1146+ A337 C9           			RET
1147+ A338              ;
1148+ A338              ;SUBROUTINES
1149+ A338              ;
1150+ A338              ;SWAP - Swap arguments
1151+ A338              ;Exchanges DE,HL D'E',H'L' and B,C
1152+ A338              ;Destroys: A,B,C,D,E,H,L,D',E',H',L'
1153+ A338              ;
1154+ A338 79           @SWAP:			LD      A,C
1155+ A339 48           			LD      C,B
1156+ A33A 47           			LD      B,A
1157+ A33B EB           			EX      DE,HL
1158+ A33C D9           			EXX
1159+ A33D EB           			EX      DE,HL
1160+ A33E D9           			EXX
1161+ A33F C9           			RET
1162+ A340              ;
1163+ A340              ;TEST - Test HLH'L' for zero
1164+ A340              ;Outputs: Z-flag set & A=0 if zero
1165+ A340              ;Destroys: A,F
1166+ A340              ;
1167+ A340 7C           @TEST:			LD      A,H
1168+ A341 B5           			OR      L
1169+ A342 D9           			EXX
1170+ A343 B4           			OR      H
1171+ A344 B5           			OR      L
1172+ A345 D9           			EXX
1173+ A346 C9           			RET
1174+ A347              ;
1175+ A347              ;DECODE - Decode line number in pseudo-binary.
1176+ A347              ;   Inputs: IY = Text pointer.
1177+ A347              ;   Outputs: HL=0, H'L'=line number, C=0.
1178+ A347              ;   Destroys: A,C,H,L,H',L',IY,F
1179+ A347              ;
1180+ A347 D9           @DECODE:		EXX
1181+ A348 FD 7E 00     			LD      A,(IY)
1182+ A34B FD 23        			INC     IY
1183+ A34D 17           			RLA
1184+ A34E 17           			RLA
1185+ A34F 67           			LD      H,A
1186+ A350 E6 C0        			AND     0C0H
1187+ A352 FD AE 00     			XOR     (IY)
1188+ A355 FD 23        			INC     IY
1189+ A357 6F           			LD      L,A
1190+ A358 7C           			LD      A,H
1191+ A359 17           			RLA
1192+ A35A 17           			RLA
1193+ A35B E6 C0        			AND     0C0H
1194+ A35D FD AE 00     			XOR     (IY)
1195+ A360 FD 23        			INC     IY
1196+ A362 67           			LD      H,A
1197+ A363 D9           			EXX
1198+ A364 AF           			XOR     A
1199+ A365 4F           			LD      C,A
1200+ A366 67           			LD      H,A
1201+ A367 6F           			LD      L,A
1202+ A368 C9           			RET
1203+ A369              ;
1204+ A369              ;HEXSTR - convert numeric value to HEX string.
1205+ A369              ;   Inputs: HLH'L'C = integer or floating-point number
1206+ A369              ;  Outputs: String in string accumulator.
1207+ A369              ;           E = string length.  D = ACCS/256
1208+ A369              ;
1209+ A369 FD 23        HEXSTS:			INC     IY              ;SKIP TILDE
1210+ A36B CD C5 9E     			CALL    ITEMN
1211+ A36E CD 74 A3     			CALL    HEXSTR
1212+ A371 3E 80        			LD      A,80H
1213+ A373 C9           			RET
1214+ A374              ;
1215+ A374 CD 5C A1     @HEXSTR:		CALL    SFIX
1216+ A377 01 08 00     			LD      BC,8
1217+ A37A 11 00 B3     			LD      DE,ACCS
1218+ A37D C5           HEXST1:			PUSH    BC
1219+ A37E 06 04        			LD      B,4
1220+ A380 AF           			XOR     A
1221+ A381 D9           HEXST2:			EXX
1222+ A382 29           			ADD     HL,HL
1223+ A383 D9           			EXX
1224+ A384 ED 6A        			ADC     HL,HL
1225+ A386 17           			RLA
1226+ A387 10 F8        			DJNZ    HEXST2
1227+ A389 C1           			POP     BC
1228+ A38A 0D           			DEC     C
1229+ A38B F8           			RET     M
1230+ A38C 28 06        			JR      Z,HEXST3
1231+ A38E B7           			OR      A
1232+ A38F 20 03        			JR      NZ,HEXST3
1233+ A391 B8           			CP      B
1234+ A392 28 E9        			JR      Z,HEXST1
1235+ A394 C6 90        HEXST3:			ADD     A,90H
1236+ A396 27           			DAA
1237+ A397 CE 40        			ADC     A,40H
1238+ A399 27           			DAA
1239+ A39A 12           			LD      (DE),A
1240+ A39B 13           			INC     DE
1241+ A39C 47           			LD      B,A
1242+ A39D 18 DE        			JR      HEXST1
1243+ A39F              ;
1244+ A39F              ;Function STR - convert numeric value to ASCII string.
1245+ A39F              ;   Inputs: HLH'L'C = integer or floating-point number.
1246+ A39F              ;  Outputs: String in string accumulator.
1247+ A39F              ;           E = length, D = ACCS/256
1248+ A39F              ;           A = 80H (type=string)
1249+ A39F              ;
1250+ A39F              ;First normalise for decimal output:
1251+ A39F              ;
1252+ A39F CD 99 A4     STRS:			CALL    NXT
1253+ A3A2 FE 7E        			CP      '~'
1254+ A3A4 28 C3        			JR      Z,HEXSTS
1255+ A3A6 CD C5 9E     			CALL    ITEMN
1256+ A3A9 DD 21 00 B5  			LD      IX,STAVAR
1257+ A3AD DD 7E 03     			LD      A,(IX+3)
1258+ A3B0 B7           			OR      A
1259+ A3B1 DD 21 D9 A3  			LD      IX,G9-1         ;G9 FORMAT
1260+ A3B5 28 04        			JR      Z,STR0
1261+ A3B7 DD 21 00 B5  @STR:			LD      IX,STAVAR
1262+ A3BB 11 00 B3     STR0:			LD      DE,ACCS
1263+ A3BE 3E 25        			LD      A,37
1264+ A3C0 CD BD A4     			CALL    FPP
1265+ A3C3 DA FE 86     			JP      C,ERROR
1266+ A3C6 DD CB 02 46  			BIT     0,(IX+2)
1267+ A3CA 3E 80        STR1:			LD      A,80H           ;STRING MARKER
1268+ A3CC C8           			RET     Z
1269+ A3CD 79           			LD      A,C
1270+ A3CE C6 04        			ADD     A,4
1271+ A3D0 BB           STR2:			CP      E
1272+ A3D1 28 F7        			JR      Z,STR1
1273+ A3D3 EB           			EX      DE,HL
1274+ A3D4 36 20        			LD      (HL),' '        ;TRAILING SPACE
1275+ A3D6 23           			INC     HL
1276+ A3D7 EB           			EX      DE,HL
1277+ A3D8 18 F6        			JR      STR2
1278+ A3DA              ;
1279+ A3DA 09 00        G9:			DEFW    9
1280+ A3DC              ;
1281+ A3DC              ;STRING COMPARE
1282+ A3DC              ;Compare string (DE) length B with string (HL) length C.
1283+ A3DC              ;Result preset to false.
1284+ A3DC              ;
1285+ A3DC CD E9 A3     SCP:			CALL    SCP0
1286+ A3DF 3E 00        @ZERO:			LD      A,0
1287+ A3E1 D9           			EXX
1288+ A3E2 67           			LD      H,A
1289+ A3E3 6F           			LD      L,A
1290+ A3E4 D9           			EXX
1291+ A3E5 67           			LD      H,A
1292+ A3E6 6F           			LD      L,A
1293+ A3E7 4F           			LD      C,A
1294+ A3E8 C9           			RET
1295+ A3E9              ;
1296+ A3E9 04           SCP0:			INC     B
1297+ A3EA 0C           			INC     C
1298+ A3EB 05           SCP1:			DEC     B
1299+ A3EC 28 0A        			JR      Z,SCP2
1300+ A3EE 0D           			DEC     C
1301+ A3EF 28 0C        			JR      Z,SCP3
1302+ A3F1 1A           			LD      A,(DE)
1303+ A3F2 BE           			CP      (HL)
1304+ A3F3 C0           			RET     NZ
1305+ A3F4 13           			INC     DE
1306+ A3F5 23           			INC     HL
1307+ A3F6 18 F3        			JR      SCP1
1308+ A3F8 B7           SCP2:			OR      A
1309+ A3F9 0D           				DEC     C
1310+ A3FA C8           			RET     Z
1311+ A3FB 37           			SCF
1312+ A3FC C9           			RET
1313+ A3FD B7           SCP3:			OR      A
1314+ A3FE 0C           			INC     C
1315+ A3FF C9           			RET
1316+ A400              ;
1317+ A400              ;PUSHS - SAVE STRING ON STACK.
1318+ A400              ;    Inputs: String in string accumulator.
1319+ A400              ;            E = string length.
1320+ A400              ;            A - saved on stack.
1321+ A400              ;  Destroys: B,C,D,E,H,L,IX,SP,F
1322+ A400              ;
1323+ A400 CD E2 95     @PUSHS:			CALL    CHECK
1324+ A403 DD E1        			POP     IX              ;RETURN ADDRESS
1325+ A405 B7           			OR      A               ;CLEAR CARRY
1326+ A406 21 00 B3     			LD      HL,ACCS
1327+ A409 54           			LD      D,H
1328+ A40A 45           			LD      B,L             ;B=0
1329+ A40B ED 52        			SBC     HL,DE
1330+ A40D 39           			ADD     HL,SP
1331+ A40E F9           			LD      SP,HL
1332+ A40F 57           			LD      D,A
1333+ A410 D5           			PUSH    DE
1334+ A411 28 0A        			JR      Z,PUSHS1        ;ZERO LENGTH
1335+ A413 4B           			LD      C,E
1336+ A414 11 00 B3     			LD      DE,ACCS
1337+ A417 EB           			EX      DE,HL
1338+ A418 ED B0        			LDIR                    ;COPY TO STACK
1339+ A41A CD E2 95     			CALL    CHECK
1340+ A41D DD E9        PUSHS1:			JP      (IX)            ;"RETURN"
1341+ A41F              ;
1342+ A41F              ;POPS - RESTORE STRING FROM STACK.
1343+ A41F              ;    Inputs: C = string length.
1344+ A41F              ;   Outputs: String in string accumulator.
1345+ A41F              ;            E = string length.
1346+ A41F              ;  Destroys: B,C,D,E,H,L,IX,SP,F
1347+ A41F              ;
1348+ A41F DD E1        @POPS:			POP     IX              ;RETURN ADDRESS
1349+ A421 21 00 00     			LD      HL,0
1350+ A424 44           			LD      B,H             ;B=0
1351+ A425 39           			ADD     HL,SP
1352+ A426 11 00 B3     			LD      DE,ACCS
1353+ A429 0C           			INC     C
1354+ A42A 0D           			DEC     C
1355+ A42B 28 02        			JR      Z,POPS1         ;ZERO LENGTH
1356+ A42D ED B0        			LDIR                    ;COPY FROM STACK
1357+ A42F F9           POPS1:			LD      SP,HL
1358+ A430 DD E9        			JP      (IX)            ;"RETURN"
1359+ A432              ;
1360+ A432 FD 7E 00     HEXDIG:			LD      A,(IY)
1361+ A435 FE 30        			CP      '0'
1362+ A437 D8           			RET     C
1363+ A438 FE 3A        			CP      '9'+1
1364+ A43A 3F           			CCF
1365+ A43B D0           			RET     NC
1366+ A43C FE 41        			CP      'A'
1367+ A43E D8           			RET     C
1368+ A43F D6 37        			SUB     'A'-10
1369+ A441 FE 10        			CP      16
1370+ A443 3F           			CCF
1371+ A444 C9           			RET
1372+ A445              ;
1373+ A445 FE 3E        RELOP?:			CP      '>'
1374+ A447 D0           			RET     NC
1375+ A448 FE 3D        			CP      '='
1376+ A44A D0           			RET     NC
1377+ A44B FE 3C        			CP      '<'
1378+ A44D C9           			RET
1379+ A44E              ;
1380+ A44E CD BE 9E     EXPRSC:			CALL    EXPRS
1381+ A451 CD 99 A4     @COMMA:			CALL    NXT
1382+ A454 FD 23        			INC     IY
1383+ A456 FE 2C        			CP      ','
1384+ A458 C8           			RET     Z
1385+ A459 3E 05        			LD      A,5
1386+ A45B 18 0A        			JR      ERROR1          ;"Missing ,"
1387+ A45D              ;
1388+ A45D CD 99 A4     @BRAKET:		CALL    NXT
1389+ A460 FD 23        			INC     IY
1390+ A462 FE 29        			CP      ')'
1391+ A464 C8           			RET     Z
1392+ A465 3E 1B        			LD      A,27
1393+ A467 C3 FE 86     ERROR1:			JP      ERROR           ;"Missing )"
1394+ A46A              ;
1395+ A46A FD 23        SAVE:			INC     IY
1396+ A46C 08           SAVE1:			EX      AF,AF'
1397+ A46D FA DA 9E     			JP      M,TYPE
1398+ A470 08           			EX      AF,AF'
1399+ A471 E3           			EX      (SP),HL
1400+ A472 D9           			EXX
1401+ A473 E5           			PUSH    HL
1402+ A474 D9           			EXX
1403+ A475 F5           			PUSH    AF
1404+ A476 C5           			PUSH    BC
1405+ A477 E9           			JP      (HL)
1406+ A478              ;
1407+ A478 08           DOIT:			EX      AF,AF'
1408+ A479 FA DA 9E     			JP      M,TYPE
1409+ A47C D9           			EXX
1410+ A47D C1           			POP     BC              ;RETURN ADDRESS
1411+ A47E D9           			EXX
1412+ A47F 79           			LD      A,C
1413+ A480 C1           			POP     BC
1414+ A481 47           			LD      B,A
1415+ A482 F1           			POP     AF              ;OPERATOR
1416+ A483 D9           			EXX
1417+ A484 EB           			EX      DE,HL
1418+ A485 E1           			POP     HL
1419+ A486 D9           			EXX
1420+ A487 EB           			EX      DE,HL
1421+ A488 E1           			POP     HL
1422+ A489 D9           			EXX
1423+ A48A C5           			PUSH    BC
1424+ A48B D9           			EXX
1425+ A48C E6 0F        			AND     0FH
1426+ A48E CD BD A4     			CALL    FPP
1427+ A491 38 D4        			JR      C,ERROR1
1428+ A493 AF           			XOR     A
1429+ A494 08           			EX      AF,AF'          ;TYPE
1430+ A495 FD 7E 00     			LD      A,(IY)
1431+ A498 C9           			RET
1432+ A499              ;
1433+ A499 FD 7E 00     @NXT:			LD      A,(IY)
1434+ A49C FE 20        			CP      ' '
1435+ A49E C0           			RET     NZ
1436+ A49F FD 23        			INC     IY
1437+ A4A1 C3 99 A4     			JP      NXT
1438+ A4A4              ;
1439+ A4A4 E5           DISPT2:			PUSH    HL
1440+ A4A5 21 99 9D     			LD      HL,SOPTBL
1441+ A4A8 18 06        			JR      DISPT0
1442+ A4AA              ;
1443+ A4AA E5           DISPAT:			PUSH    HL
1444+ A4AB D6 8D        			SUB     FUNTOK
1445+ A4AD 21 29 9D     			LD      HL,FUNTBL
1446+ A4B0 C5           DISPT0:			PUSH    BC
1447+ A4B1 87           			ADD     A,A
1448+ A4B2 4F           			LD      C,A
1449+ A4B3 06 00        			LD      B,0
1450+ A4B5 09           			ADD     HL,BC
1451+ A4B6 7E           			LD      A,(HL)
1452+ A4B7 23           			INC     HL
1453+ A4B8 66           			LD      H,(HL)
1454+ A4B9 6F           			LD      L,A
1455+ A4BA C1           			POP     BC
1456+ A4BB E3           			EX      (SP),HL
1457+ A4BC C9           			RET                     ;OFF TO ROUTINE
1458+ A4BD              ;
1459+ A4BD              CR			EQU     0DH
1460+ A4BD
1461+ A4BD              			ENDMODULE
# file closed: eval.z80
  34  A4BD              			include "fpp.z80"
# file opened: fpp.z80
   1+ A4BD              ;
   2+ A4BD              ;Z80 FLOATING POINT PACKAGE
   3+ A4BD              ;(C) COPYRIGHT  R.T.RUSSELL  1986
   4+ A4BD              ;VERSION 0.0, 26-10-1986
   5+ A4BD              ;VERSION 0.1, 14-12-1988 (BUG FIX)
   6+ A4BD              ;
   7+ A4BD              ;BINARY FLOATING POINT REPRESENTATION:
   8+ A4BD              ;   32 BIT SIGN-MAGNITUDE NORMALIZED MANTISSA
   9+ A4BD              ;    8 BIT EXCESS-128 SIGNED EXPONENT
  10+ A4BD              ;   SIGN BIT REPLACES MANTISSA MSB (IMPLIED "1")
  11+ A4BD              ;   MANTISSA=0 & EXPONENT=0 IMPLIES VALUE IS ZERO.
  12+ A4BD              ;
  13+ A4BD              ;BINARY INTEGER REPRESENTATION:
  14+ A4BD              ;   32 BIT 2'S-COMPLEMENT SIGNED INTEGER
  15+ A4BD              ;    "EXPONENT" BYTE = 0 (WHEN PRESENT)
  16+ A4BD              ;
  17+ A4BD              ;NORMAL REGISTER ALLOCATION: MANTISSA - HLH'L'
  18+ A4BD              ;                            EXPONENT - C
  19+ A4BD              ;ALTERNATE REGISTER ALLOCATION: MANTISSA - DED'E'
  20+ A4BD              ;                               EXPONENT - B
  21+ A4BD              ;
  22+ A4BD              ;Error codes:
  23+ A4BD              ;
  24+ A4BD              			MODULE FPP
  25+ A4BD
  26+ A4BD              BADOP:			EQU     1               ;Bad operation code
  27+ A4BD              DIVBY0:			EQU     18              ;Division by zero
  28+ A4BD              TOOBIG:			EQU     20              ;Too big
  29+ A4BD              NGROOT:			EQU     21              ;Negative root
  30+ A4BD              LOGRNG:			EQU     22              ;Log range
  31+ A4BD              ACLOST:			EQU     23              ;Accuracy lost
  32+ A4BD              EXPRNG:			EQU     24              ;Exp range
  33+ A4BD              ;
  34+ A4BD              ;Call entry and despatch code:
  35+ A4BD              ;
  36+ A4BD FD E5        @FPP:			PUSH    IY              ;Save IY
  37+ A4BF FD 21 00 00          		LD      IY,0
  38+ A4C3 FD 39                		ADD     IY,SP           ;Save SP in IY
  39+ A4C5 CD D4 A4             		CALL    OP              ;Perform operation
  40+ A4C8 BF                   		CP      A               ;Good return (Z, NC)
  41+ A4C9 FD E1        EXIT:			POP     IY              ;Restore IY
  42+ A4CB C9                   		RET                     ;Return to caller
  43+ A4CC              ;
  44+ A4CC              ;Error exit:
  45+ A4CC              ;
  46+ A4CC 3E 01        BAD:			LD      A,BADOP         ;"Bad operation code"
  47+ A4CE FD F9        ERROR:			LD      SP,IY           ;Restore SP from IY
  48+ A4D0 B7                   		OR      A               ;Set NZ
  49+ A4D1 37                   		SCF                     ;Set C
  50+ A4D2 18 F5                		JR      EXIT
  51+ A4D4              ;
  52+ A4D4              ;Perform operation or function:
  53+ A4D4              ;
  54+ A4D4 FE 29        OP:			CP      (RTABLE-DTABLE)/2
  55+ A4D6 30 F4                		JR      NC,BAD
  56+ A4D8 FE 10                		CP      (FTABLE-DTABLE)/2
  57+ A4DA 30 07                		JR      NC,DISPAT
  58+ A4DC 08                   		EX      AF,AF'
  59+ A4DD 78                   		LD      A,B
  60+ A4DE B1                   		OR      C               ;Both integer?
  61+ A4DF C4 5C AE             		CALL    NZ,FLOATA       ;No, so float both
  62+ A4E2 08                   		EX      AF,AF'
  63+ A4E3 E5           DISPAT:			PUSH    HL
  64+ A4E4 21 F4 A4             		LD      HL,DTABLE
  65+ A4E7 C5                   		PUSH    BC
  66+ A4E8 87                   		ADD     A,A             ;A = op-code * 2
  67+ A4E9 4F                   		LD      C,A
  68+ A4EA 06 00                		LD      B,0             ;BC = op-code * 2
  69+ A4EC 09                   		ADD     HL,BC
  70+ A4ED 7E                   		LD      A,(HL)          ;Get low byte
  71+ A4EE 23                   		INC     HL
  72+ A4EF 66                   		LD      H,(HL)          ;Get high byte
  73+ A4F0 6F                   		LD      L,A
  74+ A4F1 C1                   		POP     BC
  75+ A4F2 E3                   		EX      (SP),HL
  76+ A4F3 C9                   		RET                     ;Off to routine
  77+ A4F4              ;
  78+ A4F4              ;Despatch table:
  79+ A4F4              ;
  80+ A4F4 69 A5        DTABLE:			DEFW    IAND            ;AND (INTEGER)
  81+ A4F6 CC A5                		DEFW    IBDIV           ;DIV
  82+ A4F8 7B A5                		DEFW    IEOR            ;EOR
  83+ A4FA 9F A5                		DEFW    IMOD            ;MOD
  84+ A4FC 8D A5                		DEFW    IOR             ;OR
  85+ A4FE FB A7                		DEFW    ILE             ;<=
  86+ A500 08 A8                		DEFW    INE             ;<>
  87+ A502 F0 A7                		DEFW    IGE             ;>=
  88+ A504 D9 A7                		DEFW    ILT             ;<
  89+ A506 13 A8                		DEFW    IEQ             ;=
  90+ A508 96 A6                		DEFW    IMUL            ;*
  91+ A50A EF A5                		DEFW    IADD            ;+
  92+ A50C E4 A7                		DEFW    IGT             ;>
  93+ A50E D9 A5                		DEFW    ISUB            ;-
  94+ A510 34 A7                		DEFW    IPOW            ;^
  95+ A512 4E A6                		DEFW    IDIV            ;/
  96+ A514              ;
fpp.z80(97): error: [DW/DEFW/WORD] Syntax error:
  97+ A514              FTABLE:			DEFW    ABS             ;ABS
  98+ A514 7E AB                		DEFW    ACS             ;ACS
  99+ A516 DA AA                		DEFW    ASN             ;ASN
 100+ A518 FF AA                		DEFW    ATN             ;ATN
 101+ A51A 18 A9                		DEFW    COS             ;COS
 102+ A51C 4C A8                		DEFW    DEG             ;DEG
 103+ A51E BD A9                		DEFW    EXP             ;EXP
 104+ A520 92 A8                		DEFW    INT             ;INT
 105+ A522 48 AA                		DEFW    LN              ;LN
 106+ A524 C8 AA                		DEFW    LOG             ;LOG
 107+ A526 2D A8                		DEFW    NOTK            ;NOT
 108+ A528 54 A8                		DEFW    RAD             ;RAD
 109+ A52A 6A A8                		DEFW    SGN             ;SGN
 110+ A52C 23 A9                		DEFW    SIN             ;SIN
 111+ A52E A8 A8                		DEFW    SQR             ;SQR
 112+ A530 FB A8                		DEFW    TAN             ;TAN
 113+ A532              ;
 114+ A532 D8 AE        		        DEFW    ZERO            ;ZERO
 115+ A534 9C A9                		DEFW    FONE            ;FONE
 116+ A536 17 A8                		DEFW    TRUE            ;TRUE
 117+ A538 40 A8                		DEFW    PI              ;PI
 118+ A53A              ;
 119+ A53A 7A A8        		        DEFW    VAL             ;VAL
 120+ A53C 86 AB                		DEFW    STR             ;STR$
 121+ A53E              ;
 122+ A53E AD AD                		DEFW    SFIX            ;FIX
 123+ A540 69 AE                		DEFW    SFLOAT          ;FLOAT
 124+ A542              ;
 125+ A542 AE AE        		        DEFW    FTEST           ;TEST
 126+ A544 BF AE                		DEFW    FCOMP           ;COMPARE
 127+ A546              ;
 128+ A546 66 A5        RTABLE:			DEFW    FAND            ;AND (FLOATING-POINT)
 129+ A548 C9 A5                		DEFW    FBDIV           ;DIV
 130+ A54A 78 A5                		DEFW    FEOR            ;EOR
 131+ A54C 9C A5                		DEFW    FMOD            ;MOD
 132+ A54E 8A A5                		DEFW    FOR             ;OR
 133+ A550 F6 A7                		DEFW    FLE             ;<=
 134+ A552 03 A8                		DEFW    FNE             ;<>
 135+ A554 EB A7                		DEFW    FGE             ;>=
 136+ A556 D4 A7                		DEFW    FLT             ;<
 137+ A558 0E A8                		DEFW    FEQ             ;=
 138+ A55A E4 A6                		DEFW    FMUL            ;*
 139+ A55C F9 A5                		DEFW    FADD            ;+
 140+ A55E DF A7                		DEFW    FGT             ;>
 141+ A560 E3 A5                		DEFW    FSUB            ;-
 142+ A562 AA A7                		DEFW    FPOW            ;^
 143+ A564 51 A6                		DEFW    FDIV            ;/
 144+ A566              ;
 145+ A566              ;       PAGE
 146+ A566              ;
 147+ A566              ;ARITHMETIC AND LOGICAL OPERATORS:
 148+ A566              ;All take two arguments, in HLH'L'C & DED'E'B.
 149+ A566              ;Output in HLH'L'C
 150+ A566              ;All registers except IX, IY destroyed.
 151+ A566              ; (N.B. FPOW destroys IX).
 152+ A566              ;
 153+ A566              ;FAND - Floating-point AND.
 154+ A566              ;IAND - Integer AND.
 155+ A566              ;
 156+ A566 CD A4 AD     FAND:			CALL    FIX2
 157+ A569 7C           IAND:			LD      A,H
 158+ A56A A2                   		AND     D
 159+ A56B 67                   		LD      H,A
 160+ A56C 7D                   		LD      A,L
 161+ A56D A3                   		AND     E
 162+ A56E 6F                   		LD      L,A
 163+ A56F D9                   		EXX
 164+ A570 7C                   		LD      A,H
 165+ A571 A2                   		AND     D
 166+ A572 67                   		LD      H,A
 167+ A573 7D                   		LD      A,L
 168+ A574 A3                   		AND     E
 169+ A575 6F                   		LD      L,A
 170+ A576 D9                   		EXX
 171+ A577 C9                   		RET
 172+ A578              ;
 173+ A578              ;FEOR - Floating-point exclusive-OR.
 174+ A578              ;IEOR - Integer exclusive-OR.
 175+ A578              ;
 176+ A578 CD A4 AD     FEOR:			CALL    FIX2
 177+ A57B 7C           IEOR:			LD      A,H
 178+ A57C AA                   		XOR     D
 179+ A57D 67                   		LD      H,A
 180+ A57E 7D                   		LD      A,L
 181+ A57F AB                   		XOR     E
 182+ A580 6F                   		LD      L,A
 183+ A581 D9                   		EXX
 184+ A582 7C                   		LD      A,H
 185+ A583 AA                   		XOR     D
 186+ A584 67                   		LD      H,A
 187+ A585 7D                   		LD      A,L
 188+ A586 AB                   		XOR     E
 189+ A587 6F                   		LD      L,A
 190+ A588 D9                   		EXX
 191+ A589 C9                   		RET
 192+ A58A              ;
 193+ A58A              ;FOR - Floating-point OR.
 194+ A58A              ;IOR - Integer OR.
 195+ A58A              ;
 196+ A58A CD A4 AD     FOR:			CALL    FIX2
 197+ A58D 7C           IOR:			LD      A,H
 198+ A58E B2                   		OR      D
 199+ A58F 67                   		LD      H,A
 200+ A590 7D                   		LD      A,L
 201+ A591 B3                   		OR      E
 202+ A592 6F                   		LD      L,A
 203+ A593 D9                   		EXX
 204+ A594 7C                   		LD      A,H
 205+ A595 B2                   		OR      D
 206+ A596 67                   		LD      H,A
 207+ A597 7D                   		LD      A,L
 208+ A598 B3                   		OR      E
 209+ A599 6F                   		LD      L,A
 210+ A59A D9                   		EXX
 211+ A59B C9                   		RET
 212+ A59C              ;
 213+ A59C              ;FMOD - Floating-point remainder.
 214+ A59C              ;IMOD - Integer remainder.
 215+ A59C              ;
 216+ A59C CD A4 AD     FMOD:			CALL    FIX2
 217+ A59F 7C           IMOD:			LD      A,H
 218+ A5A0 AA                   		XOR     D               ;DIV RESULT SIGN
 219+ A5A1 CB 7C                		BIT     7,H
 220+ A5A3 08                   		EX      AF,AF'
 221+ A5A4 CB 7C                		BIT     7,H
 222+ A5A6 C4 BC AD             		CALL    NZ,NEGATE       ;MAKE ARGUMENTS +VE
 223+ A5A9 CD 93 AE             		CALL    SWAP
 224+ A5AC CB 7C                		BIT     7,H
 225+ A5AE C4 BC AD             		CALL    NZ,NEGATE
 226+ A5B1 44                   		LD      B,H
 227+ A5B2 4D                   		LD      C,L
 228+ A5B3 21 00 00             		LD      HL,0
 229+ A5B6 D9                   		EXX
 230+ A5B7 44                   		LD      B,H
 231+ A5B8 4D                   		LD      C,L
 232+ A5B9 21 00 00             		LD      HL,0
 233+ A5BC 3E DF                		LD      A,-33
 234+ A5BE CD E8 AF             		CALL    DIVA            ;DIVIDE
 235+ A5C1 D9                   		EXX
 236+ A5C2 0E 00                		LD      C,0             ;INTEGER MARKER
 237+ A5C4 08                   		EX      AF,AF'
 238+ A5C5 C8                   		RET     Z
 239+ A5C6 C3 BC AD             		JP      NEGATE
 240+ A5C9              ;
 241+ A5C9              ;BDIV - Integer division.
 242+ A5C9              ;
 243+ A5C9 CD A4 AD     FBDIV:			CALL    FIX2
 244+ A5CC CD 9F A5     IBDIV:			CALL    IMOD
 245+ A5CF B7                   		OR      A
 246+ A5D0 CD 93 AE             		CALL    SWAP
 247+ A5D3 0E 00                		LD      C,0
 248+ A5D5 F0                   		RET     P
 249+ A5D6 C3 BC AD             		JP      NEGATE
 250+ A5D9              ;
 251+ A5D9              ;ISUB - Integer subtraction.
 252+ A5D9              ;FSUB - Floating point subtraction with rounding.
 253+ A5D9              ;
 254+ A5D9 CD 1B AF     ISUB:			CALL    SUB
 255+ A5DC E0                   		RET     PO
 256+ A5DD CD 15 AF             		CALL    ADD
 257+ A5E0 CD 60 AE             		CALL    FLOAT2
 258+ A5E3 7A           FSUB:			LD      A,D
 259+ A5E4 EE 80                		XOR     80H             ;CHANGE SIGN THEN ADD
 260+ A5E6 57                   		LD      D,A
 261+ A5E7 18 10                		JR      FADD
 262+ A5E9              ;
 263+ A5E9              ;Reverse subtract.
 264+ A5E9              ;
 265+ A5E9 7C           RSUB:			LD      A,H
 266+ A5EA EE 80                		XOR     80H
 267+ A5EC 67                   		LD      H,A
 268+ A5ED 18 0A                		JR      FADD
 269+ A5EF              ;
 270+ A5EF              ;IADD - Integer addition.
 271+ A5EF              ;FADD - Floating point addition with rounding.
 272+ A5EF              ;
 273+ A5EF CD 15 AF     IADD:			CALL    ADD
 274+ A5F2 E0                   		RET     PO
 275+ A5F3 CD 1B AF             		CALL    SUB
 276+ A5F6 CD 60 AE             		CALL    FLOAT2
 277+ A5F9 05           FADD:			DEC     B
 278+ A5FA 04                   		INC     B
 279+ A5FB C8                   		RET     Z               ;ARG 2 ZERO
 280+ A5FC 0D                   		DEC     C
 281+ A5FD 0C                   		INC     C
 282+ A5FE CA 93 AE             		JP      Z,SWAP          ;ARG 1 ZERO
 283+ A601 D9                   		EXX
 284+ A602 01 00 00             		LD      BC,0            ;INITIALISE
 285+ A605 D9                   		EXX
 286+ A606 7C                   		LD      A,H
 287+ A607 AA                   		XOR     D               ;XOR SIGNS
 288+ A608 F5                   		PUSH    AF
 289+ A609 78                   		LD      A,B
 290+ A60A B9                   		CP      C               ;COMPARE EXPONENTS
 291+ A60B DC 93 AE             		CALL    C,SWAP          ;MAKE DED'E'B LARGEST
 292+ A60E 78                   		LD      A,B
 293+ A60F CB FC                		SET     7,H             ;IMPLIED 1
 294+ A611 C4 94 AD             		CALL    NZ,FIX          ;ALIGN
 295+ A614 F1                   		POP     AF
 296+ A615 7A                   		LD      A,D             ;SIGN OF LARGER
 297+ A616 CB FA                		SET     7,D             ;IMPLIED 1
 298+ A618 FA 25 A6             		JP      M,FADD3         ;SIGNS DIFFERENT
 299+ A61B CD 15 AF             		CALL    ADD             ;HLH'L'=HLH'L'+DED'E'
 300+ A61E DC 9B AE             		CALL    C,DIV2          ;NORMALISE
 301+ A621 CB FC                		SET     7,H
 302+ A623 18 0A                		JR      FADD4
 303+ A625              ;
 304+ A625 CD 1B AF     FADD3:			CALL    SUB             ;HLH'L'=HLH'L'-DED'E'
 305+ A628 DC D0 AD             		CALL    C,NEG           ;NEGATE HLH'L'B'C'
 306+ A62B CD 3D AE             		CALL    FLO48
 307+ A62E 2F                   		CPL                     ;CHANGE RESULT SIGN
 308+ A62F D9           FADD4:			EXX
 309+ A630 EB                   		EX      DE,HL
 310+ A631 21 00 80             		LD      HL,8000H
 311+ A634 B7                   		OR      A               ;CLEAR CARRY
 312+ A635 ED 42                		SBC     HL,BC
 313+ A637 EB                   		EX      DE,HL
 314+ A638 D9                   		EXX
 315+ A639 CC 8D AE             		CALL    Z,ODD           ;ROUND UNBIASSED
 316+ A63C DC 7F AE             		CALL    C,ADD1          ;ROUND UP
 317+ A63F DC A7 AE             		CALL    C,INCC
 318+ A642 CB BC                		RES     7,H
 319+ A644 0D                   		DEC     C
 320+ A645 0C                   		INC     C
 321+ A646 CA D8 AE             		JP      Z,ZERO
 322+ A649 B7                   		OR      A               ;RESULT SIGNQ
 323+ A64A F0                   		RET     P               ;POSITIVE
 324+ A64B CB FC                		SET     7,H             ;NEGATIVE
 325+ A64D C9                   		RET
 326+ A64E              ;
 327+ A64E              ;IDIV - Integer division.
 328+ A64E              ;FDIV - Floating point division with rounding.
 329+ A64E              ;
 330+ A64E CD 60 AE     IDIV:			CALL    FLOAT2
 331+ A651 05           FDIV:			DEC     B               ;TEST FOR ZERO
 332+ A652 04                   		INC     B
 333+ A653 3E 12                		LD      A,DIVBY0
 334+ A655 CA CE A4             		JP      Z,ERROR         ;"Division by zero"
 335+ A658 0D                   		DEC     C               ;TEST FOR ZERO
 336+ A659 0C                   		INC     C
 337+ A65A C8                   		RET     Z
 338+ A65B 7C                   		LD      A,H
 339+ A65C AA                   		XOR     D               ;CALC. RESULT SIGN
 340+ A65D 08                   		EX      AF,AF'          ;SAVE SIGN
 341+ A65E CB FA                		SET     7,D             ;REPLACE IMPLIED 1's
 342+ A660 CB FC                		SET     7,H
 343+ A662 C5                   		PUSH    BC              ;SAVE EXPONENTS
 344+ A663 42                   		LD      B,D             ;LOAD REGISTERS
 345+ A664 4B                   		LD      C,E
 346+ A665 11 00 00             		LD      DE,0
 347+ A668 D9                   		EXX
 348+ A669 42                   		LD      B,D
 349+ A66A 4B                   		LD      C,E
 350+ A66B 11 00 00             		LD      DE,0
 351+ A66E 3E E0                		LD      A,-32           ;LOOP COUNTER
 352+ A670 CD E8 AF             		CALL    DIVA            ;DIVIDE
 353+ A673 D9                   		EXX
 354+ A674 CB 7A                		BIT     7,D
 355+ A676 D9                   		EXX
 356+ A677 CC 03 B0             		CALL    Z,DIVB          ;NORMALISE & INC A
 357+ A67A EB                   		EX      DE,HL
 358+ A67B D9                   		EXX
 359+ A67C CB 38                		SRL     B               ;DIVISOR/2
 360+ A67E CB 19                		RR      C
 361+ A680 B7                   		OR      A               ;CLEAR CARRY
 362+ A681 ED 42                		SBC     HL,BC           ;REMAINDER-DIVISOR/2
 363+ A683 3F                   		CCF
 364+ A684 EB                   		EX      DE,HL           ;RESULT IN HLH'L'
 365+ A685 CC 8D AE             		CALL    Z,ODD           ;ROUND UNBIASSED
 366+ A688 DC 7F AE             		CALL    C,ADD1          ;ROUND UP
 367+ A68B C1                   		POP     BC              ;RESTORE EXPONENTS
 368+ A68C DC A7 AE             		CALL    C,INCC
 369+ A68F 1F                   		RRA                     ;LSB OF A TO CARRY
 370+ A690 79                   		LD      A,C             ;COMPUTE NEW EXPONENT
 371+ A691 98                   		SBC     A,B
 372+ A692 3F                   		CCF
 373+ A693 C3 1D A7             		JP      CHKOVF
 374+ A696              ;
 375+ A696              ;IMUL - Integer multiplication.
 376+ A696              ;
 377+ A696 7C           IMUL:			LD      A,H
 378+ A697 AA                   		XOR     D
 379+ A698 08                   		EX      AF,AF'          ;SAVE RESULT SIGN
 380+ A699 CB 7C                		BIT     7,H
 381+ A69B C4 BC AD             		CALL    NZ,NEGATE
 382+ A69E CD 93 AE             		CALL    SWAP
 383+ A6A1 CB 7C                		BIT     7,H
 384+ A6A3 C4 BC AD             		CALL    NZ,NEGATE
 385+ A6A6 44                   		LD      B,H
 386+ A6A7 4D                   		LD      C,L
 387+ A6A8 21 00 00             		LD      HL,0
 388+ A6AB D9                   		EXX
 389+ A6AC 44                   		LD      B,H
 390+ A6AD 4D                   		LD      C,L
 391+ A6AE 21 00 00             		LD      HL,0
 392+ A6B1 3E DF                		LD      A,-33
 393+ A6B3 CD 16 B0             		CALL    MULA            ;MULTIPLY
 394+ A6B6 D9                   		EXX
 395+ A6B7 0E BF                		LD      C,191           ;PRESET EXPONENT
 396+ A6B9 CD B8 AE             		CALL    TEST            ;TEST RANGE
 397+ A6BC 20 0D                		JR      NZ,IMUL1        ;TOO BIG
 398+ A6BE CB 7A                		BIT     7,D
 399+ A6C0 20 09                		JR      NZ,IMUL1
 400+ A6C2 CD 93 AE             		CALL    SWAP
 401+ A6C5 4A                   		LD      C,D             ;INTEGER MARKER
 402+ A6C6 08                   		EX      AF,AF'
 403+ A6C7 F0                   		RET     P
 404+ A6C8 C3 BC AD             		JP      NEGATE
 405+ A6CB              ;
 406+ A6CB 0D           IMUL1:			DEC     C
 407+ A6CC D9                   		EXX
 408+ A6CD CB 23                		SLA     E
 409+ A6CF CB 12                		RL      D
 410+ A6D1 D9                   		EXX
 411+ A6D2 CB 13                		RL      E
 412+ A6D4 CB 12                		RL      D
 413+ A6D6 D9                   		EXX
 414+ A6D7 ED 6A                		ADC     HL,HL
 415+ A6D9 D9                   		EXX
 416+ A6DA ED 6A                		ADC     HL,HL
 417+ A6DC F2 CB A6             		JP      P,IMUL1         ;NORMALISE
 418+ A6DF 08                   		EX      AF,AF'
 419+ A6E0 F8                   		RET     M
 420+ A6E1 CB BC                		RES     7,H             ;POSITIVE
 421+ A6E3 C9                   		RET
 422+ A6E4              ;
 423+ A6E4              ;FMUL - Floating point multiplication with rounding.
 424+ A6E4              ;
 425+ A6E4 05           FMUL:			DEC     B               ;TEST FOR ZERO
 426+ A6E5 04                   		INC     B
 427+ A6E6 CA D8 AE             		JP      Z,ZERO
 428+ A6E9 0D                   		DEC     C               ;TEST FOR ZERO
 429+ A6EA 0C                   		INC     C
 430+ A6EB C8                   		RET     Z
 431+ A6EC 7C                   		LD      A,H
 432+ A6ED AA                   		XOR     D               ;CALC. RESULT SIGN
 433+ A6EE 08                   		EX      AF,AF'
 434+ A6EF CB FA                		SET     7,D             ;REPLACE IMPLIED 1's
 435+ A6F1 CB FC                		SET     7,H
 436+ A6F3 C5                   		PUSH    BC              ;SAVE EXPONENTS
 437+ A6F4 44                   		LD      B,H             ;LOAD REGISTERS
 438+ A6F5 4D                   		LD      C,L
 439+ A6F6 21 00 00             		LD      HL,0
 440+ A6F9 D9                   		EXX
 441+ A6FA 44                   		LD      B,H
 442+ A6FB 4D                   		LD      C,L
 443+ A6FC 21 00 00             		LD      HL,0
 444+ A6FF 3E E0                		LD      A,-32           ;LOOP COUNTER
 445+ A701 CD 16 B0             		CALL    MULA            ;MULTIPLY
 446+ A704 DC 2A B0             		CALL    C,MULB          ;NORMALISE & INC A
 447+ A707 D9                   		EXX
 448+ A708 E5                   		PUSH    HL
 449+ A709 21 00 80             		LD      HL,8000H
 450+ A70C B7                   		OR      A               ;CLEAR CARRY
 451+ A70D ED 52                		SBC     HL,DE
 452+ A70F E1                   		POP     HL
 453+ A710 CC 8D AE             		CALL    Z,ODD           ;ROUND UNBIASSED
 454+ A713 DC 7F AE             		CALL    C,ADD1          ;ROUND UP
 455+ A716 C1                   		POP     BC              ;RESTORE EXPONENTS
 456+ A717 DC A7 AE             		CALL    C,INCC
 457+ A71A 1F                   		RRA                     ;LSB OF A TO CARRY
 458+ A71B 79                   		LD      A,C             ;COMPUTE NEW EXPONENT
 459+ A71C 88                   		ADC     A,B
 460+ A71D 38 05        CHKOVF:			JR      C,CHKO1
 461+ A71F F2 D8 AE             		JP      P,ZERO          ;UNDERFLOW
 462+ A722 18 03                		JR      CHKO2
 463+ A724 FA A9 AE     CHKO1:			JP      M,OFLOW         ;OVERFLOW
 464+ A727 C6 80        CHKO2:			ADD     A,80H
 465+ A729 4F                   		LD      C,A
 466+ A72A CA D8 AE             		JP      Z,ZERO
 467+ A72D 08                   		EX      AF,AF'          ;RESTORE SIGN BIT
 468+ A72E CB BC                		RES     7,H
 469+ A730 F0                   		RET     P
 470+ A731 CB FC                		SET     7,H
 471+ A733 C9                   		RET
 472+ A734              ;
 473+ A734              ;IPOW - Integer involution.
 474+ A734              ;
 475+ A734 CD 93 AE     IPOW:			CALL    SWAP
 476+ A737 CB 7C                		BIT     7,H
 477+ A739 F5                   		PUSH    AF              ;SAVE SIGN
 478+ A73A C4 BC AD             		CALL    NZ,NEGATE
 479+ A73D 48           IPOW0:			LD      C,B
 480+ A73E 06 20                		LD      B,32            ;LOOP COUNTER
 481+ A740 CD 32 AF     IPOW1:			CALL    X2
 482+ A743 38 08                		JR      C,IPOW2
 483+ A745 10 F9                		DJNZ    IPOW1
 484+ A747 F1                   		POP     AF
 485+ A748 D9                   		EXX
 486+ A749 2C                   		INC     L               ;RESULT=1
 487+ A74A D9                   		EXX
 488+ A74B 4C                   		LD      C,H
 489+ A74C C9                   		RET
 490+ A74D              ;
 491+ A74D F1           IPOW2:			POP     AF
 492+ A74E C5                   		PUSH    BC
 493+ A74F EB                   		EX      DE,HL
 494+ A750 E5                   		PUSH    HL
 495+ A751 D9                   		EXX
 496+ A752 EB                   		EX      DE,HL
 497+ A753 E5                   		PUSH    HL
 498+ A754 D9                   		EXX
 499+ A755 DD 21 00 00          		LD      IX,0
 500+ A759 DD 39                		ADD     IX,SP
 501+ A75B 28 42                		JR      Z,IPOW4
 502+ A75D C5                   		PUSH    BC
 503+ A75E D9                   		EXX
 504+ A75F D5                   		PUSH    DE
 505+ A760 D9                   		EXX
 506+ A761 D5                   		PUSH    DE
 507+ A762 CD 69 AE             		CALL    SFLOAT
 508+ A765 CD 34 AA             		CALL    RECIP
 509+ A768 DD 71 04             		LD      (IX+4),C
 510+ A76B D9                   		EXX
 511+ A76C DD 75 00             		LD      (IX+0),L
 512+ A76F DD 74 01             		LD      (IX+1),H
 513+ A772 D9                   		EXX
 514+ A773 DD 75 02             		LD      (IX+2),L
 515+ A776 DD 74 03             		LD      (IX+3),H
 516+ A779 18 1D                		JR      IPOW5
 517+ A77B              ;
 518+ A77B C5           IPOW3:			PUSH    BC
 519+ A77C D9                   		EXX
 520+ A77D CB 23                		SLA     E
 521+ A77F CB 12                		RL      D
 522+ A781 D5                   		PUSH    DE
 523+ A782 D9                   		EXX
 524+ A783 CB 13                		RL      E
 525+ A785 CB 12                		RL      D
 526+ A787 D5                   		PUSH    DE
 527+ A788 3E 0A                		LD      A,'*' AND 0FH
 528+ A78A F5                   		PUSH    AF
 529+ A78B CD 44 AF             		CALL    COPY
 530+ A78E CD D4 A4             		CALL    OP              ;SQUARE
 531+ A791 F1                   		POP     AF
 532+ A792 CD D8 AC             		CALL    DLOAD5
 533+ A795 DC D4 A4             		CALL    C,OP            ;MULTIPLY BY X
 534+ A798 D1           IPOW5:			POP     DE
 535+ A799 D9                   		EXX
 536+ A79A D1                   		POP     DE
 537+ A79B D9                   		EXX
 538+ A79C 79                   		LD      A,C
 539+ A79D C1                   		POP     BC
 540+ A79E 4F                   		LD      C,A
 541+ A79F 10 DA        IPOW4:			DJNZ    IPOW3
 542+ A7A1 F1                   		POP     AF
 543+ A7A2 F1                   		POP     AF
 544+ A7A3 F1                   		POP     AF
 545+ A7A4 C9                   		RET
 546+ A7A5              ;
 547+ A7A5 F1           FPOW0:			POP     AF
 548+ A7A6 F1                   		POP     AF
 549+ A7A7 F1                   		POP     AF
 550+ A7A8 18 93                		JR      IPOW0
 551+ A7AA              ;
 552+ A7AA              ;FPOW - Floating-point involution.
 553+ A7AA              ;
 554+ A7AA CB 7A        FPOW:			BIT     7,D
 555+ A7AC F5                   		PUSH    AF
 556+ A7AD CD 93 AE             		CALL    SWAP
 557+ A7B0 CD 52 AF             		CALL    PUSH5
 558+ A7B3 0D                   		DEC     C
 559+ A7B4 0C                   		INC     C
 560+ A7B5 28 EE                		JR      Z,FPOW0
 561+ A7B7 3E 9E                		LD      A,158
 562+ A7B9 B9                   		CP      C
 563+ A7BA 38 08                		JR      C,FPOW1
 564+ A7BC 3C                   		INC     A
 565+ A7BD CD 94 AD             		CALL    FIX
 566+ A7C0 08                   		EX      AF,AF'
 567+ A7C1 F2 A5 A7             		JP      P,FPOW0
 568+ A7C4 CD 93 AE     FPOW1:			CALL    SWAP
 569+ A7C7 CD 4B AA             		CALL    LN0
 570+ A7CA CD 5B AF             		CALL    POP5
 571+ A7CD F1                   		POP     AF
 572+ A7CE CD E4 A6             		CALL    FMUL
 573+ A7D1 C3 C0 A9             		JP      EXP0
 574+ A7D4              ;
 575+ A7D4              ;Integer and floating-point compare.
 576+ A7D4              ;Result is TRUE (-1) or FALSE (0).
 577+ A7D4              ;
 578+ A7D4 CD E2 AE     FLT:			CALL    FCP
 579+ A7D7 18 03                		JR      ILT1
 580+ A7D9 CD D5 AE     ILT:			CALL    ICP
 581+ A7DC D0           ILT1:			RET     NC
 582+ A7DD 18 38                		JR      TRUE
 583+ A7DF              ;
 584+ A7DF CD E2 AE     FGT:			CALL    FCP
 585+ A7E2 18 03                		JR      IGT1
 586+ A7E4 CD D5 AE     IGT:			CALL    ICP
 587+ A7E7 C8           IGT1:			RET     Z
 588+ A7E8 D8                   		RET     C
 589+ A7E9 18 2C                		JR      TRUE
 590+ A7EB              ;
 591+ A7EB CD E2 AE     FGE:			CALL    FCP
 592+ A7EE 18 03                		JR      IGE1
 593+ A7F0 CD D5 AE     IGE:			CALL    ICP
 594+ A7F3 D8           IGE1:			RET     C
 595+ A7F4 18 21                		JR      TRUE
 596+ A7F6              ;
 597+ A7F6 CD E2 AE     FLE:			CALL    FCP
 598+ A7F9 18 03                		JR      ILE1
 599+ A7FB CD D5 AE     ILE:			CALL    ICP
 600+ A7FE 28 17        ILE1:			JR      Z,TRUE
 601+ A800 D0                   		RET     NC
 602+ A801 18 14                		JR      TRUE
 603+ A803              ;
 604+ A803 CD E2 AE     FNE:			CALL    FCP
 605+ A806 18 03                		JR      INE1
 606+ A808 CD D5 AE     INE:			CALL    ICP
 607+ A80B C8           INE1:			RET     Z
 608+ A80C 18 09                		JR      TRUE
 609+ A80E              ;
 610+ A80E CD E2 AE     FEQ:			CALL    FCP
 611+ A811 18 03                		JR      IEQ1
 612+ A813 CD D5 AE     IEQ:			CALL    ICP
 613+ A816 C0           IEQ1:			RET     NZ
 614+ A817 21 FF FF     TRUE:			LD      HL,-1
 615+ A81A D9                   		EXX
 616+ A81B 21 FF FF             		LD      HL,-1
 617+ A81E D9                   		EXX
 618+ A81F AF                   		XOR     A
 619+ A820 4F                   		LD      C,A
 620+ A821 C9                   		RET
 621+ A822              ;
 622+ A822              ;FUNCTIONS:
 623+ A822              ;
 624+ A822              ;Result returned in HLH'L'C (floating point)
 625+ A822              ;Result returned in HLH'L' (C=0) (integer)
 626+ A822              ;All registers except IY destroyed.
 627+ A822              ;
 628+ A822              ;ABS - Absolute value
 629+ A822              ;Result is numeric, variable type.
 630+ A822              ;
 631+ A822 CB 7C        ABS:			BIT     7,H
 632+ A824 C8                   		RET     Z               ;POSITIVE/ZERO
 633+ A825 0D                   		DEC     C
 634+ A826 0C                   		INC     C
 635+ A827 CA BC AD             		JP      Z,NEGATE        ;INTEGER
 636+ A82A CB BC                		RES     7,H
 637+ A82C C9                   		RET
 638+ A82D              ;
 639+ A82D              ;NOT - Complement integer.
 640+ A82D              ;Result is integer numeric.
 641+ A82D              ;
 642+ A82D CD AD AD     NOTK:			CALL    SFIX
 643+ A830 7C                   		LD      A,H
 644+ A831 2F                   		CPL
 645+ A832 67                   		LD      H,A
 646+ A833 7D                   		LD      A,L
 647+ A834 2F                   		CPL
 648+ A835 6F                   		LD      L,A
 649+ A836 D9                   		EXX
 650+ A837 7C                   		LD      A,H
 651+ A838 2F                   		CPL
 652+ A839 67                   		LD      H,A
 653+ A83A 7D                   		LD      A,L
 654+ A83B 2F                   		CPL
 655+ A83C 6F                   		LD      L,A
 656+ A83D D9                   		EXX
 657+ A83E AF                   		XOR     A               ;NUMERIC MARKER
 658+ A83F C9                   		RET
 659+ A840              ;
 660+ A840              ;PI - Return PI (3.141592654)
 661+ A840              ;Result is floating-point numeric.
 662+ A840              ;
 663+ A840 21 0F 49     PI:			LD      HL,490FH
 664+ A843 D9                   		EXX
 665+ A844 21 A2 DA             		LD      HL,0DAA2H
 666+ A847 D9                   		EXX
 667+ A848 0E 81                		LD      C,81H
 668+ A84A AF                   		XOR     A               ;NUMERIC MARKER
 669+ A84B C9                   		RET
 670+ A84C              ;
 671+ A84C              ;DEG - Convert radians to degrees
 672+ A84C              ;Result is floating-point numeric.
 673+ A84C              ;
 674+ A84C CD 5C A8     DEG:			CALL    FPI180
 675+ A84F CD E4 A6             		CALL    FMUL
 676+ A852 AF                   		XOR     A
 677+ A853 C9                   		RET
 678+ A854              ;
 679+ A854              ;RAD - Convert degrees to radians
 680+ A854              ;Result is floating-point numeric.
 681+ A854              ;
 682+ A854 CD 5C A8     RAD:			CALL    FPI180
 683+ A857 CD 51 A6             		CALL    FDIV
 684+ A85A AF                   		XOR     A
 685+ A85B C9                   		RET
 686+ A85C              ;
 687+ A85C              ;180/PI
 688+ A85C              ;
 689+ A85C CD 69 AE     FPI180:			CALL    SFLOAT
 690+ A85F 11 2E 65             		LD      DE,652EH
 691+ A862 D9                   		EXX
 692+ A863 11 D3 E0             		LD      DE,0E0D3H
 693+ A866 D9                   		EXX
 694+ A867 06 85                		LD      B,85H
 695+ A869 C9                   		RET
 696+ A86A              ;
 697+ A86A              ;SGN - Return -1, 0 or +1
 698+ A86A              ;Result is integer numeric.
 699+ A86A              ;
 700+ A86A CD B8 AE     SGN:			CALL    TEST
 701+ A86D B1                   		OR      C
 702+ A86E C8                   		RET     Z               ;ZERO
 703+ A86F CB 7C                		BIT     7,H
 704+ A871 C2 17 A8             		JP      NZ,TRUE         ;-1
 705+ A874 CD D8 AE             		CALL    ZERO
 706+ A877 C3 7F AE             		JP      ADD1            ;1
 707+ A87A              ;
 708+ A87A              ;VAL - Return numeric value of string.
 709+ A87A              ;Input: ASCII string at IX
 710+ A87A              ;Result is variable type numeric.
 711+ A87A              ;
 712+ A87A CD A3 B0     VAL:			CALL    SIGNQ
 713+ A87D F5                   		PUSH    AF
 714+ A87E CD EA AC             		CALL    CON
 715+ A881 F1                   		POP     AF
 716+ A882 FE 2D                		CP      '-'
 717+ A884 3E 00                		LD      A,0             ;NUMERIC MARKER
 718+ A886 C0                   		RET     NZ
 719+ A887 0D                   		DEC     C
 720+ A888 0C                   		INC     C
 721+ A889 CA BC AD             		JP      Z,NEGATE        ;ZERO/INTEGER
 722+ A88C 7C                   		LD      A,H
 723+ A88D EE 80                		XOR     80H             ;CHANGE SIGN (FP)
 724+ A88F 67                   		LD      H,A
 725+ A890 AF                   		XOR     A
 726+ A891 C9                   		RET
 727+ A892              ;
 728+ A892              ;INT - Floor function
 729+ A892              ;Result is integer numeric.
 730+ A892              ;
 731+ A892 0D           INT:			DEC     C
 732+ A893 0C                   		INC     C
 733+ A894 C8                   		RET     Z               ;ZERO/INTEGER
 734+ A895 3E 9F                		LD      A,159
 735+ A897 44                   		LD      B,H             ;B7=SIGN BIT
 736+ A898 CD 94 AD             		CALL    FIX
 737+ A89B 08                   		EX      AF,AF'
 738+ A89C A0                   		AND     B
 739+ A89D FC 7F AE             		CALL    M,ADD1          ;NEGATIVE NON-INTEGER
 740+ A8A0 78                   		LD      A,B
 741+ A8A1 B7                   		OR      A
 742+ A8A2 FC BC AD             		CALL    M,NEGATE
 743+ A8A5 AF                   		XOR     A
 744+ A8A6 4F                   		LD      C,A
 745+ A8A7 C9                   		RET
 746+ A8A8              ;
 747+ A8A8              ;SQR - square root
 748+ A8A8              ;Result is floating-point numeric.
 749+ A8A8              ;
 750+ A8A8 CD 69 AE     SQR:			CALL    SFLOAT
 751+ A8AB CB 7C        SQR0:			BIT     7,H
 752+ A8AD 3E 15                		LD      A,NGROOT
 753+ A8AF C2 CE A4             		JP      NZ,ERROR        ;"-ve root"
 754+ A8B2 0D                   		DEC     C
 755+ A8B3 0C                   		INC     C
 756+ A8B4 C8                   		RET     Z               ;ZERO
 757+ A8B5 CB FC                		SET     7,H             ;IMPLIED 1
 758+ A8B7 CB 41                		BIT     0,C
 759+ A8B9 CC 9B AE             		CALL    Z,DIV2          ;MAKE EXPONENT ODD
 760+ A8BC 79                   		LD      A,C
 761+ A8BD D6 80                		SUB     80H
 762+ A8BF CB 2F                		SRA     A               ;HALVE EXPONENT
 763+ A8C1 C6 80                		ADD     A,80H
 764+ A8C3 4F                   		LD      C,A
 765+ A8C4 C5                   		PUSH    BC              ;SAVE EXPONENT
 766+ A8C5 EB                   		EX      DE,HL
 767+ A8C6 21 00 00             		LD      HL,0
 768+ A8C9 44                   		LD      B,H
 769+ A8CA 4D                   		LD      C,L
 770+ A8CB D9                   		EXX
 771+ A8CC EB                   		EX      DE,HL
 772+ A8CD 21 00 00             		LD      HL,0
 773+ A8D0 44                   		LD      B,H
 774+ A8D1 4D                   		LD      C,L
 775+ A8D2 3E E1                		LD      A,-31
 776+ A8D4 CD 49 B0             		CALL    SQRA            ;ROOT
 777+ A8D7 D9                   		EXX
 778+ A8D8 CB 78                		BIT     7,B
 779+ A8DA D9                   		EXX
 780+ A8DB CC 49 B0             		CALL    Z,SQRA          ;NORMALISE & INC A
 781+ A8DE CD 82 B0             		CALL    SQRB
 782+ A8E1 B7                   		OR      A               ;CLEAR CARRY
 783+ A8E2 CD 03 B0             		CALL    DIVB
 784+ A8E5 CB 1B                		RR      E               ;LSB TO CARRY
 785+ A8E7 60                   		LD      H,B
 786+ A8E8 69                   		LD      L,C
 787+ A8E9 D9                   		EXX
 788+ A8EA 60                   		LD      H,B
 789+ A8EB 69                   		LD      L,C
 790+ A8EC DC 7F AE             		CALL    C,ADD1          ;ROUND UP
 791+ A8EF C1                   		POP     BC              ;RESTORE EXPONENT
 792+ A8F0 DC A7 AE             		CALL    C,INCC
 793+ A8F3 1F                   		RRA
 794+ A8F4 9F                   		SBC     A,A
 795+ A8F5 81                   		ADD     A,C
 796+ A8F6 4F                   		LD      C,A
 797+ A8F7 CB BC                		RES     7,H             ;POSITIVE
 798+ A8F9 AF                   		XOR     A
 799+ A8FA C9                   		RET
 800+ A8FB              ;
 801+ A8FB              ;TAN - Tangent function
 802+ A8FB              ;Result is floating-point numeric.
 803+ A8FB              ;
 804+ A8FB CD 69 AE     TAN:			CALL    SFLOAT
 805+ A8FE CD 52 AF             		CALL    PUSH5
 806+ A901 CD 1B A9             		CALL    COS0
 807+ A904 CD 5B AF             		CALL    POP5
 808+ A907 CD 52 AF             		CALL    PUSH5
 809+ A90A CD 93 AE             		CALL    SWAP
 810+ A90D CD 26 A9             		CALL    SIN0
 811+ A910 CD 5B AF             		CALL    POP5
 812+ A913 CD 51 A6             		CALL    FDIV
 813+ A916 AF                   		XOR     A               ;NUMERIC MARKER
 814+ A917 C9                   		RET
 815+ A918              ;
 816+ A918              ;COS - Cosine function
 817+ A918              ;Result is floating-point numeric.
 818+ A918              ;
 819+ A918 CD 69 AE     COS:			CALL    SFLOAT
 820+ A91B CD DE AD     COS0:			CALL    SCALE
 821+ A91E 1C                   		INC     E
 822+ A91F 1C                   		INC     E
 823+ A920 7B                   		LD      A,E
 824+ A921 18 0E                		JR      SIN1
 825+ A923              ;
 826+ A923              ;SIN - Sine function
 827+ A923              ;Result is floating-point numeric.
 828+ A923              ;
 829+ A923 CD 69 AE     SIN:			CALL    SFLOAT
 830+ A926 E5           SIN0:			PUSH    HL              ;H7=SIGN
 831+ A927 CD DE AD             		CALL    SCALE
 832+ A92A F1                   		POP     AF
 833+ A92B 07                   		RLCA
 834+ A92C 07                   		RLCA
 835+ A92D 07                   		RLCA
 836+ A92E E6 04                		AND     4
 837+ A930 AB                   		XOR     E
 838+ A931 F5           SIN1:			PUSH    AF              ;OCTANT
 839+ A932 CB BC                		RES     7,H
 840+ A934 1F                   		RRA
 841+ A935 CD B2 A9             		CALL    PIBY4
 842+ A938 DC E9 A5             		CALL    C,RSUB          ;X=(PI/4)-X
 843+ A93B F1                   		POP     AF
 844+ A93C F5                   		PUSH    AF
 845+ A93D E6 03                		AND     3
 846+ A93F E2 70 A9             		JP      PO,SIN2         ;USE COSINE APPROX.
 847+ A942 CD 52 AF             		CALL    PUSH5           ;SAVE X
 848+ A945 CD 4C AF             		CALL    SQUARE          ;PUSH X*X
 849+ A948 CD 85 AF             		CALL    POLY
 850+ A94B B7 A8                		DEFW    0A8B7H          ;a(8)
 851+ A94D 11 36                		DEFW    3611H
 852+ A94F 6D                   		DEFB    6DH
 853+ A950 26 DE                		DEFW    0DE26H          ;a(6)
 854+ A952 05 D0                		DEFW    0D005H
 855+ A954 73                   		DEFB    73H
 856+ A955 C0 80                		DEFW    80C0H           ;a(4)
 857+ A957 88 08                		DEFW    888H
 858+ A959 79                   		DEFB    79H
 859+ A95A 9D AA                		DEFW    0AA9DH          ;a(2)
 860+ A95C AA AA                		DEFW    0AAAAH
 861+ A95E 7D                   		DEFB    7DH
 862+ A95F 00 00                		DEFW    0               ;a(0)
 863+ A961 00 00                		DEFW    0
 864+ A963 80                   		DEFB    80H
 865+ A964 CD 5B AF             		CALL    POP5
 866+ A967 CD 5B AF             		CALL    POP5
 867+ A96A CD E4 A6             		CALL    FMUL
 868+ A96D C3 92 A9             		JP      SIN3
 869+ A970              ;
 870+ A970 CD 4C AF     SIN2:			CALL    SQUARE          ;PUSH X*X
 871+ A973 CD 85 AF             		CALL    POLY
 872+ A976 71 D5                		DEFW    0D571H          ;b(8)
 873+ A978 78 4C                		DEFW    4C78H
 874+ A97A 70                   		DEFB    70H
 875+ A97B AF 94                		DEFW    94AFH           ;b(6)
 876+ A97D 03 B6                		DEFW    0B603H
 877+ A97F 76                   		DEFB    76H
 878+ A980 C8 9C                		DEFW    9CC8H           ;b(4)
 879+ A982 AA 2A                		DEFW    2AAAH
 880+ A984 7B                   		DEFB    7BH
 881+ A985 DD FF                		DEFW    0FFDDH          ;b(2)
 882+ A987 FF FF                		DEFW    0FFFFH
 883+ A989 7E                   		DEFB    7EH
 884+ A98A 00 00                		DEFW    0               ;b(0)
 885+ A98C 00 00                		DEFW    0
 886+ A98E 80                   		DEFB    80H
 887+ A98F CD 5B AF             		CALL    POP5
 888+ A992 F1           SIN3:			POP     AF
 889+ A993 E6 04                		AND     4
 890+ A995 C8                   		RET     Z
 891+ A996 0D                   		DEC     C
 892+ A997 0C                   		INC     C
 893+ A998 C8                   		RET     Z               ;ZERO
 894+ A999 CB FC                		SET     7,H             ;MAKE NEGATIVE
 895+ A99B C9                   		RET
 896+ A99C              ;
 897+ A99C              ;Floating-point one:
 898+ A99C              ;
 899+ A99C 21 00 00     FONE:			LD      HL,0
 900+ A99F D9                   		EXX
 901+ A9A0 21 00 00             		LD      HL,0
 902+ A9A3 D9                   		EXX
 903+ A9A4 0E 80                		LD      C,80H
 904+ A9A6 C9                   		RET
 905+ A9A7              ;
 906+ A9A7 11 00 00     DONE:			LD      DE,0
 907+ A9AA D9                   		EXX
 908+ A9AB 11 00 00             		LD      DE,0
 909+ A9AE D9                   		EXX
 910+ A9AF 06 80                		LD      B,80H
 911+ A9B1 C9                   		RET
 912+ A9B2              ;
 913+ A9B2 11 0F 49     PIBY4:			LD      DE,490FH
 914+ A9B5 D9                   		EXX
 915+ A9B6 11 A2 DA             		LD      DE,0DAA2H
 916+ A9B9 D9                   		EXX
 917+ A9BA 06 7F                		LD      B,7FH
 918+ A9BC C9                   		RET
 919+ A9BD              ;
 920+ A9BD              ;EXP - Exponential function
 921+ A9BD              ;Result is floating-point numeric.
 922+ A9BD              ;
 923+ A9BD CD 69 AE     EXP:			CALL    SFLOAT
 924+ A9C0 CD 3D AA     EXP0:			CALL    LN2             ;LN(2)
 925+ A9C3 D9                   		EXX
 926+ A9C4 1D           	        	DEC     E
 927+ A9C5 01 CF D1     		        LD      BC,0D1CFH       ;0.6931471805599453
 928+ A9C8 D9                   		EXX
 929+ A9C9 E5                   		PUSH    HL              ;H7=SIGN
 930+ A9CA CD EE AD             		CALL    MOD48           ;"MODULUS"
 931+ A9CD F1                   		POP     AF
 932+ A9CE CB 7B                		BIT     7,E
 933+ A9D0 28 09                		JR      Z,EXP1
 934+ A9D2 17                   		RLA
 935+ A9D3 DA D8 AE             		JP      C,ZERO
 936+ A9D6 3E 18                		LD      A,EXPRNG
 937+ A9D8 C3 CE A4             		JP      ERROR           ;"Exp range"
 938+ A9DB              ;
 939+ A9DB E6 80        EXP1:			AND     80H
 940+ A9DD B3                   		OR      E
 941+ A9DE F5                   		PUSH    AF              ;INTEGER PART
 942+ A9DF CB BC                		RES     7,H
 943+ A9E1 CD 52 AF             		CALL    PUSH5           ;PUSH X*LN(2)
 944+ A9E4 CD 85 AF             		CALL    POLY
 945+ A9E7 72 40                		DEFW    4072H           ;a(7)
 946+ A9E9 2E 94                		DEFW    942EH
 947+ A9EB 73                   		DEFB    73H
 948+ A9EC 65 6F                		DEFW    6F65H           ;a(6)
 949+ A9EE 4F 2E                		DEFW    2E4FH
 950+ A9F0 76                   		DEFB    76H
 951+ A9F1 37 6D                		DEFW    6D37H           ;a(5)
 952+ A9F3 02 88                		DEFW    8802H
 953+ A9F5 79                   		DEFB    79H
 954+ A9F6 12 E5                		DEFW    0E512H          ;a(4)
 955+ A9F8 A0 2A                		DEFW    2AA0H
 956+ A9FA 7B                   		DEFB    7BH
 957+ A9FB 14 4F                		DEFW    4F14H           ;a(3)
 958+ A9FD AA AA                		DEFW    0AAAAH
 959+ A9FF 7D                   		DEFB    7DH
 960+ AA00 56 FD                		DEFW    0FD56H          ;a(2)
 961+ AA02 FF 7F                		DEFW    7FFFH
 962+ AA04 7E                   		DEFB    7EH
 963+ AA05 FE FF                		DEFW    0FFFEH          ;a(1)
 964+ AA07 FF FF                		DEFW    0FFFFH
 965+ AA09 7F                   		DEFB    7FH
 966+ AA0A 00 00                		DEFW    0               ;a(0)
 967+ AA0C 00 00                		DEFW    0
 968+ AA0E 80                   		DEFB    80H
 969+ AA0F CD 5B AF             		CALL    POP5
 970+ AA12 F1                   		POP     AF
 971+ AA13 F5                   		PUSH    AF
 972+ AA14 F4 34 AA             		CALL    P,RECIP         ;X=1/X
 973+ AA17 F1                   		POP     AF
 974+ AA18 F2 1F AA             		JP      P,EXP4
 975+ AA1B E6 7F                		AND     7FH
 976+ AA1D ED 44                		NEG
 977+ AA1F C6 80        EXP4:			ADD     A,80H
 978+ AA21 81                   		ADD     A,C
 979+ AA22 38 05                		JR      C,EXP2
 980+ AA24 F2 D8 AE             		JP      P,ZERO          ;UNDERFLOW
 981+ AA27 18 03                		JR      EXP3
 982+ AA29 FA A9 AE     EXP2:			JP      M,OFLOW         ;OVERFLOW
 983+ AA2C C6 80        EXP3:			ADD     A,80H
 984+ AA2E CA D8 AE             		JP      Z,ZERO
 985+ AA31 4F                   		LD      C,A
 986+ AA32 AF                   		XOR     A               ;NUMERIC MARKER
 987+ AA33 C9                   		RET
 988+ AA34              ;
 989+ AA34 CD A7 A9     RECIP:			CALL    DONE
 990+ AA37 CD 93 AE     RDIV:			CALL    SWAP
 991+ AA3A C3 51 A6             		JP      FDIV            ;RECIPROCAL
 992+ AA3D              ;
 993+ AA3D 11 72 31     LN2:			LD      DE,3172H        ;LN(2)
 994+ AA40 D9                   		EXX
 995+ AA41 11 F8 17             		LD      DE,17F8H
 996+ AA44 D9                   		EXX
 997+ AA45 06 7F                		LD      B,7FH
 998+ AA47 C9                   		RET
 999+ AA48              ;
1000+ AA48              ;LN - Natural log.
1001+ AA48              ;Result is floating-point numeric.
1002+ AA48              ;
1003+ AA48 CD 69 AE     LN:			CALL    SFLOAT
1004+ AA4B 3E 16        LN0:			LD      A,LOGRNG
1005+ AA4D CB 7C                		BIT     7,H
1006+ AA4F C2 CE A4             		JP      NZ,ERROR        ;"Log range"
1007+ AA52 0C                   		INC     C
1008+ AA53 0D                   		DEC     C
1009+ AA54 CA CE A4             		JP      Z,ERROR
1010+ AA57 11 04 35             		LD      DE,3504H        ;SQR(2)
1011+ AA5A D9                   		EXX
1012+ AA5B 11 33 F3             		LD      DE,0F333H       ;1.41421356237
1013+ AA5E D9                   		EXX
1014+ AA5F CD EA AE             		CALL    ICP0            ;MANTISSA>SQR(2)?
1015+ AA62 79                   		LD      A,C             ;EXPONENT
1016+ AA63 0E 80                		LD      C,80H           ;1 <= X < 2
1017+ AA65 38 02                		JR      C,LN4
1018+ AA67 0D                   		DEC     C
1019+ AA68 3C                   		INC     A
1020+ AA69 F5           LN4:			PUSH    AF              ;SAVE EXPONENT
1021+ AA6A CD 67 AF             		CALL    RATIO           ;X=(X-1)/(X+1)
1022+ AA6D CD 52 AF             		CALL    PUSH5
1023+ AA70 CD 4C AF     		        CALL    SQUARE          ;PUSH X*X
1024+ AA73 CD 85 AF             		CALL    POLY
1025+ AA76 48 CC                		DEFW    0CC48H          ;a(9)
1026+ AA78 FB 74                		DEFW    74FBH
1027+ AA7A 7D                   		DEFB    7DH
1028+ AA7B AF AE                		DEFW    0AEAFH          ;a(7)
1029+ AA7D FF 11                		DEFW    11FFH
1030+ AA7F 7E                   		DEFB    7EH
1031+ AA80 8C D9                		DEFW    0D98CH          ;a(5)
1032+ AA82 CD 4C                		DEFW    4CCDH
1033+ AA84 7E                   		DEFB    7EH
1034+ AA85 E3 A9                		DEFW    0A9E3H          ;a(3)
1035+ AA87 AA 2A                		DEFW    2AAAH
1036+ AA89 7F                   		DEFB    7FH
1037+ AA8A 00 00                		DEFW    0               ;a(1)
1038+ AA8C 00 00                		DEFW    0
1039+ AA8E 81                   		DEFB    81H
1040+ AA8F CD 5B AF             		CALL    POP5
1041+ AA92 CD 5B AF             		CALL    POP5
1042+ AA95 CD E4 A6             		CALL    FMUL
1043+ AA98 F1                   		POP     AF              ;EXPONENT
1044+ AA99 CD 52 AF             		CALL    PUSH5
1045+ AA9C 08                   		EX      AF,AF'
1046+ AA9D CD D8 AE             		CALL    ZERO
1047+ AAA0 08                   		EX      AF,AF'
1048+ AAA1 D6 80                		SUB     80H
1049+ AAA3 28 1B                		JR      Z,LN3
1050+ AAA5 30 02                		JR      NC,LN1
1051+ AAA7 2F                   		CPL
1052+ AAA8 3C                   		INC     A
1053+ AAA9 67           LN1:			LD      H,A
1054+ AAAA 0E 87                		LD      C,87H
1055+ AAAC F5                   		PUSH    AF
1056+ AAAD CD 4F AE             		CALL    FLOAT
1057+ AAB0 CB BC                		RES     7,H
1058+ AAB2 CD 3D AA             		CALL    LN2
1059+ AAB5 CD E4 A6             		CALL    FMUL
1060+ AAB8 F1                   		POP     AF
1061+ AAB9 30 05                		JR      NC,LN3
1062+ AABB FA C0 AA             		JP      M,LN3
1063+ AABE CB FC                		SET     7,H
1064+ AAC0 CD 5B AF     LN3:			CALL    POP5
1065+ AAC3 CD F9 A5             		CALL    FADD
1066+ AAC6 AF                   		XOR     A
1067+ AAC7 C9                   		RET
1068+ AAC8              ;
1069+ AAC8              ;LOG - base-10 logarithm.
1070+ AAC8              ;Result is floating-point numeric.
1071+ AAC8              ;
1072+ AAC8 CD 48 AA     LOG:			CALL    LN
1073+ AACB 11 5B 5E             		LD      DE,5E5BH        ;LOG(e)
1074+ AACE D9                   		EXX
1075+ AACF 11 A9 D8             		LD      DE,0D8A9H
1076+ AAD2 D9                   		EXX
1077+ AAD3 06 7E                		LD      B,7EH
1078+ AAD5 CD E4 A6             		CALL    FMUL
1079+ AAD8 AF                   		XOR     A
1080+ AAD9 C9                   		RET
1081+ AADA              ;
1082+ AADA              ;ASN - Arc-sine
1083+ AADA              ;Result is floating-point numeric.
1084+ AADA              ;
1085+ AADA CD 69 AE     ASN:			CALL    SFLOAT
1086+ AADD CD 52 AF             		CALL    PUSH5
1087+ AAE0 CD 44 AF             		CALL    COPY
1088+ AAE3 CD E4 A6             		CALL    FMUL
1089+ AAE6 CD A7 A9             		CALL    DONE
1090+ AAE9 CD E9 A5             		CALL    RSUB
1091+ AAEC CD AB A8             		CALL    SQR0
1092+ AAEF CD 5B AF             		CALL    POP5
1093+ AAF2 0C                   		INC     C
1094+ AAF3 0D                   		DEC     C
1095+ AAF4 3E 02                		LD      A,2
1096+ AAF6 D5                   		PUSH    DE
1097+ AAF7 28 70                		JR      Z,ACS1
1098+ AAF9 D1                   		POP     DE
1099+ AAFA CD 37 AA             		CALL    RDIV
1100+ AAFD 18 03                		JR      ATN0
1101+ AAFF              ;
1102+ AAFF              ;ATN - arc-tangent
1103+ AAFF              ;Result is floating-point numeric.
1104+ AAFF              ;
1105+ AAFF CD 69 AE     ATN:			CALL    SFLOAT
1106+ AB02 E5           ATN0:			PUSH    HL              ;SAVE SIGN
1107+ AB03 CB BC                		RES     7,H
1108+ AB05 11 13 54             		LD      DE,5413H        ;TAN(PI/8)=SQR(2)-1
1109+ AB08 D9                   		EXX
1110+ AB09 11 D0 CC             		LD      DE,0CCD0H
1111+ AB0C D9                   		EXX
1112+ AB0D 06 7E                		LD      B,7EH
1113+ AB0F CD E7 AE             		CALL    FCP0            ;COMPARE
1114+ AB12 06 00                		LD      B,0
1115+ AB14 38 1C                		JR      C,ATN2
1116+ AB16 11 82 1A             		LD      DE,1A82H        ;TAN(3*PI/8)=SQR(2)+1
1117+ AB19 D9                   		EXX
1118+ AB1A 11 9A 79             		LD      DE,799AH
1119+ AB1D D9                   		EXX
1120+ AB1E 06 81                		LD      B,81H
1121+ AB20 CD E7 AE             		CALL    FCP0            ;COMPARE
1122+ AB23 38 08                		JR      C,ATN1
1123+ AB25 CD 34 AA             		CALL    RECIP           ;X=1/X
1124+ AB28 06 02                		LD      B,2
1125+ AB2A C3 32 AB             		JP      ATN2
1126+ AB2D CD 67 AF     ATN1:			CALL    RATIO           ;X=(X-1)/(X+1)
1127+ AB30 06 01                		LD      B,1
1128+ AB32 C5           ATN2:			PUSH    BC              ;SAVE FLAG
1129+ AB33 CD 52 AF             		CALL    PUSH5
1130+ AB36 CD 4C AF             		CALL    SQUARE          ;PUSH X*X
1131+ AB39 CD 85 AF             		CALL    POLY
1132+ AB3C 35 F3                		DEFW    0F335H          ;a(13)
1133+ AB3E D8 37                		DEFW    37D8H
1134+ AB40 7B                   		DEFB    7BH
1135+ AB41 91 6B                		DEFW    6B91H           ;a(11)
1136+ AB43 B9 AA                		DEFW    0AAB9H
1137+ AB45 7C                   		DEFB    7CH
1138+ AB46 DE 41                		DEFW    41DEH           ;a(9)
1139+ AB48 97 61                		DEFW    6197H
1140+ AB4A 7C                   		DEFB    7CH
1141+ AB4B 7B 9D                		DEFW    9D7BH           ;a(7)
1142+ AB4D 37 92                		DEFW    9237H
1143+ AB4F 7D                   		DEFB    7DH
1144+ AB50 5A 2A                		DEFW    2A5AH           ;a(5)
1145+ AB52 CC 4C                		DEFW    4CCCH
1146+ AB54 7D                   		DEFB    7DH
1147+ AB55 5C A9                		DEFW    0A95CH          ;a(3)
1148+ AB57 AA AA                		DEFW    0AAAAH
1149+ AB59 7E                   		DEFB    7EH
1150+ AB5A 00 00                		DEFW    0               ;a(1)
1151+ AB5C 00 00                		DEFW    0
1152+ AB5E 80                   		DEFB    80H
1153+ AB5F CD 5B AF             		CALL    POP5
1154+ AB62 CD 5B AF             		CALL    POP5
1155+ AB65 CD E4 A6             		CALL    FMUL
1156+ AB68 F1                   		POP     AF
1157+ AB69 CD B2 A9     ACS1:			CALL    PIBY4           ;PI/4
1158+ AB6C 1F                   		RRA
1159+ AB6D F5                   		PUSH    AF
1160+ AB6E DC F9 A5             		CALL    C,FADD
1161+ AB71 F1                   		POP     AF
1162+ AB72 04                   		INC     B
1163+ AB73 1F                   		RRA
1164+ AB74 DC E9 A5             		CALL    C,RSUB
1165+ AB77 F1                   		POP     AF
1166+ AB78 B7                   		OR      A
1167+ AB79 F0                   		RET     P
1168+ AB7A CB FC                		SET     7,H             ;MAKE NEGATIVE
1169+ AB7C AF                   		XOR     A
1170+ AB7D C9                   		RET
1171+ AB7E              ;
1172+ AB7E              ;ACS - Arc cosine=PI/2-ASN.
1173+ AB7E              ;Result is floating point numeric.
1174+ AB7E              ;
1175+ AB7E CD DA AA     ACS:			CALL    ASN
1176+ AB81 3E 02                		LD      A,2
1177+ AB83 F5                   		PUSH    AF
1178+ AB84 18 E3                		JR      ACS1
1179+ AB86              ;
1180+ AB86              ;Function STR - convert numeric value to ASCII string.
1181+ AB86              ;   Inputs: HLH'L'C = integer or floating-point number
1182+ AB86              ;           DE = address at which to store string
1183+ AB86              ;           IX = address of @% format control
1184+ AB86              ;  Outputs: String stored, with NUL terminator
1185+ AB86              ;
1186+ AB86              ;First normalise for decimal output:
1187+ AB86              ;
1188+ AB86 CD 69 AE     STR:			CALL    SFLOAT
1189+ AB89 06 00                		LD      B,0             ;DEFAULT PT. POSITION
1190+ AB8B CB 7C                		BIT     7,H             ;NEGATIVE?
1191+ AB8D 28 06                		JR      Z,STR10
1192+ AB8F CB BC                		RES     7,H
1193+ AB91 3E 2D                		LD      A,'-'
1194+ AB93 12                   		LD      (DE),A          ;STORE SIGN
1195+ AB94 13                   		INC     DE
1196+ AB95 AF           STR10:			XOR     A               ;CLEAR A
1197+ AB96 B9                   		CP      C
1198+ AB97 28 47                		JR      Z,STR2          ;ZERO
1199+ AB99 D5                   		PUSH    DE              ;SAVE TEXT POINTER
1200+ AB9A 78                   		LD      A,B
1201+ AB9B F5           STR11:			PUSH    AF              ;SAVE DECIMAL COUNTER
1202+ AB9C 79                   		LD      A,C             ;BINARY EXPONENT
1203+ AB9D FE A1                		CP      161
1204+ AB9F 30 1A                		JR      NC,STR14
1205+ ABA1 FE 9B                		CP      155
1206+ ABA3 30 25                		JR      NC,STR15
1207+ ABA5 2F                   		CPL
1208+ ABA6 FE E1                		CP      225
1209+ ABA8 38 02                		JR      C,STR13
1210+ ABAA 3E F8                		LD      A,-8
1211+ ABAC C6 1C        STR13:			ADD     A,28
1212+ ABAE CD AC AF             		CALL    POWR10
1213+ ABB1 F5                   		PUSH    AF
1214+ ABB2 CD E4 A6             		CALL    FMUL
1215+ ABB5 F1                   		POP     AF
1216+ ABB6 47                   		LD      B,A
1217+ ABB7 F1                   		POP     AF
1218+ ABB8 90                   		SUB     B
1219+ ABB9 18 E0                		JR      STR11
1220+ ABBB D6 20        STR14:			SUB     32
1221+ ABBD CD AC AF             		CALL    POWR10
1222+ ABC0 F5                   		PUSH    AF
1223+ ABC1 CD 51 A6             		CALL    FDIV
1224+ ABC4 F1                   		POP     AF
1225+ ABC5 47                   		LD      B,A
1226+ ABC6 F1                   		POP     AF
1227+ ABC7 80                   		ADD     A,B
1228+ ABC8 18 D1                		JR      STR11
1229+ ABCA 3E 09        STR15:			LD      A,9
1230+ ABCC CD AC AF             		CALL    POWR10          ;10^9
1231+ ABCF CD E7 AE             		CALL    FCP0
1232+ ABD2 79                   		LD      A,C
1233+ ABD3 C1                   		POP     BC
1234+ ABD4 4F                   		LD      C,A
1235+ ABD5 CB FC                		SET     7,H             ;IMPLIED 1
1236+ ABD7 DC 09 AF             		CALL    C,X10B          ;X10, DEC B
1237+ ABDA D1                   		POP     DE              ;RESTORE TEXT POINTER
1238+ ABDB CB B9                		RES     7,C
1239+ ABDD 3E 00                		LD      A,0
1240+ ABDF 17                   		RLA                     ;PUT CARRY IN LSB
1241+ ABE0              ;
1242+ ABE0              ;At this point decimal normalisation has been done,
1243+ ABE0              ;now convert to decimal digits:
1244+ ABE0              ;      AHLH'L' = number in normalised integer form
1245+ ABE0              ;            B = decimal place adjustment
1246+ ABE0              ;            C = binary place adjustment (29-33)
1247+ ABE0              ;
1248+ ABE0 0C           STR2:			INC     C
1249+ ABE1 08                   		EX      AF,AF'          ;SAVE A
1250+ ABE2 78                   		LD      A,B
1251+ ABE3 DD CB 02 4E          		BIT     1,(IX+2)
1252+ ABE7 20 08                		JR      NZ,STR20
1253+ ABE9 AF                   		XOR     A
1254+ ABEA DD BE 01             		CP      (IX+1)
1255+ ABED 28 0A                		JR      Z,STR21
1256+ ABEF 3E F6                		LD      A,-10
1257+ ABF1 DD 86 01     STR20:			ADD     A,(IX+1)        ;SIG. FIG. COUNT
1258+ ABF4 B7                   		OR      A               ;CLEAR CARRY
1259+ ABF5 FA F9 AB             		JP      M,STR21
1260+ ABF8 AF                   		XOR     A
1261+ ABF9 F5           STR21:			PUSH    AF
1262+ ABFA 08                   		EX      AF,AF'          ;RESTORE A
1263+ ABFB CD 32 AF     STR22:			CALL    X2              ;RL AHLH'L'
1264+ ABFE 8F                   		ADC     A,A
1265+ ABFF FE 0A                		CP      10
1266+ AC01 38 05                		JR      C,STR23
1267+ AC03 D6 0A                		SUB     10
1268+ AC05 D9                   		EXX
1269+ AC06 2C                   		INC     L               ;SET RESULT BIT
1270+ AC07 D9                   		EXX
1271+ AC08 0D           STR23:			DEC     C
1272+ AC09 20 F0                		JR      NZ,STR22        ;32 TIMES
1273+ AC0B 4F                   		LD      C,A             ;REMAINDER
1274+ AC0C 7C                   		LD      A,H
1275+ AC0D E6 3F                		AND     3FH             ;CLEAR OUT JUNK
1276+ AC0F 67                   		LD      H,A
1277+ AC10 F1                   		POP     AF
1278+ AC11 F2 1E AC             		JP      P,STR24
1279+ AC14 3C                   		INC     A
1280+ AC15 20 1C                		JR      NZ,STR26
1281+ AC17 3E 04                		LD      A,4
1282+ AC19 B9                   		CP      C               ;ROUND UP?
1283+ AC1A 3E 00                		LD      A,0
1284+ AC1C 18 15                		JR      STR26
1285+ AC1E F5           STR24:			PUSH    AF
1286+ AC1F 79                   		LD      A,C
1287+ AC20 CE 30                		ADC     A,'0'           ;ADD CARRY
1288+ AC22 FE 30                		CP      '0'
1289+ AC24 28 05                		JR      Z,STR25         ;SUPPRESS ZERO
1290+ AC26 FE 3A                		CP      '9'+1
1291+ AC28 3F                   		CCF
1292+ AC29 30 08                		JR      NC,STR26
1293+ AC2B E3           STR25:			EX      (SP),HL
1294+ AC2C CB 75                		BIT     6,L             ;ZERO FLAG
1295+ AC2E E3           		        EX      (SP),HL
1296+ AC2F 20 05                		JR      NZ,STR27
1297+ AC31 3E 30                		LD      A,'0'
1298+ AC33 3C           STR26:			INC     A               ;SET +VE
1299+ AC34 3D                   		DEC     A
1300+ AC35 F5                   		PUSH    AF              ;PUT ON STACK + CARRY
1301+ AC36 04           STR27:			INC     B
1302+ AC37 CD B8 AE             		CALL    TEST            ;IS HLH'L' ZERO?
1303+ AC3A 0E 20                		LD      C,32
1304+ AC3C 3E 00                		LD      A,0
1305+ AC3E 20 BB                		JR      NZ,STR22
1306+ AC40 F1                   		POP     AF
1307+ AC41 F5                   		PUSH    AF
1308+ AC42 3E 00                		LD      A,0
1309+ AC44 38 B5                		JR      C,STR22
1310+ AC46              ;
1311+ AC46              ;At this point, the decimal character string is stored
1312+ AC46              ; on the stack. Trailing zeroes are suppressed and may
1313+ AC46              ; need to be replaced.
1314+ AC46              ;B register holds decimal point position.
1315+ AC46              ;Now format number and store as ASCII string:
1316+ AC46              ;
1317+ AC46 EB           STR3:			EX      DE,HL           ;STRING POINTER
1318+ AC47 0E FF                		LD      C,-1            ;FLAG "E"
1319+ AC49 16 01                		LD      D,1
1320+ AC4B DD 5E 01             		LD      E,(IX+1)        ;f2
1321+ AC4E DD CB 02 46          		BIT     0,(IX+2)
1322+ AC52 20 32                		JR      NZ,STR34        ;E MODE
1323+ AC54 DD CB 02 4E          		BIT     1,(IX+2)
1324+ AC58 28 11                		JR      Z,STR31
1325+ AC5A 78                   		LD      A,B             ;F MODE
1326+ AC5B B7                   		OR      A
1327+ AC5C 28 04                		JR      Z,STR30
1328+ AC5E FA 62 AC             		JP      M,STR30
1329+ AC61 50                   		LD      D,B
1330+ AC62 7A           STR30:			LD      A,D
1331+ AC63 DD 86 01             		ADD     A,(IX+1)
1332+ AC66 5F                   		LD      E,A
1333+ AC67 FE 0B                		CP      11
1334+ AC69 38 17                		JR      C,STR32
1335+ AC6B 78           STR31:			LD      A,B             ;G MODE
1336+ AC6C 11 01 01             		LD      DE,101H
1337+ AC6F B7                   		OR      A
1338+ AC70 FA 86 AC             		JP      M,STR34
1339+ AC73 28 0D                		JR      Z,STR32
1340+ AC75 DD 7E 01             		LD      A,(IX+1)
1341+ AC78 B7                   		OR      A
1342+ AC79 20 02                		JR      NZ,STR3A
1343+ AC7B 3E 0A                		LD      A,10
1344+ AC7D B8           STR3A:			CP      B
1345+ AC7E 38 06                		JR      C,STR34
1346+ AC80 50                   		LD      D,B
1347+ AC81 58                   		LD      E,B
1348+ AC82 78           STR32:			LD      A,B
1349+ AC83 C6 81                		ADD     A,129
1350+ AC85 4F                   		LD      C,A
1351+ AC86 CB FA        STR34:			SET     7,D
1352+ AC88 1D                   		DEC     E
1353+ AC89 7A           STR35:			LD      A,D
1354+ AC8A B9                   		CP      C
1355+ AC8B 30 0C                		JR      NC,STR33
1356+ AC8D F1           STR36:			POP     AF
1357+ AC8E 28 03                		JR      Z,STR37
1358+ AC90 F2 9B AC             		JP      P,STR38
1359+ AC93 F5           STR37:			PUSH    AF
1360+ AC94 1C                   		INC     E
1361+ AC95 1D                   		DEC     E
1362+ AC96 FA AA AC             		JP      M,STR4
1363+ AC99 3E 30        STR33:			LD      A,'0'
1364+ AC9B 15           STR38:			DEC     D
1365+ AC9C E2 A2 AC             		JP      PO,STR39
1366+ AC9F 36 2E                		LD      (HL),'.'
1367+ ACA1 23                   		INC     HL
1368+ ACA2 77           STR39:			LD      (HL),A
1369+ ACA3 23                   		INC     HL
1370+ ACA4 1D                   		DEC     E
1371+ ACA5 F2 89 AC             		JP      P,STR35
1372+ ACA8 18 E3                		JR      STR36
1373+ ACAA              ;
1374+ ACAA F1           STR4:			POP     AF
1375+ ACAB 0C           STR40:			INC     C
1376+ ACAC 4D                   		LD      C,L
1377+ ACAD 20 27                		JR      NZ,STR44
1378+ ACAF 36 45                		LD      (HL),'E'        ;EXPONENT
1379+ ACB1 23                   		INC     HL
1380+ ACB2 78                   		LD      A,B
1381+ ACB3 3D                   		DEC     A
1382+ ACB4 F2 BC AC             		JP      P,STR41
1383+ ACB7 36 2D                		LD      (HL),'-'
1384+ ACB9 23                   		INC     HL
1385+ ACBA ED 44                		NEG
1386+ ACBC 36 30        STR41:			LD      (HL),'0'
1387+ ACBE 28 15                		JR      Z,STR47
1388+ ACC0 FE 0A                		CP      10
1389+ ACC2 47                   		LD      B,A
1390+ ACC3 3E 3A                		LD      A,':'
1391+ ACC5 38 03                		JR      C,STR42
1392+ ACC7 23                   		INC     HL
1393+ ACC8 36 30                		LD      (HL),'0'
1394+ ACCA 34           STR42:			INC     (HL)
1395+ ACCB BE                   		CP      (HL)
1396+ ACCC 20 05                		JR      NZ,STR43
1397+ ACCE 36 30                		LD      (HL),'0'
1398+ ACD0 2B                   		DEC     HL
1399+ ACD1 34                   		INC     (HL)
1400+ ACD2 23                   		INC     HL
1401+ ACD3 10 F5        STR43:			DJNZ    STR42
1402+ ACD5 23           STR47:			INC     HL
1403+ ACD6 EB           STR44:			EX      DE,HL
1404+ ACD7 C9                 			RET
1405+ ACD8              ;
1406+ ACD8              ;Support subroutines:
1407+ ACD8              ;
1408+ ACD8 DD 46 04     DLOAD5:			LD      B,(IX+4)
1409+ ACDB D9                   		EXX
1410+ ACDC DD 5E 00             		LD      E,(IX+0)
1411+ ACDF DD 56 01             		LD      D,(IX+1)
1412+ ACE2 D9                   		EXX
1413+ ACE3 DD 5E 02             		LD      E,(IX+2)
1414+ ACE6 DD 56 03             		LD      D,(IX+3)
1415+ ACE9 C9                   		RET
1416+ ACEA              ;
1417+ ACEA              ;CON - Get unsigned numeric constant from ASCII string.
1418+ ACEA              ;   Inputs: ASCII string at (IX).
1419+ ACEA              ;  Outputs: Variable-type result in HLH'L'C
1420+ ACEA              ;           IX updated (points to delimiter)
1421+ ACEA              ;           A7 = 0 (numeric marker)
1422+ ACEA              ;
1423+ ACEA CD D8 AE     CON:			CALL    ZERO            ;INITIALISE TO ZERO
1424+ ACED 0E 00                		LD      C,0             ;TRUNCATION COUNTER
1425+ ACEF CD 6F AD             		CALL    NUMBER          ;GET INTEGER PART
1426+ ACF2 FE 2E                		CP      '.'
1427+ ACF4 06 00                		LD      B,0             ;DECL. PLACE COUNTER
1428+ ACF6 CC 6D AD             		CALL    Z,NUMBIX        ;GET FRACTION PART
1429+ ACF9 FE 45                		CP      'E'
1430+ ACFB 3E 00                		LD      A,0             ;INITIALISE EXPONENT
1431+ ACFD CC 3E AD             		CALL    Z,GETEXP        ;GET EXPONENT
1432+ AD00 CB 7C                		BIT     7,H
1433+ AD02 20 08                		JR      NZ,CON0         ;INTEGER OVERFLOW
1434+ AD04 B7                   		OR      A
1435+ AD05 20 05                		JR      NZ,CON0         ;EXPONENT NON-ZERO
1436+ AD07 B8                   		CP      B
1437+ AD08 20 02                		JR      NZ,CON0         ;DECIMAL POINT
1438+ AD0A B9                   		CP      C
1439+ AD0B C8                   		RET     Z               ;INTEGER
1440+ AD0C 90           CON0:			SUB     B
1441+ AD0D 81                   		ADD     A,C
1442+ AD0E 0E 9F                		LD      C,159
1443+ AD10 CD 4F AE             		CALL    FLOAT
1444+ AD13 CB BC                		RES     7,H             ;DITCH IMPLIED 1
1445+ AD15 B7                   		OR      A
1446+ AD16 C8                   		RET     Z               ;DONE
1447+ AD17 FA 22 AD             		JP      M,CON2          ;NEGATIVE EXPONENT
1448+ AD1A CD AC AF             		CALL    POWR10
1449+ AD1D CD E4 A6             		CALL    FMUL            ;SCALE
1450+ AD20 AF                   		XOR     A
1451+ AD21 C9                   		RET
1452+ AD22 FE DA        CON2:			CP      -38
1453+ AD24 38 0A                		JR      C,CON3          ;CAN'T SCALE IN ONE GO
1454+ AD26 ED 44                		NEG
1455+ AD28 CD AC AF             		CALL    POWR10
1456+ AD2B CD 51 A6             		CALL    FDIV            ;SCALE
1457+ AD2E AF                   		XOR     A
1458+ AD2F C9                   		RET
1459+ AD30 F5           CON3:			PUSH    AF
1460+ AD31 3E 26                		LD      A,38
1461+ AD33 CD AC AF             		CALL    POWR10
1462+ AD36 CD 51 A6             		CALL    FDIV
1463+ AD39 F1                   		POP     AF
1464+ AD3A C6 26                		ADD     A,38
1465+ AD3C 18 E4                		JR      CON2
1466+ AD3E              ;
1467+ AD3E              ;GETEXP - Get decimal exponent from string
1468+ AD3E              ;     Inputs: ASCII string at (IX)
1469+ AD3E              ;             (IX points at 'E')
1470+ AD3E              ;             A = initial value
1471+ AD3E              ;    Outputs: A = new exponent
1472+ AD3E              ;             IX updated.
1473+ AD3E              ;   Destroys: A,A',IX,F,F'
1474+ AD3E              ;
1475+ AD3E C5           GETEXP:			PUSH    BC              ;SAVE REGISTERS
1476+ AD3F 47                   		LD      B,A             ;INITIAL VALUE
1477+ AD40 0E 02                		LD      C,2             ;2 DIGITS MAX
1478+ AD42 DD 23                		INC     IX              ;BUMP PAST 'E'
1479+ AD44 CD A3 B0             		CALL    SIGNQ
1480+ AD47 08                   		EX      AF,AF'          ;SAVE EXPONENT SIGN
1481+ AD48 CD 99 B0     GETEX1:			CALL    DIGITQ
1482+ AD4B 38 17                		JR      C,GETEX2
1483+ AD4D 78                   		LD      A,B             ;B=B*10
1484+ AD4E 87                   		ADD     A,A
1485+ AD4F 87                   		ADD     A,A
1486+ AD50 80                   		ADD     A,B
1487+ AD51 87                   		ADD     A,A
1488+ AD52 47                   		LD      B,A
1489+ AD53 DD 7E 00             		LD      A,(IX)          ;GET BACK DIGIT
1490+ AD56 DD 23                		INC     IX
1491+ AD58 E6 0F                		AND     0FH             ;MASK UNWANTED BITS
1492+ AD5A 80                   		ADD     A,B             ;ADD IN DIGIT
1493+ AD5B 47                   		LD      B,A
1494+ AD5C 0D                   		DEC     C
1495+ AD5D F2 48 AD             		JP      P,GETEX1
1496+ AD60 06 64                		LD      B,100           ;FORCE OVERFLOW
1497+ AD62 18 E4                		JR      GETEX1
1498+ AD64 08           GETEX2:			EX      AF,AF'          ;RESTORE SIGN
1499+ AD65 FE 2D                		CP      '-'
1500+ AD67 78                   		LD      A,B
1501+ AD68 C1                   		POP     BC              ;RESTORE
1502+ AD69 C0                   		RET     NZ
1503+ AD6A ED 44                		NEG                     ;NEGATE EXPONENT
1504+ AD6C C9                   		RET
1505+ AD6D              ;
1506+ AD6D              ;NUMBER: Get unsigned integer from string.
1507+ AD6D              ;    Inputs: string at (IX)
1508+ AD6D              ;            C = truncated digit count
1509+ AD6D              ;                (initially zero)
1510+ AD6D              ;            B = total digit count
1511+ AD6D              ;            HLH'L' = initial value
1512+ AD6D              ;   Outputs: HLH'L' = number (binary integer)
1513+ AD6D              ;            A = delimiter.
1514+ AD6D              ;            B, C & IX updated
1515+ AD6D              ;  Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IX,F
1516+ AD6D              ;
1517+ AD6D DD 23        NUMBIX:			INC     IX
1518+ AD6F CD 99 B0     NUMBER:			CALL    DIGITQ
1519+ AD72 D8                   		RET     C
1520+ AD73 04                   		INC     B               ;INCREMENT DIGIT COUNT
1521+ AD74 DD 23                		INC     IX
1522+ AD76 CD 23 AF             		CALL    X10             ;*10 & COPY OLD VALUE
1523+ AD79 38 13                		JR      C,NUMB1         ;OVERFLOW
1524+ AD7B 0D                   		DEC     C               ;SEE IF TRUNCATED
1525+ AD7C 0C                   		INC     C
1526+ AD7D 20 0F                		JR      NZ,NUMB1        ;IMPORTANT!
1527+ AD7F E6 0F                		AND     0FH
1528+ AD81 D9                   		EXX
1529+ AD82 06 00                		LD      B,0
1530+ AD84 4F                   		LD      C,A
1531+ AD85 09                   		ADD     HL,BC           ;ADD IN DIGIT
1532+ AD86 D9                   		EXX
1533+ AD87 30 E6                		JR      NC,NUMBER
1534+ AD89 23                   		INC     HL              ;CARRY
1535+ AD8A 7C                   		LD      A,H
1536+ AD8B B5                   		OR      L
1537+ AD8C 20 E1                		JR      NZ,NUMBER
1538+ AD8E 0C           NUMB1:			INC     C               ;TRUNCATION COUNTER
1539+ AD8F CD 96 AE             		CALL    SWAP1           ;RESTORE PREVIOUS VALUE
1540+ AD92 18 DB                		JR      NUMBER
1541+ AD94              ;
1542+ AD94              ;FIX - Fix number to specified exponent value.
1543+ AD94              ;    Inputs: HLH'L'C = +ve non-zero number (floated)
1544+ AD94              ;            A = desired exponent (A>C)
1545+ AD94              ;   Outputs: HLH'L'C = fixed number (unsigned)
1546+ AD94              ;            fraction shifted into B'C'
1547+ AD94              ;            A'F' positive if integer input
1548+ AD94              ;  Destroys: C,H,L,A',B',C',H',L',F,F'
1549+ AD94              ;
1550+ AD94 08           FIX:			EX      AF,AF'
1551+ AD95 AF                   		XOR     A
1552+ AD96 08                   		EX      AF,AF'
1553+ AD97 CB FC                		SET     7,H             ;IMPLIED 1
1554+ AD99 CD 9B AE     FIX1:			CALL    DIV2
1555+ AD9C B9                   		CP      C
1556+ AD9D C8                   		RET     Z
1557+ AD9E D2 99 AD             		JP      NC,FIX1
1558+ ADA1 C3 A9 AE             		JP      OFLOW
1559+ ADA4              ;
1560+ ADA4              ;SFIX - Convert to integer if necessary.
1561+ ADA4              ;    Input: Variable-type number in HLH'L'C
1562+ ADA4              ;   Output: Integer in HLH'L', C=0
1563+ ADA4              ; Destroys: A,C,H,L,A',B',C',H',L',F,F'
1564+ ADA4              ;
1565+ ADA4              ;NEGATE - Negate HLH'L'
1566+ ADA4              ;    Destroys: H,L,H',L',F
1567+ ADA4              ;
1568+ ADA4 CD 93 AE     FIX2:			CALL    SWAP
1569+ ADA7 CD AD AD             		CALL    SFIX
1570+ ADAA CD 93 AE             		CALL    SWAP
1571+ ADAD 0D           SFIX:			DEC     C
1572+ ADAE 0C                   		INC     C
1573+ ADAF C8                   		RET     Z               ;INTEGER/ZERO
1574+ ADB0 CB 7C                		BIT     7,H             ;SIGN
1575+ ADB2 F5                   		PUSH    AF
1576+ ADB3 3E 9F                		LD      A,159
1577+ ADB5 CD 94 AD             		CALL    FIX
1578+ ADB8 F1                   		POP     AF
1579+ ADB9 0E 00                		LD      C,0
1580+ ADBB C8                   		RET     Z
1581+ ADBC B7           NEGATE:			OR      A               ;CLEAR CARRY
1582+ ADBD D9                   		EXX
1583+ ADBE D5           NEG0:			PUSH    DE
1584+ ADBF EB                   		EX      DE,HL
1585+ ADC0 21 00 00             		LD      HL,0
1586+ ADC3 ED 52                		SBC     HL,DE
1587+ ADC5 D1                   		POP     DE
1588+ ADC6 D9                   		EXX
1589+ ADC7 D5                   		PUSH    DE
1590+ ADC8 EB                   		EX      DE,HL
1591+ ADC9 21 00 00             		LD      HL,0
1592+ ADCC ED 52                		SBC     HL,DE
1593+ ADCE D1                   		POP     DE
1594+ ADCF C9                   		RET
1595+ ADD0              ;
1596+ ADD0              ;NEG - Negate HLH'L'B'C'
1597+ ADD0              ;    Also complements A (used in FADD)
1598+ ADD0              ;    Destroys: A,H,L,B',C',H',L',F
1599+ ADD0              ;
1600+ ADD0 D9           NEG:			EXX
1601+ ADD1 2F                   		CPL
1602+ ADD2 E5                   		PUSH    HL
1603+ ADD3 B7                   		OR      A               ;CLEAR CARRY
1604+ ADD4 21 00 00             		LD      HL,0
1605+ ADD7 ED 42                		SBC     HL,BC
1606+ ADD9 44                   		LD      B,H
1607+ ADDA 4D                   		LD      C,L
1608+ ADDB E1                   		POP     HL
1609+ ADDC 18 E0                		JR      NEG0
1610+ ADDE              ;
1611+ ADDE              ;SCALE - Trig scaling.
1612+ ADDE              ;MOD48 - 48-bit floating-point "modulus" (remainder).
1613+ ADDE              ;   Inputs: HLH'L'C unsigned floating-point dividend
1614+ ADDE              ;           DED'E'B'C'B unsigned 48-bit FP divisor
1615+ ADDE              ;  Outputs: HLH'L'C floating point remainder (H7=1)
1616+ ADDE              ;           E = quotient (bit 7 is sticky)
1617+ ADDE              ; Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IX,F
1618+ ADDE              ;FLO48 - Float unsigned number (48 bits)
1619+ ADDE              ;    Input/output in HLH'L'B'C'C
1620+ ADDE              ;   Destroys: C,H,L,B',C',H',L',F
1621+ ADDE              ;
1622+ ADDE 3E 96        SCALE:			LD      A,150
1623+ ADE0 B9                   		CP      C
1624+ ADE1 3E 17                		LD      A,ACLOST
1625+ ADE3 DA CE A4             		JP      C,ERROR         ;"Accuracy lost"
1626+ ADE6 CD B2 A9             		CALL    PIBY4
1627+ ADE9 D9                   		EXX
1628+ ADEA 01 69 21             		LD      BC,2169H        ;3.141592653589793238
1629+ ADED D9                   		EXX
1630+ ADEE CB FA        MOD48:			SET     7,D             ;IMPLIED 1
1631+ ADF0 CB FC                		SET     7,H
1632+ ADF2 79                   		LD      A,C
1633+ ADF3 0E 00                		LD      C,0             ;INIT QUOTIENT
1634+ ADF5 DD 21 00 00          		LD      IX,0
1635+ ADF9 DD E5                		PUSH    IX              ;PUT ZERO ON STACK
1636+ ADFB B8                   		CP      B
1637+ ADFC 38 3A                		JR      C,MOD485        ;DIVIDEND<DIVISOR
1638+ ADFE D9           MOD481:			EXX                     ;CARRY=0 HERE
1639+ ADFF E3                   		EX      (SP),HL
1640+ AE00 ED 42                		SBC     HL,BC
1641+ AE02 E3                   		EX      (SP),HL
1642+ AE03 ED 52                		SBC     HL,DE
1643+ AE05 D9                   		EXX
1644+ AE06 ED 52                		SBC     HL,DE
1645+ AE08 30 09                		JR      NC,MOD482       ;DIVIDEND>=DIVISOR
1646+ AE0A D9                   		EXX
1647+ AE0B E3                   		EX      (SP),HL
1648+ AE0C 09                   		ADD     HL,BC
1649+ AE0D E3                   		EX      (SP),HL
1650+ AE0E ED 5A                		ADC     HL,DE
1651+ AE10 D9                   		EXX
1652+ AE11 ED 5A                		ADC     HL,DE
1653+ AE13 3F           MOD482:			CCF
1654+ AE14 CB 11                		RL      C               ;QUOTIENT
1655+ AE16 30 02                		JR      NC,MOD483
1656+ AE18 CB F9                		SET     7,C             ;STICKY BIT
1657+ AE1A 3D           MOD483:			DEC     A
1658+ AE1B B8                   		CP      B
1659+ AE1C 38 19                		JR      C,MOD484        ;DIVIDEND<DIVISOR
1660+ AE1E E3                   		EX      (SP),HL
1661+ AE1F 29                   		ADD     HL,HL           ;DIVIDEND * 2
1662+ AE20 E3                   		EX      (SP),HL
1663+ AE21 D9                   		EXX
1664+ AE22 ED 6A                		ADC     HL,HL
1665+ AE24 D9                   		EXX
1666+ AE25 ED 6A                		ADC     HL,HL
1667+ AE27 30 D5                		JR      NC,MOD481       ;AGAIN
1668+ AE29 B7                   		OR      A
1669+ AE2A D9                   		EXX
1670+ AE2B E3                   		EX      (SP),HL
1671+ AE2C ED 42                		SBC     HL,BC           ;OVERFLOW, SO SUBTRACT
1672+ AE2E E3                   		EX      (SP),HL
1673+ AE2F ED 52                		SBC     HL,DE
1674+ AE31 D9                   		EXX
1675+ AE32 ED 52                		SBC     HL,DE
1676+ AE34 B7                   		OR      A
1677+ AE35 18 DC                		JR      MOD482
1678+ AE37              ;
1679+ AE37 3C           MOD484:			INC     A
1680+ AE38 59           MOD485:			LD      E,C             ;QUOTIENT
1681+ AE39 4F                   		LD      C,A             ;REMAINDER EXPONENT
1682+ AE3A D9                   		EXX
1683+ AE3B C1                   		POP     BC
1684+ AE3C D9                   		EXX
1685+ AE3D CB 7C        FLO48:			BIT     7,H
1686+ AE3F C0                   		RET     NZ
1687+ AE40 D9                   		EXX
1688+ AE41 CB 21                		SLA     C
1689+ AE43 CB 10                		RL      B
1690+ AE45 ED 6A                		ADC     HL,HL
1691+ AE47 D9                   		EXX
1692+ AE48 ED 6A                		ADC     HL,HL
1693+ AE4A 0D                   		DEC     C
1694+ AE4B C2 3D AE             		JP      NZ,FLO48
1695+ AE4E C9                   		RET
1696+ AE4F              ;
1697+ AE4F              ;Float unsigned number
1698+ AE4F              ;    Input/output in HLH'L'C
1699+ AE4F              ;   Destroys: C,H,L,H',L',F
1700+ AE4F              ;
1701+ AE4F CB 7C        FLOAT:			BIT     7,H
1702+ AE51 C0                   		RET     NZ
1703+ AE52 D9                   		EXX                     ;SAME AS "X2"
1704+ AE53 29                   		ADD     HL,HL           ;TIME-CRITICAL
1705+ AE54 D9                   		EXX                     ;REGION
1706+ AE55 ED 6A                		ADC     HL,HL           ;(BENCHMARKS)
1707+ AE57 0D                   		DEC     C
1708+ AE58 C2 4F AE             		JP      NZ,FLOAT
1709+ AE5B C9                   		RET
1710+ AE5C              ;
1711+ AE5C              ;SFLOAT - Convert to floating-point if necessary.
1712+ AE5C              ;    Input: Variable-type number in HLH'L'C
1713+ AE5C              ;    Output: Floating-point in HLH'L'C
1714+ AE5C              ;    Destroys: A,C,H,L,H',L',F
1715+ AE5C              ;
1716+ AE5C 08           FLOATA:			EX      AF,AF'
1717+ AE5D C6 29                		ADD     A,(RTABLE-DTABLE)/2
1718+ AE5F 08                   		EX      AF,AF'
1719+ AE60 CD 93 AE     FLOAT2:			CALL    SWAP
1720+ AE63 CD 69 AE             		CALL    SFLOAT
1721+ AE66 CD 93 AE             		CALL    SWAP
1722+ AE69 0D           SFLOAT:			DEC     C
1723+ AE6A 0C                   		INC     C
1724+ AE6B C0                   		RET     NZ              ;ALREADY FLOATING-POINT
1725+ AE6C CD B8 AE             		CALL    TEST
1726+ AE6F C8                   		RET     Z               ;ZERO
1727+ AE70 7C                   		LD      A,H
1728+ AE71 B7                   		OR      A
1729+ AE72 FC BC AD             		CALL    M,NEGATE
1730+ AE75 0E 9F                		LD      C,159
1731+ AE77 CD 4F AE             		CALL    FLOAT
1732+ AE7A B7                   		OR      A
1733+ AE7B F8                   		RET     M               ;NEGATIVE
1734+ AE7C CB BC                		RES     7,H
1735+ AE7E C9                   		RET
1736+ AE7F              ;
1737+ AE7F              ;ROUND UP
1738+ AE7F              ;Return with carry set if 32-bit overflow
1739+ AE7F              ;   Destroys: H,L,B',C',H',L',F
1740+ AE7F              ;
1741+ AE7F D9           ADD1:			EXX
1742+ AE80 01 01 00             		LD      BC,1
1743+ AE83 09                   		ADD     HL,BC
1744+ AE84 D9                   		EXX
1745+ AE85 D0                   		RET     NC
1746+ AE86 C5                   		PUSH    BC
1747+ AE87 01 01 00             		LD      BC,1
1748+ AE8A 09                   		ADD     HL,BC
1749+ AE8B C1                   		POP     BC
1750+ AE8C C9                   		RET
1751+ AE8D              ;
1752+ AE8D              ;ODD - Add one if even, leave alone if odd.
1753+ AE8D              ; (Used to perform unbiassed rounding, i.e.
1754+ AE8D              ;  number is rounded up half the time)
1755+ AE8D              ;    Destroys: L',F (carry cleared)
1756+ AE8D              ;
1757+ AE8D B7           ODD:			OR      A               ;CLEAR CARRY
1758+ AE8E D9                   		EXX
1759+ AE8F CB C5                		SET     0,L             ;MAKE ODD
1760+ AE91 D9                   		EXX
1761+ AE92 C9                   		RET
1762+ AE93              ;
1763+ AE93              ;SWAP - Swap arguments.
1764+ AE93              ;    Exchanges DE,HL D'E',H'L' and B,C
1765+ AE93              ;    Destroys: A,B,C,D,E,H,L,D',E',H',L'
1766+ AE93              ;SWAP1 - Swap DEHL with D'E'H'L'
1767+ AE93              ;    Destroys: D,E,H,L,D',E',H',L'
1768+ AE93              ;
1769+ AE93 79           SWAP:			LD      A,C
1770+ AE94 48                   		LD      C,B
1771+ AE95 47                   		LD      B,A
1772+ AE96 EB           SWAP1:			EX      DE,HL
1773+ AE97 D9                   		EXX
1774+ AE98 EB                   		EX      DE,HL
1775+ AE99 D9                   		EXX
1776+ AE9A C9                   		RET
1777+ AE9B              ;
1778+ AE9B              ;DIV2 - destroys C,H,L,A',B',C',H',L',F,F'
1779+ AE9B              ;INCC - destroys C,F
1780+ AE9B              ;OFLOW
1781+ AE9B              ;
1782+ AE9B CD 39 AF     DIV2:			CALL    D2
1783+ AE9E D9                   		EXX
1784+ AE9F CB 18                		RR      B
1785+ AEA1 CB 19                		RR      C
1786+ AEA3 08                   		EX      AF,AF'
1787+ AEA4 B0                   		OR      B
1788+ AEA5 08                   		EX      AF,AF'
1789+ AEA6 D9                   		EXX
1790+ AEA7 0C           INCC:			INC     C
1791+ AEA8 C0                   		RET     NZ
1792+ AEA9 3E 14        OFLOW:			LD      A,TOOBIG
1793+ AEAB C3 CE A4             		JP      ERROR           ;"Too big"
1794+ AEAE              ;
1795+ AEAE              ;FTEST - Test for zero & sign
1796+ AEAE              ;    Output: A=0 if zero, A=&40 if +ve, A=&C0 if -ve
1797+ AEAE              ;
1798+ AEAE CD B8 AE     FTEST:			CALL    TEST
1799+ AEB1 C8                   		RET     Z
1800+ AEB2 7C                   		LD      A,H
1801+ AEB3 E6 80                		AND     10000000B
1802+ AEB5 F6 40                		OR      01000000B
1803+ AEB7 C9                   		RET
1804+ AEB8              ;
1805+ AEB8              ;TEST - Test HLH'L' for zero.
1806+ AEB8              ;    Output: Z-flag set & A=0 if HLH'L'=0
1807+ AEB8              ;    Destroys: A,F
1808+ AEB8              ;
1809+ AEB8 7C           TEST:			LD      A,H
1810+ AEB9 B5                   		OR      L
1811+ AEBA D9                   		EXX
1812+ AEBB B4                   		OR      H
1813+ AEBC B5                   		OR      L
1814+ AEBD D9                   		EXX
1815+ AEBE C9                   		RET
1816+ AEBF              ;
1817+ AEBF              ;FCOMP - Compare two numbers
1818+ AEBF              ;    Output: A=0 if equal, A=&40 if L>R, A=&C0 if L<R
1819+ AEBF              ;
1820+ AEBF 78           FCOMP:			LD      A,B
1821+ AEC0 B1                   		OR      C               ;Both integer?
1822+ AEC1 20 0A                		JR      NZ,FCOMP1
1823+ AEC3 CD D5 AE             		CALL    ICP
1824+ AEC6 3E 00        FCOMP0:			LD      A,0
1825+ AEC8 C8                   		RET     Z               ;Equal
1826+ AEC9 3E 80                		LD      A,80H
1827+ AECB 1F                   		RRA
1828+ AECC C9                   		RET
1829+ AECD              ;
1830+ AECD CD 60 AE     FCOMP1:			CALL    FLOAT2          ;Float both
1831+ AED0 CD E2 AE             		CALL    FCP
1832+ AED3 18 F1                		JR      FCOMP0
1833+ AED5              ;
1834+ AED5              ;Integer and floating point compare.
1835+ AED5              ;Sets carry & zero flags according to HLH'L'C-DED'E'B
1836+ AED5              ;Result pre-set to FALSE
1837+ AED5              ;ICP1, FCP1 destroy A,F
1838+ AED5              ;
1839+ AED5              ;ZERO - Return zero.
1840+ AED5              ; Destroys: A,C,H,L,H',L'
1841+ AED5              ;
1842+ AED5 CD 01 AF     ICP:			CALL    ICP1
1843+ AED8 3E 00        ZERO:			LD      A,0
1844+ AEDA D9                   		EXX
1845+ AEDB 67                   		LD      H,A
1846+ AEDC 6F                   		LD      L,A
1847+ AEDD D9                   		EXX
1848+ AEDE 67                   		LD      H,A
1849+ AEDF 6F                   		LD      L,A
1850+ AEE0 4F                   		LD      C,A
1851+ AEE1 C9                   		RET
1852+ AEE2              ;
1853+ AEE2 CD F4 AE     FCP:			CALL    FCP1
1854+ AEE5 18 F1                		JR      ZERO            ;PRESET FALSE
1855+ AEE7              ;
1856+ AEE7 79           FCP0:			LD      A,C
1857+ AEE8 B8                   		CP      B               ;COMPARE EXPONENTS
1858+ AEE9 C0                   		RET     NZ
1859+ AEEA ED 52        ICP0:			SBC     HL,DE           ;COMP MANTISSA MSB
1860+ AEEC 19                   		ADD     HL,DE
1861+ AEED C0                   		RET     NZ
1862+ AEEE D9                   		EXX
1863+ AEEF ED 52                		SBC     HL,DE           ;COMP MANTISSA LSB
1864+ AEF1 19                   		ADD     HL,DE
1865+ AEF2 D9                   		EXX
1866+ AEF3 C9                   		RET
1867+ AEF4              ;
1868+ AEF4 7C           FCP1:			LD      A,H
1869+ AEF5 AA                   		XOR     D
1870+ AEF6 7C                   		LD      A,H
1871+ AEF7 17                   		RLA
1872+ AEF8 F8                   		RET     M
1873+ AEF9 30 EC                		JR      NC,FCP0
1874+ AEFB CD E7 AE             		CALL    FCP0
1875+ AEFE C8                   		RET     Z               ;** V0.1 BUG FIX
1876+ AEFF 3F                   		CCF
1877+ AF00 C9                   		RET
1878+ AF01              ;
1879+ AF01 7C           ICP1:			LD      A,H
1880+ AF02 AA                   		XOR     D
1881+ AF03 F2 EA AE             		JP      P,ICP0
1882+ AF06 7C                   		LD      A,H
1883+ AF07 17                   		RLA
1884+ AF08 C9                   		RET
1885+ AF09              ;
1886+ AF09              ;ADD - Integer add.
1887+ AF09              ;Carry, sign & zero flags valid on exit
1888+ AF09              ;    Destroys: H,L,H',L',F
1889+ AF09              ;
1890+ AF09 05           X10B:			DEC     B
1891+ AF0A 0C                   		INC     C
1892+ AF0B CD 45 AF     X5:			CALL    COPY0
1893+ AF0E CD 38 AF             		CALL    D2C
1894+ AF11 CD 38 AF             		CALL    D2C
1895+ AF14 08                   		EX      AF,AF'          ;SAVE CARRY
1896+ AF15 D9           ADD:			EXX
1897+ AF16 19                   		ADD     HL,DE
1898+ AF17 D9                   		EXX
1899+ AF18 ED 5A                		ADC     HL,DE
1900+ AF1A C9                   		RET
1901+ AF1B              ;
1902+ AF1B              ;SUB - Integer subtract.
1903+ AF1B              ;Carry, sign & zero flags valid on exit
1904+ AF1B              ;    Destroys: H,L,H',L',F
1905+ AF1B              ;
1906+ AF1B D9           SUB:			EXX
1907+ AF1C B7                   		OR      A
1908+ AF1D ED 52                		SBC     HL,DE
1909+ AF1F D9                   		EXX
1910+ AF20 ED 52                		SBC     HL,DE
1911+ AF22 C9                   		RET
1912+ AF23              ;
1913+ AF23              ;X10 - unsigned integer * 10
1914+ AF23              ;   Inputs: HLH'L' initial value
1915+ AF23              ;  Outputs: DED'E' = initial HLH'L'
1916+ AF23              ;           Carry bit set if overflow
1917+ AF23              ;           If carry not set HLH'L'=result
1918+ AF23              ; Destroys: D,E,H,L,D',E',H',L',F
1919+ AF23              ;X2 - Multiply HLH'L' by 2 as 32-bit integer.
1920+ AF23              ;    Carry set if MSB=1 before shift.
1921+ AF23              ;    Sign set if MSB=1 after shift.
1922+ AF23              ;    Destroys: H,L,H',L',F
1923+ AF23              ;
1924+ AF23 CD 45 AF     X10:			CALL    COPY0           ;DED'E'=HLH'L'
1925+ AF26 CD 32 AF             		CALL    X2
1926+ AF29 D8                   		RET     C               ;TOO BIG
1927+ AF2A CD 32 AF             		CALL    X2
1928+ AF2D D8                   		RET     C
1929+ AF2E CD 15 AF             		CALL    ADD
1930+ AF31 D8                   		RET     C
1931+ AF32 D9           X2:			EXX
1932+ AF33 29                   		ADD     HL,HL
1933+ AF34 D9                   		EXX
1934+ AF35 ED 6A                		ADC     HL,HL
1935+ AF37 C9                   		RET
1936+ AF38              ;
1937+ AF38              ;D2 - Divide HLH'L' by 2 as 32-bit integer.
1938+ AF38              ;    Carry set if LSB=1 before shift.
1939+ AF38              ;    Destroys: H,L,H',L',F
1940+ AF38              ;
1941+ AF38 0C           D2C:			INC     C
1942+ AF39 CB 3C        D2:			SRL     H
1943+ AF3B CB 1D                		RR      L
1944+ AF3D D9                   		EXX
1945+ AF3E CB 1C                		RR      H
1946+ AF40 CB 1D                		RR      L
1947+ AF42 D9                   		EXX
1948+ AF43 C9                   		RET
1949+ AF44              ;
1950+ AF44              ;COPY - COPY HLH'L'C INTO DED'E'B
1951+ AF44              ;  Destroys: B,C,D,E,H,L,D',E',H',L'
1952+ AF44              ;
1953+ AF44 41           COPY:			LD      B,C
1954+ AF45 54           COPY0:			LD      D,H
1955+ AF46 5D                   		LD      E,L
1956+ AF47 D9                   		EXX
1957+ AF48 54                   		LD      D,H
1958+ AF49 5D                   		LD      E,L
1959+ AF4A D9                   		EXX
1960+ AF4B C9                   		RET
1961+ AF4C              ;
1962+ AF4C              ;SQUARE - PUSH X*X
1963+ AF4C              ;PUSH5 - PUSH HLH'L'C ONTO STACK.
1964+ AF4C              ;  Destroys: SP,IX
1965+ AF4C              ;
1966+ AF4C CD 44 AF     SQUARE:			CALL    COPY
1967+ AF4F CD E4 A6             		CALL    FMUL
1968+ AF52 DD E1        PUSH5:			POP     IX              ;RETURN ADDRESS
1969+ AF54 C5                   		PUSH    BC
1970+ AF55 E5                   		PUSH    HL
1971+ AF56 D9                   		EXX
1972+ AF57 E5                   		PUSH    HL
1973+ AF58 D9                   		EXX
1974+ AF59 DD E9                		JP      (IX)            ;"RETURN"
1975+ AF5B              ;
1976+ AF5B              ;POP5 - POP DED'E'B OFF STACK.
1977+ AF5B              ;  Destroys: A,B,D,E,D',E',SP,IX
1978+ AF5B              ;
1979+ AF5B DD E1        POP5:			POP     IX              ;RETURN ADDRESS
1980+ AF5D D9                   		EXX
1981+ AF5E D1                   		POP     DE
1982+ AF5F D9                   		EXX
1983+ AF60 D1                   		POP     DE
1984+ AF61 79                   		LD      A,C
1985+ AF62 C1                   		POP     BC
1986+ AF63 41                   		LD      B,C
1987+ AF64 4F                   		LD      C,A
1988+ AF65 DD E9                		JP      (IX)            ;"RETURN"
1989+ AF67              ;
1990+ AF67              ;RATIO - Calculate (X-1)/(X+1)
1991+ AF67              ;    Inputs: X in HLH'L'C
1992+ AF67              ;   Outputs: (X-1)/(X+1) in HLH'L'C
1993+ AF67              ;  Destroys: Everything except IY,SP,I
1994+ AF67              ;
1995+ AF67 CD 52 AF     RATIO:			CALL    PUSH5           ;SAVE X
1996+ AF6A CD A7 A9             		CALL    DONE
1997+ AF6D CD F9 A5             		CALL    FADD
1998+ AF70 CD 5B AF             		CALL    POP5            ;RESTORE X
1999+ AF73 CD 52 AF             		CALL    PUSH5           ;SAVE X+1
2000+ AF76 CD 93 AE             		CALL    SWAP
2001+ AF79 CD A7 A9             		CALL    DONE
2002+ AF7C CD E3 A5             		CALL    FSUB
2003+ AF7F CD 5B AF             		CALL    POP5            ;RESTORE X+1
2004+ AF82 C3 51 A6             		JP      FDIV
2005+ AF85              ;
2006+ AF85              ;POLY - Evaluate a polynomial.
2007+ AF85              ;    Inputs: X in HLH'L'C and also stored at (SP+2)
2008+ AF85              ;            Polynomial coefficients follow call.
2009+ AF85              ;   Outputs: Result in HLH'L'C
2010+ AF85              ;  Destroys: Everything except IY,SP,I
2011+ AF85              ;Routine terminates on finding a coefficient >=1.
2012+ AF85              ;Note: The last coefficient is EXECUTED on return
2013+ AF85              ;      so must contain only innocuous bytes!
2014+ AF85              ;
2015+ AF85 DD 21 02 00  POLY:			LD      IX,2
2016+ AF89 DD 39                		ADD     IX,SP
2017+ AF8B DD E3                		EX      (SP),IX
2018+ AF8D CD D8 AC             		CALL    DLOAD5          ;FIRST COEFFICIENT
2019+ AF90 CD E4 A6     POLY1:			CALL    FMUL
2020+ AF93 11 05 00             		LD      DE,5
2021+ AF96 DD 19                		ADD     IX,DE
2022+ AF98 CD D8 AC             		CALL    DLOAD5          ;NEXT COEFFICIENT
2023+ AF9B DD E3                		EX      (SP),IX
2024+ AF9D 04                   		INC     B
2025+ AF9E 05                   		DEC     B               ;TEST
2026+ AF9F FA F9 A5             		JP      M,FADD
2027+ AFA2 CD F9 A5             		CALL    FADD
2028+ AFA5 CD D8 AC             		CALL    DLOAD5          ;X
2029+ AFA8 DD E3                		EX      (SP),IX
2030+ AFAA 18 E4                		JR      POLY1
2031+ AFAC              ;
2032+ AFAC              ;POWR10 - Calculate power of ten.
2033+ AFAC              ;    Inputs: A=power of 10 required (A<128)
2034+ AFAC              ;            A=binary exponent to be exceeded (A>=128)
2035+ AFAC              ;   Outputs: DED'E'B = result
2036+ AFAC              ;            A = actual power of ten returned
2037+ AFAC              ;  Destroys: A,B,D,E,A',D',E',F,F'
2038+ AFAC              ;
2039+ AFAC 3C           POWR10:			INC     A
2040+ AFAD 08                   		EX      AF,AF'
2041+ AFAE E5                   		PUSH    HL
2042+ AFAF D9                   		EXX
2043+ AFB0 E5                   		PUSH    HL
2044+ AFB1 D9                   		EXX
2045+ AFB2 CD A7 A9             		CALL    DONE
2046+ AFB5 CD 93 AE             		CALL    SWAP
2047+ AFB8 AF                   		XOR     A
2048+ AFB9 08           POWR11:			EX      AF,AF'
2049+ AFBA 3D                   		DEC     A
2050+ AFBB 28 20                		JR      Z,POWR14        ;EXIT TYPE 1
2051+ AFBD F2 C4 AF             		JP      P,POWR13
2052+ AFC0 B9                   		CP      C
2053+ AFC1 38 1A                		JR      C,POWR14        ;EXIT TYPE 2
2054+ AFC3 3C                   		INC     A
2055+ AFC4 08           POWR13:			EX      AF,AF'
2056+ AFC5 3C                   		INC     A
2057+ AFC6 CB FC                		SET     7,H
2058+ AFC8 CD 0B AF             		CALL    X5
2059+ AFCB 30 05                		JR      NC,POWR12
2060+ AFCD 08                   		EX      AF,AF'
2061+ AFCE CD 38 AF             		CALL    D2C
2062+ AFD1 08                   		EX      AF,AF'
2063+ AFD2 08           POWR12:			EX      AF,AF'
2064+ AFD3 DC 7F AE             		CALL    C,ADD1          ;ROUND UP
2065+ AFD6 0C                   		INC     C
2066+ AFD7 FA B9 AF             		JP      M,POWR11
2067+ AFDA C3 A9 AE             		JP      OFLOW
2068+ AFDD CD 93 AE     POWR14:			CALL    SWAP
2069+ AFE0 CB BA                		RES     7,D
2070+ AFE2 D9                   		EXX
2071+ AFE3 E1                   		POP     HL
2072+ AFE4 D9                   		EXX
2073+ AFE5 E1                   		POP     HL
2074+ AFE6 08                   		EX      AF,AF'
2075+ AFE7 C9                   		RET
2076+ AFE8              ;
2077+ AFE8              ;DIVA, DIVB - DIVISION PRIMITIVE.
2078+ AFE8              ;    Function: D'E'DE = H'L'HLD'E'DE / B'C'BC
2079+ AFE8              ;              Remainder in H'L'HL
2080+ AFE8              ;    Inputs: A = loop counter (normally -32)
2081+ AFE8              ;    Destroys: A,D,E,H,L,D',E',H',L',F
2082+ AFE8              ;
2083+ AFE8 B7           DIVA:			OR      A               ;CLEAR CARRY
2084+ AFE9 ED 42        DIV0:			SBC     HL,BC           ;DIVIDEND-DIVISOR
2085+ AFEB D9                   		EXX
2086+ AFEC ED 42                		SBC     HL,BC
2087+ AFEE D9                   		EXX
2088+ AFEF 30 05                		JR      NC,DIV1
2089+ AFF1 09                   		ADD     HL,BC           ;DIVIDEND+DIVISOR
2090+ AFF2 D9                   		EXX
2091+ AFF3 ED 4A                		ADC     HL,BC
2092+ AFF5 D9                   		EXX
2093+ AFF6 3F           DIV1:			CCF
2094+ AFF7 CB 13        DIVC:			RL      E               ;SHIFT RESULT INTO DE
2095+ AFF9 CB 12                		RL      D
2096+ AFFB D9                   		EXX
2097+ AFFC CB 13                		RL      E
2098+ AFFE CB 12                		RL      D
2099+ B000 D9                   		EXX
2100+ B001 3C                   		INC     A
2101+ B002 F0                   		RET     P
2102+ B003 ED 6A        DIVB:			ADC     HL,HL           ;DIVIDEND*2
2103+ B005 D9                   		EXX
2104+ B006 ED 6A                		ADC     HL,HL
2105+ B008 D9                   		EXX
2106+ B009 30 DE                		JR      NC,DIV0
2107+ B00B B7                   		OR      A
2108+ B00C ED 42                		SBC     HL,BC           ;DIVIDEND-DIVISOR
2109+ B00E D9                   		EXX
2110+ B00F ED 42                		SBC     HL,BC
2111+ B011 D9                   		EXX
2112+ B012 37                   		SCF
2113+ B013 C3 F7 AF             		JP      DIVC
2114+ B016              ;
2115+ B016              ;MULA, MULB - MULTIPLICATION PRIMITIVE.
2116+ B016              ;    Function: H'L'HLD'E'DE = B'C'BC * D'E'DE
2117+ B016              ;    Inputs: A = loop counter (usually -32)
2118+ B016              ;            H'L'HL = 0
2119+ B016              ;    Destroys: D,E,H,L,D',E',H',L',A,F
2120+ B016              ;
2121+ B016 B7           MULA:			OR      A               ;CLEAR CARRY
2122+ B017 D9           MUL0:			EXX
2123+ B018 CB 1A                		RR      D               ;MULTIPLIER/2
2124+ B01A CB 1B                		RR      E
2125+ B01C D9                   		EXX
2126+ B01D CB 1A                		RR      D
2127+ B01F CB 1B                		RR      E
2128+ B021 30 05                		JR      NC,MUL1
2129+ B023 09                   		ADD     HL,BC           ;ADD IN MULTIPLICAND
2130+ B024 D9                   		EXX
2131+ B025 ED 4A                		ADC     HL,BC
2132+ B027 D9                   		EXX
2133+ B028 3C           MUL1:			INC     A
2134+ B029 F0                   		RET     P
2135+ B02A D9           MULB:			EXX
2136+ B02B CB 1C                		RR      H               ;PRODUCT/2
2137+ B02D CB 1D                		RR      L
2138+ B02F D9                   		EXX
2139+ B030 CB 1C                		RR      H
2140+ B032 CB 1D                		RR      L
2141+ B034 C3 17 B0             		JP      MUL0
2142+ B037              ;
2143+ B037              ;SQRA, SQRB - SQUARE ROOT PRIMITIVES
2144+ B037              ;    Function: B'C'BC = SQR (D'E'DE)
2145+ B037              ;    Inputs: A = loop counter (normally -31)
2146+ B037              ;            B'C'BCH'L'HL initialised to 0
2147+ B037              ;  Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',F
2148+ B037              ;
2149+ B037 ED 42        SQR1:		SBC     HL,BC
2150+ B039 D9                   		EXX
2151+ B03A ED 42                		SBC     HL,BC
2152+ B03C D9                   		EXX
2153+ B03D 0C                   		INC     C
2154+ B03E 30 07                		JR      NC,SQR2
2155+ B040 0D                   		DEC     C
2156+ B041 09                   		ADD     HL,BC
2157+ B042 D9                   		EXX
2158+ B043 ED 4A                		ADC     HL,BC
2159+ B045 D9                   		EXX
2160+ B046 0D                   		DEC     C
2161+ B047 3C           SQR2:			INC     A
2162+ B048 F0                   		RET     P
2163+ B049 CB 21        SQRA:			SLA     C
2164+ B04B CB 10                		RL      B
2165+ B04D D9                   		EXX
2166+ B04E CB 11                		RL      C
2167+ B050 CB 10                		RL      B
2168+ B052 D9                   		EXX
2169+ B053 0C                   		INC     C
2170+ B054 CB 23                		SLA     E
2171+ B056 CB 12                		RL      D
2172+ B058 D9                   		EXX
2173+ B059 CB 13                		RL      E
2174+ B05B CB 12                		RL      D
2175+ B05D D9                   		EXX
2176+ B05E ED 6A                		ADC     HL,HL
2177+ B060 D9                   		EXX
2178+ B061 ED 6A                		ADC     HL,HL
2179+ B063 D9                   		EXX
2180+ B064 CB 23                		SLA     E
2181+ B066 CB 12                		RL      D
2182+ B068 D9                   		EXX
2183+ B069 CB 13                		RL      E
2184+ B06B CB 12                		RL      D
2185+ B06D D9                   		EXX
2186+ B06E ED 6A                		ADC     HL,HL
2187+ B070 D9                   		EXX
2188+ B071 ED 6A                		ADC     HL,HL
2189+ B073 D9                   		EXX
2190+ B074 D2 37 B0             		JP      NC,SQR1
2191+ B077 B7           SQR3:			OR      A
2192+ B078 ED 42                		SBC     HL,BC
2193+ B07A D9                   		EXX
2194+ B07B ED 42                		SBC     HL,BC
2195+ B07D D9                   		EXX
2196+ B07E 0C                   		INC     C
2197+ B07F C3 47 B0             		JP      SQR2
2198+ B082              ;
2199+ B082 29           SQRB:			ADD     HL,HL
2200+ B083 D9                   		EXX
2201+ B084 ED 6A                		ADC     HL,HL
2202+ B086 D9                   		EXX
2203+ B087 38 EE                		JR      C,SQR3
2204+ B089 3C                   		INC     A
2205+ B08A 0C                   		INC     C
2206+ B08B ED 42                		SBC     HL,BC
2207+ B08D D9                   		EXX
2208+ B08E ED 42                		SBC     HL,BC
2209+ B090 D9                   		EXX
2210+ B091 D0                   		RET     NC
2211+ B092 09                   		ADD     HL,BC
2212+ B093 D9                   		EXX
2213+ B094 ED 4A                		ADC     HL,BC
2214+ B096 D9                   		EXX
2215+ B097 0D                   		DEC     C
2216+ B098 C9                   		RET
2217+ B099              ;
2218+ B099 DD 7E 00     DIGITQ:			LD      A,(IX)
2219+ B09C FE 3A                		CP      '9'+1
2220+ B09E 3F                   		CCF
2221+ B09F D8                   		RET     C
2222+ B0A0 FE 30                		CP      '0'
2223+ B0A2 C9                   		RET
2224+ B0A3              ;
2225+ B0A3 DD 7E 00     SIGNQ:			LD      A,(IX)
2226+ B0A6 DD 23                		INC     IX
2227+ B0A8 FE 20                		CP      ' '
2228+ B0AA 28 F7                		JR      Z,SIGNQ
2229+ B0AC FE 2B                		CP      '+'
2230+ B0AE C8                   		RET     Z
2231+ B0AF FE 2D                		CP      '-'
2232+ B0B1 C8                   		RET     Z
2233+ B0B2 DD 2B                		DEC     IX
2234+ B0B4 C9                   		RET
2235+ B0B5
2236+ B0B5              			ENDMODULE
# file closed: fpp.z80
  35  B0B5              			include "sorry.z80"
# file opened: sorry.z80
   1+ B0B5              			MODULE SORRY
   2+ B0B5
   3+ B0B5              @CLG:
sorry.z80(4): warning: Label has different value in pass 3: previous value 45534 not equal 45237
   4+ B0B5              @COLOUR:
   5+ B0B5              @DRAW:
   6+ B0B5              @ENVEL:
   7+ B0B5              @GCOL:
   8+ B0B5              @MODE:
   9+ B0B5              @MOVE:
  10+ B0B5              @PLOT:
  11+ B0B5              @SOUND:
  12+ B0B5              @ADVAL:
  13+ B0B5              @POINT:
  14+ B0B5              @GETIMS:
  15+ B0B5              @PUTIMS:
  16+ B0B5 AF           			XOR     A
  17+ B0B6 CD 13 87     			CALL    EXTERR
  18+ B0B9 53 6F 72 72  			DEFM    'Sorry'
  18+ B0BD 79
  19+ B0BE 00           			DEFB    0
  20+ B0BF
  21+ B0BF              			ENDMODULE
# file closed: sorry.z80
  36  B0BF              			include "patch.z80"
# file opened: patch.z80
   1+ B0BF              ;
   2+ B0BF              ; Title:	BBC Basic for BSX
   3+ B0BF              ; Author:	Dean Belfield
   4+ B0BF              ; Created:	16/05/2020
   5+ B0BF              ; Last Updated:	08/10/2020
   6+ B0BF              ;
   7+ B0BF              ; Modinfo:
   8+ B0BF              ; 20/05/2020:	Added minimal OSCLI command (*BYE)
   9+ B0BF              ;		Uses RST instructions in latest ROM for I/O
  10+ B0BF              ; 10/06/2020:	Fixed COLOUR to use EXPRI instead of ITEMI so that calculations work without brackets, i.e. COLOUR 1+128
  11+ B0BF              ; 08/10/2020:	Minor mods to support UART
  12+ B0BF              ;
  13+ B0BF
  14+ B0BF              			MODULE PATCH
  15+ B0BF
  16+ B0BF              ; CLRSCN: clears the screen.
  17+ B0BF              ;
  18+ B0BF CD 4E 8C     @CLRSCN:		CALL	TELL
  19+ B0C2 1B 5B 32 4A  			DEFB	0x1B,0x5B,"2J",0x1B,0x5B,"1;1H",0
  19+ B0C6 1B 5B 31 3B
  19+ B0CA 31 48 00
  20+ B0CD C9           			RET
  21+ B0CE
  22+ B0CE              ; PUTIME: set current time to DE:HL, in centiseconds.
  23+ B0CE              ;
  24+ B0CE C9           @PUTIME:		RET
  25+ B0CF
  26+ B0CF              ; GETIME: return current time in DE:HL, in centiseconds.
  27+ B0CF              ;
  28+ B0CF 11 00 00     @GETIME:		LD	DE, 0
  29+ B0D2 21 00 00      	  		LD	HL, 0
  30+ B0D5 C9           			RET
  31+ B0D6
  32+ B0D6              ; PUTCSR: move to cursor to x=DE, y=HL
  33+ B0D6              ;
  34+ B0D6 C9           @PUTCSR:		RET
  35+ B0D7
  36+ B0D7              ; GETCSR: return cursor position in x=DE, y=HL
  37+ B0D7              ;
  38+ B0D7 11 00 00     @GETCSR:		LD	DE,0
  39+ B0DA 21 00 00     			LD	HL,0
  40+ B0DD C9           			RET
  41+ B0DE
  42+ B0DE              ; OSRDCH: read a character in from the keyboard (non-blocking)
  43+ B0DE              ;
  44+ B0DE CF           @OSRDCH:		RST	8
  45+ B0DF C9           			RET
  46+ B0E0
  47+ B0E0              ; PROMPT: output the input prompt
  48+ B0E0              ;
  49+ B0E0 3E 3E        @PROMPT: 		LD	A,'>'
  50+ B0E2
  51+ B0E2              ; OSWRCH: write a character out to the serial port
  52+ B0E2              ;
  53+ B0E2 D7           @OSWRCH:		RST	16
  54+ B0E3 C9           			RET
  55+ B0E4
  56+ B0E4              ;OSKEY - Read key with time-limit, test for ESCape.
  57+ B0E4              ;Main function is carried out in user patch.
  58+ B0E4              ;   Inputs: HL = time limit (centiseconds)
  59+ B0E4              ;  Outputs: Carry reset if time-out
  60+ B0E4              ;           If carry set A = character
  61+ B0E4              ; Destroys: A,H,L,F
  62+ B0E4              ;
  63+ B0E4 2B           @OSKEY:			DEC	HL
  64+ B0E5 7C           			LD	A,H
  65+ B0E6 B5           			OR	L
  66+ B0E7 C8           			RET	Z
  67+ B0E8 CF           			RST	8
  68+ B0E9 30 F9        			JR	NC,OSKEY
  69+ B0EB              ;			IN	A,(PORT_STM_IO)
  70+ B0EB              ;			JR	Z,OSKEY
  71+ B0EB FE 1B        			CP	0x1B		; ESC
  72+ B0ED 37           			SCF
  73+ B0EE C0           			RET	NZ
  74+ B0EF E5           ESCSET: 		PUSH    HL
  75+ B0F0 21 00 B6             		LD      HL,FLAGS
  76+ B0F3 CB 76                		BIT     6,(HL)          ; ESC DISABLED?
  77+ B0F5 20 02                		JR      NZ,ESCDIS
  78+ B0F7 CB FE                		SET     7,(HL)          ; SET ESCAPE FLAG
  79+ B0F9 E1           ESCDIS: 		POP     HL
  80+ B0FA C9                   		RET
  81+ B0FB CF           ESCTEST:		RST	8
  82+ B0FC D0           			RET	NC
  83+ B0FD              ;			IN	A,(PORT_STM_IO)
  84+ B0FD              ;			OR	A
  85+ B0FD              ;			RET	Z
  86+ B0FD FE 1B        			CP	0x1B		; ESC
  87+ B0FF 28 EE        			JR	Z,ESCSET
  88+ B101 C9           			RET
  89+ B102
  90+ B102 CD FB B0     @TRAP:			CALL ESCTEST
  91+ B105 3A 00 B6     @LTRAP:			LD A,(FLAGS)
  92+ B108 B7           			OR A
  93+ B109 F0           			RET P
  94+ B10A 21 00 B6     			LD HL,FLAGS
  95+ B10D CB BE        			RES 7,(HL)
  96+ B10F C3 E5 8D     			JP ESCAPE
  97+ B112
  98+ B112              ;OSINIT - Initialise RAM mapping etc.
  99+ B112              ;If BASIC is entered by BBCBASIC FILENAME then file
 100+ B112              ;FILENAME.BBC is automatically CHAINed.
 101+ B112              ;   Outputs: DE = initial value of HIMEM (top of RAM)
 102+ B112              ;            HL = initial value of PAGE (user program)
 103+ B112              ;            Z-flag reset indicates AUTO-RUN.
 104+ B112              ;  Destroys: A,D,E,H,L,F
 105+ B112              ;
 106+ B112 AF           @OSINIT: 		XOR	A
 107+ B113 32 00 B6     			LD	(@FLAGS),A	;Clear flags
 108+ B116 11 00 00              		LD 	DE,0x0000	;DE = HIMEM
 109+ B119 5F                    		LD 	E,A             ;PAGE BOUNDARY
 110+ B11A 21 01 B6              		LD 	HL,@USER
 111+ B11D C9                    		RET
 112+ B11E
 113+ B11E              ;
 114+ B11E              ;OSLINE - Read/edit a complete line, terminated by CR.
 115+ B11E              ;   Inputs: HL addresses destination buffer.
 116+ B11E              ;           (L=0)
 117+ B11E              ;  Outputs: Buffer filled, terminated by CR.
 118+ B11E              ;           A=0.
 119+ B11E              ; Destroys: A,B,C,D,E,H,L,F
 120+ B11E              ;
 121+ B11E CF           @OSLINE:		RST	8
 122+ B11F B7           			OR	A
 123+ B120 28 FC        			JR	Z,OSLINE
 124+ B122 FE 0D        			CP	0x0D		; CR
 125+ B124 28 0B        			JR	Z,KEYCR
 126+ B126 FE 7F        			CP	0x7F		; Backspace
 127+ B128 28 0D        			JR	Z,KEYBS
 128+ B12A 77           			LD	(HL),A		; Save the character in the buffer
 129+ B12B 23           			INC	HL
 130+ B12C CD E2 B0     			CALL	OSWRCH		; Echo character back to terminal
 131+ B12F 18 ED        			JR	OSLINE		; Loop
 132+ B131
 133+ B131 77           KEYCR:			LD	(HL),A		; Write final CR
 134+ B132 CD 90 88     			CALL	@CRLF		; Print CR
 135+ B135 A7           			AND	A
 136+ B136 C9           			RET
 137+ B137
 138+ B137 2C           KEYBS:			INC	L		; Check for beginning of line
 139+ B138 2D           			DEC	L
 140+ B139 28 E3        			JR	Z,OSLINE
 141+ B13B CD E2 B0     			CALL	OSWRCH
 142+ B13E 2D           			DEC	L
 143+ B13F 18 DD        			JR	OSLINE
 144+ B141
 145+ B141
 146+ B141              ;
 147+ B141              ;OSCLI - Process an "operating system" command
 148+ B141              ;
 149+ B141 CD 9B B1     @OSCLI: 		CALL    SKIPSP
 150+ B144 FE 0D        			CP      CR
 151+ B146 C8           			RET     Z
 152+ B147 FE 7C        			CP      '|'
 153+ B149 C8           			RET     Z
 154+ B14A FE 2E        			CP      '.'
 155+ B14C CA AD B1     			JP      Z,STARDOT	; *.
 156+ B14F EB           			EX      DE,HL
 157+ B150 21 CE B1     			LD      HL,COMDS
 158+ B153 1A           OSCLI0:			LD      A,(DE)
 159+ B154 CD A2 B1     			CALL    UPPRC
 160+ B157 BE           			CP      (HL)
 161+ B158 28 0B        			JR      Z,OSCLI2
 162+ B15A 38 2E        			JR      C,HUH
 163+ B15C CB 7E        OSCLI1:			BIT     7,(HL)
 164+ B15E 23           			INC     HL
 165+ B15F 28 FB        			JR      Z,OSCLI1
 166+ B161 23           			INC     HL
 167+ B162 23           			INC     HL
 168+ B163 18 EE        			JR      OSCLI0
 169+ B165              ;
 170+ B165 D5           OSCLI2:			PUSH    DE
 171+ B166 13           OSCLI3:			INC     DE
 172+ B167 23           			INC     HL
 173+ B168 1A           			LD      A,(DE)
 174+ B169 CD A2 B1     			CALL    UPPRC
 175+ B16C FE 2E        			CP      '.'		; ABBREVIATED?
 176+ B16E 28 0A        			JR      Z,OSCLI4
 177+ B170 AE           			XOR     (HL)
 178+ B171 28 F3        			JR      Z,OSCLI3
 179+ B173 FE 80        			CP      80H
 180+ B175 28 03        			JR      Z,OSCLI4
 181+ B177 D1           			POP     DE
 182+ B178 18 E2        			JR      OSCLI1
 183+ B17A              ;
 184+ B17A F1           OSCLI4:			POP     AF
 185+ B17B 13           		        INC     DE
 186+ B17C CB 7E        OSCLI5:			BIT     7,(HL)
 187+ B17E 23           			INC     HL
 188+ B17F 28 FB        			JR      Z,OSCLI5
 189+ B181 7E           			LD      A,(HL)
 190+ B182 23           			INC     HL
 191+ B183 66           			LD      H,(HL)
 192+ B184 6F           			LD      L,A
 193+ B185 E5           			PUSH    HL
 194+ B186 EB           			EX      DE,HL
 195+ B187 C3 9B B1     			JP      SKIPSP
 196+ B18A
 197+ B18A 3E FE        HUH:    		LD      A,254
 198+ B18C CD 13 87             		CALL    EXTERR
 199+ B18F 42 61 64 20          		DEFM    'Bad command'
 199+ B193 63 6F 6D 6D
 199+ B197 61 6E 64
 200+ B19A 00                   		DEFB    0
 201+ B19B
 202+ B19B 7E           SKIPSP:			LD      A,(HL)
 203+ B19C FE 20                		CP      ' '
 204+ B19E C0                   		RET     NZ
 205+ B19F 23                   		INC     HL
 206+ B1A0 18 F9                		JR      SKIPSP
 207+ B1A2
 208+ B1A2 E6 7F        UPPRC:  		AND     7FH
 209+ B1A4 FE 60        			CP      '`'
 210+ B1A6 D8           			RET     C
 211+ B1A7 E6 5F        			AND     5FH		; CONVERT TO UPPER CASE
 212+ B1A9 C9           			RET
 213+ B1AA              ; OSCLI - *BYE
 214+ B1AA              ;
 215+ B1AA C3 00 00     BYE:			JP	0
 216+ B1AD
 217+ B1AD              ; OSCLI - *CAT / *.
 218+ B1AD              ;
 219+ B1AD              STARDOT:
 220+ B1AD 3E 02        CAT:			LD 	A,0x02
 221+ B1AF D3 01        			OUT	(PORT_STM_FILE),A
 222+ B1B1 C9           			RET
 223+ B1B2
 224+ B1B2              ; OSCLI - *DIR
 225+ B1B2              ;
 226+ B1B2 7E           DIR:			LD	A,(HL)
 227+ B1B3 FE 22        			CP	0x22		; Quote
 228+ B1B5 20 D3        			JR 	NZ,HUH
 229+ B1B7 23           			INC 	HL
 230+ B1B8 3E 01        			LD 	A,0x01
 231+ B1BA D3 01        			OUT	(PORT_STM_FILE),A
 232+ B1BC 7E           1:			LD 	A,(HL)
 233+ B1BD FE 22        			CP	0x22
 234+ B1BF 28 09        			JR	Z,2F
 235+ B1C1 FE 0D        			CP	CR
 236+ B1C3 28 05        			JR 	Z,2F
 237+ B1C5 D3 01        			OUT	(PORT_STM_FILE),A
 238+ B1C7 23           			INC	HL
 239+ B1C8 18 F2        			JR 	1B
 240+ B1CA AF           2:			XOR	A
 241+ B1CB D3 01        			OUT	(PORT_STM_FILE),A
 242+ B1CD C9           			RET
 243+ B1CE
 244+ B1CE              ; Each command has bit 7 of the last character set, and is followed by the address of the handler
 245+ B1CE              ;
 246+ B1CE 42 59 C5     COMDS:  		DC    	'BYE'
 246+ B1D1 AA B1         	DEFW BYE	; JP 0
 247+ B1D3 43 41 D4     			DC	'CAT'
 247+ B1D6 AD B1         	DEFW CAT	; Catalogue SD Card
 248+ B1D8 44 49 D2     			DC	'DIR'
 248+ B1DB B2 B1         	DEFW DIR	; Change directory
 249+ B1DD FF           			DEFB	0FFH
 250+ B1DE
 251+ B1DE              ; COLOUR: change text colour
 252+ B1DE              ;
patch.z80(253): warning: Label has different value in pass 3: previous value 45237 not equal 45534
 253+ B1DE CD B5 9E     @COLOUR:		CALL    EXPRI
 254+ B1E1 CD 4E 8C     			CALL 	TELL
 255+ B1E4 1B 5B 00     			DEFB 	0x1B,0x5B,0
 256+ B1E7 D9           			EXX
 257+ B1E8 3E 33        			LD 	A,'3'
 258+ B1EA CB 7D        			BIT 	7,L
 259+ B1EC 28 01        			JR 	Z,1F
 260+ B1EE 3C           			INC 	A
 261+ B1EF CD E2 B0     1:			CALL	OSWRCH
 262+ B1F2 7D           			LD	A,L
 263+ B1F3 E6 07        			AND	7
 264+ B1F5 C6 30        			ADD	A,'0'
 265+ B1F7 CD E2 B0     			CALL 	OSWRCH
 266+ B1FA 3E 6D        			LD	A,"m"
 267+ B1FC CD E2 B0     			CALL 	OSWRCH
 268+ B1FF C3 0B 8D     			JP 	XEQ
 269+ B202
 270+ B202              ; Stuff not implemented yet
 271+ B202              ;
 272+ B202              @OSBPUT:
 273+ B202              @OSBGET:
 274+ B202              @OSSTAT:
 275+ B202              @OSSHUT:
 276+ B202              @OSOPEN:
 277+ B202              @OSCALL:
 278+ B202              @OSSAVE:
 279+ B202              @OSLOAD:
 280+ B202              @GETPTR:
 281+ B202              @PUTPTR:
 282+ B202              @GETEXT:
 283+ B202              @RESET:
 284+ B202 C9           			RET
 285+ B203
 286+ B203              			ENDMODULE
# file closed: patch.z80
  37  B203              			include "ram.z80"
# file opened: ram.z80
   1+ B203              ;
   2+ B203              ;RAM MODULE FOR BBC BASIC INTERPRETER
   3+ B203              ;FOR USE WITH VERSION 2.0 OF BBC BASIC
   4+ B203              ;*STANDARD CP/M DISTRIBUTION VERSION*
   5+ B203              ;(C) COPYRIGHT R.T.RUSSELL 31-12-1983
   6+ B203              ;
   7+ B203              			MODULE RAM
   8+ B203              ;
   9+ B203              ;n.b. ACCS, BUFFER & STAVAR must be on page boundaries.
  10+ B203              ;
  11+ B203 00 00 00...  			ALIGN 256
  12+ B300
  13+ B300 00 00 00...  @ACCS:			DEFS    256             ;STRING ACCUMULATOR
  14+ B400 00 00 00...  @BUFFER:		DEFS    256             ;STRING INPUT BUFFER
  15+ B500 00 00 00...  @STAVAR:		DEFS    27*4            ;STATIC VARIABLES
  16+ B56C              @OC:			EQU     STAVAR+15*4     ;CODE ORIGIN (O%)
  17+ B56C              @PC:			EQU     STAVAR+16*4     ;PROGRAM COUNTER (P%)
  18+ B56C 00 00 00...  @DYNVAR: 		DEFS    54*2            ;DYN. VARIABLE POINTERS
  19+ B5D8 00 00        @FNPTR:  		DEFS    2               ;DYN. FUNCTION POINTER
  20+ B5DA 00 00        @PROPTR: 		DEFS    2               ;DYN. PROCEDURE POINTER
  21+ B5DC              ;
  22+ B5DC 00 00        @PAGE:   		DEFS    2               ;START OF USER PROGRAM
  23+ B5DE 00 00        @TOP:    		DEFS    2               ;FIRST LOCN AFTER PROG.
  24+ B5E0 00 00        @LOMEM:  		DEFS    2               ;START OF DYN. STORAGE
  25+ B5E2 00 00        @FREE:   		DEFS    2               ;FIRST FREE-SPACE BYTE
  26+ B5E4 00 00        @HIMEM:  		DEFS    2               ;FIRST PROTECTED BYTE
  27+ B5E6              ;
  28+ B5E6 00 00        @LINENO: 		DEFS    2               ;LINE NUMBER
  29+ B5E8 00 00        @TRACEN:		DEFS    2               ;TRACE FLAG
  30+ B5EA 00 00        @AUTONO:		DEFS    2               ;AUTO FLAG
  31+ B5EC 00 00        @ERRTRP:		DEFS    2               ;ERROR TRAP
  32+ B5EE 00 00        @ERRTXT:		DEFS    2               ;ERROR MESSAGE POINTER
  33+ B5F0 00 00        @DATPTR:		DEFS    2               ;DATA POINTER
  34+ B5F2 00 00        @ERL:			DEFS    2               ;ERROR LINE
  35+ B5F4 00 00        @ERRLIN:		DEFS    2               ;"ON ERROR" LINE
  36+ B5F6 00 00 00...  @RANDOM:		DEFS    5               ;RANDOM NUMBER
  37+ B5FB 00           @COUNT:			DEFS    1               ;PRINT POSITION
  38+ B5FC 00           @WIDTH:			DEFS    1               ;PRINT WIDTH
  39+ B5FD 00           @ERR:			DEFS    1               ;ERROR NUMBER
  40+ B5FE 00           @LISTON:		DEFS    1               ;LISTO & OPT FLAG
  41+ B5FF 00           @INCREM:		DEFS    1               ;AUTO INCREMENT
  42+ B600              ;
  43+ B600              ; Added by me
  44+ B600              ;
  45+ B600 00           @FLAGS			DEFS	1		; Flags: B7=ESC PRESSED, B6=ESC DISABLED
  46+ B601
  47+ B601              			ENDMODULE
# file closed: ram.z80
  38  B601
  39  B601              @USER:  		ENDMODULE
# file closed: build.z80
